<!-- VERSION: Verbeterde Kozijnen Tekenapp -->
<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kozijnen Vrij Tekenen</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root { --bg:#0b0d10; --fg:#e6e6e6; --muted:#9aa1a8; --accent:#4aa3ff; --tussenStijl:#00ff88; --tussenDorpel:#ff8888; }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bg)}
    .wrap{display:grid;grid-template-columns:340px 1fr 320px;gap:16px;max-width:1800px;margin:0 auto;padding:16px}
    .prijsOverzicht{background:#1a1f2a;border:1px solid #2b2f36;border-radius:12px;padding:16px;position:sticky;top:16px;max-height:calc(100vh - 32px);overflow-y:auto}
    .prijsOverzicht h3{margin:0 0 12px;color:var(--fg);font-size:16px;font-weight:600}
    .prijsItem{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #2b2f36;font-size:13px}
    .prijsItem:last-child{border-bottom:none}
    .prijsItemLabel{color:var(--muted)}
    .prijsItemWaarde{color:var(--fg);font-weight:600}
    .prijsTotaal{margin-top:12px;padding-top:12px;border-top:2px solid var(--accent);display:flex;justify-content:space-between;font-size:16px;font-weight:700}
    .prijsTotaalLabel{color:var(--fg)}
    .prijsTotaalWaarde{color:var(--accent)}
    .prijsSectie{margin-bottom:16px}
    .prijsSectie h4{margin:0 0 8px;color:var(--fg);font-size:14px;font-weight:600}
    .prijsSubItem{display:flex;justify-content:space-between;padding:4px 0;font-size:12px;color:var(--muted);padding-left:12px}
    .canvasSection{display:flex;flex-direction:column;gap:12px}
    .dagmaatBar{display:none;padding:12px 16px;background:#1a1f2a;border:1px solid #2b2f36;border-radius:12px;flex-direction:row;align-items:center;gap:12px;flex-wrap:wrap}
    .dagmaatBar.active{display:flex}
    .dagmaatBar .barLabel{color:var(--muted);font-size:13px;font-weight:600;margin-right:8px}
    .dagmaatBar .btn{margin-bottom:0}
    fieldset{border:1px solid #2b2f36;border-radius:12px;padding:12px;margin-bottom:12px}
    legend{padding:0 6px;color:var(--muted);font-size:14px}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px;font-weight:500}
    input[type=number]{width:100%;padding:10px 12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);font-size:14px}
    input[type=number]:focus{outline:none;border-color:var(--accent)}
    .btn{display:inline-block;padding:10px 16px;border:1px solid #2b2f36;border-radius:10px;background:#141921;color:var(--fg);cursor:pointer;user-select:none;margin-right:6px;margin-bottom:6px;font-size:13px;transition:all 0.2s}
    .btn:hover{background:#1a1f2a;border-color:#3a3f46}
    .btn.primary{background:var(--accent);border-color:transparent;color:#0b0d10;font-weight:600}
    .btn.primary:hover{background:#5ab3ff}
    .btn.danger{background:#ff4444;border-color:transparent;color:#fff}
    .btn.danger:hover{background:#ff6666}
    .canvasWrap{background:#0f1318;border:1px solid #2b2f36;border-radius:16px;position:relative;overflow:hidden}
    svg{width:100%;height:min(90vh,1200px);display:block;cursor:crosshair}
    .kozijnFrame{stroke:#fff;stroke-width:3;fill:none}
    .kozijnKader{stroke:#fff;stroke-width:3;fill:none}
    .kozijnMeetlat{stroke:#888;stroke-width:1;fill:none;opacity:0.5}
    .tussenStijl{stroke:#fff;stroke-width:4;fill:none}
    .tussenDorpel{stroke:#fff;stroke-width:4;fill:none}
    .maatketting line{stroke:#ffb347;stroke-width:1.4;fill:none}
    .maatketting .maatkettingTick{stroke-width:1}
    .maatketting text{fill:#ffb347;font-size:11px;font-weight:600;letter-spacing:0.2px}
    .maatketting text[data-segment-id]{cursor:pointer;text-decoration:underline;text-underline-offset:3px}
    .maatkettingTextVert{text-anchor:start;dominant-baseline:middle}
    .maatPopover{position:fixed;display:none;flex-direction:column;gap:10px;padding:16px;background:#1a1f2a;border:1px solid var(--accent);border-radius:10px;z-index:3000;box-shadow:0 8px 24px rgba(0,0,0,0.45);min-width:220px}
    .maatPopover h4{margin:0;font-size:14px;color:var(--fg)}
    .maatPopover label{font-size:12px;color:var(--muted)}
    .maatPopover input{width:100%;padding:8px;border-radius:8px;border:1px solid #2b2f36;background:#10141a;color:var(--fg)}
    .maatPopover .actions{display:flex;gap:8px;justify-content:flex-end}
    .maatPopover button{padding:6px 12px;border-radius:8px;border:1px solid #2b2f36;background:#12161b;color:var(--fg);cursor:pointer;font-size:12px}
    .maatPopover button.primary{background:var(--accent);color:#0b0d10;border-color:transparent}
    .maatPopoverLock{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .preview{stroke:var(--accent);stroke-width:3;stroke-dasharray:6 3;opacity:0.8}
    .preview.stijl{stroke:#fff}
    .preview.dorpel{stroke:#fff}
    .info{margin-top:10px;padding:8px;background:#1a1f2a;border-radius:8px;font-size:12px;color:var(--muted);line-height:1.5}
    .info strong{color:var(--fg)}
    small{color:var(--muted);display:block;margin-top:8px;font-size:11px;line-height:1.4}
    .stats{padding:8px;background:#1a1f2a;border-radius:8px;font-size:12px;margin-top:8px}
    .stats div{margin:4px 0}
    h1{margin:0 0 12px;font-size:24px;color:var(--fg)}
    .subtitle{color:var(--muted);font-size:14px;margin-bottom:16px}
    .vakSelectModal{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#1a1f2a;border:2px solid var(--accent);border-radius:16px;padding:20px;z-index:1000;box-shadow:0 8px 32px rgba(0,0,0,0.5);min-width:400px;max-width:90vw;max-height:85vh;overflow-y:auto;overflow-x:hidden;display:none}
    .vakSelectModal.active{display:block}
    .technischeTekeningModal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1f2a;border:2px solid var(--accent);border-radius:16px;padding:20px;z-index:2000;box-shadow:0 8px 32px rgba(0,0,0,0.5);min-width:600px;max-width:95vw;max-height:90vh;display:none;flex-direction:column}
    .technischeTekeningModal.active{display:flex}
    .fotoModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:2500;display:none;align-items:center;justify-content:center;padding:20px}
    .fotoModal.active{display:flex}
    .fotoModalContent{position:relative;max-width:95vw;max-height:95vh;display:flex;align-items:center;justify-content:center}
    .fotoModalContent img{max-width:100%;max-height:95vh;object-fit:contain;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
    .fotoModalClose{position:absolute;top:20px;right:20px;background:rgba(26,31,42,0.9);border:2px solid var(--accent);border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;color:var(--fg);font-size:24px;cursor:pointer;transition:all 0.2s;z-index:10}
    .fotoModalClose:hover{background:var(--accent);color:#0b0d10;transform:scale(1.1)}
    .technischeTekeningModal h3{margin:0 0 16px;color:var(--fg);font-size:18px}
    .technischeTekeningModalContent{flex:1;display:flex;flex-direction:column;gap:16px;min-height:0}
    .technischeTekeningModal iframe{width:100%;flex:1;min-height:500px;border:1px solid #2b2f36;border-radius:8px;background:#0f1318}
    .technischeTekeningModalActions{display:flex;justify-content:flex-end;gap:12px;margin-top:16px;padding-top:16px;border-top:1px solid #2b2f36}
    .vakSelectModal h3{margin:0 0 16px;color:var(--fg);font-size:18px}
    .vakSelectGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-top:12px}
    .vakSelectOption{display:flex;flex-direction:column;align-items:center;padding:12px;border:2px solid #2b2f36;border-radius:10px;cursor:pointer;transition:all 0.2s;background:#12161b}
    .vakSelectOption:hover{border-color:var(--accent);background:#1a1f2a;transform:translateY(-2px)}
    .vakSelectOption.selected{border-color:var(--accent);background:#1a2f3a}
    .vakSelectOption img{width:80px;height:80px;object-fit:contain;margin-bottom:8px;background:#0b0d10;border-radius:6px;padding:8px}
    .vakSelectOption span{color:var(--fg);font-size:13px;font-weight:500;text-align:center}
    .modalClose{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:6px}
    .modalClose:hover{background:#2b2f36;color:var(--fg)}
    .vakQuickMenu{position:fixed;display:none;gap:12px;padding:12px;background:#1a1f2a;border:2px solid var(--accent);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.45);transform:translate(-50%,-50%);z-index:1500;max-height:85vh;overflow-y:auto}
    .vakQuickMenu button{display:flex;flex-direction:column;align-items:center;gap:8px;padding:10px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);cursor:pointer;min-width:120px;transition:all 0.2s}
    .vakQuickMenu button:hover{border-color:var(--accent);background:#182331;transform:translateY(-2px)}
    .vakQuickMenu button.selected{border-color:var(--accent);background:#1a2f3a;box-shadow:0 0 0 2px rgba(74,163,255,0.25)}
    .vakQuickMenu button img,.vakQuickMenu button svg{width:70px;height:70px;object-fit:contain;border-radius:8px;padding:8px;background:#0b0d10}
    .vakQuickMenu button span{font-size:13px;font-weight:600}
    .vakRaamMenu{position:fixed;display:none;flex-direction:column;gap:12px;padding:14px 16px;background:#1a1f2a;border:2px solid var(--accent);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.5);transform:translate(-50%,-50%);z-index:1600;min-width:340px;max-width:min(90vw,760px);max-height:85vh;overflow-y:auto}
    .vakRaamMenu h4{margin:0;color:var(--fg);font-size:14px;font-weight:600}
    .vakRaamStatus{padding:8px 10px;background:#141a22;border-radius:8px;color:var(--muted);font-size:12px}
    .vakRaamMenuSection{display:flex;gap:12px;flex-wrap:wrap}
    .vakRaamMenuSection button{display:flex;flex-direction:column;align-items:center;gap:8px;padding:10px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);cursor:pointer;min-width:150px;transition:all 0.2s}
    .vakRaamMenuSection button:hover{border-color:var(--accent);background:#182331;transform:translateY(-2px)}
    .vakRaamMenuSection button.selected{border-color:var(--accent);background:#1a2f3a;box-shadow:0 0 0 2px rgba(74,163,255,0.25)}
    .vakRaamMenuSection button svg,.vakRaamMenuSection button img{width:80px;height:80px;background:#0b0d10;border-radius:8px;padding:8px;object-fit:contain}
    .vakRaamMenuSection button span{font-size:13px;font-weight:600;text-align:center}
    .vakOrientationMenu{position:fixed;display:none;flex-direction:column;gap:12px;padding:14px 16px;background:#1a1f2a;border:2px solid var(--accent);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.5);transform:translate(-50%,-50%);z-index:1650;min-width:320px;max-width:min(90vw,600px);max-height:85vh;overflow-y:auto}
    .vakOrientationMenu h4{margin:0;color:var(--fg);font-size:14px;font-weight:600}
    .vakOrientationStatus{padding:8px 10px;background:#141a22;border-radius:8px;color:var(--muted);font-size:12px}
    .vakOrientationButtons{display:flex;gap:10px;flex-wrap:wrap}
    .vakOrientationButtons button{flex:1 1 120px;padding:10px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);cursor:pointer;font-size:13px;font-weight:600;transition:all 0.2s;display:flex;flex-direction:column;align-items:center;gap:6px}
    .vakOrientationButtons button svg,.vakOrientationButtons button img{width:42px;height:42px;object-fit:contain;display:block;background:transparent}
    .vakOrientationButtons button:hover{border-color:var(--accent);background:#182331;transform:translateY(-2px)}
    .vakOrientationButtons button.selected{border-color:var(--accent);background:#1a2f3a;box-shadow:0 0 0 2px rgba(74,163,255,0.25)}
    .vakOrientationActions{display:flex;justify-content:flex-end;gap:8px}
    .vakOrientationActions button{padding:8px 12px;border-radius:8px;border:1px solid #2b2f36;background:#10141a;color:var(--fg);cursor:pointer;font-size:12px;font-weight:600}
    .vakOrientationActions button:hover{border-color:var(--accent);background:#182331;color:#fff}
    .vakRaamMenuActions{display:flex;justify-content:flex-end;gap:8px}
    .vakRaamMenuActions button{padding:8px 12px;border-radius:8px;border:1px solid #2b2f36;background:#10141a;color:#ff7777;cursor:pointer;font-size:12px;font-weight:600}
    .vakRaamMenuActions button:hover{border-color:#ff7777;background:#1c1518}
    .vakRaamMenuActions button:disabled{opacity:0.4;cursor:not-allowed;border-color:#2b2f36;color:#666}
    .vakRaamMenuActions .secondary{color:var(--fg);background:#12161b;border-color:#2b2f36}
    .vakRaamMenuActions .secondary:hover{border-color:var(--accent);background:#182331;color:var(--fg)}
    .vakRaamExtraMenu{position:fixed;display:none;flex-direction:column;gap:14px;padding:16px 18px;background:#1a1f2a;border:2px solid var(--accent);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.5);z-index:1700;min-width:360px;max-width:min(90vw,650px);max-height:85vh;overflow-y:auto!important;overflow-x:hidden!important}
    #vakAfwerkingsOptiesMenu{max-height:85vh!important;overflow-y:auto!important;overflow-x:hidden!important}
    .vakRaamExtraMenu h4{margin:0;color:var(--fg);font-size:14px;font-weight:600}
    .vakRaamExtraStatus{padding:8px 10px;background:#141a22;border-radius:8px;color:var(--muted);font-size:12px}
    .vakRaamExtraOptions{display:flex;flex-direction:column;gap:16px}
    .extra-option-group{display:flex;flex-direction:column;gap:8px}
    .extra-option-group label{color:var(--fg);font-size:13px;font-weight:600}
    .checkbox-label{display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px;border:1px solid #2b2f36;border-radius:8px;background:#12161b;transition:all 0.2s}
    .checkbox-label:hover{border-color:var(--accent);background:#182331}
    .checkbox-label input[type="checkbox"]{width:18px;height:18px;cursor:pointer;accent-color:var(--accent)}
    .checkbox-label input[type="checkbox"]:checked + span{color:var(--accent)}
    .beslag-kleur-buttons{display:flex;gap:10px;flex-wrap:wrap}
    .beslag-kleur-btn{flex:1 1 150px;padding:10px;border:1px solid #2b2f36;border-radius:8px;background:#12161b;color:var(--fg);cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s}
    .beslag-kleur-btn:hover{border-color:var(--accent);background:#182331}
    .beslag-kleur-btn.selected{border-color:var(--accent);background:#1a2f3a;box-shadow:0 0 0 2px rgba(74,163,255,0.25)}
    .beslag-kleur-picker{margin-top:10px;display:flex;align-items:center;gap:10px;padding:10px;background:#12161b;border-radius:8px;border:1px solid #2b2f36}
    .beslag-kleur-picker input[type="color"]{width:50px;height:40px;border:none;border-radius:6px;cursor:pointer;background:transparent}
    .beslag-kleur-picker label{color:var(--fg);font-size:12px;cursor:pointer}
    .vakRaamExtraActions{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .vakRaamExtraActions button{padding:8px 14px;border-radius:8px;border:1px solid #2b2f36;background:#10141a;color:var(--fg);cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s}
    .vakRaamExtraActions button:hover{border-color:var(--accent);background:#182331;color:#fff}
    .vakRaamExtraActions button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .vakRaamExtraActions button.primary:hover{background:#3d8ce6;transform:translateY(-1px);box-shadow:0 4px 12px rgba(74,163,255,0.3)}
    .glasRoosterButtons{display:flex;gap:10px;flex-wrap:wrap}
    .glasRoosterBtn{flex:1 1 150px;padding:10px;border:1px solid #2b2f36;border-radius:8px;background:#12161b;color:var(--fg);cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s;text-align:center}
    .glasRoosterBtn:hover{border-color:var(--accent);background:#182331}
    .glasRoosterBtn.selected{border-color:var(--accent);background:#1a2f3a;box-shadow:0 0 0 2px rgba(74,163,255,0.25)}
    .ral-kleur-btn:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.3)}
    .ral-kleur-btn.selected{border:2px solid var(--accent)!important;box-shadow:0 0 0 2px rgba(74,163,255,0.25)}
    /* Scrollbar styling voor menu's - zorg dat alle menu's scrollbaar zijn */
    .vakQuickMenu::-webkit-scrollbar,.vakRaamMenu::-webkit-scrollbar,.vakOrientationMenu::-webkit-scrollbar,.vakRaamExtraMenu::-webkit-scrollbar{width:10px}
    .vakQuickMenu::-webkit-scrollbar-track,.vakRaamMenu::-webkit-scrollbar-track,.vakOrientationMenu::-webkit-scrollbar-track,.vakRaamExtraMenu::-webkit-scrollbar-track{background:#0f1318;border-radius:5px}
    .vakQuickMenu::-webkit-scrollbar-thumb,.vakRaamMenu::-webkit-scrollbar-thumb,.vakOrientationMenu::-webkit-scrollbar-thumb,.vakRaamExtraMenu::-webkit-scrollbar-thumb{background:#2b2f36;border-radius:5px;border:2px solid #0f1318}
    .vakQuickMenu::-webkit-scrollbar-thumb:hover,.vakRaamMenu::-webkit-scrollbar-thumb:hover,.vakOrientationMenu::-webkit-scrollbar-thumb:hover,.vakRaamExtraMenu::-webkit-scrollbar-thumb:hover{background:#4a4f56}
    .vakQuickMenu,.vakRaamMenu,.vakOrientationMenu,.vakRaamExtraMenu{scrollbar-width:thin;scrollbar-color:#2b2f36 #0f1318}
    /* Zorg dat menu's altijd scrollbaar zijn wanneer nodig */
    .vakQuickMenu,.vakRaamMenu,.vakOrientationMenu,.vakRaamExtraMenu{overflow-y:auto;overflow-x:hidden}
    /* Scrollbar styling voor vakSelectModal */
    .vakSelectModal::-webkit-scrollbar{width:10px}
    .vakSelectModal::-webkit-scrollbar-track{background:#0f1318;border-radius:5px}
    .vakSelectModal::-webkit-scrollbar-thumb{background:#2b2f36;border-radius:5px;border:2px solid #0f1318}
    .vakSelectModal::-webkit-scrollbar-thumb:hover{background:#4a4f56}
    .vakSelectModal{scrollbar-width:thin;scrollbar-color:#2b2f36 #0f1318}
    /* Winkelwagen styling */
    .winkelwagenPagina{display:none;max-width:1200px;margin:0 auto;padding:16px}
    .winkelwagenPagina.active{display:block}
    .losseProductenPagina{display:none;max-width:1600px;margin:0 auto;padding:16px}
    .losseProductenPagina.active{display:block;min-height:calc(100vh - 100px)}
    .losseProductenOverzicht{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 200px);padding:40px 20px}
    .losseProductenOverzicht h1{margin:0 0 12px;font-size:32px;color:var(--fg);text-align:center}
    .losseProductenOverzicht p{margin:0 0 40px;color:var(--muted);font-size:16px;text-align:center;max-width:600px}
    .productKeuzeGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;max-width:1000px;width:100%}
    .productKeuzeCard{display:flex;flex-direction:column;align-items:center;padding:40px 30px;border:2px solid #2b2f36;border-radius:16px;cursor:pointer;transition:all 0.3s;background:#1a1f2a;text-decoration:none}
    .productKeuzeCard:hover{border-color:var(--accent);background:#1a2f3a;transform:translateY(-4px);box-shadow:0 8px 24px rgba(74,163,255,0.2)}
    .productKeuzeCard img{width:150px;height:150px;object-fit:contain;margin-bottom:20px;background:#0b0d10;border-radius:12px;padding:20px}
    .productKeuzeCard h2{margin:0 0 12px;color:var(--fg);font-size:24px;font-weight:600;text-align:center}
    .productKeuzeCard p{margin:0;color:var(--muted);font-size:14px;text-align:center}
    .productPagina{display:none;max-width:1400px;margin:0 auto;padding:16px}
    .productPagina.active{display:block}
    .productPaginaHeader{margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid #2b2f36}
    .productPaginaHeader h1{margin:0 0 8px;color:var(--fg);font-size:28px;font-weight:600}
    .productPaginaHeader p{margin:0;color:var(--muted);font-size:14px}
    .productPaginaContent{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    .productConfigSectie{background:#1a1f2a;border:1px solid #2b2f36;border-radius:12px;padding:24px}
    .productTekeningSectie{background:#1a1f2a;border:1px solid #2b2f36;border-radius:12px;padding:24px}
    .tekenPagina{display:block}
    .tekenPagina.hidden{display:none}
    .productPreview{flex:1;background:#1a1f2a;border:1px solid #2b2f36;border-radius:12px;padding:24px;overflow-y:auto;display:flex;flex-direction:column}
    .productPreviewHeader{margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid #2b2f36}
    .productPreviewHeader h2{margin:0 0 8px;color:var(--fg);font-size:24px;font-weight:600}
    .productPreviewHeader p{margin:0;color:var(--muted);font-size:14px}
    .productConfigForm{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px}
    .productConfigItem{display:flex;flex-direction:column}
    .productConfigItem label{color:var(--muted);font-size:13px;font-weight:500;margin-bottom:8px}
    .productConfigItem input,.productConfigItem select{width:100%;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);font-size:14px}
    .productConfigItem input:focus,.productConfigItem select:focus{outline:none;border-color:var(--accent)}
    .productConfigItem input[type="radio"]{width:auto;padding:0;margin:0;cursor:pointer;accent-color:var(--accent)}
    .productConfigItem label label{color:var(--fg);font-weight:normal;margin-bottom:0}
    .productConfigItem.small{flex:0 0 calc(50% - 12px);max-width:calc(50% - 12px)}
    .productConfigItem.small.third{flex:0 0 calc(33.333% - 16px);max-width:calc(33.333% - 16px)}
    .productConfigRow{display:flex;gap:24px;margin-bottom:20px;grid-column:1/-1}
    .productConfigItem.full-width{grid-column:1/-1}
    .productPreviewActions{display:flex;justify-content:flex-end;gap:12px;margin-top:24px;padding-top:24px;border-top:1px solid #2b2f36}
    .productPreviewInfo{background:#12161b;border:1px solid #2b2f36;border-radius:10px;padding:16px;margin-top:20px}
    .productPreviewInfo h3{margin:0 0 12px;color:var(--fg);font-size:16px;font-weight:600}
    .productPreviewInfoItem{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #2b2f36;font-size:13px}
    .productPreviewInfoItem:last-child{border-bottom:none}
    .productPreviewInfoLabel{color:var(--muted)}
    .productPreviewInfoWaarde{color:var(--fg);font-weight:600}
    .productPreviewPrijs{font-size:20px;font-weight:700;color:var(--accent);text-align:right;margin-top:12px}
    .productPreviewTekening{background:#0f1318;border:1px solid #2b2f36;border-radius:10px;padding:20px;margin-top:20px;display:flex;flex-direction:column;align-items:center}
    .productPreviewTekening h3{margin:0 0 16px;color:var(--fg);font-size:16px;font-weight:600;width:100%}
    .productPreviewTekening svg{width:100%;max-width:500px;height:400px;border:1px solid #2b2f36;border-radius:8px;background:#0b0d10}
    .glasTekening{stroke:#4aa3ff;stroke-width:2;fill:none}
    .glasTekeningRooster{stroke:#4aa3ff;stroke-width:1;fill:none;opacity:0.6}
    .glasTekeningMaat{fill:#ffb347;font-size:12px;font-weight:600;text-anchor:middle}
    .winkelwagenHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid #2b2f36}
    .winkelwagenHeader h1{margin:0;font-size:28px;color:var(--fg)}
    .winkelwagenItem{background:#1a1f2a;border:1px solid #2b2f36;border-radius:12px;padding:16px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
    .winkelwagenItemThumbnail{width:200px;height:150px;flex-shrink:0;border:1px solid #2b2f36;border-radius:8px;background:#0f1318;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .winkelwagenItemThumbnail img{width:100%;height:100%;object-fit:contain}
    .winkelwagenItemInfo{flex:1}
    .winkelwagenItemInfo h3{margin:0 0 8px;color:var(--fg);font-size:16px;font-weight:600}
    .winkelwagenItemInfo p{margin:4px 0;color:var(--muted);font-size:13px}
    .winkelwagenItemDetails{display:flex;flex-direction:column;gap:4px;margin-top:8px}
    .winkelwagenItemDetails span{color:var(--muted);font-size:12px}
    .winkelwagenItemActies{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .winkelwagenItemPrijs{font-size:18px;font-weight:700;color:var(--accent)}
    .winkelwagenItemType{display:inline-block;padding:4px 8px;background:#12161b;border-radius:6px;font-size:11px;font-weight:600;color:var(--accent);margin-bottom:8px}
    .winkelwagenTotaal{background:#1a1f2a;border:2px solid var(--accent);border-radius:12px;padding:20px;margin-top:24px;display:flex;justify-content:space-between;align-items:center}
    .winkelwagenTotaalLabel{font-size:20px;font-weight:600;color:var(--fg)}
    .winkelwagenTotaalWaarde{font-size:24px;font-weight:700;color:var(--accent)}
    .winkelwagenLeeg{text-align:center;padding:60px 20px;color:var(--muted)}
    .winkelwagenLeeg h2{margin:0 0 12px;color:var(--fg);font-size:20px}
    .winkelwagenLeeg p{margin:0;font-size:14px}
    .navigatieBar{background:#1a1f2a;border-bottom:1px solid #2b2f36;padding:12px 16px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
    .navigatieBar h2{margin:0;font-size:18px;color:var(--fg)}
    .navigatieKnoppen{display:flex;gap:12px}
    .winkelwagenBadge{display:inline-block;background:var(--accent);color:#0b0d10;border-radius:12px;padding:2px 8px;font-size:11px;font-weight:700;margin-left:8px}
  </style>
</head>
<body>
  <!-- Navigatie bar -->
  <div class="navigatieBar">
    <h2>üé® Kozijnen Configurator</h2>
    <div class="navigatieKnoppen">
      <button class="btn" id="btnNaarTekenen">‚úèÔ∏è Tekenen</button>
      <button class="btn" id="btnNaarLosseProducten">üì¶ Losse Producten</button>
      <button class="btn primary" id="btnNaarWinkelwagen">üõí Winkelwagen<span id="winkelwagenBadge" class="winkelwagenBadge" style="display:none">0</span></button>
    </div>
  </div>

  <!-- Teken pagina -->
  <div class="tekenPagina" id="tekenPagina">
  <div class="wrap">
    <aside>
      <h1>üé® Kozijnen Tekenen</h1>
      <div class="subtitle">Teken als op papier</div>
      
      <fieldset>
        <legend>üìê Kader Afmetingen</legend>
        <label>Breedte (mm)</label>
        <input id="inpW" type="number" min="200" max="10000" value="2000" step="50" />
        <label>Hoogte (mm)</label>
        <input id="inpH" type="number" min="200" max="10000" value="2000" step="50" />
        <div style="margin-top:10px">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-top:10px;margin-bottom:10px">
            <input type="checkbox" id="ekosietOnderdorpel" style="width:18px;height:18px;cursor:pointer;accent-color:var(--accent)" />
            <span>Ekosiet onderdorpel</span>
          </label>
        </div>
        <div style="margin-top:10px">
          <button class="btn primary" id="btnApply">‚úì Toepassen</button>
        </div>
        <small>Buitenmaat kozijn.<br>Kader: 67mm<br>Tussenstijlen/dorpels: 90mm<br><br>Boven/onder dorpel loopt door, stijlen sluiten erop aan.</small>
      </fieldset>

      <fieldset>
        <legend>‚úèÔ∏è Tekenmodus</legend>
        <div id="modeInfo" class="info">
          <strong>Huidige modus:</strong><br>
          <span id="modeText">Klik en sleep in het kader...</span>
        </div>
      </fieldset>

      <fieldset>
        <legend>üîß Acties</legend>
        <button class="btn" id="btnUndo">‚Ü∂ Ongedaan maken</button>
        <button class="btn danger" id="btnReset">üóëÔ∏è Alles wissen</button>
        <button class="btn primary" id="btnDetectVakken" style="margin-top:10px;width:100%">‚úì Klaar met tekenen</button>
        <small>Wis de laatste lijn of start helemaal opnieuw.</small>
      </fieldset>

      <fieldset>
        <legend>üì∑ Foto Upload</legend>
        <input type="file" id="fotoUploadBuitenkant" accept="image/*" capture="environment" style="display:none" />
        <button class="btn" id="btnUploadFotoBuitenkant" style="width:100%;margin-bottom:10px">üì∑ Buitenkant foto maken</button>
        <button class="btn" id="btnVerwijderFotoBuitenkant" style="width:100%;display:none;margin-bottom:10px">üóëÔ∏è Verwijder buitenkant foto</button>
        <div id="fotoPreviewBuitenkant" style="display:none;margin-top:10px">
          <img id="fotoPreviewImgBuitenkant" style="max-width:100%;border:1px solid #444;border-radius:4px;cursor:pointer" />
        </div>
        
        <input type="file" id="fotoUploadBinnenkant" accept="image/*" capture="environment" style="display:none" />
        <button class="btn" id="btnUploadFotoBinnenkant" style="width:100%;margin-top:10px;margin-bottom:10px">üì∑ Binnenkant foto maken</button>
        <button class="btn" id="btnVerwijderFotoBinnenkant" style="width:100%;display:none;margin-bottom:10px">üóëÔ∏è Verwijder binnenkant foto</button>
        <div id="fotoPreviewBinnenkant" style="display:none;margin-top:10px">
          <img id="fotoPreviewImgBinnenkant" style="max-width:100%;border:1px solid #444;border-radius:4px;cursor:pointer" />
        </div>
        <small style="display:block;margin-top:10px;color:#888">Op mobiele apparaten kun je kiezen tussen camera of galerij.</small>
      </fieldset>

      <fieldset id="vakkenFieldset" style="display:none">
        <legend>üìã Vakken Toewijzing</legend>
        <div id="vakkenList"></div>
        <button type="button" id="btnAfwerkingsOpties" class="btn primary" style="width:100%;margin-top:12px;display:none">
          Afwerkingsopties
        </button>
      </fieldset>

      <fieldset>
        <legend>üíæ Opslaan & Laden</legend>
        <button class="btn" id="btnSave">üíæ Opslaan</button>
        <button class="btn" id="btnLoad">üìÇ Laden</button>
        <div class="stats">
          <div><strong>Tussen stijlen:</strong> <span id="countStijl">0</span></div>
          <div><strong>Tussen dorpels:</strong> <span id="countDorpel">0</span></div>
        </div>
        <small>Snapshots worden lokaal opgeslagen in je browser.</small>
      </fieldset>
    </aside>

    <section class="canvasSection">
      <div id="maatTools" class="dagmaatBar">
        <span class="barLabel">üìè Dagmaat beheer:</span>
        <button class="btn" id="btnEqualizeDagHoriz" type="button">‚Üî Alle dagmaten gelijk (breedte)</button>
        <button class="btn" id="btnEqualizeDagVert" type="button">‚Üï Alle dagmaten gelijk (hoogte)</button>
        <button class="btn" id="btnDistributeMiddleHoriz" type="button">‚§¢ Verdeel middenvakken (breedte)</button>
        <button class="btn" id="btnDistributeMiddleVert" type="button">‚§¢ Verdeel middenvakken (hoogte)</button>
      </div>
      <div class="canvasWrap">
      <svg id="view" viewBox="0 0 1400 1400"></svg>
      </div>
    </section>

    <aside class="prijsOverzicht">
      <h3>üí∞ Prijs Overzicht</h3>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;margin-bottom:12px;border-bottom:1px solid #2b2f36;font-size:13px;gap:16px">
        <div style="display:flex;align-items:center;gap:8px;flex:1">
          <strong>Getekend:</strong>
          <input type="number" id="aantalGetekend" min="0" value="1" style="width:60px;padding:6px 8px;border:1px solid #2b2f36;border-radius:6px;background:#12161b;color:var(--fg);font-size:13px;text-align:center" />
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex:1">
          <strong>Gespiegeld:</strong>
          <input type="number" id="aantalGespiegeld" min="0" value="0" style="width:60px;padding:6px 8px;border:1px solid #2b2f36;border-radius:6px;background:#12161b;color:var(--fg);font-size:13px;text-align:center" />
        </div>
      </div>
      <div id="prijsContent">
        <div class="prijsSectie">
          <h4>Kozijn</h4>
          <div class="prijsItem">
            <span class="prijsItemLabel">Basis kozijn</span>
            <span class="prijsItemWaarde" id="prijsBasisKozijn">‚Ç¨0,00</span>
          </div>
          <div class="prijsItem">
            <span class="prijsItemLabel">Tussenstijlen</span>
            <span class="prijsItemWaarde" id="prijsTussenstijlen">‚Ç¨0,00</span>
          </div>
          <div class="prijsItem">
            <span class="prijsItemLabel">Tussendorpels</span>
            <span class="prijsItemWaarde" id="prijsTussendorpels">‚Ç¨0,00</span>
          </div>
        </div>
        <div class="prijsSectie">
          <h4>Vakken</h4>
          <div id="prijsVakken"></div>
        </div>
        <div class="prijsSectie">
          <h4>Afwerking</h4>
          <div id="prijsAfwerking"></div>
        </div>
        <div class="prijsTotaal">
          <span class="prijsTotaalLabel">Totaal</span>
          <span class="prijsTotaalWaarde" id="prijsTotaal">‚Ç¨0,00</span>
        </div>
        <button class="btn primary" id="btnExportPDF" style="width:100%;margin-top:16px">üìÑ Technische Tekening</button>
        <button class="btn primary" id="btnToevoegenAanWinkelwagen" style="width:100%;margin-top:12px">üõí Toevoegen aan winkelwagen</button>
      </div>
    </aside>
  </div>
  </div>

  <!-- Losse Producten Overzicht pagina -->
  <div class="losseProductenPagina" id="losseProductenPagina">
    <div class="losseProductenOverzicht">
      <h1>üì¶ Losse Producten</h1>
      <p>Kies een product om te configureren en toe te voegen aan uw winkelwagen</p>
      <div class="productKeuzeGrid">
        <div class="productKeuzeCard" data-product="glas" id="keuzeGlas">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='10' y='10' width='80' height='80' fill='none' stroke='%234aa3ff' stroke-width='3'/%3E%3Cline x1='20' y1='20' x2='80' y2='20' stroke='%234aa3ff' stroke-width='2'/%3E%3Cline x1='20' y1='50' x2='80' y2='50' stroke='%234aa3ff' stroke-width='2'/%3E%3Cline x1='20' y1='80' x2='80' y2='80' stroke='%234aa3ff' stroke-width='2'/%3E%3C/svg%3E" alt="Glas" />
          <h2>ü™ü Los Glas</h2>
          <p>Bestel los glas in verschillende afmetingen en types</p>
        </div>
        <div class="productKeuzeCard" data-product="raam" id="keuzeRaam">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='10' y='10' width='80' height='80' fill='none' stroke='%234aa3ff' stroke-width='3'/%3E%3Cline x1='10' y1='50' x2='90' y2='50' stroke='%234aa3ff' stroke-width='2'/%3E%3Cline x1='50' y1='10' x2='50' y2='90' stroke='%234aa3ff' stroke-width='2'/%3E%3Ccircle cx='50' cy='50' r='8' fill='%234aa3ff'/%3E%3C/svg%3E" alt="Raam" />
          <h2>ü™ü Los Raam</h2>
          <p>Bestel losse ramen in verschillende types en afmetingen</p>
        </div>
        <div class="productKeuzeCard" data-product="deur" id="keuzeDeur">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='10' y='10' width='80' height='80' fill='none' stroke='%234aa3ff' stroke-width='3'/%3E%3Cline x1='10' y1='50' x2='90' y2='50' stroke='%234aa3ff' stroke-width='2'/%3E%3Ccircle cx='85' cy='50' r='4' fill='%234aa3ff'/%3E%3C/svg%3E" alt="Deur" />
          <h2>üö™ Losse Deur</h2>
          <p>Bestel losse deuren in verschillende types en afmetingen</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Oude preview content (verborgen) -->
  <div style="display:none">
    <!-- Product Preview Rechts -->
    <div class="productPreview">
      <!-- Glas Preview -->
      <div class="productPreviewContent" id="previewGlas" style="display:block">
        <div class="productPreviewHeader">
          <h2>ü™ü Los Glas Configureren</h2>
          <p>Configureer uw glas met afmetingen en type</p>
        </div>
        <div class="productConfigForm">
          <div class="productConfigItem">
            <label>Breedte (mm)</label>
            <input type="number" id="glasBreedte" min="100" max="5000" step="10" value="1000" />
          </div>
          <div class="productConfigItem">
            <label>Hoogte (mm)</label>
            <input type="number" id="glasHoogte" min="100" max="5000" step="10" value="1000" />
          </div>
          <div class="productConfigItem">
            <label>Glas Type</label>
            <select id="glasTypeLos">
              <option value="enkel">Enkel glas</option>
              <option value="dubbel">Dubbel glas</option>
              <option value="trippel">Trippel glas</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Rooster</label>
            <select id="glasRooster">
              <!-- Opties worden geladen vanuit glas-en-rooster-data.json -->
            </select>
          </div>
          <div class="productConfigItem">
            <label>Aantal</label>
            <input type="number" id="glasAantal" min="1" value="1" />
          </div>
        </div>
        <div class="productPreviewTekening">
          <h3>üìê Overzicht Tekening</h3>
          <svg id="glasTekeningSVG" viewBox="0 0 500 400" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
        <div class="productPreviewInfo">
          <h3>Product Informatie</h3>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Afmetingen:</span>
            <span class="productPreviewInfoWaarde" id="glasAfmetingen">1000 x 1000 mm</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Oppervlakte:</span>
            <span class="productPreviewInfoWaarde" id="glasOppervlakte">1,00 m¬≤</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Glas Type:</span>
            <span class="productPreviewInfoWaarde" id="glasTypeDisplay">Enkel glas</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Aantal:</span>
            <span class="productPreviewInfoWaarde" id="glasAantalDisplay">1</span>
          </div>
          <div class="productPreviewPrijs" id="glasPrijs">‚Ç¨0,00</div>
        </div>
        <div class="productPreviewActions">
          <button class="btn primary" id="btnVoegGlasToe">üõí Toevoegen aan winkelwagen</button>
        </div>
      </div>

      <!-- Raam Preview -->
      <div class="productPreviewContent" id="previewRaam" style="display:none">
        <div class="productPreviewHeader">
          <h2>ü™ü Los Raam Configureren</h2>
          <p>Configureer uw raam met afmetingen, type en opties</p>
        </div>
        <div class="productConfigForm">
          <div class="productConfigItem">
            <label>Breedte (mm)</label>
            <input type="number" id="raamBreedte" min="300" max="5000" step="10" value="1000" />
          </div>
          <div class="productConfigItem">
            <label>Hoogte (mm)</label>
            <input type="number" id="raamHoogte" min="300" max="5000" step="10" value="1000" />
          </div>
          <div class="productConfigItem">
            <label>Raam Type</label>
            <select id="raamTypeLos">
              <option value="draairaam_buiten">Draairaam naar buiten</option>
              <option value="draairaam_binnen">Draairaam naar binnen</option>
              <option value="stolpraam_buiten">Stolpraam buitendraaiend</option>
              <option value="stolpraam_binnen">Stolpraam binnendraaiend</option>
              <option value="draaikiep">Draaikiep raam</option>
              <option value="kiep">Kiep raam</option>
              <option value="vast">Vast raam</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Draairichting</label>
            <select id="raamDraairichting">
              <option value="links">Links draaiend</option>
              <option value="rechts">Rechts draaiend</option>
              <option value="actief">Actief</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Glas Type</label>
            <select id="raamGlasType">
              <option value="enkel">Enkel glas</option>
              <option value="hr+">HR+</option>
              <option value="hr++">HR++</option>
              <option value="hr+++">HR+++</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Aantal</label>
            <input type="number" id="raamAantal" min="1" value="1" />
          </div>
        </div>
        <div class="productPreviewInfo">
          <h3>Product Informatie</h3>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Afmetingen:</span>
            <span class="productPreviewInfoWaarde" id="raamAfmetingen">1000 x 1000 mm</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Oppervlakte:</span>
            <span class="productPreviewInfoWaarde" id="raamOppervlakte">1,00 m¬≤</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Raam Type:</span>
            <span class="productPreviewInfoWaarde" id="raamTypeDisplay">Draairaam naar buiten</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Draairichting:</span>
            <span class="productPreviewInfoWaarde" id="raamDraairichtingDisplay">Links draaiend</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Glas Type:</span>
            <span class="productPreviewInfoWaarde" id="raamGlasTypeDisplay">Enkel glas</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Aantal:</span>
            <span class="productPreviewInfoWaarde" id="raamAantalDisplay">1</span>
          </div>
          <div class="productPreviewPrijs" id="raamPrijs">‚Ç¨0,00</div>
        </div>
        <div class="productPreviewActions">
          <button class="btn primary" id="btnVoegRaamToe">üõí Toevoegen aan winkelwagen</button>
        </div>
      </div>

      <!-- Deur Preview -->
      <div class="productPreviewContent" id="previewDeur" style="display:none">
        <div class="productPreviewHeader">
          <h2>üö™ Losse Deur Configureren</h2>
          <p>Configureer uw deur met afmetingen, type en opties</p>
        </div>
        <div class="productConfigForm">
          <div class="productConfigItem">
            <label>Breedte (mm)</label>
            <input type="number" id="deurBreedte" min="600" max="5000" step="10" value="900" />
          </div>
          <div class="productConfigItem">
            <label>Hoogte (mm)</label>
            <input type="number" id="deurHoogte" min="1800" max="5000" step="10" value="2100" />
          </div>
          <div class="productConfigItem">
            <label>Deur Type</label>
            <select id="deurTypeLos">
              <option value="dichte_deur">Dichte deur</option>
              <option value="deur_met_raam">Deur met raam</option>
              <option value="stolpdeur_buitendraaiend">Stolpdeur buitendraaiend</option>
              <option value="stolpdeur_binnendraaiend">Stolpdeur binnendraaiend</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Draairichting</label>
            <select id="deurDraairichting">
              <option value="links">Links draaiend</option>
              <option value="rechts">Rechts draaiend</option>
              <option value="actief">Actief</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Glas Type</label>
            <select id="deurGlasType">
              <option value="enkel">Enkel glas</option>
              <option value="hr+">HR+</option>
              <option value="hr++">HR++</option>
              <option value="hr+++">HR+++</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Aantal</label>
            <input type="number" id="deurAantal" min="1" value="1" />
          </div>
        </div>
        <div class="productPreviewInfo">
          <h3>Product Informatie</h3>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Afmetingen:</span>
            <span class="productPreviewInfoWaarde" id="deurAfmetingen">900 x 2100 mm</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Oppervlakte:</span>
            <span class="productPreviewInfoWaarde" id="deurOppervlakte">1,89 m¬≤</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Deur Type:</span>
            <span class="productPreviewInfoWaarde" id="deurTypeDisplay">Dichte deur</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Draairichting:</span>
            <span class="productPreviewInfoWaarde" id="deurDraairichtingDisplay">Links draaiend</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Glas Type:</span>
            <span class="productPreviewInfoWaarde" id="deurGlasTypeDisplay">Enkel glas</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Aantal:</span>
            <span class="productPreviewInfoWaarde" id="deurAantalDisplay">1</span>
          </div>
          <div class="productPreviewPrijs" id="deurPrijs">‚Ç¨0,00</div>
        </div>
        <div class="productPreviewActions">
          <button class="btn primary" id="btnVoegDeurToe">üõí Toevoegen aan winkelwagen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Winkelwagen pagina -->
  <div class="winkelwagenPagina" id="winkelwagenPagina">
    <div class="winkelwagenHeader">
      <h1>üõí Winkelwagen</h1>
      <button class="btn" id="btnLeegWinkelwagen">üóëÔ∏è Winkelwagen legen</button>
    </div>
    <div id="winkelwagenContent">
      <div class="winkelwagenLeeg" id="winkelwagenLeeg">
        <h2>Je winkelwagen is leeg</h2>
        <p>Voeg kozijnen, ramen, deuren of glas toe om te beginnen.</p>
      </div>
      <div id="winkelwagenItems"></div>
    </div>
    <div class="winkelwagenTotaal" id="winkelwagenTotaal" style="display:none">
      <span class="winkelwagenTotaalLabel">Totaal:</span>
      <span class="winkelwagenTotaalWaarde" id="winkelwagenTotaalWaarde">‚Ç¨0,00</span>
    </div>
  </div>

  <!-- Glas Product Pagina -->
  <div class="productPagina" id="productPaginaGlas">
    <div class="productPaginaHeader">
      <button class="btn" id="btnTerugNaarOverzicht" style="margin-bottom:16px">‚Üê Terug naar overzicht</button>
      <h1>ü™ü Los Glas Configureren</h1>
      <p>Configureer uw glas met afmetingen, type en rooster</p>
    </div>
    <div class="productPaginaContent">
      <div class="productConfigSectie">
        <h2 style="margin:0 0 20px;color:var(--fg);font-size:20px;font-weight:600">Configuratie</h2>
        <div class="productConfigForm">
          <div class="productConfigItem full-width">
            <label>Aantal</label>
            <input type="number" id="glasAantal" min="1" value="1" />
          </div>
          <div class="productConfigRow">
            <div class="productConfigItem small">
              <label>Breedte (mm)</label>
              <input type="number" id="glasBreedte" min="100" max="5000" step="10" value="1000" />
            </div>
            <div class="productConfigItem small">
              <label>Hoogte (mm)</label>
              <input type="number" id="glasHoogte" min="100" max="5000" step="10" value="1000" />
            </div>
          </div>
          <div class="productConfigItem">
            <label>Glas Type</label>
            <select id="glasTypeLos">
              <option value="enkel">Enkel glas</option>
              <option value="dubbel">Dubbel glas</option>
              <option value="trippel">Trippel glas</option>
            </select>
          </div>
          <div class="productConfigRow">
            <div class="productConfigItem small" id="glasOpbouwItem" style="display:none">
              <label>Glasopbouw</label>
              <select id="glasOpbouw">
                <option value="4mm">4mm</option>
                <option value="5mm">5mm</option>
                <option value="33.1_gelaagd">33.1 gelaagd</option>
                <option value="44.2_gelaagd">44.2 gelaagd</option>
                <option value="33.1_matte_witte_folie">33.1 matte witte folie</option>
              </select>
            </div>
            <div class="productConfigItem small" id="glasSpouwItem">
              <label>Spouw</label>
              <select id="glasSpouw">
                <option value="6mm">6mm (HR+)</option>
                <option value="8mm">8mm (HR+)</option>
                <option value="10mm">10mm (HR+)</option>
                <option value="12mm">12mm (HR+)</option>
                <option value="13mm">13mm (HR++)</option>
                <option value="14mm">14mm (HR++)</option>
                <option value="15mm">15mm (HR++)</option>
                <option value="16mm">16mm (HR++)</option>
              </select>
            </div>
          </div>
          <div class="productConfigItem">
            <label>Rooster</label>
            <select id="glasRooster">
              <!-- Opties worden geladen vanuit glas-en-rooster-data.json -->
            </select>
          </div>
          <div class="productConfigItem" id="glasSpacerItem" style="display:flex">
            <label>Spacer</label>
            <div style="display:flex;gap:24px;align-items:center;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:normal">
                <input type="radio" name="glasSpacer" id="glasSpacerAlu" value="aluspacer" checked style="width:18px;height:18px;cursor:pointer" />
                <span>Aluspacer</span>
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:normal">
                <input type="radio" name="glasSpacer" id="glasSpacerTGI" value="tgi_zwart" style="width:18px;height:18px;cursor:pointer" />
                <span>TGI zwart spacer</span>
              </label>
            </div>
          </div>
        </div>
        <div class="productPreviewInfo" style="margin-top:24px">
          <h3>Product Informatie</h3>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Afmetingen:</span>
            <span class="productPreviewInfoWaarde" id="glasAfmetingen">1000 x 1000 mm</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Oppervlakte:</span>
            <span class="productPreviewInfoWaarde" id="glasOppervlakte">1,00 m¬≤</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Glas Type:</span>
            <span class="productPreviewInfoWaarde" id="glasTypeDisplay">Enkel glas</span>
          </div>
          <div class="productPreviewInfoItem" id="glasUWaardeDisplayItem" style="display:none">
            <span class="productPreviewInfoLabel">U-waarde:</span>
            <span class="productPreviewInfoWaarde" id="glasUWaardeDisplay">-</span>
          </div>
          <div class="productPreviewInfoItem" id="glasOpbouwDisplayItem" style="display:none">
            <span class="productPreviewInfoLabel">Glasopbouw:</span>
            <span class="productPreviewInfoWaarde" id="glasOpbouwDisplay">-</span>
          </div>
          <div class="productPreviewInfoItem" id="glasSpouwDisplayItem" style="display:none">
            <span class="productPreviewInfoLabel">Spouw:</span>
            <span class="productPreviewInfoWaarde" id="glasSpouwDisplay">-</span>
          </div>
          <div class="productPreviewInfoItem" id="glasDikteDisplayItem" style="display:none">
            <span class="productPreviewInfoLabel">Totale dikte:</span>
            <span class="productPreviewInfoWaarde" id="glasDikteDisplay">-</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Aantal:</span>
            <span class="productPreviewInfoWaarde" id="glasAantalDisplay">1</span>
          </div>
          <div class="productPreviewPrijs" id="glasPrijs">‚Ç¨0,00</div>
        </div>
        <div class="productPreviewActions" style="margin-top:24px;border-top:none;padding-top:0">
          <button class="btn primary" id="btnVoegGlasToe" style="width:100%">üõí Toevoegen aan winkelwagen</button>
        </div>
      </div>
      <div class="productTekeningSectie">
        <h2 style="margin:0 0 20px;color:var(--fg);font-size:20px;font-weight:600">üìê Overzicht Tekening</h2>
        <div class="productPreviewTekening" style="margin-top:0">
          <svg id="glasTekeningSVG" viewBox="0 0 500 400" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Raam Product Pagina -->
  <div class="productPagina" id="productPaginaRaam">
    <div class="productPaginaHeader">
      <button class="btn" id="btnTerugNaarOverzichtRaam" style="margin-bottom:16px">‚Üê Terug naar overzicht</button>
      <h1>ü™ü Los Raam Configureren</h1>
      <p>Configureer uw raam met afmetingen, type en opties</p>
    </div>
    <div class="productPaginaContent">
      <div class="productConfigSectie">
        <h2 style="margin:0 0 20px;color:var(--fg);font-size:20px;font-weight:600">Configuratie</h2>
        <div class="productConfigForm">
          <div class="productConfigItem">
            <label>Breedte (mm)</label>
            <input type="number" id="raamBreedte" min="300" max="5000" step="10" value="1000" />
          </div>
          <div class="productConfigItem">
            <label>Hoogte (mm)</label>
            <input type="number" id="raamHoogte" min="300" max="5000" step="10" value="1000" />
          </div>
          <div class="productConfigItem">
            <label>Raam Type</label>
            <select id="raamTypeLos">
              <option value="draairaam_buiten">Draairaam naar buiten</option>
              <option value="draairaam_binnen">Draairaam naar binnen</option>
              <option value="stolpraam_buiten">Stolpraam buitendraaiend</option>
              <option value="stolpraam_binnen">Stolpraam binnendraaiend</option>
              <option value="draaikiep">Draaikiep raam</option>
              <option value="kiep">Kiep raam</option>
              <option value="vast">Vast raam</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Draairichting</label>
            <select id="raamDraairichting">
              <option value="links">Links draaiend</option>
              <option value="rechts">Rechts draaiend</option>
              <option value="actief">Actief</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Glas Type</label>
            <select id="raamGlasType">
              <option value="enkel">Enkel glas</option>
              <option value="hr+">HR+</option>
              <option value="hr++">HR++</option>
              <option value="hr+++">HR+++</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Aantal</label>
            <input type="number" id="raamAantal" min="1" value="1" />
          </div>
        </div>
        <div class="productPreviewInfo" style="margin-top:24px">
          <h3>Product Informatie</h3>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Afmetingen:</span>
            <span class="productPreviewInfoWaarde" id="raamAfmetingen">1000 x 1000 mm</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Oppervlakte:</span>
            <span class="productPreviewInfoWaarde" id="raamOppervlakte">1,00 m¬≤</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Raam Type:</span>
            <span class="productPreviewInfoWaarde" id="raamTypeDisplay">Draairaam naar buiten</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Draairichting:</span>
            <span class="productPreviewInfoWaarde" id="raamDraairichtingDisplay">Links draaiend</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Glas Type:</span>
            <span class="productPreviewInfoWaarde" id="raamGlasTypeDisplay">Enkel glas</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Aantal:</span>
            <span class="productPreviewInfoWaarde" id="raamAantalDisplay">1</span>
          </div>
          <div class="productPreviewPrijs" id="raamPrijs">‚Ç¨0,00</div>
        </div>
        <div class="productPreviewActions" style="margin-top:24px;border-top:none;padding-top:0">
          <button class="btn primary" id="btnVoegRaamToe" style="width:100%">üõí Toevoegen aan winkelwagen</button>
        </div>
      </div>
      <div class="productTekeningSectie">
        <h2 style="margin:0 0 20px;color:var(--fg);font-size:20px;font-weight:600">üìê Overzicht Tekening</h2>
        <div class="productPreviewTekening" style="margin-top:0">
          <svg id="raamTekeningSVG" viewBox="0 0 500 400" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Deur Product Pagina -->
  <div class="productPagina" id="productPaginaDeur">
    <div class="productPaginaHeader">
      <button class="btn" id="btnTerugNaarOverzichtDeur" style="margin-bottom:16px">‚Üê Terug naar overzicht</button>
      <h1>üö™ Losse Deur Configureren</h1>
      <p>Configureer uw deur met afmetingen, type en opties</p>
    </div>
    <div class="productPaginaContent">
      <div class="productConfigSectie">
        <h2 style="margin:0 0 20px;color:var(--fg);font-size:20px;font-weight:600">Configuratie</h2>
        <div class="productConfigForm">
          <div class="productConfigItem">
            <label>Breedte (mm)</label>
            <input type="number" id="deurBreedte" min="600" max="5000" step="10" value="900" />
          </div>
          <div class="productConfigItem">
            <label>Hoogte (mm)</label>
            <input type="number" id="deurHoogte" min="1800" max="5000" step="10" value="2100" />
          </div>
          <div class="productConfigItem">
            <label>Deur Type</label>
            <select id="deurTypeLos">
              <option value="dichte_deur">Dichte deur</option>
              <option value="deur_met_raam">Deur met raam</option>
              <option value="stolpdeur_buitendraaiend">Stolpdeur buitendraaiend</option>
              <option value="stolpdeur_binnendraaiend">Stolpdeur binnendraaiend</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Draairichting</label>
            <select id="deurDraairichting">
              <option value="links">Links draaiend</option>
              <option value="rechts">Rechts draaiend</option>
              <option value="actief">Actief</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Glas Type</label>
            <select id="deurGlasType">
              <option value="enkel">Enkel glas</option>
              <option value="hr+">HR+</option>
              <option value="hr++">HR++</option>
              <option value="hr+++">HR+++</option>
            </select>
          </div>
          <div class="productConfigItem">
            <label>Aantal</label>
            <input type="number" id="deurAantal" min="1" value="1" />
          </div>
        </div>
        <div class="productPreviewInfo" style="margin-top:24px">
          <h3>Product Informatie</h3>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Afmetingen:</span>
            <span class="productPreviewInfoWaarde" id="deurAfmetingen">900 x 2100 mm</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Oppervlakte:</span>
            <span class="productPreviewInfoWaarde" id="deurOppervlakte">1,89 m¬≤</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Deur Type:</span>
            <span class="productPreviewInfoWaarde" id="deurTypeDisplay">Dichte deur</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Draairichting:</span>
            <span class="productPreviewInfoWaarde" id="deurDraairichtingDisplay">Links draaiend</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Glas Type:</span>
            <span class="productPreviewInfoWaarde" id="deurGlasTypeDisplay">Enkel glas</span>
          </div>
          <div class="productPreviewInfoItem">
            <span class="productPreviewInfoLabel">Aantal:</span>
            <span class="productPreviewInfoWaarde" id="deurAantalDisplay">1</span>
          </div>
          <div class="productPreviewPrijs" id="deurPrijs">‚Ç¨0,00</div>
        </div>
        <div class="productPreviewActions" style="margin-top:24px;border-top:none;padding-top:0">
          <button class="btn primary" id="btnVoegDeurToe" style="width:100%">üõí Toevoegen aan winkelwagen</button>
        </div>
      </div>
      <div class="productTekeningSectie">
        <h2 style="margin:0 0 20px;color:var(--fg);font-size:20px;font-weight:600">üìê Overzicht Tekening</h2>
        <div class="productPreviewTekening" style="margin-top:0">
          <svg id="deurTekeningSVG" viewBox="0 0 500 400" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal voor vak selectie -->
  <div id="vakSelectModal" class="vakSelectModal">
    <button class="modalClose" id="modalClose">&times;</button>
    <h3 id="modalTitle">Selecteer type voor Vak <span id="modalVakId"></span></h3>
    <div class="vakSelectGrid" id="vakSelectGrid"></div>
  </div>
  <!-- Modal voor technische tekening -->
  <!-- Foto Modal -->
  <div id="fotoModal" class="fotoModal">
    <div class="fotoModalContent">
      <button class="fotoModalClose" id="fotoModalClose">&times;</button>
      <img id="fotoModalImg" src="" alt="Foto" />
    </div>
  </div>

  <div id="technischeTekeningModal" class="technischeTekeningModal">
    <button class="modalClose" id="technischeTekeningModalClose">&times;</button>
    <h3>üìÑ Technische Tekening</h3>
    <div class="technischeTekeningModalContent">
      <iframe id="technischeTekeningIframe" src=""></iframe>
    </div>
    <div class="technischeTekeningModalActions">
      <button class="btn" id="technischeTekeningSluiten">Sluiten</button>
      <button class="btn primary" id="technischeTekeningDownload">üíæ Download PDF</button>
    </div>
  </div>
  <div id="vakQuickMenu" class="vakQuickMenu">
    <button type="button" data-type="raam">
      <img alt="Raam" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM0YWEzZmYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8bGluZSB4MT0iNDAiIHkxPSIxMCIgeDI9IjQwIiB5Mj0iNzAiIHN0cm9rZT0iIzRhYTNmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPg==" />
      <span>Raam</span>
    </button>
    <button type="button" data-type="deur">
      <img alt="Deur" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM0YWEzZmYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8Y2lyY2xlIGN4PSI1NSIgY3k9IjQwIiByPSI0IiBmaWxsPSIjNGFlM2ZmIi8+Cjwvc3ZnPg==" />
      <span>Deur</span>
    </button>
    <button type="button" data-type="glas">
      <img alt="Glas" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM0YWEzZmYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8cmVjdCB4PSIxNSIgeT0iMTUiIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0iIzRhYTNmZiIgZmlsbC1vcGFjaXR5PSIwLjIiLz4KPC9zdmc+" />
      <span>Glas</span>
    </button>
  </div>
  <div id="vakRaamMenu" class="vakRaamMenu">
    <h4 id="vakRaamVariantTitle">Kies raamtype</h4>
    <div id="vakRaamStatus" class="vakRaamStatus">Selecteer een raamtype voor dit vak</div>
    <div class="vakRaamMenuSection" id="vakRaamMenuSection">
      <button type="button" data-variant="draairaam_buiten">
        <img src="" alt="Draairaam naar buiten" data-svg-type="variant" data-variant="draairaam_buiten" />
        <span>Draairaam naar buiten</span>
      </button>
      <button type="button" data-variant="stolpraam_buiten">
        <img src="" alt="Stolpraam buitendraaiend" data-svg-type="variant" data-variant="stolpraam_buiten" />
        <span>Stolpraam buitendraaiend</span>
      </button>
      <button type="button" data-variant="draaikiep">
        <img src="" alt="Draaikiep raam" data-svg-type="variant" data-variant="draaikiep" />
        <span>Draaikiep raam</span>
      </button>
      <button type="button" data-variant="stolpraam_draaikiep">
        <img src="" alt="Stolpraam draaikiep" data-svg-type="variant" data-variant="stolpraam_draaikiep" />
        <span>Stolpraam draaikiep</span>
      </button>
      <button type="button" data-variant="klepraam">
        <img src="" alt="Klepraam" data-svg-type="variant" data-variant="klepraam" />
        <span>Klepraam</span>
      </button>
    </div>
    <div class="vakRaamMenuActions">
      <button type="button" id="vakRaamWis">Verwijder toewijzing</button>
    </div>
  </div>
  <div id="vakDeurMenu" class="vakRaamMenu">
    <h4 id="vakDeurVariantTitle">Kies deurtype</h4>
    <div id="vakDeurStatus" class="vakRaamStatus">Selecteer een deurtype voor dit vak</div>
    <div class="vakRaamMenuSection" id="vakDeurMenuSection">
      <button type="button" data-variant="deur_buiten">
        <img src="" alt="Buitendraaiende deur" data-svg-type="variant" data-variant="deur_buiten" />
        <span>Buitendraaiende deur</span>
      </button>
      <button type="button" data-variant="stolpdeuren_buiten">
        <img src="" alt="Stolpdeuren buitendraaiend" data-svg-type="variant" data-variant="stolpdeuren_buiten" />
        <span>Stolpdeuren buitendraaiend</span>
      </button>
      <button type="button" data-variant="deur_draaikiep">
        <img src="" alt="Draaikiep deur" data-svg-type="variant" data-variant="deur_draaikiep" />
        <span>Draaikiep deur</span>
      </button>
      <button type="button" data-variant="stolpdeuren_draaikiep">
        <img src="" alt="Stolpdraaikiep deuren" data-svg-type="variant" data-variant="stolpdeuren_draaikiep" />
        <span>Stolpdraaikiep deuren</span>
      </button>
      <button type="button" data-variant="voordeur">
        <img src="" alt="Voordeur" data-svg-type="variant" data-variant="voordeur" />
        <span>Voordeur</span>
      </button>
    </div>
    <div class="vakRaamMenuActions">
      <button type="button" id="vakDeurWis">Verwijder toewijzing</button>
    </div>
  </div>
  <div id="vakGlasMenu" class="vakRaamMenu">
    <h4 id="vakGlasVariantTitle">Kies glasvariant</h4>
    <div id="vakGlasStatus" class="vakRaamStatus">Selecteer een glasvariant voor dit vak</div>
    <div class="vakRaamMenuSection" id="vakGlasMenuSection">
      <button type="button" data-variant="glas_vast">
        <img src="" alt="Vast glas" data-svg-type="variant" data-variant="glas_vast" />
        <span>Vast glas</span>
      </button>
      <button type="button" data-variant="glas_vast_stapel">
        <img src="" alt="Vast glas met stapeldorpels" data-svg-type="variant" data-variant="glas_vast_stapel" />
        <span>Vast glas met stapeldorpels</span>
      </button>
    </div>
    <div class="vakRaamMenuActions">
      <button type="button" id="vakGlasWis">Verwijder toewijzing</button>
    </div>
  </div>
  <div id="vakOrientationMenu" class="vakOrientationMenu">
    <h4>Kies draairichting</h4>
    <div id="vakOrientationStatus" class="vakOrientationStatus">Selecteer eerst een raamtype</div>
    <div class="vakOrientationButtons" id="vakOrientationButtons">
      <button type="button" data-orientation="links">
        <img src="" alt="Links draaiend raam" data-svg-type="orientation" data-variant="" />
        <span>Links</span>
      </button>
      <button type="button" data-orientation="rechts">
        <img src="" alt="Rechts draaiend raam" data-svg-type="orientation" data-variant="" />
        <span>Rechts</span>
      </button>
      <button type="button" data-orientation="vast">
        <img src="" alt="Vast raam" data-svg-type="orientation" data-orientation="vast" />
        <span>Vast raam</span>
      </button>
    </div>
    <div class="vakOrientationActions">
      <button type="button" id="vakOrientationBack">‚Üê Terug</button>
      <button type="button" id="vakOrientationCancel">Annuleren</button>
    </div>
  </div>

  <div id="vakKlepraamMenu" class="vakOrientationMenu">
    <h4>Kies klepraam type</h4>
    <div id="vakKlepraamStatus" class="vakOrientationStatus">Selecteer of het klepraam open of vast is</div>
    <div class="vakOrientationButtons" id="vakKlepraamButtons">
      <button type="button" data-klepraam-type="open">
        <span>Open</span>
      </button>
      <button type="button" data-klepraam-type="vast">
        <span>Vast</span>
      </button>
    </div>
    <div class="vakOrientationActions">
      <button type="button" id="vakKlepraamBack">‚Üê Terug</button>
      <button type="button" id="vakKlepraamCancel">Annuleren</button>
    </div>
  </div>

  <div id="vakDeurBuitenMenu" class="vakOrientationMenu">
    <h4>Kies buitendraaiende deur type</h4>
    <div id="vakDeurBuitenStatus" class="vakOrientationStatus">Selecteer het type buitendraaiende deur</div>
    <div class="vakOrientationButtons" id="vakDeurBuitenButtons">
      <button type="button" data-deur-buiten-type="stapeldorpel">
        <img src="" alt="Stapeldorpel deur" data-svg-type="deur-buiten" data-deur-buiten-type="stapeldorpel" />
        <span>Stapeldorpel deur</span>
      </button>
      <button type="button" data-deur-buiten-type="2vaks">
        <img src="" alt="2 vaks deur" data-svg-type="deur-buiten" data-deur-buiten-type="2vaks" />
        <span>2 vaks deur</span>
      </button>
      <button type="button" data-deur-buiten-type="dicht">
        <img src="" alt="Dichte deur" data-svg-type="deur-buiten" data-deur-buiten-type="dicht" />
        <span>Dichte deur</span>
      </button>
    </div>
    <div class="vakOrientationActions">
      <button type="button" id="vakDeurBuitenBack">‚Üê Terug</button>
      <button type="button" id="vakDeurBuitenCancel">Annuleren</button>
    </div>
  </div>

  <div id="vakStolpdeurenBuitenMenu" class="vakOrientationMenu">
    <h4>Kies stolpdeuren buitendraaiend type</h4>
    <div id="vakStolpdeurenBuitenStatus" class="vakOrientationStatus">Selecteer het type stolpdeuren buitendraaiend</div>
    <div class="vakOrientationButtons" id="vakStolpdeurenBuitenButtons">
      <button type="button" data-stolpdeuren-buiten-type="stapeldorpel">
        <img src="" alt="Stapeldorpel deur" data-svg-type="stolpdeuren-buiten" data-stolpdeuren-buiten-type="stapeldorpel" />
        <span>Stapeldorpel deur</span>
      </button>
      <button type="button" data-stolpdeuren-buiten-type="2vaks">
        <img src="" alt="2 vaks deur" data-svg-type="stolpdeuren-buiten" data-stolpdeuren-buiten-type="2vaks" />
        <span>2 vaks deur</span>
      </button>
      <button type="button" data-stolpdeuren-buiten-type="dicht">
        <img src="" alt="Dichte deur" data-svg-type="stolpdeuren-buiten" data-stolpdeuren-buiten-type="dicht" />
        <span>Dichte deur</span>
      </button>
    </div>
    <div class="vakOrientationActions">
      <button type="button" id="vakStolpdeurenBuitenBack">‚Üê Terug</button>
      <button type="button" id="vakStolpdeurenBuitenCancel">Annuleren</button>
    </div>
  </div>

  <div id="vakDeurDraaikiepMenu" class="vakOrientationMenu">
    <h4>Kies draaikiep deur type</h4>
    <div id="vakDeurDraaikiepStatus" class="vakOrientationStatus">Selecteer het type draaikiep deur</div>
    <div class="vakOrientationButtons" id="vakDeurDraaikiepButtons">
      <button type="button" data-deur-draaikiep-type="stapeldorpel">
        <img src="" alt="Stapeldorpel deur" data-svg-type="deur-draaikiep" data-deur-draaikiep-type="stapeldorpel" />
        <span>Stapeldorpel deur</span>
      </button>
      <button type="button" data-deur-draaikiep-type="2vaks">
        <img src="" alt="2 vaks deur" data-svg-type="deur-draaikiep" data-deur-draaikiep-type="2vaks" />
        <span>2 vaks deur</span>
      </button>
      <button type="button" data-deur-draaikiep-type="dicht">
        <img src="" alt="Dichte deur" data-svg-type="deur-draaikiep" data-deur-draaikiep-type="dicht" />
        <span>Dichte deur</span>
      </button>
    </div>
    <div class="vakOrientationActions">
      <button type="button" id="vakDeurDraaikiepBack">‚Üê Terug</button>
      <button type="button" id="vakDeurDraaikiepCancel">Annuleren</button>
    </div>
  </div>

  <div id="vakStolpdeurenDraaikiepMenu" class="vakOrientationMenu">
    <h4>Kies stolpdraaikiep deuren type</h4>
    <div id="vakStolpdeurenDraaikiepStatus" class="vakOrientationStatus">Selecteer het type stolpdraaikiep deuren</div>
    <div class="vakOrientationButtons" id="vakStolpdeurenDraaikiepButtons">
      <button type="button" data-stolpdeuren-draaikiep-type="stapeldorpel">
        <img src="" alt="Stapeldorpel deur" data-svg-type="stolpdeuren-draaikiep" data-stolpdeuren-draaikiep-type="stapeldorpel" />
        <span>Stapeldorpel deur</span>
      </button>
      <button type="button" data-stolpdeuren-draaikiep-type="2vaks">
        <img src="" alt="2 vaks deur" data-svg-type="stolpdeuren-draaikiep" data-stolpdeuren-draaikiep-type="2vaks" />
        <span>2 vaks deur</span>
      </button>
      <button type="button" data-stolpdeuren-draaikiep-type="dicht">
        <img src="" alt="Dichte deur" data-svg-type="stolpdeuren-draaikiep" data-stolpdeuren-draaikiep-type="dicht" />
        <span>Dichte deur</span>
      </button>
    </div>
    <div class="vakOrientationActions">
      <button type="button" id="vakStolpdeurenDraaikiepBack">‚Üê Terug</button>
      <button type="button" id="vakStolpdeurenDraaikiepCancel">Annuleren</button>
    </div>
  </div>

  <div id="vakRaamExtraMenu" class="vakRaamExtraMenu">
    <h4>Extra opties</h4>
    <div id="vakRaamExtraStatus" class="vakRaamExtraStatus">Configureer extra opties voor dit raam</div>
    
    <div class="vakRaamExtraOptions">
      <div class="extra-option-group">
        <label class="checkbox-label">
          <input type="checkbox" id="roosterCheckbox" />
          <span>Rooster in het glas</span>
        </label>
      </div>
      
      <div class="extra-option-group">
        <label class="checkbox-label">
          <input type="checkbox" id="horCheckbox" />
          <span>Hor</span>
        </label>
      </div>
      
      <div class="extra-option-group">
        <label>Beslagkleur</label>
        <div class="beslag-kleur-buttons">
          <button type="button" class="beslag-kleur-btn" data-beslag-kleur="f1" id="beslagF1Btn">
            <span>F1 Kleurig (standaard)</span>
          </button>
          <button type="button" class="beslag-kleur-btn" data-beslag-kleur="anders" id="beslagAndersBtn">
            <span>Andere kleur</span>
          </button>
        </div>
        <div class="beslag-kleur-picker" id="beslagKleurPicker" style="display: none;">
          <input type="color" id="beslagKleurInput" value="#8B7355" />
          <label for="beslagKleurInput">Kies kleur</label>
        </div>
      </div>
    </div>
    
    <div class="vakRaamExtraActions">
      <button type="button" id="vakRaamExtraBack">‚Üê Terug</button>
      <button type="button" id="vakRaamExtraCancel">Annuleren</button>
      <button type="button" id="vakRaamExtraConfirm" class="primary">Bevestigen</button>
    </div>
  </div>

  <div id="vakDeurStapeldorpelMenu" class="vakRaamExtraMenu">
    <h4 id="vakDeurStapeldorpelTitle">Deur opties</h4>
    <div id="vakDeurStapeldorpelStatus" class="vakRaamExtraStatus">Configureer de deur opties</div>
    
    <div class="vakRaamExtraOptions">
      <div class="extra-option-group" id="stapeldorpelAantalGroup">
        <label>Aantal stapeldorpels</label>
        <select id="stapeldorpelAantal" style="width:100%;padding:10px 12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);font-size:14px">
          <option value="2">2 dorpels (218mm)</option>
          <option value="3">3 dorpels (332mm)</option>
          <option value="4">4 dorpels (446mm)</option>
          <option value="5">5 dorpels (560mm)</option>
          <option value="6">6 dorpels (674mm)</option>
          <option value="7">7 dorpels (788mm)</option>
          <option value="8">8 dorpels (902mm)</option>
          <option value="9">9 dorpels (1016mm)</option>
        </select>
        <small style="color:var(--muted);font-size:11px;margin-top:4px">Standaard: 2 dorpels (218mm). Elke extra dorpel voegt 114mm toe.</small>
      </div>
      
      <div class="extra-option-group" id="tussendorpelHoogteGroup" style="display:none">
        <label>Hoogte tussendorpel</label>
        <input type="number" id="tussendorpelHoogte" min="250" max="1500" step="1" value="250" style="width:100%;padding:10px 12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);font-size:14px" placeholder="Hoogte in mm" />
        <small style="color:var(--muted);font-size:11px;margin-top:4px">Minimaal 250mm, maximaal 1500mm</small>
      </div>
      
      <div class="extra-option-group" id="roosterGroup">
        <label class="checkbox-label">
          <input type="checkbox" id="stapeldorpelRoosterCheckbox" />
          <span>Rooster</span>
        </label>
      </div>
      
      <div class="extra-option-group" id="vak1Group" style="display:none">
        <label>Bovenste vak</label>
        <div class="vakRaamMenuSection" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
          <button type="button" class="btn" data-vak1-type="glas" id="vak1GlasBtn" style="flex:1;min-width:100px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer">
            <img src="" alt="Glas" data-svg-type="vak1" data-vak1-type="glas" style="width:40px;height:40px;pointer-events:none" />
            <span style="pointer-events:none">Glas</span>
          </button>
          <button type="button" class="btn" data-vak1-type="bossing" id="vak1BossingBtn" style="flex:1;min-width:100px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer">
            <img src="" alt="Bossing paneel" data-svg-type="vak1" data-vak1-type="bossing" style="width:40px;height:40px;pointer-events:none" />
            <span style="pointer-events:none">Bossing paneel</span>
          </button>
          <button type="button" class="btn" data-vak1-type="vlak" id="vak1VlakBtn" style="flex:1;min-width:100px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer">
            <img src="" alt="Vlak paneel" data-svg-type="vak1" data-vak1-type="vlak" style="width:40px;height:40px;pointer-events:none" />
            <span style="pointer-events:none">Vlak paneel</span>
          </button>
        </div>
      </div>
      
      <div class="extra-option-group" id="vak2Group" style="display:none">
        <label>Onderste vak</label>
        <div class="vakRaamMenuSection" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
          <button type="button" class="btn" data-vak2-type="glas" id="vak2GlasBtn" style="flex:1;min-width:100px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer">
            <img src="" alt="Glas" data-svg-type="vak2" data-vak2-type="glas" style="width:40px;height:40px;pointer-events:none" />
            <span style="pointer-events:none">Glas</span>
          </button>
          <button type="button" class="btn" data-vak2-type="bossing" id="vak2BossingBtn" style="flex:1;min-width:100px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer">
            <img src="" alt="Bossing paneel" data-svg-type="vak2" data-vak2-type="bossing" style="width:40px;height:40px;pointer-events:none" />
            <span style="pointer-events:none">Bossing paneel</span>
          </button>
          <button type="button" class="btn" data-vak2-type="vlak" id="vak2VlakBtn" style="flex:1;min-width:100px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer">
            <img src="" alt="Vlak paneel" data-svg-type="vak2" data-vak2-type="vlak" style="width:40px;height:40px;pointer-events:none" />
            <span style="pointer-events:none">Vlak paneel</span>
          </button>
        </div>
      </div>
      
      <div class="extra-option-group">
        <label>Deurbeslag</label>
        <button type="button" id="btnKiesDeurbeslag" class="btn" style="width:100%;margin-top:8px">Kies deurbeslag</button>
        <div id="stapeldorpelDeurbeslagStatus" style="padding:8px 10px;background:#141a22;border-radius:8px;color:var(--muted);font-size:12px;margin-top:8px">Geen deurbeslag gekozen</div>
      </div>
      
    </div>
    
    <div class="vakRaamExtraActions">
      <button type="button" id="vakDeurStapeldorpelBack">‚Üê Terug</button>
      <button type="button" id="vakDeurStapeldorpelCancel">Annuleren</button>
      <button type="button" id="vakDeurStapeldorpelConfirm" class="primary">Bevestigen</button>
    </div>
  </div>

  <div id="vak2vaksVak1Menu" class="vakRaamMenu">
    <h4>Kies optie voor bovenste vak</h4>
    <div id="vak2vaksVak1Status" class="vakRaamStatus">Selecteer een optie voor bovenste vak</div>
    <div class="vakRaamMenuSection" id="vak2vaksVak1MenuSection">
      <button type="button" data-vak1-type="glas">
        <img src="" alt="Glas" data-svg-type="vak1" data-vak1-type="glas" />
        <span>Glas</span>
      </button>
      <button type="button" data-vak1-type="bossing">
        <img src="" alt="Bossing paneel" data-svg-type="vak1" data-vak1-type="bossing" />
        <span>Bossing paneel</span>
      </button>
      <button type="button" data-vak1-type="vlak">
        <img src="" alt="Vlak paneel" data-svg-type="vak1" data-vak1-type="vlak" />
        <span>Vlak paneel</span>
      </button>
    </div>
    <div class="vakRaamMenuActions">
      <button type="button" id="vak2vaksVak1Back">‚Üê Terug</button>
      <button type="button" id="vak2vaksVak1Cancel">Annuleren</button>
    </div>
  </div>

  <div id="vak2vaksVak2Menu" class="vakRaamMenu">
    <h4>Kies optie voor onderste vak</h4>
    <div id="vak2vaksVak2Status" class="vakRaamStatus">Selecteer een optie voor onderste vak</div>
    <div class="vakRaamMenuSection" id="vak2vaksVak2MenuSection">
      <button type="button" data-vak2-type="glas">
        <img src="" alt="Glas" data-svg-type="vak2" data-vak2-type="glas" />
        <span>Glas</span>
      </button>
      <button type="button" data-vak2-type="bossing">
        <img src="" alt="Bossing paneel" data-svg-type="vak2" data-vak2-type="bossing" />
        <span>Bossing paneel</span>
      </button>
      <button type="button" data-vak2-type="vlak">
        <img src="" alt="Vlak paneel" data-svg-type="vak2" data-vak2-type="vlak" />
        <span>Vlak paneel</span>
      </button>
    </div>
    <div class="vakRaamMenuActions">
      <button type="button" id="vak2vaksVak2Back">‚Üê Terug</button>
      <button type="button" id="vak2vaksVak2Cancel">Annuleren</button>
    </div>
  </div>

  <div id="vakStapeldorpelOrientationMenu" class="vakOrientationMenu">
    <h4 id="vakStapeldorpelOrientationTitle">Kies draairichting deur</h4>
    <div id="vakStapeldorpelOrientationStatus" class="vakOrientationStatus">Selecteer de draairichting voor de deur</div>
    <div class="vakOrientationButtons" id="vakStapeldorpelOrientationButtons">
      <button type="button" data-stapeldorpel-orientation="links">
        <img src="" alt="Links draaiend" data-svg-type="stapeldorpel-orientation" data-orientation="links" />
        <span>Links</span>
      </button>
      <button type="button" data-stapeldorpel-orientation="rechts">
        <img src="" alt="Rechts draaiend" data-svg-type="stapeldorpel-orientation" data-orientation="rechts" />
        <span>Rechts</span>
      </button>
    </div>
    <div class="vakOrientationActions">
      <button type="button" id="vakStapeldorpelOrientationBack">‚Üê Terug</button>
      <button type="button" id="vakStapeldorpelOrientationCancel">Annuleren</button>
    </div>
  </div>

  <!-- Menu 1: Draairichting Links/Rechts draaiend (voor normale deuren) -->
  <div id="vakDeurOrientationMenu" class="vakOrientationMenu">
    <h4 id="vakDeurOrientationTitle">Kies draairichting deur</h4>
    <div id="vakDeurOrientationStatus" class="vakOrientationStatus">Selecteer de draairichting voor de deur</div>
    <div class="vakOrientationButtons" id="vakDeurOrientationButtons">
      <button type="button" data-deur-orientation="links">
        <img src="" alt="Links draaiend" data-svg-type="deur-orientation" data-orientation="links" />
        <span>Links</span>
      </button>
      <button type="button" data-deur-orientation="rechts">
        <img src="" alt="Rechts draaiend" data-svg-type="deur-orientation" data-orientation="rechts" />
        <span>Rechts</span>
      </button>
    </div>
    <div class="vakOrientationActions">
      <button type="button" id="vakDeurOrientationBack">‚Üê Terug</button>
      <button type="button" id="vakDeurOrientationCancel">Annuleren</button>
    </div>
  </div>

  <!-- Menu 2: Draairichting Links actief/Rechts actief (voor stolpdeuren) -->
  <div id="vakStolpdeurenOrientationMenu" class="vakOrientationMenu">
    <h4 id="vakStolpdeurenOrientationTitle">Kies draairichting deur</h4>
    <div id="vakStolpdeurenOrientationStatus" class="vakOrientationStatus">Selecteer de draairichting voor de deur</div>
    <div class="vakOrientationButtons" id="vakStolpdeurenOrientationButtons">
      <button type="button" data-stolpdeuren-orientation="links">
        <img src="" alt="Links actief" data-svg-type="stolpdeuren-orientation" data-orientation="links" />
        <span>Links actief</span>
      </button>
      <button type="button" data-stolpdeuren-orientation="rechts">
        <img src="" alt="Rechts actief" data-svg-type="stolpdeuren-orientation" data-orientation="rechts" />
        <span>Rechts actief</span>
      </button>
    </div>
    <div class="vakOrientationActions">
      <button type="button" id="vakStolpdeurenOrientationBack">‚Üê Terug</button>
      <button type="button" id="vakStolpdeurenOrientationCancel">Annuleren</button>
    </div>
  </div>

  <!-- Afwerkingsopties menu -->
  <div id="vakAfwerkingsOptiesMenu" class="vakRaamExtraMenu">
    <h4 id="vakAfwerkingsOptiesTitle">Afwerkingsopties</h4>
    <div id="vakAfwerkingsOptiesStatus" class="vakRaamExtraStatus">Configureer de afwerkingsopties voor het kozijn</div>
    
    <div class="vakRaamExtraOptions">
      <div class="extra-option-group">
        <label>Glas type</label>
        <div class="vakRaamMenuSection" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
          <button type="button" class="btn" data-glas-type="enkelglas" id="glasEnkelglasBtn" style="flex:1;min-width:100px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);cursor:pointer">
            <span>Enkelglas</span>
          </button>
          <button type="button" class="btn" data-glas-type="hr++" id="glasHrPlusPlusBtn" style="flex:1;min-width:100px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);cursor:pointer">
            <span>HR++</span>
          </button>
          <button type="button" class="btn" data-glas-type="hr+++" id="glasHrPlusPlusPlusBtn" style="flex:1;min-width:100px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);cursor:pointer">
            <span>HR+++</span>
          </button>
        </div>
      </div>
      
      <div class="extra-option-group">
        <label>Kleur deuren/ramen binnen</label>
        <div class="ral-kleuren-selectie" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button type="button" class="ral-kleur-btn selected" data-ral="9010" data-kleur="#F7F9EF" data-target="binnen" style="padding:8px 12px;border:2px solid var(--accent);border-radius:6px;background:#F7F9EF;color:#0b0d10;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 9010</button>
          <button type="button" class="ral-kleur-btn" data-ral="9001" data-kleur="#F7F9EF" data-target="binnen" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#F7F9EF;color:#0b0d10;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 9001</button>
          <button type="button" class="ral-kleur-btn" data-ral="9005" data-kleur="#0E0E10" data-target="binnen" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#0E0E10;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 9005</button>
          <button type="button" class="ral-kleur-btn" data-ral="7040" data-kleur="#9D9D9D" data-target="binnen" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#9D9D9D;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 7040</button>
          <button type="button" class="ral-kleur-btn" data-ral="7016" data-kleur="#383E42" data-target="binnen" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#383E42;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 7016</button>
          <button type="button" class="ral-kleur-btn" data-ral="6005" data-kleur="#0F5132" data-target="binnen" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#0F5132;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 6005</button>
        </div>
      </div>
      
      <div class="extra-option-group">
        <label>Kleur deuren/ramen buiten</label>
        <div class="ral-kleuren-selectie" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button type="button" class="ral-kleur-btn selected" data-ral="9010" data-kleur="#F7F9EF" data-target="buiten" style="padding:8px 12px;border:2px solid var(--accent);border-radius:6px;background:#F7F9EF;color:#0b0d10;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 9010</button>
          <button type="button" class="ral-kleur-btn" data-ral="9001" data-kleur="#F7F9EF" data-target="buiten" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#F7F9EF;color:#0b0d10;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 9001</button>
          <button type="button" class="ral-kleur-btn" data-ral="9005" data-kleur="#0E0E10" data-target="buiten" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#0E0E10;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 9005</button>
          <button type="button" class="ral-kleur-btn" data-ral="7040" data-kleur="#9D9D9D" data-target="buiten" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#9D9D9D;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 7040</button>
          <button type="button" class="ral-kleur-btn" data-ral="7016" data-kleur="#383E42" data-target="buiten" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#383E42;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 7016</button>
          <button type="button" class="ral-kleur-btn" data-ral="6005" data-kleur="#0F5132" data-target="buiten" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#0F5132;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 6005</button>
        </div>
      </div>
      
      <div class="extra-option-group">
        <label>Kleur kozijn</label>
        <div class="ral-kleuren-selectie" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button type="button" class="ral-kleur-btn selected" data-ral="9010" data-kleur="#F7F9EF" data-target="kozijn" style="padding:8px 12px;border:2px solid var(--accent);border-radius:6px;background:#F7F9EF;color:#0b0d10;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 9010</button>
          <button type="button" class="ral-kleur-btn" data-ral="9001" data-kleur="#F7F9EF" data-target="kozijn" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#F7F9EF;color:#0b0d10;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 9001</button>
          <button type="button" class="ral-kleur-btn" data-ral="9005" data-kleur="#0E0E10" data-target="kozijn" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#0E0E10;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 9005</button>
          <button type="button" class="ral-kleur-btn" data-ral="7040" data-kleur="#9D9D9D" data-target="kozijn" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#9D9D9D;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 7040</button>
          <button type="button" class="ral-kleur-btn" data-ral="7016" data-kleur="#383E42" data-target="kozijn" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#383E42;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 7016</button>
          <button type="button" class="ral-kleur-btn" data-ral="6005" data-kleur="#0F5132" data-target="kozijn" style="padding:8px 12px;border:1px solid #2b2f36;border-radius:6px;background:#0F5132;color:#fff;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s">RAL 6005</button>
        </div>
      </div>
      
      <div class="extra-option-group">
        <label>Afwerking</label>
        <div class="vakRaamMenuSection" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
          <button type="button" class="btn" data-afwerking="afgelakt" id="afwerkingAfgelaktBtn" style="flex:1;min-width:120px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);cursor:pointer">
            <span>Afgelakt</span>
          </button>
          <button type="button" class="btn" data-afwerking="alleen-gegrond" id="afwerkingGegrondBtn" style="flex:1;min-width:120px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);cursor:pointer">
            <span>Alleen gegrond</span>
          </button>
        </div>
      </div>
    </div>
    
    <div class="vakRaamExtraActions">
      <button type="button" id="vakAfwerkingsOptiesBack">‚Üê Terug</button>
      <button type="button" id="vakAfwerkingsOptiesCancel">Annuleren</button>
      <button type="button" id="vakAfwerkingsOptiesConfirm" class="primary">Bevestigen</button>
    </div>
  </div>

  <div id="vakDeurDichtMenu" class="vakRaamExtraMenu">
    <h4 id="vakDeurDichtTitle">Dichte deur opties</h4>
    <div id="vakDeurDichtStatus" class="vakRaamExtraStatus">Configureer de dichte deur opties</div>
    
    <div class="vakRaamExtraOptions">
      <div class="extra-option-group">
        <label>Deur type</label>
        <div class="vakRaamMenuSection" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
          <button type="button" class="btn" data-deur-dicht-type="vlak" id="deurDichtVlakBtn" style="flex:1;min-width:150px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer">
            <img src="" alt="Vlakke deur" data-svg-type="deur-dicht" data-deur-dicht-type="vlak" style="width:80px;height:80px;pointer-events:none;object-fit:contain" />
            <span style="pointer-events:none">Vlakke deur</span>
          </button>
          <button type="button" class="btn" data-deur-dicht-type="vgroeven" id="deurDichtVgroevenBtn" style="flex:1;min-width:150px;padding:12px;border:1px solid #2b2f36;border-radius:10px;background:#12161b;color:var(--fg);display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer">
            <img src="" alt="Deur met verticale v groeven" data-svg-type="deur-dicht" data-deur-dicht-type="vgroeven" style="width:80px;height:80px;pointer-events:none;object-fit:contain" />
            <span style="pointer-events:none">Met verticale v groeven</span>
          </button>
        </div>
      </div>
      
      <div class="extra-option-group">
        <label>Deurbeslag</label>
        <button type="button" id="btnKiesDeurbeslagDicht" class="btn" style="width:100%;margin-top:8px;cursor:pointer;position:relative;z-index:1">Kies deurbeslag</button>
        <div id="dichtDeurbeslagStatus" style="padding:8px 10px;background:#141a22;border-radius:8px;color:var(--muted);font-size:12px;margin-top:8px">Geen deurbeslag gekozen</div>
      </div>
      
    </div>
    
    <div class="vakRaamExtraActions">
      <button type="button" id="vakDeurDichtBack">‚Üê Terug</button>
      <button type="button" id="vakDeurDichtCancel">Annuleren</button>
      <button type="button" id="vakDeurDichtConfirm" class="primary">Bevestigen</button>
    </div>
  </div>

  <div id="vakDeurbeslagMenu" class="vakRaamMenu">
    <h4 id="vakDeurbeslagTitle">Kies deurbeslag</h4>
    <div id="vakDeurbeslagStatus" class="vakRaamStatus">Selecteer een deurbeslag type</div>
    <div class="vakRaamMenuSection" id="vakDeurbeslagMenuSection">
      <button type="button" data-deurbeslag="standaard">
        <img src="" alt="Standaard deurbeslag" data-svg-type="deurbeslag" data-deurbeslag="standaard" />
        <span>Standaard</span>
      </button>
      <button type="button" data-deurbeslag="luxe">
        <img src="" alt="Luxe deurbeslag" data-svg-type="deurbeslag" data-deurbeslag="luxe" />
        <span>Luxe</span>
      </button>
      <button type="button" data-deurbeslag="modern">
        <img src="" alt="Modern deurbeslag" data-svg-type="deurbeslag" data-deurbeslag="modern" />
        <span>Modern</span>
      </button>
      <button type="button" data-deurbeslag="klassiek">
        <img src="" alt="Klassiek deurbeslag" data-svg-type="deurbeslag" data-deurbeslag="klassiek" />
        <span>Klassiek</span>
      </button>
    </div>
    <div class="vakRaamMenuActions">
      <button type="button" id="vakDeurbeslagWis">Verwijder keuze</button>
    </div>
  </div>

  <div id="vakGlasExtraMenu" class="vakRaamExtraMenu">
    <h4>Kies extra glasopties</h4>
    <div id="vakGlasExtraStatus" class="vakRaamExtraStatus">Wil je een rooster in dit glasvak?</div>
    <div class="glasRoosterButtons">
      <button type="button" class="glasRoosterBtn selected" data-rooster="false" id="glasRoosterNo">Zonder rooster</button>
      <button type="button" class="glasRoosterBtn" data-rooster="true" id="glasRoosterYes">Met rooster</button>
    </div>
    <div class="vakRaamExtraActions">
      <button type="button" id="vakGlasExtraBack">‚Üê Terug</button>
      <button type="button" id="vakGlasExtraCancel">Annuleren</button>
      <button type="button" id="vakGlasExtraConfirm" class="primary">Bevestigen</button>
    </div>
  </div>

  <div id="maatPopover" class="maatPopover">
    <h4>Dagmaat aanpassen</h4>
    <label for="maatPopoverInput">Breedte/hoogte (mm)</label>
    <input type="number" id="maatPopoverInput" min="10" />
    <label class="maatPopoverLock">
      <input type="checkbox" id="maatPopoverLock" />
      Vastzetten
    </label>
    <div class="actions">
      <button type="button" id="maatPopoverCancel">Annuleren</button>
      <button type="button" id="maatPopoverSave" class="primary">Opslaan</button>
    </div>
  </div>

<script>
(function(){
  const LS_KEY = 'kozijn_snapshot_v4';
  const state = { 
    Wmm: 2000, 
    Hmm: 2000,
    frameDikte: 67,    // buitenkader
    tussenDikte: 90,   // dikte van tussenstijlen/dorpels
    tussenStijlen: [], // verticale lijnen (tussenstijlen)
    tussenDorpels: [], // horizontale lijnen (tussendorpels)
    vakken: [],        // gedetecteerde vakken
    vakkenToewijzingen: {}, // toewijzingen per vak: {vakId: {type:'raam'|'deur'|'glas', ...}}
    kanTekenen: true,
    ekosietOnderdorpel: false, // ekosiet onderdorpel actief
    dagmaatConfig: {
      horiz: null,
      vert: null
    },
    afwerkingsOpties: {
      glasType: null,
      kleurDeurenRamenBinnen: '#F7F9EF', // RAL 9010 standaard
      kleurDeurenRamenBuiten: '#F7F9EF', // RAL 9010 standaard
      kleurKozijn: '#F7F9EF', // RAL 9010 standaard
      afwerking: null
    }
  };
  
  // Track of afwerkingsopties menu has been auto-opened
  let afwerkingsOptiesMenuAutoOpened = false;
  
  const svg = document.getElementById('view');
  const inpW = document.getElementById('inpW');
  const inpH = document.getElementById('inpH');
  const ekosietOnderdorpelCheckbox = document.getElementById('ekosietOnderdorpel');
  const btnApply = document.getElementById('btnApply');
  const btnReset = document.getElementById('btnReset');
  const btnUndo = document.getElementById('btnUndo');
  const btnSave = document.getElementById('btnSave');
  const btnLoad = document.getElementById('btnLoad');
  const btnExportPDF = document.getElementById('btnExportPDF');
  const btnDetectVakken = document.getElementById('btnDetectVakken');
  const modeText = document.getElementById('modeText');
  const countStijl = document.getElementById('countStijl');
  const countDorpel = document.getElementById('countDorpel');
  const vakkenFieldset = document.getElementById('vakkenFieldset');
  const vakkenList = document.getElementById('vakkenList');
  const btnAfwerkingsOpties = document.getElementById('btnAfwerkingsOpties');
  const vakAfwerkingsOptiesMenu = document.getElementById('vakAfwerkingsOptiesMenu');
  const vakAfwerkingsOptiesTitle = document.getElementById('vakAfwerkingsOptiesTitle');
  const vakAfwerkingsOptiesStatus = document.getElementById('vakAfwerkingsOptiesStatus');
  const glasEnkelglasBtn = document.getElementById('glasEnkelglasBtn');
  const glasHrPlusPlusBtn = document.getElementById('glasHrPlusPlusBtn');
  const glasHrPlusPlusPlusBtn = document.getElementById('glasHrPlusPlusPlusBtn');
  const kleurDeurenRamenBinnen = document.getElementById('kleurDeurenRamenBinnen');
  const kleurDeurenRamenBinnenText = document.getElementById('kleurDeurenRamenBinnenText');
  const kleurDeurenRamenBuiten = document.getElementById('kleurDeurenRamenBuiten');
  const kleurDeurenRamenBuitenText = document.getElementById('kleurDeurenRamenBuitenText');
  const kleurKozijn = document.getElementById('kleurKozijn');
  const kleurKozijnText = document.getElementById('kleurKozijnText');
  const afwerkingAfgelaktBtn = document.getElementById('afwerkingAfgelaktBtn');
  const afwerkingGegrondBtn = document.getElementById('afwerkingGegrondBtn');
  const vakAfwerkingsOptiesBack = document.getElementById('vakAfwerkingsOptiesBack');
  const vakAfwerkingsOptiesCancel = document.getElementById('vakAfwerkingsOptiesCancel');
  const vakAfwerkingsOptiesConfirm = document.getElementById('vakAfwerkingsOptiesConfirm');
  const vakSelectModal = document.getElementById('vakSelectModal');
  const modalClose = document.getElementById('modalClose');
  const modalTitle = document.getElementById('modalTitle');
  const modalVakId = document.getElementById('modalVakId');
  const vakSelectGrid = document.getElementById('vakSelectGrid');
  const maatTools = document.getElementById('maatTools');
  const btnEqualizeDagHoriz = document.getElementById('btnEqualizeDagHoriz');
  const btnEqualizeDagVert = document.getElementById('btnEqualizeDagVert');
  const btnDistributeMiddleHoriz = document.getElementById('btnDistributeMiddleHoriz');
  const btnDistributeMiddleVert = document.getElementById('btnDistributeMiddleVert');
  const maatPopover = document.getElementById('maatPopover');
  const maatPopoverInput = document.getElementById('maatPopoverInput');
  const maatPopoverLock = document.getElementById('maatPopoverLock');
  const fotoUploadBuitenkant = document.getElementById('fotoUploadBuitenkant');
  const btnUploadFotoBuitenkant = document.getElementById('btnUploadFotoBuitenkant');
  const btnVerwijderFotoBuitenkant = document.getElementById('btnVerwijderFotoBuitenkant');
  const fotoPreviewBuitenkant = document.getElementById('fotoPreviewBuitenkant');
  const fotoPreviewImgBuitenkant = document.getElementById('fotoPreviewImgBuitenkant');
  
  const fotoUploadBinnenkant = document.getElementById('fotoUploadBinnenkant');
  const btnUploadFotoBinnenkant = document.getElementById('btnUploadFotoBinnenkant');
  const btnVerwijderFotoBinnenkant = document.getElementById('btnVerwijderFotoBinnenkant');
  const fotoPreviewBinnenkant = document.getElementById('fotoPreviewBinnenkant');
  const fotoPreviewImgBinnenkant = document.getElementById('fotoPreviewImgBinnenkant');
  const fotoModal = document.getElementById('fotoModal');
  const fotoModalImg = document.getElementById('fotoModalImg');
  const fotoModalClose = document.getElementById('fotoModalClose');
  
  // Verborgen canvas voor image processing
  const processingCanvas = document.createElement('canvas');
  const processingCtx = processingCanvas.getContext('2d');
  const maatPopoverSave = document.getElementById('maatPopoverSave');
  const maatPopoverCancel = document.getElementById('maatPopoverCancel');
  const vakQuickMenu = document.getElementById('vakQuickMenu');
  const vakQuickButtons = Array.from(vakQuickMenu.querySelectorAll('button[data-type]'));
  const vakRaamMenu = document.getElementById('vakRaamMenu');
  const vakRaamMenuSection = document.getElementById('vakRaamMenuSection');
  const vakRaamVariantButtons = vakRaamMenuSection ? Array.from(vakRaamMenuSection.querySelectorAll('button[data-variant]')) : [];
  const vakDeurMenu = document.getElementById('vakDeurMenu');
  const vakDeurMenuSection = document.getElementById('vakDeurMenuSection');
  const vakDeurVariantButtons = vakDeurMenuSection ? Array.from(vakDeurMenuSection.querySelectorAll('button[data-variant]')) : [];
  const vakGlasMenu = document.getElementById('vakGlasMenu');
  const vakGlasMenuSection = document.getElementById('vakGlasMenuSection');
  const vakGlasVariantButtons = vakGlasMenuSection ? Array.from(vakGlasMenuSection.querySelectorAll('button[data-variant]')) : [];
  const vakOrientationMenu = document.getElementById('vakOrientationMenu');
  const vakOrientationStatus = document.getElementById('vakOrientationStatus');
  const vakOrientationButtons = vakOrientationMenu ? Array.from(vakOrientationMenu.querySelectorAll('button[data-orientation]')) : [];
  const vakOrientationBack = document.getElementById('vakOrientationBack');
  const vakOrientationCancel = document.getElementById('vakOrientationCancel');
  const vakKlepraamMenu = document.getElementById('vakKlepraamMenu');
  const vakKlepraamStatus = document.getElementById('vakKlepraamStatus');
  const vakKlepraamButtons = vakKlepraamMenu ? Array.from(vakKlepraamMenu.querySelectorAll('button[data-klepraam-type]')) : [];
  const vakKlepraamBack = document.getElementById('vakKlepraamBack');
  const vakKlepraamCancel = document.getElementById('vakKlepraamCancel');
  const vakDeurBuitenMenu = document.getElementById('vakDeurBuitenMenu');
  const vakDeurBuitenStatus = document.getElementById('vakDeurBuitenStatus');
  const vakDeurBuitenButtons = vakDeurBuitenMenu ? Array.from(vakDeurBuitenMenu.querySelectorAll('button[data-deur-buiten-type]')) : [];
  const vakDeurBuitenBack = document.getElementById('vakDeurBuitenBack');
  const vakDeurBuitenCancel = document.getElementById('vakDeurBuitenCancel');
  const vakStolpdeurenBuitenMenu = document.getElementById('vakStolpdeurenBuitenMenu');
  const vakStolpdeurenBuitenStatus = document.getElementById('vakStolpdeurenBuitenStatus');
  const vakStolpdeurenBuitenButtons = vakStolpdeurenBuitenMenu ? Array.from(vakStolpdeurenBuitenMenu.querySelectorAll('button[data-stolpdeuren-buiten-type]')) : [];
  const vakStolpdeurenBuitenBack = document.getElementById('vakStolpdeurenBuitenBack');
  const vakStolpdeurenBuitenCancel = document.getElementById('vakStolpdeurenBuitenCancel');
  const vakDeurDraaikiepMenu = document.getElementById('vakDeurDraaikiepMenu');
  const vakDeurDraaikiepStatus = document.getElementById('vakDeurDraaikiepStatus');
  const vakDeurDraaikiepButtons = vakDeurDraaikiepMenu ? Array.from(vakDeurDraaikiepMenu.querySelectorAll('button[data-deur-draaikiep-type]')) : [];
  const vakDeurDraaikiepBack = document.getElementById('vakDeurDraaikiepBack');
  const vakDeurDraaikiepCancel = document.getElementById('vakDeurDraaikiepCancel');
  const vakStolpdeurenDraaikiepMenu = document.getElementById('vakStolpdeurenDraaikiepMenu');
  const vakStolpdeurenDraaikiepStatus = document.getElementById('vakStolpdeurenDraaikiepStatus');
  const vakStolpdeurenDraaikiepButtons = vakStolpdeurenDraaikiepMenu ? Array.from(vakStolpdeurenDraaikiepMenu.querySelectorAll('button[data-stolpdeuren-draaikiep-type]')) : [];
  const vakStolpdeurenDraaikiepBack = document.getElementById('vakStolpdeurenDraaikiepBack');
  const vakStolpdeurenDraaikiepCancel = document.getElementById('vakStolpdeurenDraaikiepCancel');
  const vakRaamStatus = document.getElementById('vakRaamStatus');
  const vakRaamWis = document.getElementById('vakRaamWis');
  const vakDeurStatus = document.getElementById('vakDeurStatus');
  const vakDeurWis = document.getElementById('vakDeurWis');
  const vakGlasStatus = document.getElementById('vakGlasStatus');
  const vakGlasWis = document.getElementById('vakGlasWis');
  const vakRaamExtraMenu = document.getElementById('vakRaamExtraMenu');
  const vakRaamExtraStatus = document.getElementById('vakRaamExtraStatus');
  const roosterCheckbox = document.getElementById('roosterCheckbox');
  const horCheckbox = document.getElementById('horCheckbox');
  const beslagF1Btn = document.getElementById('beslagF1Btn');
  const beslagAndersBtn = document.getElementById('beslagAndersBtn');
  const beslagKleurPicker = document.getElementById('beslagKleurPicker');
  const beslagKleurInput = document.getElementById('beslagKleurInput');
  const vakRaamExtraBack = document.getElementById('vakRaamExtraBack');
  const vakRaamExtraCancel = document.getElementById('vakRaamExtraCancel');
  const vakRaamExtraConfirm = document.getElementById('vakRaamExtraConfirm');
  const vakGlasExtraMenu = document.getElementById('vakGlasExtraMenu');
  const vakGlasExtraStatus = document.getElementById('vakGlasExtraStatus');
  const glasRoosterYesBtn = document.getElementById('glasRoosterYes');
  const glasRoosterNoBtn = document.getElementById('glasRoosterNo');
  const vakGlasExtraBack = document.getElementById('vakGlasExtraBack');
  const vakGlasExtraCancel = document.getElementById('vakGlasExtraCancel');
  const vakGlasExtraConfirm = document.getElementById('vakGlasExtraConfirm');
  const vakDeurStapeldorpelMenu = document.getElementById('vakDeurStapeldorpelMenu');
  const vakDeurStapeldorpelStatus = document.getElementById('vakDeurStapeldorpelStatus');
  const stapeldorpelAantal = document.getElementById('stapeldorpelAantal');
  const stapeldorpelAantalGroup = document.getElementById('stapeldorpelAantalGroup');
  const tussendorpelHoogteGroup = document.getElementById('tussendorpelHoogteGroup');
  const tussendorpelHoogte = document.getElementById('tussendorpelHoogte');
  const stapeldorpelRoosterCheckbox = document.getElementById('stapeldorpelRoosterCheckbox');
  const roosterGroup = document.getElementById('roosterGroup');
  const vak1Group = document.getElementById('vak1Group');
  const vak2Group = document.getElementById('vak2Group');
  const vak1GlasBtn = document.getElementById('vak1GlasBtn');
  const vak1BossingBtn = document.getElementById('vak1BossingBtn');
  const vak1VlakBtn = document.getElementById('vak1VlakBtn');
  const vak2GlasBtn = document.getElementById('vak2GlasBtn');
  const vak2BossingBtn = document.getElementById('vak2BossingBtn');
  const vak2VlakBtn = document.getElementById('vak2VlakBtn');
  const btnKiesDeurbeslag = document.getElementById('btnKiesDeurbeslag');
  const stapeldorpelDeurbeslagStatus = document.getElementById('stapeldorpelDeurbeslagStatus');
  const vakDeurStapeldorpelBack = document.getElementById('vakDeurStapeldorpelBack');
  const vakDeurStapeldorpelCancel = document.getElementById('vakDeurStapeldorpelCancel');
  const vakDeurStapeldorpelConfirm = document.getElementById('vakDeurStapeldorpelConfirm');
  const vakDeurDichtMenu = document.getElementById('vakDeurDichtMenu');
  const vakDeurDichtTitle = document.getElementById('vakDeurDichtTitle');
  const vakDeurDichtStatus = document.getElementById('vakDeurDichtStatus');
  const deurDichtVlakBtn = document.getElementById('deurDichtVlakBtn');
  const deurDichtVgroevenBtn = document.getElementById('deurDichtVgroevenBtn');
  const vakDeurDichtBack = document.getElementById('vakDeurDichtBack');
  const vakDeurDichtCancel = document.getElementById('vakDeurDichtCancel');
  const vakDeurDichtConfirm = document.getElementById('vakDeurDichtConfirm');
  const btnKiesDeurbeslagDicht = document.getElementById('btnKiesDeurbeslagDicht');
  console.log('btnKiesDeurbeslagDicht gevonden:', !!btnKiesDeurbeslagDicht);
  const dichtDeurbeslagStatus = document.getElementById('dichtDeurbeslagStatus');
  const vakDeurbeslagMenu = document.getElementById('vakDeurbeslagMenu');
  const vakDeurbeslagTitle = document.getElementById('vakDeurbeslagTitle');
  const vakDeurbeslagStatus = document.getElementById('vakDeurbeslagStatus');
  const vakDeurbeslagMenuSection = document.getElementById('vakDeurbeslagMenuSection');
  const vakDeurbeslagWis = document.getElementById('vakDeurbeslagWis');
  const vakDeurbeslagVariantButtons = vakDeurbeslagMenuSection ? Array.from(vakDeurbeslagMenuSection.querySelectorAll('button[data-deurbeslag]')) : [];
  const vakStapeldorpelOrientationMenu = document.getElementById('vakStapeldorpelOrientationMenu');
  const vakStapeldorpelOrientationStatus = document.getElementById('vakStapeldorpelOrientationStatus');
  const vakStapeldorpelOrientationButtons = vakStapeldorpelOrientationMenu ? Array.from(vakStapeldorpelOrientationMenu.querySelectorAll('button[data-stapeldorpel-orientation]')) : [];
  const vakStapeldorpelOrientationBack = document.getElementById('vakStapeldorpelOrientationBack');
  const vakStapeldorpelOrientationCancel = document.getElementById('vakStapeldorpelOrientationCancel');
  const vakDeurOrientationMenu = document.getElementById('vakDeurOrientationMenu');
  const vakDeurOrientationStatus = document.getElementById('vakDeurOrientationStatus');
  const vakDeurOrientationTitle = document.getElementById('vakDeurOrientationTitle');
  const vakDeurOrientationButtons = vakDeurOrientationMenu ? Array.from(vakDeurOrientationMenu.querySelectorAll('button[data-deur-orientation]')) : [];
  const vakDeurOrientationBack = document.getElementById('vakDeurOrientationBack');
  const vakDeurOrientationCancel = document.getElementById('vakDeurOrientationCancel');
  const vakStolpdeurenOrientationMenu = document.getElementById('vakStolpdeurenOrientationMenu');
  const vakStolpdeurenOrientationStatus = document.getElementById('vakStolpdeurenOrientationStatus');
  const vakStolpdeurenOrientationTitle = document.getElementById('vakStolpdeurenOrientationTitle');
  const vakStolpdeurenOrientationButtons = vakStolpdeurenOrientationMenu ? Array.from(vakStolpdeurenOrientationMenu.querySelectorAll('button[data-stolpdeuren-orientation]')) : [];
  const vakStolpdeurenOrientationBack = document.getElementById('vakStolpdeurenOrientationBack');
  const vakStolpdeurenOrientationCancel = document.getElementById('vakStolpdeurenOrientationCancel');
  const vak2vaksVak1Menu = document.getElementById('vak2vaksVak1Menu');
  const vak2vaksVak1Status = document.getElementById('vak2vaksVak1Status');
  const vak2vaksVak1MenuSection = document.getElementById('vak2vaksVak1MenuSection');
  const vak2vaksVak1Buttons = vak2vaksVak1MenuSection ? Array.from(vak2vaksVak1MenuSection.querySelectorAll('button[data-vak1-type]')) : [];
  const vak2vaksVak1Back = document.getElementById('vak2vaksVak1Back');
  const vak2vaksVak1Cancel = document.getElementById('vak2vaksVak1Cancel');
  const vak2vaksVak2Menu = document.getElementById('vak2vaksVak2Menu');
  const vak2vaksVak2Status = document.getElementById('vak2vaksVak2Status');
  const vak2vaksVak2MenuSection = document.getElementById('vak2vaksVak2MenuSection');
  const vak2vaksVak2Buttons = vak2vaksVak2MenuSection ? Array.from(vak2vaksVak2MenuSection.querySelectorAll('button[data-vak2-type]')) : [];
  const vak2vaksVak2Back = document.getElementById('vak2vaksVak2Back');
  const vak2vaksVak2Cancel = document.getElementById('vak2vaksVak2Cancel');

  // Functie om alle SVG iconen dynamisch in te laden
  let drawing = false;
  let huidigGeselecteerdVak = null;
  let huidigQuickMenuVak = null;
  let huidigRaamMenuVak = null;
  let huidigRaamVariant = null;
  let huidigRaamOrientation = null;
  let huidigKlepraamType = null;
  let huidigDeurBuitenType = null;
  let huidigStolpdeurenBuitenType = null;
  let huidigDeurDraaikiepType = null;
  let huidigStolpdeurenDraaikiepType = null;
  let huidigDeurDichtType = null;
  let huidigStapeldorpelAantal = 2;
  let huidigTussendorpelHoogte = 250;
  let huidigStapeldorpelRooster = false;
  let huidigDeurbeslag = null;
  let huidigStapeldorpelOrientation = null;
  let huidigRooster = false;
  let huidigGlasType = null; // 'enkelglas', 'hr++', 'hr+++'
  let huidigKleurDeurenRamenBinnen = '#F7F9EF'; // RAL 9010 standaard
  let huidigKleurDeurenRamenBuiten = '#F7F9EF'; // RAL 9010 standaard
  let huidigKleurKozijn = '#F7F9EF'; // RAL 9010 standaard
  let huidigAfwerking = null; // 'afgelakt', 'alleen-gegrond'
  let huidigHor = false;
  let huidigBeslagKleur = 'f1'; // 'f1' of 'anders'
  let huidigBeslagKleurWaarde = '#8B7355';
  let huidigDeurMenuVak = null;
  let huidigDeurVariant = null;
  let laatsteDeurMenuPos = null;
  let huidigGlasMenuVak = null;
  let huidigGlasVariant = null;
  let huidigGlasRooster = false;
  let laatsteGlasMenuPos = null;
  let laatsteRaamMenuPos = null;
  let preview = null;
  let start = null;
  let laatsteVakClickPos = { x: 0, y: 0 };
  let actieveMaatContext = null;

  function berekenVakMenuPos(vak) {
    const rect = svg.getBoundingClientRect();
    const viewBox = svg.viewBox.baseVal;
    const x = toPx(vak.x + vak.breedte / 2);
    const y = toPx(vak.y + vak.hoogte / 2);
    const scaleX = viewBox.width !== 0 ? rect.width / viewBox.width : 1;
    const scaleY = viewBox.height !== 0 ? rect.height / viewBox.height : 1;
    return {
      x: rect.left + x * scaleX,
      y: rect.top + y * scaleY
    };
  }

  function getButtonToewijzing(button) {
    if (!button) return null;
    const type = button.dataset.type;
    if (!type) return null;
    const payload = { type };
    if (button.dataset.variant) payload.variant = button.dataset.variant;
    if (button.dataset.orientation) payload.orientation = button.dataset.orientation;
    return payload;
  }

  const toBoolean = (val) => {
    if (typeof val === 'string') {
      const lower = val.toLowerCase();
      return lower === 'true' || lower === '1' || lower === 'yes';
    }
    return !!val;
  };

  function buttonKomtOvereenMet(assign, button) {
    if (!assign) return false;
    const type = button?.dataset?.type;
    if (!type) return false;
    if (assign.type !== type) return false;
    if (type === 'raam') {
      const variant = button.dataset.variant;
      if (!variant) return true;
      return assign.variant === variant;
    }
    if (type === 'deur') {
      const variant = button.dataset.variant;
      if (!variant) return true;
      return assign.variant === variant;
    }
    if (type === 'glas') return true;
    return false;
  }

  function updateRaamVariantButtons() {
    if (!vakRaamVariantButtons.length) return;
    vakRaamVariantButtons.forEach(btn => {
      btn.classList.toggle('selected', !!huidigRaamVariant && btn.dataset.variant === huidigRaamVariant);
    });
  }

  function updateDeurVariantButtons() {
    if (!vakDeurVariantButtons.length) return;
    vakDeurVariantButtons.forEach(btn => {
      btn.classList.toggle('selected', !!huidigDeurVariant && btn.dataset.variant === huidigDeurVariant);
    });
  }

  function updateGlasVariantButtons() {
    if (!vakGlasVariantButtons.length) return;
    vakGlasVariantButtons.forEach(btn => {
      btn.classList.toggle('selected', !!huidigGlasVariant && btn.dataset.variant === huidigGlasVariant);
    });
  }

  function refreshDeurStatus(assign) {
    if (!vakDeurStatus) return;
    if (assign && assign.type === 'deur') {
      // Bepaal basis variant tekst (zonder subvarianten)
      let baseVariant = assign.variant;
      // Voor voordeur: geen subvarianten, return direct
      if (baseVariant === 'voordeur') {
        vakDeurStatus.textContent = 'Geselecteerd: Voordeur';
        return;
      }
      
      if (baseVariant.includes('_stapeldorpel')) {
        baseVariant = baseVariant.replace('_stapeldorpel', '');
      } else if (baseVariant.includes('_2vaks')) {
        baseVariant = baseVariant.replace('_2vaks', '');
      } else if (baseVariant.includes('_dicht')) {
        baseVariant = baseVariant.replace('_dicht', '');
      }
      
      const variantTextMap = {
        deur_buiten: 'Buitendraaiende deur',
        stolpdeuren_buiten: 'Stolpdeuren buitendraaiend',
        deur_draaikiep: 'Draaikiep deur',
        stolpdeuren_draaikiep: 'Stolpdraaikiep deur',
        voordeur: 'Voordeur'
      };
      
      // Bepaal of het een stolpdeuren variant is
      const isStolpdeuren = baseVariant === 'stolpdeuren_buiten' || baseVariant === 'stolpdeuren_draaikiep';
      
      // Bepaal deur type tekst
      let deurTypeText = '';
      if (assign.variant.includes('_stapeldorpel')) {
        deurTypeText = ' (stapeldorpel)';
      } else if (assign.variant.includes('_2vaks')) {
        deurTypeText = ' (2 vaks)';
      } else if (assign.variant.includes('_dicht')) {
        deurTypeText = ' (dicht)';
      }
      
      const baseText = variantTextMap[baseVariant] || 'Deur';
      const variantText = baseText + deurTypeText;
      
      // Voeg draairichting toe
      if (assign.orientation) {
        if (isStolpdeuren) {
          // Voor stolpdeuren: "links actief" of "rechts actief"
          const orientationText = assign.orientation === 'links' ? 'links actief' :
                                  assign.orientation === 'rechts' ? 'rechts actief' : '';
          vakDeurStatus.textContent = `Geselecteerd: ${variantText} ${orientationText}`;
        } else {
          // Voor normale deuren: "links draaiend" of "rechts draaiend"
          const orientationText = assign.orientation === 'links' ? 'links draaiend' :
                                  assign.orientation === 'rechts' ? 'rechts draaiend' : '';
          vakDeurStatus.textContent = `Geselecteerd: ${variantText} ${orientationText}`;
        }
      } else {
        vakDeurStatus.textContent = `Geselecteerd: ${variantText}`;
      }
    } else {
      vakDeurStatus.textContent = 'Selecteer een deurtype voor dit vak';
    }
  }

  function refreshGlasStatus(assign) {
    if (!vakGlasStatus) return;
    if (assign && assign.type === 'glas') {
      const variantTextMap = {
        glas_vast: 'Vast glas',
        glas_vast_stapel: 'Vast glas met stapeldorpels'
      };
      const variantText = variantTextMap[assign.variant] || 'Glas';
      const roosterText = assign.rooster ? ' ¬∑ Met rooster' : '';
      vakGlasStatus.textContent = `Geselecteerd: ${variantText}${roosterText}`;
    } else {
      vakGlasStatus.textContent = 'Selecteer een glasvariant voor dit vak';
    }
  }

  function getVariantOmschrijving(variant) {
    if (!variant) return 'dit raam';
    if (variant === 'draairaam_buiten') return 'dit buitendraaiend raam';
    if (variant === 'stolpraam_buiten') return 'dit buitendraaiend stolpraam';
    if (variant === 'draaikiep') return 'dit draaikiepraam';
    if (variant === 'stolpraam_draaikiep') return 'dit stolpraam draaikiep';
    if (variant === 'klepraam') return 'dit klepraam';
    if (variant === 'klepraam_open') return 'dit klepraam (open)';
    if (variant === 'klepraam_vast') return 'dit vast klepraam';
    return 'dit raam';
  }

  function getDeurVariantOmschrijving(variant) {
    if (!variant) return 'deze deur';
    if (variant === 'deur_buiten') return 'deze buitendraaiende deur';
    if (variant === 'deur_buiten_stapeldorpel') return 'deze buitendraaiende deur met stapeldorpel';
    if (variant === 'deur_buiten_2vaks') return 'deze 2 vaks buitendraaiende deur';
    if (variant === 'deur_buiten_dicht') return 'deze dichte buitendraaiende deur';
    if (variant === 'stolpdeuren_buiten') return 'deze stolpdeuren buitendraaiend';
    if (variant === 'deur_draaikiep') return 'deze draaikiep deur';
    if (variant === 'stolpdeuren_draaikiep') return 'deze stolpdraaikiep deuren';
    if (variant === 'voordeur') return 'deze voordeur';
    return 'deze deur';
  }

  // Functie om SVG bestandsnaam te bepalen op basis van variant en orientation
  function getVariantSvgPath(variant, orientation = null) {
    const basePath = getSvgBasePath();
    
    // Als er een orientation is, gebruik specifieke bestandsnaam
    if (orientation) {
      if (variant === 'draairaam_buiten' && orientation === 'links') {
        return basePath + 'buiten linksdraaiend raam.svg';
      }
      // Voeg hier meer specifieke mappings toe als je meer SVG's hebt
    }
    
    // Fallback naar generieke namen op basis van variant
    const variantMap = {
      'draairaam_buiten': 'draairaam_buiten.svg',
      'stolpraam_buiten': 'stolpraam_buiten.svg',
      'draaikiep': 'draaikiep.svg',
      'stolpraam_draaikiep': 'stolpraam_draaikiep.svg',
      'klepraam': 'klepraam.svg',
      'klepraam_open': 'klepraam_open.svg',
      'klepraam_vast': 'klepraam_vast.svg',
      'deur_buiten': 'deur_buiten.svg',
      'deur_buiten_stapeldorpel': 'deur_buiten_stapeldorpel.svg',
      'deur_buiten_2vaks': 'deur_buiten_2vaks.svg',
      'deur_buiten_dicht': 'deur_buiten_dicht.svg',
      'deur_buiten_dicht_vlak': 'deur_buiten_dicht_vlak.svg',
      'deur_buiten_dicht_vgroeven': 'deur_buiten_dicht_vgroeven.svg',
      'stolpdeuren_buiten': 'stolpdeuren_buiten.svg',
      'deur_draaikiep': 'deur_draaikiep.svg',
      'stolpdeuren_draaikiep': 'stolpdeuren_draaikiep.svg',
      'voordeur': 'voordeur.svg',
      'glas_vast': 'glas_vast.svg',
      'glas_vast_stapel': 'glas_vast_stapel.svg',
      'deurbeslag_standaard': 'deurbeslag_standaard.svg',
      'deurbeslag_luxe': 'deurbeslag_luxe.svg',
      'deurbeslag_modern': 'deurbeslag_modern.svg',
      'deurbeslag_klassiek': 'deurbeslag_klassiek.svg'
    };
    
    const filename = variantMap[variant] || 'default.svg';
    return basePath + filename;
  }

  // Functie om het basispad voor SVG iconen te bepalen
  function getSvgBasePath() {
    // Probeer eerst het pad relatief vanuit public/ (voor Streamlit/html componenten)
    // Als dat niet werkt, probeer dan vanuit de root
    return 'assets/icons/';
  }

  // Cache voor geladen SVG bestanden
  const svgCache = {};
  
  // Functie om SVG content als data URI terug te geven (voor about:srcdoc context)
  // Gebruikt de EXACTE SVG-content uit je bestand: public/public/assets/icons/buiten linksdraaiend raam.svg
  function getOrientationSvgDataUri(orientation, variant = null) {
    // VOOR BUITENDRAAIEND LINKS RAAM: Gebruik exact je SVG-bestand uit het bestandssysteem
    if (variant === 'draairaam_buiten' && orientation === 'links') {
      // Laad het SVG-bestand direct - dit is je originele bestand!
      // Gebruik het pad: public/public/assets/icons/buiten linksdraaiend raam.svg
      // Voor nu gebruiken we de exacte content die in dat bestand staat
      // TODO: Laad dit dynamisch vanuit het bestand als dat mogelijk is
      
      // EXACTE content uit je technische tekening: public/public/assets/icons/buiten linksdraaiend raam.svg
      // Dit is je originele CAD-tekening!
      // AANGEPAST: stroke-width verhoogd (0.5 -> 2) en kleuren lichter gemaakt (black -> #4aa3ff, blue -> #88ccff) voor zichtbaarheid
      const jouwSvgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="800.000" height="600.000" viewBox="0.0 0.0 800.000 600.000" version="1.1">
  <desc>Produce by Acme CAD Converter</desc>
  <g stroke-width="3" stroke="#4aa3ff" fill="none">
<path d="M288.58 145.46L463.3 145.46"
/>
<path d="M288.58 145.46L463.3 145.46"
/>
<path d="M288.58 145.46L288.58 407.54Z"
/>
<path d="M288.58 145.46L288.58 407.54Z"
/>
<path d="M463.3 145.46L463.3 407.54Z"
/>
<path d="M463.3 145.46L463.3 407.54Z"
/>
<path d="M288.58 407.54L463.3 407.54"
/>
<path d="M288.58 407.54L463.3 407.54"
/>
<path d="M305.62 162.49L446.27 162.49"
/>
<path d="M305.62 390.5L446.27 390.5"
/>
<path d="M305.62 162.49L305.62 390.5Z"
/>
<path d="M446.27 162.49L446.27 390.5Z"
/>
<path d="M445.43 162.58L445.45 162.6"
/>
<path d="M445.45 162.6L445.43 162.62"
/>
<path d="M445.43 162.62L445.4 162.6"
/>
<path d="M445.4 162.6L445.4 162.58Z"
/>
<path d="M445.4 162.58L445.43 162.54"
/>
<path d="M445.43 162.54L445.45 162.51"
/>
<path d="M445.45 162.51L445.49 162.49"
/>
<path d="M445.49 162.49L445.55 162.49"
/>
<path d="M445.55 162.49L445.61 162.51"
/>
<path d="M445.61 162.51L445.63 162.56"
/>
<path d="M445.63 162.56L445.63 162.6Z"
/>
<path d="M445.63 162.6L445.61 162.64"
/>
<path d="M445.61 162.64L445.59 162.66"
/>
<path d="M445.59 162.66L445.55 162.68"
/>
<path d="M445.55 162.68L445.51 162.72"
/>
<path d="M445.51 162.72L445.51 162.78Z"
/>
<path d="M445.51 162.89L445.49 162.91"
/>
<path d="M445.49 162.91L445.51 162.93"
/>
<path d="M445.51 162.93L445.53 162.91"
/>
<path d="M445.53 162.91L445.51 162.89"
/>
<path d="M445.8 162.58L445.82 162.6"
/>
<path d="M445.82 162.6L445.8 162.62"
/>
<path d="M445.8 162.62L445.78 162.6"
/>
<path d="M445.78 162.6L445.78 162.58Z"
/>
<path d="M445.78 162.58L445.8 162.54"
/>
<path d="M445.8 162.54L445.82 162.51"
/>
<path d="M445.82 162.51L445.86 162.49"
/>
<path d="M445.86 162.49L445.92 162.49"
/>
<path d="M445.92 162.49L445.99 162.51"
/>
<path d="M445.99 162.51L446.01 162.56"
/>
<path d="M446.01 162.56L446.01 162.6Z"
/>
<path d="M446.01 162.6L445.99 162.64"
/>
<path d="M445.99 162.64L445.97 162.66"
/>
<path d="M445.97 162.66L445.92 162.68"
/>
<path d="M445.92 162.68L445.88 162.72"
/>
<path d="M445.88 162.72L445.88 162.78Z"
/>
<path d="M445.88 162.89L445.86 162.91"
/>
<path d="M445.86 162.91L445.88 162.93"
/>
<path d="M445.88 162.93L445.9 162.91"
/>
<path d="M445.9 162.91L445.88 162.89"
/>
<path d="M288.58 145.46L463.3 276.5"
/>
<path d="M288.58 407.54L463.3 276.5"
/>
<path d="M286.4 167.3L288.58 167.3"
stroke="#88ccff"/>
<path d="M288.58 167.3L288.58 174.83Z"
stroke="#88ccff"/>
<path d="M288.58 179.2L288.58 186.74Z"
stroke="#88ccff"/>
<path d="M286.4 167.3L286.4 174.83Z"
stroke="#88ccff"/>
<path d="M286.4 179.2L286.4 186.74Z"
stroke="#88ccff"/>
<path d="M286.4 186.74L288.58 186.74"
stroke="#88ccff"/>
<path d="M286.4 232.82L288.58 232.82"
/>
<path d="M288.58 232.82L288.58 252.26Z"
/>
<path d="M286.4 232.82L286.4 252.26Z"
/>
<path d="M286.4 252.26L288.58 252.26"
/>
<path d="M286.4 366.26L288.58 366.26"
/>
<path d="M288.58 366.26L288.58 385.7Z"
/>
<path d="M286.4 366.26L286.4 385.7Z"
/>
<path d="M286.4 385.7L288.58 385.7"
stroke-width="3"/>
  </g>
</svg>`;
      
      console.log('‚úÖ Gebruik JOUW SVG-bestand voor draairaam_buiten + links in canvas!');
      console.log('Variant:', variant, 'Orientation:', orientation);
      // Gebruik exact je SVG-bestand - geen aanpassingen!
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(jouwSvgContent);
    }
    
    // Voor rechtsdraaiend: spiegel de SVG
    const rechtsDraaiendSvg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80">
  <rect width="80" height="80" fill="#0f1318"/>
  <rect x="12" y="12" width="56" height="56" fill="#0f1a24" stroke="#4aa3ff" stroke-width="3"/>
  <rect x="16" y="16" width="44" height="52" fill="none" stroke="#4aa3ff" stroke-width="2"/>
  <line x1="60" y1="26" x2="60" y2="26" stroke="#888" stroke-width="2.5" stroke-linecap="round"/>
  <line x1="60" y1="54" x2="60" y2="54" stroke="#888" stroke-width="2.5" stroke-linecap="round"/>
  <line x1="60" y1="16" x2="16" y2="64" stroke="#4aa3ff" stroke-width="3"/>
  <line x1="60" y1="16" x2="16" y2="40" stroke="#4aa3ff" stroke-width="2"/>
</svg>`;
    
    if (orientation === 'rechts') {
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(rechtsDraaiendSvg);
    }
    
    // Voor vast raam
    const vastSvg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80">
  <rect width="80" height="80" fill="#0f1318"/>
  <rect x="12" y="12" width="56" height="56" fill="#0f1a24" stroke="#4aa3ff" stroke-width="3"/>
  <rect x="18" y="18" width="44" height="44" fill="#4aa3ff" opacity="0.25"/>
</svg>`;
    
    if (orientation === 'vast') {
      return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(vastSvg);
    }
    
    // Default voor links: gebruik je exacte SVG-bestand
    const linksDraaiendSvg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80">
  <!-- Achtergrond -->
  <rect width="80" height="80" fill="#0f1318"/>
  
  <!-- Buitenframe -->
  <rect x="12" y="12" width="56" height="56" fill="#0f1a24" stroke="#4aa3ff" stroke-width="3"/>
  
  <!-- Binnenframe/raam (linksdraaiend) -->
  <rect x="20" y="16" width="44" height="52" fill="none" stroke="#4aa3ff" stroke-width="2"/>
  
  <!-- Hinges aan de linkerkant (kleine streepjes) -->
  <line x1="20" y1="26" x2="20" y2="26" stroke="#888" stroke-width="2.5" stroke-linecap="round"/>
  <line x1="20" y1="54" x2="20" y2="54" stroke="#888" stroke-width="2.5" stroke-linecap="round"/>
  
  <!-- Diagonaal van linksboven naar rechtsonder (buitendraaiend indicatie) -->
  <line x1="20" y1="16" x2="64" y2="64" stroke="#4aa3ff" stroke-width="3"/>
  
  <!-- Extra diagonaal voor driehoek-vorm (opening naar rechts) -->
  <line x1="20" y1="16" x2="64" y2="40" stroke="#4aa3ff" stroke-width="2"/>
</svg>`;
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(linksDraaiendSvg);
  }

  // Functie om orientation SVG bestandsnaam te bepalen (legacy, voor externe bestanden)
  function getOrientationSvgPath(orientation, variant = null) {
    const basePath = 'assets/icons/';
    if (variant === 'draairaam_buiten') {
      if (orientation === 'links') {
        return basePath + 'buiten linksdraaiend raam.svg';
      }
      if (orientation === 'rechts') {
        return basePath + 'buiten rechtsdraaiend raam.svg';
      }
    }
    const orientationMap = {
      'links': 'links.svg',
      'rechts': 'rechts.svg',
      'vast': 'vast.svg'
    };
    const filename = orientationMap[orientation] || 'default.svg';
    return basePath + filename;
  }

  // Functie om SVG data URI te krijgen voor raam varianten - gebruikt je bestand
  function getRaamVariantSvgDataUri(variant) {
    // Gebruik hetzelfde SVG-bestand voor alle raamvarianten
    // Exacte content uit: public/public/assets/icons/buiten linksdraaiend raam.svg
    const raamSvg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80">
  <!-- Achtergrond -->
  <rect width="80" height="80" fill="#0f1318"/>
  
  <!-- Buitenframe -->
  <rect x="12" y="12" width="56" height="56" fill="#0f1a24" stroke="#4aa3ff" stroke-width="3"/>
  
  <!-- Binnenframe/raam (linksdraaiend) -->
  <rect x="20" y="16" width="44" height="52" fill="none" stroke="#4aa3ff" stroke-width="2"/>
  
  <!-- Hinges aan de linkerkant (kleine streepjes) -->
  <line x1="20" y1="26" x2="20" y2="26" stroke="#888" stroke-width="2.5" stroke-linecap="round"/>
  <line x1="20" y1="54" x2="20" y2="54" stroke="#888" stroke-width="2.5" stroke-linecap="round"/>
  
  <!-- Diagonaal van linksboven naar rechtsonder (buitendraaiend indicatie) -->
  <line x1="20" y1="16" x2="64" y2="64" stroke="#4aa3ff" stroke-width="3"/>
  
  <!-- Extra diagonaal voor driehoek-vorm (opening naar rechts) -->
  <line x1="20" y1="16" x2="64" y2="40" stroke="#4aa3ff" stroke-width="2"/>
</svg>`;
    
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(raamSvg);
  }

  // Functie om alle SVG iconen dynamisch in te laden
  function loadSvgIcons() {
    // Laad variant iconen (raam, deur, glas)
    document.querySelectorAll('button[data-variant] img[data-svg-type="variant"]').forEach(img => {
      const variant = img.closest('button').dataset.variant;
      if (variant) {
        // Voor alle raamvarianten: gebruik je SVG-bestand
        if (variant.startsWith('draairaam_') || variant.startsWith('stolpraam_') || variant === 'draaikiep' || variant === 'stolpraam_draaikiep' || variant === 'klepraam' || variant === 'klepraam_open' || variant === 'klepraam_vast') {
          img.src = getRaamVariantSvgDataUri(variant);
        } else {
          // Voor andere varianten (deur, glas): gebruik bestandspad
          const svgPath = getVariantSvgPath(variant);
          img.src = svgPath;
        }
      }
    });
  }

  // Functie om orientation iconen te updaten op basis van geselecteerde variant
  function updateOrientationIcons(variant) {
    const orientationButtons = document.querySelectorAll('#vakOrientationButtons button[data-orientation]');
    orientationButtons.forEach(btn => {
      const img = btn.querySelector('img[data-svg-type="orientation"]');
      if (img) {
        const orientation = btn.dataset.orientation;
        
        // Gebruik direct de data URI functie (niet async meer)
        const svgDataUri = getOrientationSvgDataUri(orientation, variant);
        img.src = svgDataUri;
        
        // Sla variant op in data attribuut voor toekomstig gebruik
        if (img.dataset) {
          img.dataset.variant = variant || '';
        }
      }
    });
  }

  function updateOrientationButtons() {
    if (!vakOrientationButtons.length) return;
    vakOrientationButtons.forEach(btn => {
      btn.classList.toggle('selected', !!huidigRaamOrientation && btn.dataset.orientation === huidigRaamOrientation);
    });
  }

  function openVakOrientationMenu(vak, _pos) {
    if (!vakOrientationMenu) return;
    huidigRaamMenuVak = vak;
    const centerPos = getSvgCenterPos();
    vakOrientationMenu.style.left = `${centerPos.x}px`;
    vakOrientationMenu.style.top = `${centerPos.y}px`;
    vakOrientationMenu.style.display = 'flex';
    // Update SVG iconen op basis van huidige variant
    updateOrientationIcons(huidigRaamVariant);
    updateOrientationButtons();
    if (vakOrientationStatus) {
      const variantText = getVariantOmschrijving(huidigRaamVariant);
      vakOrientationStatus.textContent = `Kies de draairichting voor ${variantText}`;
    }
  }

  function closeVakOrientationMenu(resetState = true) {
    if (!vakOrientationMenu) return;
    vakOrientationMenu.style.display = 'none';
    if (resetState) {
      huidigRaamVariant = null;
      huidigRaamOrientation = null;
      updateOrientationButtons();
    }
  }

  function openVakKlepraamMenu(vak, _pos) {
    if (!vakKlepraamMenu) return;
    huidigRaamMenuVak = vak;
    const centerPos = getSvgCenterPos();
    vakKlepraamMenu.style.left = `${centerPos.x}px`;
    vakKlepraamMenu.style.top = `${centerPos.y}px`;
    vakKlepraamMenu.style.display = 'flex';
    
    // Laad bestaande waarde als er al een toewijzing is
    const assign = getVakToewijzing(vak.id);
    if (assign && assign.type === 'raam' && (assign.variant === 'klepraam_open' || assign.variant === 'klepraam_vast')) {
      huidigKlepraamType = assign.variant === 'klepraam_open' ? 'open' : 'vast';
    } else {
      huidigKlepraamType = null;
    }
    
    updateKlepraamButtons();
    if (vakKlepraamStatus) {
      vakKlepraamStatus.textContent = 'Selecteer of het klepraam open of vast is';
    }
  }

  function closeVakKlepraamMenu(resetState = true) {
    if (!vakKlepraamMenu) return;
    vakKlepraamMenu.style.display = 'none';
    if (resetState) {
      huidigKlepraamType = null;
      updateKlepraamButtons();
    }
  }

  function updateKlepraamButtons() {
    if (!vakKlepraamButtons.length) return;
    vakKlepraamButtons.forEach(btn => {
      btn.classList.toggle('selected', !!huidigKlepraamType && btn.dataset.klepraamType === huidigKlepraamType);
    });
  }

  function openVakDeurBuitenMenu(vak, _pos) {
    if (!vakDeurBuitenMenu) return;
    huidigDeurMenuVak = vak;
    const centerPos = getSvgCenterPos();
    vakDeurBuitenMenu.style.left = `${centerPos.x}px`;
    vakDeurBuitenMenu.style.top = `${centerPos.y}px`;
    vakDeurBuitenMenu.style.display = 'flex';
    
    // Laad bestaande waarde als er al een toewijzing is
    const assign = getVakToewijzing(vak.id);
    if (assign && assign.type === 'deur' && (
      assign.variant === 'deur_buiten_stapeldorpel' || 
      assign.variant === 'deur_buiten_2vaks' || 
      assign.variant === 'deur_buiten_dicht'
    )) {
      if (assign.variant === 'deur_buiten_stapeldorpel') {
        huidigDeurBuitenType = 'stapeldorpel';
      } else if (assign.variant === 'deur_buiten_2vaks') {
        huidigDeurBuitenType = '2vaks';
      } else if (assign.variant === 'deur_buiten_dicht') {
        huidigDeurBuitenType = 'dicht';
      }
    } else {
      huidigDeurBuitenType = null;
    }
    
    updateDeurBuitenIcons();
    updateDeurBuitenButtons();
    if (vakDeurBuitenStatus) {
      vakDeurBuitenStatus.textContent = 'Selecteer het type buitendraaiende deur';
    }
  }

  function closeVakDeurBuitenMenu(resetState = true) {
    if (!vakDeurBuitenMenu) return;
    vakDeurBuitenMenu.style.display = 'none';
    if (resetState) {
      huidigDeurBuitenType = null;
      updateDeurBuitenButtons();
    }
  }

  function openVakDeurDichtMenu(vak, pos) {
    if (!vakDeurDichtMenu || !vak) return;
    huidigDeurMenuVak = vak;
    huidigDeurBuitenType = 'dicht';
    const centerPos = pos || getSvgCenterPos();
    vakDeurDichtMenu.style.left = `${centerPos.x}px`;
    vakDeurDichtMenu.style.top = `${centerPos.y}px`;
    vakDeurDichtMenu.style.display = 'flex';
    vakDeurDichtMenu.style.zIndex = '1700';
    
    // Laad bestaande waarde als er al een toewijzing is
    const assign = getVakToewijzing(vak.id);
    if (assign && assign.type === 'deur' && assign.variant === 'deur_buiten_dicht') {
      huidigDeurDichtType = assign.deurDichtType || null;
      // Laad ook deurbeslag als die al is gekozen
      huidigDeurbeslag = assign.deurbeslag || null;
      huidigStapeldorpelOrientation = assign.orientation || null;
    } else {
      // Behoud huidige deurbeslag waarde als deze al is ingesteld (bij navigatie tussen menu's)
      const behoudDeurbeslag = huidigDeurbeslag;
      
      huidigDeurDichtType = null;
      huidigDeurbeslag = behoudDeurbeslag || null;
      huidigStapeldorpelOrientation = null;
    }
    
    updateDeurDichtButtons();
    updateDeurDichtIcons();
    updateDeurbeslagStatusDicht();
    if (vakDeurDichtStatus) {
      vakDeurDichtStatus.textContent = 'Configureer de dichte deur opties';
    }
  }

  function closeVakDeurDichtMenu(resetState = true) {
    if (!vakDeurDichtMenu) return;
    vakDeurDichtMenu.style.display = 'none';
    if (resetState) {
      huidigDeurDichtType = null;
      updateDeurDichtButtons();
    }
  }

  function updateDeurDichtButtons() {
    if (deurDichtVlakBtn) {
      deurDichtVlakBtn.classList.toggle('selected', huidigDeurDichtType === 'vlak');
    }
    if (deurDichtVgroevenBtn) {
      deurDichtVgroevenBtn.classList.toggle('selected', huidigDeurDichtType === 'vgroeven');
    }
  }

  function updateDeurDichtIcons() {
    if (deurDichtVlakBtn) {
      const img = deurDichtVlakBtn.querySelector('img[data-svg-type="deur-dicht"]');
      if (img) {
        const svgPath = getVariantSvgPath('deur_buiten_dicht_vlak');
        if (svgPath) {
          img.src = svgPath;
        }
      }
    }
    if (deurDichtVgroevenBtn) {
      const img = deurDichtVgroevenBtn.querySelector('img[data-svg-type="deur-dicht"]');
      if (img) {
        const svgPath = getVariantSvgPath('deur_buiten_dicht_vgroeven');
        if (svgPath) {
          img.src = svgPath;
        }
      }
    }
  }

  function updateDeurbeslagStatusDicht() {
    if (!dichtDeurbeslagStatus) return;
    if (huidigDeurbeslag) {
      const deurbeslagLabels = {
        standaard: 'Standaard deurbeslag',
        luxe: 'Luxe deurbeslag',
        modern: 'Modern deurbeslag',
        klassiek: 'Klassiek deurbeslag'
      };
      dichtDeurbeslagStatus.textContent = `Geselecteerd: ${deurbeslagLabels[huidigDeurbeslag] || huidigDeurbeslag}`;
    } else {
      dichtDeurbeslagStatus.textContent = 'Geen deurbeslag gekozen';
    }
  }


  function updateDeurBuitenIcons() {
    if (!vakDeurBuitenButtons.length) return;
    vakDeurBuitenButtons.forEach(btn => {
      const img = btn.querySelector('img[data-svg-type="deur-buiten"]');
      if (img) {
        const deurBuitenType = btn.dataset.deurBuitenType;
        let variant = 'deur_buiten';
        if (deurBuitenType === 'stapeldorpel') {
          variant = 'deur_buiten_stapeldorpel';
        } else if (deurBuitenType === '2vaks') {
          variant = 'deur_buiten_2vaks';
        } else if (deurBuitenType === 'dicht') {
          variant = 'deur_buiten_dicht';
        }
        const svgPath = getVariantSvgPath(variant);
        img.src = svgPath;
      }
    });
  }

  function updateDeurBuitenButtons() {
    if (!vakDeurBuitenButtons.length) return;
    vakDeurBuitenButtons.forEach(btn => {
      btn.classList.toggle('selected', !!huidigDeurBuitenType && btn.dataset.deurBuitenType === huidigDeurBuitenType);
    });
  }

  // Functies voor stolpdeuren_buiten
  function openVakStolpdeurenBuitenMenu(vak, _pos) {
    if (!vakStolpdeurenBuitenMenu) return;
    huidigDeurMenuVak = vak;
    const centerPos = getSvgCenterPos();
    vakStolpdeurenBuitenMenu.style.left = `${centerPos.x}px`;
    vakStolpdeurenBuitenMenu.style.top = `${centerPos.y}px`;
    vakStolpdeurenBuitenMenu.style.display = 'flex';
    
    const assign = getVakToewijzing(vak.id);
    if (assign && assign.type === 'deur' && (
      assign.variant === 'stolpdeuren_buiten_stapeldorpel' || 
      assign.variant === 'stolpdeuren_buiten_2vaks' || 
      assign.variant === 'stolpdeuren_buiten_dicht'
    )) {
      if (assign.variant === 'stolpdeuren_buiten_stapeldorpel') {
        huidigStolpdeurenBuitenType = 'stapeldorpel';
      } else if (assign.variant === 'stolpdeuren_buiten_2vaks') {
        huidigStolpdeurenBuitenType = '2vaks';
      } else if (assign.variant === 'stolpdeuren_buiten_dicht') {
        huidigStolpdeurenBuitenType = 'dicht';
      }
    } else {
      huidigStolpdeurenBuitenType = null;
    }
    
    updateStolpdeurenBuitenIcons();
    updateStolpdeurenBuitenButtons();
    if (vakStolpdeurenBuitenStatus) {
      vakStolpdeurenBuitenStatus.textContent = 'Selecteer het type stolpdeuren buitendraaiend';
    }
  }

  function closeVakStolpdeurenBuitenMenu(resetState = true) {
    if (!vakStolpdeurenBuitenMenu) return;
    vakStolpdeurenBuitenMenu.style.display = 'none';
    if (resetState) {
      huidigStolpdeurenBuitenType = null;
      updateStolpdeurenBuitenButtons();
    }
  }

  function updateStolpdeurenBuitenIcons() {
    if (!vakStolpdeurenBuitenButtons.length) return;
    vakStolpdeurenBuitenButtons.forEach(btn => {
      const img = btn.querySelector('img[data-svg-type="stolpdeuren-buiten"]');
      if (img) {
        const type = btn.dataset.stolpdeurenBuitenType;
        let variant = 'stolpdeuren_buiten';
        if (type === 'stapeldorpel') {
          variant = 'stolpdeuren_buiten_stapeldorpel';
        } else if (type === '2vaks') {
          variant = 'stolpdeuren_buiten_2vaks';
        } else if (type === 'dicht') {
          variant = 'stolpdeuren_buiten_dicht';
        }
        const svgPath = getVariantSvgPath(variant);
        img.src = svgPath;
      }
    });
  }

  function updateStolpdeurenBuitenButtons() {
    if (!vakStolpdeurenBuitenButtons.length) return;
    vakStolpdeurenBuitenButtons.forEach(btn => {
      btn.classList.toggle('selected', !!huidigStolpdeurenBuitenType && btn.dataset.stolpdeurenBuitenType === huidigStolpdeurenBuitenType);
    });
  }

  // Functies voor deur_draaikiep
  function openVakDeurDraaikiepMenu(vak, _pos) {
    if (!vakDeurDraaikiepMenu) return;
    huidigDeurMenuVak = vak;
    const centerPos = getSvgCenterPos();
    vakDeurDraaikiepMenu.style.left = `${centerPos.x}px`;
    vakDeurDraaikiepMenu.style.top = `${centerPos.y}px`;
    vakDeurDraaikiepMenu.style.display = 'flex';
    
    const assign = getVakToewijzing(vak.id);
    if (assign && assign.type === 'deur' && (
      assign.variant === 'deur_draaikiep_stapeldorpel' || 
      assign.variant === 'deur_draaikiep_2vaks' || 
      assign.variant === 'deur_draaikiep_dicht'
    )) {
      if (assign.variant === 'deur_draaikiep_stapeldorpel') {
        huidigDeurDraaikiepType = 'stapeldorpel';
      } else if (assign.variant === 'deur_draaikiep_2vaks') {
        huidigDeurDraaikiepType = '2vaks';
      } else if (assign.variant === 'deur_draaikiep_dicht') {
        huidigDeurDraaikiepType = 'dicht';
      }
    } else {
      huidigDeurDraaikiepType = null;
    }
    
    updateDeurDraaikiepIcons();
    updateDeurDraaikiepButtons();
    if (vakDeurDraaikiepStatus) {
      vakDeurDraaikiepStatus.textContent = 'Selecteer het type draaikiep deur';
    }
  }

  function closeVakDeurDraaikiepMenu(resetState = true) {
    if (!vakDeurDraaikiepMenu) return;
    vakDeurDraaikiepMenu.style.display = 'none';
    if (resetState) {
      huidigDeurDraaikiepType = null;
      updateDeurDraaikiepButtons();
    }
  }

  function updateDeurDraaikiepIcons() {
    if (!vakDeurDraaikiepButtons.length) return;
    vakDeurDraaikiepButtons.forEach(btn => {
      const img = btn.querySelector('img[data-svg-type="deur-draaikiep"]');
      if (img) {
        const type = btn.dataset.deurDraaikiepType;
        let variant = 'deur_draaikiep';
        if (type === 'stapeldorpel') {
          variant = 'deur_draaikiep_stapeldorpel';
        } else if (type === '2vaks') {
          variant = 'deur_draaikiep_2vaks';
        } else if (type === 'dicht') {
          variant = 'deur_draaikiep_dicht';
        }
        const svgPath = getVariantSvgPath(variant);
        img.src = svgPath;
      }
    });
  }

  function updateDeurDraaikiepButtons() {
    if (!vakDeurDraaikiepButtons.length) return;
    vakDeurDraaikiepButtons.forEach(btn => {
      btn.classList.toggle('selected', !!huidigDeurDraaikiepType && btn.dataset.deurDraaikiepType === huidigDeurDraaikiepType);
    });
  }

  // Functies voor stolpdeuren_draaikiep
  function openVakStolpdeurenDraaikiepMenu(vak, _pos) {
    if (!vakStolpdeurenDraaikiepMenu) return;
    huidigDeurMenuVak = vak;
    const centerPos = getSvgCenterPos();
    vakStolpdeurenDraaikiepMenu.style.left = `${centerPos.x}px`;
    vakStolpdeurenDraaikiepMenu.style.top = `${centerPos.y}px`;
    vakStolpdeurenDraaikiepMenu.style.display = 'flex';
    
    const assign = getVakToewijzing(vak.id);
    if (assign && assign.type === 'deur' && (
      assign.variant === 'stolpdeuren_draaikiep_stapeldorpel' || 
      assign.variant === 'stolpdeuren_draaikiep_2vaks' || 
      assign.variant === 'stolpdeuren_draaikiep_dicht'
    )) {
      if (assign.variant === 'stolpdeuren_draaikiep_stapeldorpel') {
        huidigStolpdeurenDraaikiepType = 'stapeldorpel';
      } else if (assign.variant === 'stolpdeuren_draaikiep_2vaks') {
        huidigStolpdeurenDraaikiepType = '2vaks';
      } else if (assign.variant === 'stolpdeuren_draaikiep_dicht') {
        huidigStolpdeurenDraaikiepType = 'dicht';
      }
    } else {
      huidigStolpdeurenDraaikiepType = null;
    }
    
    updateStolpdeurenDraaikiepIcons();
    updateStolpdeurenDraaikiepButtons();
    if (vakStolpdeurenDraaikiepStatus) {
      vakStolpdeurenDraaikiepStatus.textContent = 'Selecteer het type stolpdraaikiep deuren';
    }
  }

  function closeVakStolpdeurenDraaikiepMenu(resetState = true) {
    if (!vakStolpdeurenDraaikiepMenu) return;
    vakStolpdeurenDraaikiepMenu.style.display = 'none';
    if (resetState) {
      huidigStolpdeurenDraaikiepType = null;
      updateStolpdeurenDraaikiepButtons();
    }
  }

  function updateStolpdeurenDraaikiepIcons() {
    if (!vakStolpdeurenDraaikiepButtons.length) return;
    vakStolpdeurenDraaikiepButtons.forEach(btn => {
      const img = btn.querySelector('img[data-svg-type="stolpdeuren-draaikiep"]');
      if (img) {
        const type = btn.dataset.stolpdeurenDraaikiepType;
        let variant = 'stolpdeuren_draaikiep';
        if (type === 'stapeldorpel') {
          variant = 'stolpdeuren_draaikiep_stapeldorpel';
        } else if (type === '2vaks') {
          variant = 'stolpdeuren_draaikiep_2vaks';
        } else if (type === 'dicht') {
          variant = 'stolpdeuren_draaikiep_dicht';
        }
        const svgPath = getVariantSvgPath(variant);
        img.src = svgPath;
      }
    });
  }

  function updateStolpdeurenDraaikiepButtons() {
    if (!vakStolpdeurenDraaikiepButtons.length) return;
    vakStolpdeurenDraaikiepButtons.forEach(btn => {
      btn.classList.toggle('selected', !!huidigStolpdeurenDraaikiepType && btn.dataset.stolpdeurenDraaikiepType === huidigStolpdeurenDraaikiepType);
    });
  }

  // Functies voor afwerkingsopties menu
  function openVakAfwerkingsOptiesMenu() {
    if (!vakAfwerkingsOptiesMenu) return;
    
    // Laad bestaande waarden uit state
    huidigGlasType = state.afwerkingsOpties.glasType || null;
    huidigKleurDeurenRamenBinnen = state.afwerkingsOpties.kleurDeurenRamenBinnen || '#F7F9EF';
    huidigKleurDeurenRamenBuiten = state.afwerkingsOpties.kleurDeurenRamenBuiten || '#F7F9EF';
    huidigKleurKozijn = state.afwerkingsOpties.kleurKozijn || '#F7F9EF';
    huidigAfwerking = state.afwerkingsOpties.afwerking || null;
    
    // Eerst display flex zetten om afmetingen te kunnen meten
    vakAfwerkingsOptiesMenu.style.display = 'flex';
    vakAfwerkingsOptiesMenu.style.visibility = 'hidden';
    vakAfwerkingsOptiesMenu.style.transform = 'none'; // Verwijder transform voor betere scroll
    vakAfwerkingsOptiesMenu.style.overflowY = 'auto'; // Zorg voor scroll
    vakAfwerkingsOptiesMenu.style.overflowX = 'hidden'; // Voorkom horizontale scroll
    
    // Gebruik requestAnimationFrame om te wachten tot menu gerenderd is
    requestAnimationFrame(() => {
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // Bereken maximale hoogte voor scroll (85% van viewport, max 800px)
      const maxMenuHeight = Math.min(viewportHeight * 0.85, 800);
      
      // Haal menu afmetingen op
      const menuRect = vakAfwerkingsOptiesMenu.getBoundingClientRect();
      const menuWidth = menuRect.width || 400;
      const actualContentHeight = menuRect.height || 500;
      
      // Gebruik de kleinste waarde: content hoogte of max hoogte
      const menuHeight = Math.min(actualContentHeight, maxMenuHeight);
      
      // Center van viewport
      let menuX = (viewportWidth - menuWidth) / 2;
      let menuY = (viewportHeight - menuHeight) / 2;
      
      // Zorg dat menu niet buiten scherm valt (met marge)
      const margin = 20;
      menuX = Math.max(margin, Math.min(menuX, viewportWidth - menuWidth - margin));
      menuY = Math.max(margin, Math.min(menuY, viewportHeight - menuHeight - margin));
      
      vakAfwerkingsOptiesMenu.style.left = `${menuX}px`;
      vakAfwerkingsOptiesMenu.style.top = `${menuY}px`;
      vakAfwerkingsOptiesMenu.style.maxHeight = `${maxMenuHeight}px`; // Zorg voor scroll
      vakAfwerkingsOptiesMenu.style.height = 'auto'; // Laat content bepalen of scroll nodig is
      vakAfwerkingsOptiesMenu.style.zIndex = '1700';
      vakAfwerkingsOptiesMenu.style.visibility = 'visible';
    });
    
    // Update knoppen en inputs
    updateGlasTypeButtons();
    updateAfwerkingButtons();
    updateKleurInputs();
    updateAfwerkingsOptiesStatus();
  }

  function closeVakAfwerkingsOptiesMenu(resetState = true) {
    if (!vakAfwerkingsOptiesMenu) return;
    vakAfwerkingsOptiesMenu.style.display = 'none';
    if (resetState) {
      // Reset naar default waarden
      huidigGlasType = null;
      huidigKleurDeurenRamenBinnen = '#F7F9EF'; // RAL 9010 standaard
      huidigKleurDeurenRamenBuiten = '#F7F9EF'; // RAL 9010 standaard
      huidigKleurKozijn = '#F7F9EF'; // RAL 9010 standaard
      huidigAfwerking = null;
      updateGlasTypeButtons();
      updateAfwerkingButtons();
      updateKleurInputs();
      // Reset state
      state.afwerkingsOpties = {
        glasType: null,
        kleurDeurenRamenBinnen: '#F7F9EF', // RAL 9010 standaard
        kleurDeurenRamenBuiten: '#F7F9EF', // RAL 9010 standaard
        kleurKozijn: '#F7F9EF', // RAL 9010 standaard
        afwerking: null
      };
    }
    // Reset de auto-opened flag zodat menu weer kan openen als alle vakken opnieuw ingevuld zijn
    afwerkingsOptiesMenuAutoOpened = false;
  }

  function updateGlasTypeButtons() {
    if (glasEnkelglasBtn) glasEnkelglasBtn.classList.toggle('selected', huidigGlasType === 'enkelglas');
    if (glasHrPlusPlusBtn) glasHrPlusPlusBtn.classList.toggle('selected', huidigGlasType === 'hr++');
    if (glasHrPlusPlusPlusBtn) glasHrPlusPlusPlusBtn.classList.toggle('selected', huidigGlasType === 'hr+++');
  }

  function updateAfwerkingButtons() {
    if (afwerkingAfgelaktBtn) afwerkingAfgelaktBtn.classList.toggle('selected', huidigAfwerking === 'afgelakt');
    if (afwerkingGegrondBtn) afwerkingGegrondBtn.classList.toggle('selected', huidigAfwerking === 'alleen-gegrond');
  }

  function updateKleurInputs() {
    // Color picker en text input velden zijn verwijderd, alleen RAL buttons updaten
    updateRalKleurButtons();
  }

  function updateRalKleurButtons() {
    // Update RAL buttons voor binnen
    const ralButtonsBinnen = document.querySelectorAll('.ral-kleur-btn[data-target="binnen"]');
    ralButtonsBinnen.forEach(btn => {
      const kleur = btn.getAttribute('data-kleur');
      if (kleur === huidigKleurDeurenRamenBinnen.toUpperCase() || kleur === huidigKleurDeurenRamenBinnen.toLowerCase()) {
        btn.classList.add('selected');
        btn.style.border = '2px solid var(--accent)';
      } else {
        btn.classList.remove('selected');
        btn.style.border = '1px solid #2b2f36';
      }
    });

    // Update RAL buttons voor buiten
    const ralButtonsBuiten = document.querySelectorAll('.ral-kleur-btn[data-target="buiten"]');
    ralButtonsBuiten.forEach(btn => {
      const kleur = btn.getAttribute('data-kleur');
      if (kleur === huidigKleurDeurenRamenBuiten.toUpperCase() || kleur === huidigKleurDeurenRamenBuiten.toLowerCase()) {
        btn.classList.add('selected');
        btn.style.border = '2px solid var(--accent)';
      } else {
        btn.classList.remove('selected');
        btn.style.border = '1px solid #2b2f36';
      }
    });

    // Update RAL buttons voor kozijn
    const ralButtonsKozijn = document.querySelectorAll('.ral-kleur-btn[data-target="kozijn"]');
    ralButtonsKozijn.forEach(btn => {
      const kleur = btn.getAttribute('data-kleur');
      if (kleur === huidigKleurKozijn.toUpperCase() || kleur === huidigKleurKozijn.toLowerCase()) {
        btn.classList.add('selected');
        btn.style.border = '2px solid var(--accent)';
      } else {
        btn.classList.remove('selected');
        btn.style.border = '1px solid #2b2f36';
      }
    });
  }

  function updateAfwerkingsOptiesStatus() {
    if (!vakAfwerkingsOptiesStatus) return;
    const opties = [];
    if (huidigGlasType) opties.push(`Glas: ${huidigGlasType === 'enkelglas' ? 'Enkelglas' : huidigGlasType.toUpperCase()}`);
    if (huidigAfwerking) opties.push(`Afwerking: ${huidigAfwerking === 'afgelakt' ? 'Afgelakt' : 'Alleen gegrond'}`);
    vakAfwerkingsOptiesStatus.textContent = opties.length > 0 
      ? `Geselecteerd: ${opties.join(', ')}` 
      : 'Configureer de afwerkingsopties voor het kozijn';
  }

  function openVakDeurStapeldorpelMenu(vak, deurType = 'stapeldorpel', baseVariant = 'deur_buiten') {
    if (!vakDeurStapeldorpelMenu || !vak) {
      console.error('openVakDeurStapeldorpelMenu: menu or vak is null', { 
        menu: vakDeurStapeldorpelMenu, 
        vak,
        menuExists: !!document.getElementById('vakDeurStapeldorpelMenu')
      });
      return;
    }
    huidigDeurMenuVak = vak;
    // Sla het type op voor later gebruik - gebruik de juiste variabele op basis van baseVariant
    if (baseVariant === 'stolpdeuren_buiten') {
      huidigStolpdeurenBuitenType = deurType;
    } else if (baseVariant === 'deur_draaikiep') {
      huidigDeurDraaikiepType = deurType;
    } else if (baseVariant === 'stolpdeuren_draaikiep') {
      huidigStolpdeurenDraaikiepType = deurType;
    } else {
      huidigDeurBuitenType = deurType;
    }
    
    // Update menu titel op basis van type
    const titleEl = document.getElementById('vakDeurStapeldorpelTitle');
    const statusEl = document.getElementById('vakDeurStapeldorpelStatus');
    if (titleEl) {
      if (deurType === 'stapeldorpel') {
        titleEl.textContent = 'Stapeldorpel deur opties';
        if (statusEl) statusEl.textContent = 'Configureer de stapeldorpel deur opties';
      } else if (deurType === '2vaks') {
        titleEl.textContent = '2 vaks deur opties';
        if (statusEl) statusEl.textContent = 'Configureer de 2 vaks deur opties';
      }
    }
    
    const centerPos = getSvgCenterPos();
    vakDeurStapeldorpelMenu.style.left = `${centerPos.x}px`;
    vakDeurStapeldorpelMenu.style.top = `${centerPos.y}px`;
    vakDeurStapeldorpelMenu.style.display = 'flex';
    vakDeurStapeldorpelMenu.style.zIndex = '1700';
    
    // Laad bestaande waarden als er al een toewijzing is
    const assign = getVakToewijzing(vak.id);
    const isStapeldorpel = deurType === 'stapeldorpel';
    const is2vaks = deurType === '2vaks';
    const expectedVariant = isStapeldorpel ? `${baseVariant}_stapeldorpel` : `${baseVariant}_2vaks`;
    
    // Behoud huidige deurbeslag waarde als deze al is ingesteld (bij navigatie tussen menu's)
    const behoudDeurbeslag = huidigDeurbeslag;
    
    if (assign && assign.type === 'deur' && assign.variant === expectedVariant) {
      if (isStapeldorpel) {
        huidigStapeldorpelAantal = assign.stapeldorpelAantal || 2;
      } else if (is2vaks) {
        huidigTussendorpelHoogte = assign.tussendorpelHoogte || 250;
        huidig2vaksVak1Type = assign.vak1Type || null;
        huidig2vaksVak2Type = assign.vak2Type || null;
      }
      huidigStapeldorpelRooster = assign.rooster || false;
      // Gebruik deurbeslag uit toewijzing, of behoud huidige waarde als die bestaat
      huidigDeurbeslag = assign.deurbeslag || behoudDeurbeslag || null;
      huidigStapeldorpelOrientation = assign.orientation || null;
      console.log('Deurbeslag geladen uit toewijzing:', { 
        deurbeslag: huidigDeurbeslag, 
        behoudDeurbeslag: behoudDeurbeslag
      });
    } else {
      if (isStapeldorpel) {
        huidigStapeldorpelAantal = 2;
      } else if (is2vaks) {
        huidigTussendorpelHoogte = 250;
        huidig2vaksVak1Type = null;
        huidig2vaksVak2Type = null;
      }
      huidigStapeldorpelRooster = false;
      // Behoud deurbeslag waarde als die al is ingesteld (bij navigatie tussen menu's)
      huidigDeurbeslag = behoudDeurbeslag || null;
      huidigStapeldorpelOrientation = null;
      console.log('Geen toewijzing gevonden, behoud deurbeslag:', { 
        deurbeslag: huidigDeurbeslag,
        behoudDeurbeslag: behoudDeurbeslag
      });
    }
    
    // Toon/verberg de juiste opties op basis van type
    if (stapeldorpelAantalGroup) {
      stapeldorpelAantalGroup.style.display = isStapeldorpel ? 'flex' : 'none';
    }
    if (tussendorpelHoogteGroup) {
      tussendorpelHoogteGroup.style.display = is2vaks ? 'flex' : 'none';
    }
    if (roosterGroup) {
      roosterGroup.style.display = isStapeldorpel ? 'flex' : 'none'; // Alleen voor stapeldorpel
    }
    if (vak1Group) {
      vak1Group.style.display = is2vaks ? 'flex' : 'none'; // Alleen voor 2vaks
    }
    if (vak2Group) {
      vak2Group.style.display = is2vaks ? 'flex' : 'none'; // Alleen voor 2vaks
    }
    
    // Update iconen en buttons voor 2vaks
    if (is2vaks) {
      update2vaksVak1Icons();
      update2vaksVak2Icons();
      update2vaksVak1Buttons();
      update2vaksVak2Buttons();
    }
    
    // Update UI elementen
    if (stapeldorpelAantal) stapeldorpelAantal.value = huidigStapeldorpelAantal;
    if (tussendorpelHoogte) tussendorpelHoogte.value = huidigTussendorpelHoogte;
    if (stapeldorpelRoosterCheckbox) stapeldorpelRoosterCheckbox.checked = huidigStapeldorpelRooster;
    if (is2vaks) {
      update2vaksVak1Buttons();
      update2vaksVak2Buttons();
      update2vaksVak1Icons();
      update2vaksVak2Icons();
    }
    updateDeurbeslagStatus();
  }

  function closeVakDeurStapeldorpelMenu(resetState = true) {
    if (!vakDeurStapeldorpelMenu) return;
    vakDeurStapeldorpelMenu.style.display = 'none';
    if (resetState) {
      huidigStapeldorpelAantal = 2;
      huidigTussendorpelHoogte = 250;
      huidigStapeldorpelRooster = false;
      // Behoud deurbeslag wanneer resetState = false (bij navigatie tussen menu's)
      // Alleen resetten wanneer echt nodig (bij cancel/close)
      huidigDeurbeslag = null;
    }
  }

  function updateDeurbeslagStatus() {
    if (!stapeldorpelDeurbeslagStatus) return;
    console.log('updateDeurbeslagStatus aangeroepen, huidigDeurbeslag:', huidigDeurbeslag);
    if (huidigDeurbeslag) {
      const deurbeslagLabels = {
        standaard: 'Standaard deurbeslag',
        luxe: 'Luxe deurbeslag',
        modern: 'Modern deurbeslag',
        klassiek: 'Klassiek deurbeslag'
      };
      const label = deurbeslagLabels[huidigDeurbeslag] || huidigDeurbeslag;
      stapeldorpelDeurbeslagStatus.textContent = `Gekozen: ${label}`;
      console.log('Deurbeslag status bijgewerkt naar:', label);
    } else {
      stapeldorpelDeurbeslagStatus.textContent = 'Geen deurbeslag gekozen';
      console.log('Geen deurbeslag gekozen');
    }
  }


  function openVakDeurbeslagMenu(vak, _pos, deurType = null) {
    if (!vakDeurbeslagMenu) {
      console.error('openVakDeurbeslagMenu: vakDeurbeslagMenu is null');
      return;
    }
    huidigDeurMenuVak = vak;
    if (deurType) {
      huidigDeurBuitenType = deurType; // Sla het type op voor later gebruik
    }
    const centerPos = _pos || getSvgCenterPos();
    vakDeurbeslagMenu.style.left = `${centerPos.x}px`;
    vakDeurbeslagMenu.style.top = `${centerPos.y}px`;
    vakDeurbeslagMenu.style.display = 'flex';
    vakDeurbeslagMenu.style.zIndex = '1800'; // Zorg dat het boven andere menu's komt
    vakDeurbeslagMenu.style.pointerEvents = 'auto'; // Zorg dat het klikbaar is
    
    console.log('Deurbeslag menu geopend, deurType:', deurType);
    
    // Laad bestaande waarde als er al een deurbeslag is gekozen
    updateDeurbeslagButtons();
    updateDeurbeslagIcons();
    if (vakDeurbeslagStatus) {
      if (huidigDeurbeslag) {
        const deurbeslagLabels = {
          standaard: 'Standaard deurbeslag',
          luxe: 'Luxe deurbeslag',
          modern: 'Modern deurbeslag',
          klassiek: 'Klassiek deurbeslag'
        };
        vakDeurbeslagStatus.textContent = `Geselecteerd: ${deurbeslagLabels[huidigDeurbeslag] || huidigDeurbeslag}`;
      } else {
        vakDeurbeslagStatus.textContent = 'Selecteer een deurbeslag type';
      }
    }
    
    // Update ook de status in het dichte deur menu als dat open is
    if (deurType === 'dicht') {
      updateDeurbeslagStatusDicht();
    }
  }

  function closeVakDeurbeslagMenu(resetState = true) {
    if (!vakDeurbeslagMenu) return;
    vakDeurbeslagMenu.style.display = 'none';
    if (resetState) {
      // Reset niet, want we willen de keuze behouden
    }
  }

  function updateDeurbeslagButtons() {
    if (!vakDeurbeslagVariantButtons.length) return;
    vakDeurbeslagVariantButtons.forEach(btn => {
      btn.classList.toggle('selected', !!huidigDeurbeslag && btn.dataset.deurbeslag === huidigDeurbeslag);
    });
  }

  function updateDeurbeslagIcons() {
    if (!vakDeurbeslagVariantButtons.length) return;
    vakDeurbeslagVariantButtons.forEach(btn => {
      const img = btn.querySelector('img[data-svg-type="deurbeslag"]');
      if (img) {
        const deurbeslagType = btn.dataset.deurbeslag;
        const svgPath = getVariantSvgPath(`deurbeslag_${deurbeslagType}`);
        img.src = svgPath;
      }
    });
  }

  function openVak2vaksVak1Menu(vak) {
    if (!vak2vaksVak1Menu || !vak) return;
    huidigDeurMenuVak = vak;
    const centerPos = getSvgCenterPos();
    vak2vaksVak1Menu.style.left = `${centerPos.x}px`;
    vak2vaksVak1Menu.style.top = `${centerPos.y}px`;
    vak2vaksVak1Menu.style.display = 'flex';
    
    // Laad bestaande waarde als er al een toewijzing is
    const assign = getVakToewijzing(vak.id);
    if (assign && assign.type === 'deur' && assign.variant === 'deur_buiten_2vaks') {
      huidig2vaksVak1Type = assign.vak1Type || null;
    } else {
      huidig2vaksVak1Type = null;
    }
    
    update2vaksVak1Buttons();
    update2vaksVak1Icons();
    if (vak2vaksVak1Status) {
      vak2vaksVak1Status.textContent = 'Selecteer een optie voor bovenste vak';
    }
  }

  function closeVak2vaksVak1Menu(resetState = true) {
    if (!vak2vaksVak1Menu) return;
    vak2vaksVak1Menu.style.display = 'none';
    if (resetState) {
      huidig2vaksVak1Type = null;
      update2vaksVak1Buttons();
    }
  }

  function update2vaksVak1Buttons() {
    // Update knoppen in het ge√Øntegreerde menu (vak1Group)
    if (vak1GlasBtn) {
      vak1GlasBtn.classList.toggle('selected', huidig2vaksVak1Type === 'glas');
    }
    if (vak1BossingBtn) {
      vak1BossingBtn.classList.toggle('selected', huidig2vaksVak1Type === 'bossing');
    }
    if (vak1VlakBtn) {
      vak1VlakBtn.classList.toggle('selected', huidig2vaksVak1Type === 'vlak');
    }
    // Update ook de oude aparte menu knoppen (als ze nog bestaan)
    if (vak2vaksVak1Buttons && vak2vaksVak1Buttons.length) {
      vak2vaksVak1Buttons.forEach(btn => {
        btn.classList.toggle('selected', !!huidig2vaksVak1Type && btn.dataset.vak1Type === huidig2vaksVak1Type);
      });
    }
  }

  function update2vaksVak1Icons() {
    // Update iconen in het ge√Øntegreerde menu (vak1Group)
    const icons = [
      { btn: vak1GlasBtn, type: 'glas' },
      { btn: vak1BossingBtn, type: 'bossing' },
      { btn: vak1VlakBtn, type: 'vlak' }
    ];
    icons.forEach(({ btn, type }) => {
      if (btn) {
        const img = btn.querySelector('img[data-svg-type="vak1"]');
        if (img) {
          const svgPath = getVariantSvgPath(`2vaks_vak1_${type}`);
          img.src = svgPath;
        }
      }
    });
    // Update ook de oude aparte menu iconen (als ze nog bestaan)
    if (vak2vaksVak1Buttons && vak2vaksVak1Buttons.length) {
      vak2vaksVak1Buttons.forEach(btn => {
        const img = btn.querySelector('img[data-svg-type="vak1"]');
        if (img) {
          const vak1Type = btn.dataset.vak1Type;
          const svgPath = getVariantSvgPath(`2vaks_vak1_${vak1Type}`);
          img.src = svgPath;
        }
      });
    }
  }

  function openVak2vaksVak2Menu(vak) {
    if (!vak2vaksVak2Menu || !vak) return;
    huidigDeurMenuVak = vak;
    const centerPos = getSvgCenterPos();
    vak2vaksVak2Menu.style.left = `${centerPos.x}px`;
    vak2vaksVak2Menu.style.top = `${centerPos.y}px`;
    vak2vaksVak2Menu.style.display = 'flex';
    
    // Laad bestaande waarde als er al een toewijzing is
    const assign = getVakToewijzing(vak.id);
    if (assign && assign.type === 'deur' && assign.variant === 'deur_buiten_2vaks') {
      huidig2vaksVak2Type = assign.vak2Type || null;
    } else {
      huidig2vaksVak2Type = null;
    }
    
    update2vaksVak2Buttons();
    update2vaksVak2Icons();
    if (vak2vaksVak2Status) {
      vak2vaksVak2Status.textContent = 'Selecteer een optie voor onderste vak';
    }
  }

  function closeVak2vaksVak2Menu(resetState = true) {
    if (!vak2vaksVak2Menu) return;
    vak2vaksVak2Menu.style.display = 'none';
    if (resetState) {
      huidig2vaksVak2Type = null;
      update2vaksVak2Buttons();
    }
  }

  function update2vaksVak2Buttons() {
    // Update knoppen in het opties menu
    if (vak2GlasBtn) vak2GlasBtn.classList.toggle('selected', huidig2vaksVak2Type === 'glas');
    if (vak2BossingBtn) vak2BossingBtn.classList.toggle('selected', huidig2vaksVak2Type === 'bossing');
    if (vak2VlakBtn) vak2VlakBtn.classList.toggle('selected', huidig2vaksVak2Type === 'vlak');
    // Update ook de oude menu knoppen (als ze nog bestaan)
    if (vak2vaksVak2Buttons && vak2vaksVak2Buttons.length) {
      vak2vaksVak2Buttons.forEach(btn => {
        btn.classList.toggle('selected', !!huidig2vaksVak2Type && btn.dataset.vak2Type === huidig2vaksVak2Type);
      });
    }
  }

  function update2vaksVak2Icons() {
    // Update iconen in het opties menu
    const icons = [
      { btn: vak2GlasBtn, type: 'glas' },
      { btn: vak2BossingBtn, type: 'bossing' },
      { btn: vak2VlakBtn, type: 'vlak' }
    ];
    icons.forEach(({ btn, type }) => {
      if (btn) {
        const img = btn.querySelector('img[data-svg-type="vak2"]');
        if (img) {
          const svgPath = getVariantSvgPath(`2vaks_vak2_${type}`);
          img.src = svgPath;
        }
      }
    });
    // Update ook de oude menu iconen (als ze nog bestaan)
    if (vak2vaksVak2Buttons && vak2vaksVak2Buttons.length) {
      vak2vaksVak2Buttons.forEach(btn => {
        const img = btn.querySelector('img[data-svg-type="vak2"]');
        if (img) {
          const vak2Type = btn.dataset.vak2Type;
          const svgPath = getVariantSvgPath(`2vaks_vak2_${vak2Type}`);
          img.src = svgPath;
        }
      });
    }
  }

  function openVak2vaksVak1Menu(vak) {
    if (!vak2vaksVak1Menu || !vak) return;
    huidigDeurMenuVak = vak;
    const centerPos = getSvgCenterPos();
    vak2vaksVak1Menu.style.left = `${centerPos.x}px`;
    vak2vaksVak1Menu.style.top = `${centerPos.y}px`;
    vak2vaksVak1Menu.style.display = 'flex';
    
    // Laad bestaande waarde als er al een toewijzing is
    const assign = getVakToewijzing(vak.id);
    if (assign && assign.type === 'deur' && assign.variant === 'deur_buiten_2vaks') {
      huidig2vaksVak1Type = assign.vak1Type || null;
    } else {
      huidig2vaksVak1Type = null;
    }
    
    update2vaksVak1Buttons();
    update2vaksVak1Icons();
    if (vak2vaksVak1Status) {
      vak2vaksVak1Status.textContent = 'Selecteer een optie voor bovenste vak';
    }
  }

  function closeVak2vaksVak1Menu(resetState = true) {
    if (!vak2vaksVak1Menu) return;
    vak2vaksVak1Menu.style.display = 'none';
    if (resetState) {
      huidig2vaksVak1Type = null;
      update2vaksVak1Buttons();
    }
  }

  function update2vaksVak1Buttons() {
    // Update knoppen in het ge√Øntegreerde menu (vak1Group)
    if (vak1GlasBtn) {
      vak1GlasBtn.classList.toggle('selected', huidig2vaksVak1Type === 'glas');
    }
    if (vak1BossingBtn) {
      vak1BossingBtn.classList.toggle('selected', huidig2vaksVak1Type === 'bossing');
    }
    if (vak1VlakBtn) {
      vak1VlakBtn.classList.toggle('selected', huidig2vaksVak1Type === 'vlak');
    }
    // Update ook de oude aparte menu knoppen (als ze nog bestaan)
    if (vak2vaksVak1Buttons && vak2vaksVak1Buttons.length) {
      vak2vaksVak1Buttons.forEach(btn => {
        btn.classList.toggle('selected', !!huidig2vaksVak1Type && btn.dataset.vak1Type === huidig2vaksVak1Type);
      });
    }
  }

  function update2vaksVak1Icons() {
    // Update iconen in het ge√Øntegreerde menu (vak1Group)
    const icons = [
      { btn: vak1GlasBtn, type: 'glas' },
      { btn: vak1BossingBtn, type: 'bossing' },
      { btn: vak1VlakBtn, type: 'vlak' }
    ];
    icons.forEach(({ btn, type }) => {
      if (btn) {
        const img = btn.querySelector('img[data-svg-type="vak1"]');
        if (img) {
          const svgPath = getVariantSvgPath(`2vaks_vak1_${type}`);
          img.src = svgPath;
        }
      }
    });
    // Update ook de oude aparte menu iconen (als ze nog bestaan)
    if (vak2vaksVak1Buttons && vak2vaksVak1Buttons.length) {
      vak2vaksVak1Buttons.forEach(btn => {
        const img = btn.querySelector('img[data-svg-type="vak1"]');
        if (img) {
          const vak1Type = btn.dataset.vak1Type;
          const svgPath = getVariantSvgPath(`2vaks_vak1_${vak1Type}`);
          img.src = svgPath;
        }
      });
    }
  }

  function openVak2vaksVak2Menu(vak) {
    if (!vak2vaksVak2Menu || !vak) return;
    huidigDeurMenuVak = vak;
    const centerPos = getSvgCenterPos();
    vak2vaksVak2Menu.style.left = `${centerPos.x}px`;
    vak2vaksVak2Menu.style.top = `${centerPos.y}px`;
    vak2vaksVak2Menu.style.display = 'flex';
    
    // Laad bestaande waarde als er al een toewijzing is
    const assign = getVakToewijzing(vak.id);
    if (assign && assign.type === 'deur' && assign.variant === 'deur_buiten_2vaks') {
      huidig2vaksVak2Type = assign.vak2Type || null;
    } else {
      huidig2vaksVak2Type = null;
    }
    
    update2vaksVak2Buttons();
    update2vaksVak2Icons();
    if (vak2vaksVak2Status) {
      vak2vaksVak2Status.textContent = 'Selecteer een optie voor onderste vak';
    }
  }

  function closeVak2vaksVak2Menu(resetState = true) {
    if (!vak2vaksVak2Menu) return;
    vak2vaksVak2Menu.style.display = 'none';
    if (resetState) {
      huidig2vaksVak2Type = null;
      update2vaksVak2Buttons();
    }
  }

  function update2vaksVak2Buttons() {
    // Update knoppen in het opties menu
    if (vak2GlasBtn) vak2GlasBtn.classList.toggle('selected', huidig2vaksVak2Type === 'glas');
    if (vak2BossingBtn) vak2BossingBtn.classList.toggle('selected', huidig2vaksVak2Type === 'bossing');
    if (vak2VlakBtn) vak2VlakBtn.classList.toggle('selected', huidig2vaksVak2Type === 'vlak');
    // Update ook de oude menu knoppen (als ze nog bestaan)
    if (vak2vaksVak2Buttons && vak2vaksVak2Buttons.length) {
      vak2vaksVak2Buttons.forEach(btn => {
        btn.classList.toggle('selected', !!huidig2vaksVak2Type && btn.dataset.vak2Type === huidig2vaksVak2Type);
      });
    }
  }

  function update2vaksVak2Icons() {
    // Update iconen in het opties menu
    const icons = [
      { btn: vak2GlasBtn, type: 'glas' },
      { btn: vak2BossingBtn, type: 'bossing' },
      { btn: vak2VlakBtn, type: 'vlak' }
    ];
    icons.forEach(({ btn, type }) => {
      if (btn) {
        const img = btn.querySelector('img[data-svg-type="vak2"]');
        if (img) {
          const svgPath = getVariantSvgPath(`2vaks_vak2_${type}`);
          img.src = svgPath;
        }
      }
    });
    // Update ook de oude menu iconen (als ze nog bestaan)
    if (vak2vaksVak2Buttons && vak2vaksVak2Buttons.length) {
      vak2vaksVak2Buttons.forEach(btn => {
        const img = btn.querySelector('img[data-svg-type="vak2"]');
        if (img) {
          const vak2Type = btn.dataset.vak2Type;
          const svgPath = getVariantSvgPath(`2vaks_vak2_${vak2Type}`);
          img.src = svgPath;
        }
      });
    }
  }

  function openVakStapeldorpelOrientationMenu(vak) {
    if (!vakStapeldorpelOrientationMenu || !vak) return;
    huidigDeurMenuVak = vak;
    const centerPos = getSvgCenterPos();
    vakStapeldorpelOrientationMenu.style.left = `${centerPos.x}px`;
    vakStapeldorpelOrientationMenu.style.top = `${centerPos.y}px`;
    vakStapeldorpelOrientationMenu.style.display = 'flex';
    
    // Laad bestaande waarde als er al een toewijzing is
    const assign = getVakToewijzing(vak.id);
    // Bepaal deurType en baseVariant op basis van welke variabele is ingesteld
    // Check eerst op normale deuren (deur_buiten), dan op andere varianten
    let deurType = 'stapeldorpel';
    let baseVariant = 'deur_buiten';
    
    if (huidigDeurBuitenType) {
      // Normale buitendraaiende deur
      baseVariant = 'deur_buiten';
      deurType = huidigDeurBuitenType;
    } else if (huidigStolpdeurenBuitenType) {
      // Buitendraaiende stolpdeuren
      baseVariant = 'stolpdeuren_buiten';
      deurType = huidigStolpdeurenBuitenType;
    } else if (huidigDeurDraaikiepType) {
      // Draaikiep deur
      baseVariant = 'deur_draaikiep';
      deurType = huidigDeurDraaikiepType;
    } else if (huidigStolpdeurenDraaikiepType) {
      // Stolpdraaikiep deuren
      baseVariant = 'stolpdeuren_draaikiep';
      deurType = huidigStolpdeurenDraaikiepType;
    }
    const expectedVariant = deurType === 'stapeldorpel' ? `${baseVariant}_stapeldorpel` : 
                            deurType === '2vaks' ? `${baseVariant}_2vaks` : 
                            deurType === 'dicht' ? `${baseVariant}_dicht` : `${baseVariant}_stapeldorpel`;
    
    if (assign && assign.type === 'deur' && assign.variant === expectedVariant) {
      huidigStapeldorpelOrientation = assign.orientation || null;
    } else {
      huidigStapeldorpelOrientation = null;
    }
    
    updateStapeldorpelOrientationButtons();
    updateStapeldorpelOrientationIcons();
    updateStapeldorpelOrientationLabels(baseVariant);
    if (vakStapeldorpelOrientationStatus) {
      const deurTypeLabel = deurType === 'dicht' ? 'dichte deur' : 
                            deurType === '2vaks' ? '2 vaks deur' : 
                            'stapeldorpel deur';
      vakStapeldorpelOrientationStatus.textContent = `Selecteer de draairichting voor de ${deurTypeLabel}`;
    }
  }

  function closeVakStapeldorpelOrientationMenu(resetState = true) {
    if (!vakStapeldorpelOrientationMenu) return;
    vakStapeldorpelOrientationMenu.style.display = 'none';
    if (resetState) {
      huidigStapeldorpelOrientation = null;
      updateStapeldorpelOrientationButtons();
      // Reset labels naar standaard
      updateStapeldorpelOrientationLabels('deur_buiten');
    }
  }

  function updateStapeldorpelOrientationButtons() {
    if (!vakStapeldorpelOrientationButtons.length) return;
    vakStapeldorpelOrientationButtons.forEach(btn => {
      btn.classList.toggle('selected', !!huidigStapeldorpelOrientation && btn.dataset.stapeldorpelOrientation === huidigStapeldorpelOrientation);
    });
  }

  function updateStapeldorpelOrientationLabels(baseVariant) {
    if (!vakStapeldorpelOrientationButtons.length) return;
    // Alleen voor stolpdeuren_buiten en stolpdeuren_draaikiep: gebruik "actief"
    // Voor alle andere varianten (deur_buiten, deur_draaikiep): gebruik normale labels
    const isStolpdeuren = baseVariant === 'stolpdeuren_buiten' || baseVariant === 'stolpdeuren_draaikiep';
    
    vakStapeldorpelOrientationButtons.forEach(btn => {
      const span = btn.querySelector('span');
      if (span) {
        const orientation = btn.dataset.stapeldorpelOrientation;
        if (isStolpdeuren) {
          // Voor stolpdeuren: "Links actief" en "Rechts actief"
          if (orientation === 'links') {
            span.textContent = 'Links actief';
          } else if (orientation === 'rechts') {
            span.textContent = 'Rechts actief';
          }
        } else {
          // Voor normale deuren: "Links" en "Rechts"
          if (orientation === 'links') {
            span.textContent = 'Links';
          } else if (orientation === 'rechts') {
            span.textContent = 'Rechts';
          }
        }
      }
    });
  }

  function updateStapeldorpelOrientationIcons() {
    if (!vakStapeldorpelOrientationButtons.length) return;
    vakStapeldorpelOrientationButtons.forEach(btn => {
      const img = btn.querySelector('img[data-svg-type="stapeldorpel-orientation"]');
      if (img) {
        const orientation = btn.dataset.stapeldorpelOrientation;
        // Gebruik dezelfde SVG path logica als voor andere orientaties
        if (orientation === 'links') {
          img.src = getVariantSvgPath('deur_buiten_stapeldorpel', 'links');
        } else if (orientation === 'rechts') {
          img.src = getVariantSvgPath('deur_buiten_stapeldorpel', 'rechts');
        }
      }
    });
  }

  function openVakRaamExtraMenu(vak) {
    if (!vakRaamExtraMenu || !vak) return;
    const centerPos = getSvgCenterPos();
    vakRaamExtraMenu.style.left = `${centerPos.x}px`;
    vakRaamExtraMenu.style.top = `${centerPos.y}px`;
    vakRaamExtraMenu.style.display = 'flex';
    
    // Laad bestaande waarden als er al een toewijzing is
    const assign = getVakToewijzing(vak.id);
    const isKlepraam = (huidigRaamVariant === 'klepraam') || 
                       (assign && assign.type === 'raam' && (assign.variant === 'klepraam_open' || assign.variant === 'klepraam_vast'));
    
    if (assign && assign.type === 'raam') {
      huidigRooster = assign.rooster || false;
      huidigHor = assign.hor || false;
      huidigBeslagKleur = assign.beslagKleur || 'f1';
      huidigBeslagKleurWaarde = assign.beslagKleurWaarde || '#8B7355';
    } else {
      huidigRooster = false;
      huidigHor = false;
      huidigBeslagKleur = 'f1';
      huidigBeslagKleurWaarde = '#8B7355';
    }
    
    // Update UI elementen
    if (roosterCheckbox) roosterCheckbox.checked = huidigRooster;
    if (horCheckbox) {
      horCheckbox.checked = huidigHor;
      // Verberg hor checkbox voor klepraam varianten
      const horGroup = horCheckbox.closest('.extra-option-group');
      if (horGroup) {
        horGroup.style.display = isKlepraam ? 'none' : 'flex';
        // Zorg ervoor dat de checkbox weer zichtbaar is voor andere varianten
        if (!isKlepraam && horGroup.style.display === 'none') {
          horGroup.style.display = 'flex';
        }
      }
    }
    if (beslagF1Btn) beslagF1Btn.classList.toggle('selected', huidigBeslagKleur === 'f1');
    if (beslagAndersBtn) beslagAndersBtn.classList.toggle('selected', huidigBeslagKleur === 'anders');
    if (beslagKleurPicker) beslagKleurPicker.style.display = huidigBeslagKleur === 'anders' ? 'flex' : 'none';
    if (beslagKleurInput) beslagKleurInput.value = huidigBeslagKleurWaarde;
  }

  function closeVakRaamExtraMenu(resetState = true) {
    if (!vakRaamExtraMenu) return;
    vakRaamExtraMenu.style.display = 'none';
    if (resetState) {
      huidigRooster = false;
      huidigHor = false;
      // Reset klepraam type niet, want dat moet behouden blijven tot bevestiging
      huidigBeslagKleur = 'f1';
      huidigBeslagKleurWaarde = '#8B7355';
    }
  }

  function normalizeToewijzingValue(value) {
    if (value === null || value === undefined) return null;
    if (typeof value === 'string') {
      const trimmed = value.trim();
      if (!trimmed) return null;
      if (trimmed.startsWith('raam_') || trimmed.startsWith('raam:')) {
        const variant = trimmed.split(/[:_]/)[1];
        if (variant) {
          return { type: 'raam', variant };
        }
      }
      if (['draairaam_buiten','stolpraam_buiten','draaikiep','stolpraam_draaikiep','klepraam','klepraam_open','klepraam_vast'].includes(trimmed)) {
        return { type: 'raam', variant: trimmed };
      }
      if (['glas_vast','glas_vast_stapel'].includes(trimmed)) {
        return { type: 'glas', variant: trimmed };
      }
      return { type: trimmed };
    }
    if (typeof value === 'object') {
      const type = value.type || value.value;
      if (!type) return null;
      const normalized = { type };
      if (type === 'raam') {
        if (value.variant) normalized.variant = value.variant;
        if (value.orientation) normalized.orientation = value.orientation;
        if (value.rooster !== undefined) normalized.rooster = toBoolean(value.rooster);
        if (value.hor !== undefined) normalized.hor = toBoolean(value.hor);
        if (value.beslagKleur) normalized.beslagKleur = value.beslagKleur;
        if (value.beslagKleurWaarde) normalized.beslagKleurWaarde = value.beslagKleurWaarde;
      }
      if (type === 'deur') {
        if (value.variant) normalized.variant = value.variant;
        if (value.orientation) normalized.orientation = value.orientation;
      }
      if (type === 'glas') {
        if (value.variant) normalized.variant = value.variant;
        if (value.rooster !== undefined) normalized.rooster = toBoolean(value.rooster);
      }
      return normalized;
    }
    return null;
  }

  function getVakToewijzing(vakId) {
    const raw = state.vakkenToewijzingen[vakId];
    const normalized = normalizeToewijzingValue(raw);
    return normalized ? { ...normalized } : null;
  }

  function setVakToewijzing(vakId, waarde) {
    const normalized = normalizeToewijzingValue(waarde);
    if (!normalized) {
      delete state.vakkenToewijzingen[vakId];
    } else {
      state.vakkenToewijzingen[vakId] = normalized;
    }
    updatePrijsOverzicht();
  }

  // Prijs berekening functies
  function formatPrijs(bedrag) {
    return '‚Ç¨' + bedrag.toFixed(2).replace('.', ',');
  }

  function berekenPrijs() {
    const prijzen = {
      basisKozijn: 0,
      tussenstijlen: 0,
      tussendorpels: 0,
      vakken: [],
      afwerking: 0,
      totaal: 0
    };

    // Basis kozijn prijs (per m¬≤)
    const oppervlakteM2 = (state.Wmm / 1000) * (state.Hmm / 1000);
    prijzen.basisKozijn = oppervlakteM2 * 150; // ‚Ç¨150 per m¬≤

    // Tussenstijlen (‚Ç¨25 per stuk)
    prijzen.tussenstijlen = state.tussenStijlen.length * 25;

    // Tussendorpels (‚Ç¨25 per stuk)
    prijzen.tussendorpels = state.tussenDorpels.length * 25;

    // Vakken prijzen
    state.vakken.forEach(vak => {
      const toewijzing = getVakToewijzing(vak.id);
      if (!toewijzing) return;

      let vakPrijs = 0;
      const vakOppervlakteM2 = (vak.breedte / 1000) * (vak.hoogte / 1000);

      if (toewijzing.type === 'raam') {
        // Ramen: ‚Ç¨80 per m¬≤
        vakPrijs = vakOppervlakteM2 * 80;
      } else if (toewijzing.type === 'deur') {
        // Deuren: ‚Ç¨120 per m¬≤
        vakPrijs = vakOppervlakteM2 * 120;
      } else if (toewijzing.type === 'glas') {
        // Glas: ‚Ç¨60 per m¬≤
        vakPrijs = vakOppervlakteM2 * 60;
      }

      if (vakPrijs > 0) {
        prijzen.vakken.push({
          id: vak.id,
          type: toewijzing.type,
          variant: toewijzing.variant || '',
          prijs: vakPrijs
        });
      }
    });

    // Afwerkingsopties
    if (state.afwerkingsOpties.glasType) {
      const glasOppervlakte = prijzen.vakken.reduce((sum, v) => {
        const vak = state.vakken.find(vak => vak.id === v.id);
        if (!vak) return sum;
        return sum + ((vak.breedte / 1000) * (vak.hoogte / 1000));
      }, 0);
      
      if (state.afwerkingsOpties.glasType === 'hr++') {
        prijzen.afwerking += glasOppervlakte * 15; // ‚Ç¨15 per m¬≤ voor HR++
      } else if (state.afwerkingsOpties.glasType === 'hr+++') {
        prijzen.afwerking += glasOppervlakte * 25; // ‚Ç¨25 per m¬≤ voor HR+++
      }
    }

    if (state.afwerkingsOpties.afwerking === 'afgelakt') {
      prijzen.afwerking += oppervlakteM2 * 20; // ‚Ç¨20 per m¬≤ voor afgelakt
    }

    // Totaal
    prijzen.totaal = prijzen.basisKozijn + prijzen.tussenstijlen + prijzen.tussendorpels +
                     prijzen.vakken.reduce((sum, v) => sum + v.prijs, 0) + prijzen.afwerking;

    return prijzen;
  }

  function updatePrijsOverzicht() {
    const prijsContent = document.getElementById('prijsContent');
    if (!prijsContent) return;

    const prijzen = berekenPrijs();

    // Update basis kozijn
    const prijsBasisKozijn = document.getElementById('prijsBasisKozijn');
    if (prijsBasisKozijn) prijsBasisKozijn.textContent = formatPrijs(prijzen.basisKozijn);

    // Update tussenstijlen
    const prijsTussenstijlen = document.getElementById('prijsTussenstijlen');
    if (prijsTussenstijlen) {
      prijsTussenstijlen.textContent = formatPrijs(prijzen.tussenstijlen);
      prijsTussenstijlen.parentElement.style.display = state.tussenStijlen.length > 0 ? 'flex' : 'none';
    }

    // Update tussendorpels
    const prijsTussendorpels = document.getElementById('prijsTussendorpels');
    if (prijsTussendorpels) {
      prijsTussendorpels.textContent = formatPrijs(prijzen.tussendorpels);
      prijsTussendorpels.parentElement.style.display = state.tussenDorpels.length > 0 ? 'flex' : 'none';
    }

    // Update vakken
    const prijsVakken = document.getElementById('prijsVakken');
    if (prijsVakken) {
      if (prijzen.vakken.length === 0) {
        prijsVakken.innerHTML = '<div class="prijsItem"><span class="prijsItemLabel" style="color:var(--muted);font-size:12px">Geen vakken toegewezen</span></div>';
      } else {
        prijsVakken.innerHTML = prijzen.vakken.map((v, idx) => {
          const vak = state.vakken.find(vak => vak.id === v.id);
          const toewijzing = getVakToewijzing(v.id);
          const label = toewijzing ? `${toewijzing.type} ${idx + 1}` : `Vak ${idx + 1}`;
          return `<div class="prijsItem">
            <span class="prijsItemLabel">${label}</span>
            <span class="prijsItemWaarde">${formatPrijs(v.prijs)}</span>
          </div>`;
        }).join('');
      }
    }

    // Update afwerking
    const prijsAfwerking = document.getElementById('prijsAfwerking');
    if (prijsAfwerking) {
      if (prijzen.afwerking === 0) {
        prijsAfwerking.innerHTML = '<div class="prijsItem"><span class="prijsItemLabel" style="color:var(--muted);font-size:12px">Geen afwerking geselecteerd</span></div>';
      } else {
        let afwerkingHTML = '';
        if (state.afwerkingsOpties.glasType) {
          const glasTypeLabel = state.afwerkingsOpties.glasType === 'hr++' ? 'HR++' : 
                                state.afwerkingsOpties.glasType === 'hr+++' ? 'HR+++' : 'Enkelglas';
          afwerkingHTML += `<div class="prijsSubItem">
            <span>Glas type: ${glasTypeLabel}</span>
          </div>`;
        }
        if (state.afwerkingsOpties.afwerking) {
          const afwerkingLabel = state.afwerkingsOpties.afwerking === 'afgelakt' ? 'Afgelakt' : 'Alleen gegrond';
          afwerkingHTML += `<div class="prijsSubItem">
            <span>Afwerking: ${afwerkingLabel}</span>
          </div>`;
        }
        prijsAfwerking.innerHTML = `<div class="prijsItem">
          <span class="prijsItemLabel">Afwerking</span>
          <span class="prijsItemWaarde">${formatPrijs(prijzen.afwerking)}</span>
        </div>${afwerkingHTML}`;
      }
    }

    // Haal aantallen op en bereken totaal met vermenigvuldiging
    const aantalGetekendInput = document.getElementById('aantalGetekend');
    const aantalGespiegeldInput = document.getElementById('aantalGespiegeld');
    const aantalGetekend = aantalGetekendInput ? parseInt(aantalGetekendInput.value) || 0 : 1;
    const aantalGespiegeld = aantalGespiegeldInput ? parseInt(aantalGespiegeldInput.value) || 0 : 0;
    
    // Bereken totaal: (getekend + gespiegeld) * basisprijs
    const totaalAantal = aantalGetekend + aantalGespiegeld;
    const totaalPrijs = prijzen.totaal * totaalAantal;
    
    // Update totaal
    const prijsTotaal = document.getElementById('prijsTotaal');
    if (prijsTotaal) prijsTotaal.textContent = formatPrijs(totaalPrijs);
    
    // Bewaar huidige prijzen voor winkelwagen (zonder vermenigvuldiging)
    state.huidigePrijzen = prijzen;
    state.huidigeTotaalPrijs = totaalPrijs; // Bewaar totaal met vermenigvuldiging
  }

  // Winkelwagen functionaliteit
  const WINKELWAGEN_KEY = 'kozijn_winkelwagen';
  
  function haalWinkelwagenOp() {
    try {
      const opgeslagen = localStorage.getItem(WINKELWAGEN_KEY);
      return opgeslagen ? JSON.parse(opgeslagen) : [];
    } catch (e) {
      return [];
    }
  }

  function slaWinkelwagenOp(items) {
    try {
      localStorage.setItem(WINKELWAGEN_KEY, JSON.stringify(items));
      updateWinkelwagenBadge();
    } catch (e) {
      console.error('Fout bij opslaan winkelwagen:', e);
    }
  }

  async function voegToeAanWinkelwagen() {
    if (!state.vakken || state.vakken.length === 0) {
      alert('‚ö†Ô∏è Voeg eerst vakken toe aan het kozijn voordat je het aan de winkelwagen toevoegt.');
      return;
    }

    // Toon laad indicator
    const btnToevoegen = document.getElementById('btnToevoegenAanWinkelwagen');
    const oorspronkelijkeTekst = btnToevoegen ? btnToevoegen.textContent : '';
    if (btnToevoegen) {
      btnToevoegen.disabled = true;
      btnToevoegen.textContent = '‚è≥ Tekening wordt opgeslagen...';
    }

    try {
      // Zorg dat prijzen berekend zijn
      if (!state.huidigePrijzen) {
        berekenPrijs();
      }
      const prijzen = state.huidigePrijzen;
      
      // Maak snapshot van het canvas
      let thumbnailDataUrl = '';
      if (window.html2canvas) {
        const canvasWrap = document.querySelector('.canvasWrap');
        if (canvasWrap) {
          const canvas = await html2canvas(canvasWrap, {
            backgroundColor: '#0f1318',
            scale: 0.5, // Kleinere schaal voor thumbnail
            logging: false,
            useCORS: true,
            width: canvasWrap.offsetWidth,
            height: canvasWrap.offsetHeight
          });
          thumbnailDataUrl = canvas.toDataURL('image/png');
        }
      }
      
      // Haal aantallen op uit input velden
      const aantalGetekendInput = document.getElementById('aantalGetekend');
      const aantalGespiegeldInput = document.getElementById('aantalGespiegeld');
      const aantalGetekend = aantalGetekendInput ? parseInt(aantalGetekendInput.value) || 0 : 1;
      const aantalGespiegeld = aantalGespiegeldInput ? parseInt(aantalGespiegeldInput.value) || 0 : 0;
      const totaalAantal = aantalGetekend + aantalGespiegeld;
      
      const winkelwagen = haalWinkelwagenOp();
      
      // Maak een beschrijving van het kozijn
      const vakkenDetails = state.vakken.map(vak => {
        const toewijzing = getVakToewijzing(vak.id);
        const beschrijving = toewijzing ? formatToewijzing(toewijzing) : 'Niet toegewezen';
        return {
          id: vak.id,
          type: toewijzing?.type || 'geen',
          variant: toewijzing?.variant || '',
          beschrijving: beschrijving,
          maten: `${Math.round(vak.breedte)}mm √ó ${Math.round(vak.hoogte)}mm`
        };
      });

      // Bereken prijs met aantallen
      const basisPrijs = prijzen.totaal;
      const totaalPrijs = basisPrijs * totaalAantal;

      const item = {
        id: Date.now(),
        type: 'kozijn',
        titel: `Kozijn ${state.Wmm}mm √ó ${state.Hmm}mm`,
        afmetingen: `${state.Wmm}mm √ó ${state.Hmm}mm`,
        ekosietOnderdorpel: state.ekosietOnderdorpel,
        tussenstijlen: state.tussenStijlen.length,
        tussendorpels: state.tussenDorpels.length,
        aantalGetekend: aantalGetekend,
        aantalGespiegeld: aantalGespiegeld,
        totaalAantal: totaalAantal,
        vakken: vakkenDetails,
        afwerkingsOpties: { ...state.afwerkingsOpties },
        thumbnail: thumbnailDataUrl, // Voeg thumbnail toe
        prijs: totaalPrijs, // Prijs met aantallen
        basisPrijs: basisPrijs, // Basisprijs zonder vermenigvuldiging
        prijsDetails: {
          basisKozijn: prijzen.basisKozijn,
          tussenstijlen: prijzen.tussenstijlen,
          tussendorpels: prijzen.tussendorpels,
          vakken: prijzen.vakken,
          afwerking: prijzen.afwerking
        },
        datum: new Date().toISOString()
      };

      winkelwagen.push(item);
      slaWinkelwagenOp(winkelwagen);
      alert('‚úÖ Kozijn toegevoegd aan winkelwagen!');
      updateWinkelwagenBadge();
    } catch (error) {
      console.error('Fout bij toevoegen aan winkelwagen:', error);
      alert('‚ùå Fout bij toevoegen aan winkelwagen: ' + error.message);
    } finally {
      if (btnToevoegen) {
        btnToevoegen.disabled = false;
        btnToevoegen.textContent = oorspronkelijkeTekst;
      }
    }
  }

  function verwijderUitWinkelwagen(itemId) {
    const winkelwagen = haalWinkelwagenOp();
    const gefilterd = winkelwagen.filter(item => item.id !== itemId);
    slaWinkelwagenOp(gefilterd);
    toonWinkelwagen();
  }

  function leegWinkelwagen() {
    if (confirm('Weet je zeker dat je de winkelwagen wilt legen?')) {
      slaWinkelwagenOp([]);
      toonWinkelwagen();
      alert('‚úÖ Winkelwagen geleegd');
    }
  }

  function toonWinkelwagen() {
    const winkelwagen = haalWinkelwagenOp();
    const winkelwagenItems = document.getElementById('winkelwagenItems');
    const winkelwagenLeeg = document.getElementById('winkelwagenLeeg');
    const winkelwagenTotaal = document.getElementById('winkelwagenTotaal');
    const winkelwagenTotaalWaarde = document.getElementById('winkelwagenTotaalWaarde');

    if (winkelwagen.length === 0) {
      if (winkelwagenLeeg) winkelwagenLeeg.style.display = 'block';
      if (winkelwagenItems) winkelwagenItems.innerHTML = '';
      if (winkelwagenTotaal) winkelwagenTotaal.style.display = 'none';
      return;
    }

    if (winkelwagenLeeg) winkelwagenLeeg.style.display = 'none';
    if (winkelwagenTotaal) winkelwagenTotaal.style.display = 'flex';

    if (winkelwagenItems) {
      winkelwagenItems.innerHTML = winkelwagen.map(item => {
        
        let vakkenHTML = '';
        if (item.vakken && item.vakken.length > 0) {
          vakkenHTML = '<div class="winkelwagenItemDetails">';
          vakkenHTML += '<strong style="color:var(--fg);font-size:12px;margin-bottom:4px;display:block">Vakken:</strong>';
          item.vakken.forEach(vak => {
            vakkenHTML += `<span>‚Ä¢ ${vak.beschrijving} - ${vak.maten}</span>`;
          });
          vakkenHTML += '</div>';
        }

        let afwerkingHTML = '';
        if (item.afwerkingsOpties) {
          const opties = [];
          if (item.afwerkingsOpties.glasType) {
            const glasTypeLabel = item.afwerkingsOpties.glasType === 'hr++' ? 'HR++' : 
                                 item.afwerkingsOpties.glasType === 'hr+++' ? 'HR+++' : 'Enkelglas';
            opties.push(`Glas: ${glasTypeLabel}`);
          }
          if (item.afwerkingsOpties.afwerking) {
            const afwerkingLabel = item.afwerkingsOpties.afwerking === 'afgelakt' ? 'Afgelakt' : 'Alleen gegrond';
            opties.push(`Afwerking: ${afwerkingLabel}`);
          }
          if (item.afwerkingsOpties.kleurDeurenRamenBinnen) {
            opties.push(`Kleur binnen: ${item.afwerkingsOpties.kleurDeurenRamenBinnen}`);
          }
          if (item.afwerkingsOpties.kleurDeurenRamenBuiten) {
            opties.push(`Kleur buiten: ${item.afwerkingsOpties.kleurDeurenRamenBuiten}`);
          }
          if (item.afwerkingsOpties.kleurKozijn) {
            opties.push(`Kleur kozijn: ${item.afwerkingsOpties.kleurKozijn}`);
          }
          if (opties.length > 0) {
            afwerkingHTML = `<div class="winkelwagenItemDetails" style="margin-top:8px">
              <strong style="color:var(--fg);font-size:12px;margin-bottom:4px;display:block">Afwerking:</strong>
              ${opties.map(opt => `<span>‚Ä¢ ${opt}</span>`).join('')}
            </div>`;
          }
        }

        const thumbnailHTML = item.thumbnail 
          ? `<div class="winkelwagenItemThumbnail"><img src="${item.thumbnail}" alt="Kozijn tekening" /></div>`
          : '<div class="winkelwagenItemThumbnail" style="color:var(--muted);font-size:12px;text-align:center;padding:20px">Geen preview</div>';
        
        // Bepaal type en basis prijs
        const isKozijn = item.type === 'kozijn';
        const isLosProduct = item.type === 'glas' || item.type === 'raam' || item.type === 'deur';
        
        let basisPrijs, totaalAantal, aantallenHTML;
        
        if (isKozijn) {
          // Kozijn met getekend/gespiegeld
          basisPrijs = item.basisPrijs || (item.prijs / (item.totaalAantal || 1));
          const aantalGetekend = item.aantalGetekend !== undefined ? item.aantalGetekend : 1;
          const aantalGespiegeld = item.aantalGespiegeld !== undefined ? item.aantalGespiegeld : 0;
          totaalAantal = aantalGetekend + aantalGespiegeld;
          
          aantallenHTML = `<div class="winkelwagenItemDetails" style="margin-top:8px;margin-bottom:8px">
                <strong style="color:var(--fg);font-size:12px;margin-bottom:4px;display:block">Aantallen:</strong>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                  <span style="min-width:80px">Getekend:</span>
                  <input type="number" class="winkelwagenAantalInput" data-item-id="${item.id}" data-type="getekend" min="0" value="${aantalGetekend}" style="width:60px;padding:4px 6px;border:1px solid #2b2f36;border-radius:6px;background:#12161b;color:var(--fg);font-size:12px;text-align:center" />
                </div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                  <span style="min-width:80px">Gespiegeld:</span>
                  <input type="number" class="winkelwagenAantalInput" data-item-id="${item.id}" data-type="gespiegeld" min="0" value="${aantalGespiegeld}" style="width:60px;padding:4px 6px;border:1px solid #2b2f36;border-radius:6px;background:#12161b;color:var(--fg);font-size:12px;text-align:center" />
                </div>
                <div style="margin-top:4px;padding-top:4px;border-top:1px solid #2b2f36">
                  <span style="color:var(--accent);font-weight:600;font-size:12px">Totaal: ${totaalAantal} √ó ${formatPrijs(basisPrijs)} = <span id="winkelwagenItemPrijs_${item.id}">${formatPrijs(basisPrijs * totaalAantal)}</span></span>
                </div>
              </div>`;
        } else if (isLosProduct) {
          // Los product met aantal
          basisPrijs = item.basisPrijs || item.prijs;
          totaalAantal = item.aantal || 1;
          
          aantallenHTML = `<div class="winkelwagenItemDetails" style="margin-top:8px;margin-bottom:8px">
                <strong style="color:var(--fg);font-size:12px;margin-bottom:4px;display:block">Aantal:</strong>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                  <input type="number" class="winkelwagenAantalInput" data-item-id="${item.id}" data-type="aantal" min="1" value="${totaalAantal}" style="width:60px;padding:4px 6px;border:1px solid #2b2f36;border-radius:6px;background:#12161b;color:var(--fg);font-size:12px;text-align:center" />
                </div>
                <div style="margin-top:4px;padding-top:4px;border-top:1px solid #2b2f36">
                  <span style="color:var(--accent);font-weight:600;font-size:12px">Totaal: ${totaalAantal} √ó ${formatPrijs(basisPrijs)} = <span id="winkelwagenItemPrijs_${item.id}">${formatPrijs(basisPrijs * totaalAantal)}</span></span>
                </div>
              </div>`;
        } else {
          basisPrijs = item.prijs;
          totaalAantal = 1;
          aantallenHTML = '';
        }
        
        // Details voor losse producten
        let losProductDetails = '';
        if (item.type === 'glas') {
          losProductDetails = `<p><strong>Glas type:</strong> ${item.glasTypeLabel || 'Enkel glas'}</p>`;
        } else if (item.type === 'raam') {
          losProductDetails = `<p><strong>Type:</strong> ${item.raamTypeLabel || item.raamType}</p>`;
          if (item.draairichting) {
            losProductDetails += `<p><strong>Draairichting:</strong> ${item.draairichting}</p>`;
          }
          if (item.glasTypeLabel) {
            losProductDetails += `<p><strong>Glas type:</strong> ${item.glasTypeLabel}</p>`;
          }
        } else if (item.type === 'deur') {
          losProductDetails = `<p><strong>Type:</strong> ${item.deurTypeLabel || item.deurType}</p>`;
          if (item.draairichting) {
            losProductDetails += `<p><strong>Draairichting:</strong> ${item.draairichting}</p>`;
          }
          if (item.glasTypeLabel) {
            losProductDetails += `<p><strong>Glas type:</strong> ${item.glasTypeLabel}</p>`;
          }
        }
        
        const typeLabel = item.type === 'kozijn' ? 'Kozijn' : 
                         item.type === 'glas' ? 'Glas' : 
                         item.type === 'raam' ? 'Raam' : 
                         item.type === 'deur' ? 'Deur' : item.type;
        
        return `
          <div class="winkelwagenItem" data-item-id="${item.id}">
            ${thumbnailHTML}
            <div class="winkelwagenItemInfo">
              <span class="winkelwagenItemType">${typeLabel}</span>
              <h3>${item.titel}</h3>
              <p><strong>Afmetingen:</strong> ${item.afmetingen}</p>
              ${losProductDetails}
              ${item.ekosietOnderdorpel ? '<p>‚úì Ekosiet onderdorpel</p>' : ''}
              ${item.tussenstijlen > 0 ? `<p>Tussenstijlen: ${item.tussenstijlen}</p>` : ''}
              ${item.tussendorpels > 0 ? `<p>Tussendorpels: ${item.tussendorpels}</p>` : ''}
              ${aantallenHTML}
              ${vakkenHTML}
              ${afwerkingHTML}
            </div>
            <div class="winkelwagenItemActies">
              <div class="winkelwagenItemPrijs" id="winkelwagenItemPrijsDisplay_${item.id}">${formatPrijs(basisPrijs * totaalAantal)}</div>
              <button class="btn danger winkelwagenVerwijderBtn" data-item-id="${item.id}">üóëÔ∏è Verwijder</button>
            </div>
          </div>
        `;
      }).join('');
    }

    updateWinkelwagenTotaal();

    // Voeg event listeners toe voor verwijder knoppen
    const verwijderKnoppen = document.querySelectorAll('.winkelwagenVerwijderBtn');
    verwijderKnoppen.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const itemId = parseInt(e.target.dataset.itemId || e.target.closest('.winkelwagenVerwijderBtn')?.dataset.itemId);
        if (itemId) {
          verwijderUitWinkelwagen(itemId);
        }
      });
    });

    // Voeg event listeners toe voor aantal input velden
    const aantalInputs = document.querySelectorAll('.winkelwagenAantalInput');
    aantalInputs.forEach(input => {
      input.addEventListener('input', (e) => {
        updateWinkelwagenItemAantal(e.target);
      });
      input.addEventListener('change', (e) => {
        updateWinkelwagenItemAantal(e.target);
      });
    });
  }

  function updateWinkelwagenItemAantal(inputElement) {
    const itemId = parseInt(inputElement.dataset.itemId);
    const type = inputElement.dataset.type; // 'getekend', 'gespiegeld' of 'aantal'
    const nieuweWaarde = parseInt(inputElement.value) || 0;

    if (!itemId || !type) return;

    const winkelwagen = haalWinkelwagenOp();
    const item = winkelwagen.find(i => i.id === itemId);
    
    if (!item) return;

    // Update het aantal
    if (type === 'getekend') {
      item.aantalGetekend = nieuweWaarde;
    } else if (type === 'gespiegeld') {
      item.aantalGespiegeld = nieuweWaarde;
    } else if (type === 'aantal') {
      // Voor losse producten
      item.aantal = Math.max(1, nieuweWaarde);
    }

    // Bereken nieuwe totaal
    let totaalAantal;
    if (item.type === 'glas' || item.type === 'raam' || item.type === 'deur') {
      // Losse producten gebruiken 'aantal'
      totaalAantal = item.aantal || 1;
      item.totaalAantal = totaalAantal;
    } else {
      // Kozijnen gebruiken 'getekend' + 'gespiegeld'
      const aantalGetekend = item.aantalGetekend || 0;
      const aantalGespiegeld = item.aantalGespiegeld || 0;
      totaalAantal = aantalGetekend + aantalGespiegeld;
      item.totaalAantal = totaalAantal;
    }

    // Bereken nieuwe prijs
    const basisPrijs = item.basisPrijs || (item.prijs / (item.totaalAantal || 1));
    item.basisPrijs = basisPrijs; // Zorg dat basisPrijs is opgeslagen
    item.prijs = basisPrijs * totaalAantal;

    // Update de weergave
    const prijsDisplayElement = document.getElementById(`winkelwagenItemPrijsDisplay_${itemId}`);
    const totaalSpan = document.getElementById(`winkelwagenItemPrijs_${itemId}`);

    if (prijsDisplayElement) {
      prijsDisplayElement.textContent = formatPrijs(item.prijs);
    }
    if (totaalSpan) {
      totaalSpan.textContent = formatPrijs(item.prijs);
      // Update ook de totaal regel tekst
      const totaalRegel = totaalSpan.closest('div');
      if (totaalRegel) {
        const totaalTekst = totaalRegel.textContent;
        if (totaalTekst.includes('Totaal:') || totaalTekst.includes('Aantal:')) {
          const label = (item.type === 'glas' || item.type === 'raam' || item.type === 'deur') ? 'Aantal' : 'Totaal';
          totaalRegel.innerHTML = `<span style="color:var(--accent);font-weight:600;font-size:12px">${label}: ${totaalAantal} √ó ${formatPrijs(basisPrijs)} = <span id="winkelwagenItemPrijs_${itemId}">${formatPrijs(item.prijs)}</span></span>`;
        }
      }
    }

    // Sla winkelwagen op
    slaWinkelwagenOp(winkelwagen);

    // Update totaal prijs winkelwagen
    updateWinkelwagenTotaal();
  }

  function updateWinkelwagenTotaal() {
    const winkelwagen = haalWinkelwagenOp();
    const totaalPrijs = winkelwagen.reduce((sum, item) => sum + (item.prijs || 0), 0);
    const winkelwagenTotaalWaarde = document.getElementById('winkelwagenTotaalWaarde');
    if (winkelwagenTotaalWaarde) {
      winkelwagenTotaalWaarde.textContent = formatPrijs(totaalPrijs);
    }
  }

  function updateWinkelwagenBadge() {
    const winkelwagen = haalWinkelwagenOp();
    const badge = document.getElementById('winkelwagenBadge');
    if (badge) {
      if (winkelwagen.length > 0) {
        badge.textContent = winkelwagen.length;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }
  }

  function gaNaarPagina(pagina) {
    const tekenPagina = document.getElementById('tekenPagina');
    const winkelwagenPagina = document.getElementById('winkelwagenPagina');
    const losseProductenPagina = document.getElementById('losseProductenPagina');
    const productPaginaGlas = document.getElementById('productPaginaGlas');
    const productPaginaRaam = document.getElementById('productPaginaRaam');
    const productPaginaDeur = document.getElementById('productPaginaDeur');
    
    // Verberg alle pagina's eerst
    if (tekenPagina) tekenPagina.classList.add('hidden');
    if (winkelwagenPagina) winkelwagenPagina.classList.remove('active');
    if (losseProductenPagina) losseProductenPagina.classList.remove('active');
    if (productPaginaGlas) productPaginaGlas.classList.remove('active');
    if (productPaginaRaam) productPaginaRaam.classList.remove('active');
    if (productPaginaDeur) productPaginaDeur.classList.remove('active');
    
    if (pagina === 'tekenen') {
      if (tekenPagina) tekenPagina.classList.remove('hidden');
    } else if (pagina === 'winkelwagen') {
      if (winkelwagenPagina) winkelwagenPagina.classList.add('active');
      toonWinkelwagen();
    } else if (pagina === 'losseProducten') {
      if (losseProductenPagina) losseProductenPagina.classList.add('active');
    } else if (pagina === 'glas') {
      if (productPaginaGlas) productPaginaGlas.classList.add('active');
      // Wacht even zodat DOM elementen beschikbaar zijn
      setTimeout(() => {
        updateGlasOpbouwMenu();
        updateRoosterOpties();
        updateGlasPreview();
      }, 100);
    } else if (pagina === 'raam') {
      if (productPaginaRaam) productPaginaRaam.classList.add('active');
      updateRaamPreview();
    } else if (pagina === 'deur') {
      if (productPaginaDeur) productPaginaDeur.classList.add('active');
      updateDeurPreview();
    }
  }

  function toewijzingenGelijk(a, b) {
    if (!a || !b) return !a && !b;
    if (a.type !== b.type) return false;
    if (a.type === 'raam') {
      const variantA = a.variant || '';
      const variantB = b.variant || '';
      const orientationA = a.orientation || '';
      const orientationB = b.orientation || '';
      return variantA === variantB && orientationA === orientationB;
    }
    if (a.type === 'deur') {
      const variantA = a.variant || '';
      const variantB = b.variant || '';
      const orientationA = a.orientation || '';
      const orientationB = b.orientation || '';
      return variantA === variantB && orientationA === orientationB;
    }
    if (a.type === 'glas') {
      const variantA = a.variant || '';
      const variantB = b.variant || '';
      const roosterA = !!a.rooster;
      const roosterB = !!b.rooster;
      return variantA === variantB && roosterA === roosterB;
    }
    return true;
  }

  function normalizeAlleToewijzingen() {
    Object.keys(state.vakkenToewijzingen).forEach(key => {
      const normalized = normalizeToewijzingValue(state.vakkenToewijzingen[key]);
      if (normalized) {
        state.vakkenToewijzingen[key] = normalized;
      } else {
        delete state.vakkenToewijzingen[key];
      }
    });
  }

  function formatToewijzing(toewijzing) {
    if (!toewijzing) return 'Geen toewijzing';
    if (toewijzing.type === 'raam') {
      const variantLabelMap = {
        draairaam_buiten: 'Draairaam naar buiten',
        stolpraam_buiten: 'Stolpraam buitendraaiend',
        draaikiep: 'Draaikiep raam',
        stolpraam_draaikiep: 'Stolpraam draaikiep',
        klepraam: 'Klepraam',
        klepraam_open: 'Klepraam (open)',
        klepraam_vast: 'Vast klepraam'
      };
      const base = variantLabelMap[toewijzing.variant] || 'Raam';
      // Voor klepraam varianten: geen orientation tekst
      if (toewijzing.variant === 'klepraam' || toewijzing.variant === 'klepraam_open' || toewijzing.variant === 'klepraam_vast') {
        return base;
      }
      const orientationText = toewijzing.orientation === 'links' ? ' (links)' :
                              toewijzing.orientation === 'rechts' ? ' (rechts)' :
                              toewijzing.orientation === 'vast' ? ' (vast)' : '';
      return `${base}${orientationText}`;
    }
    if (toewijzing.type === 'deur') {
      // Bepaal basis variant tekst (zonder subvarianten)
      let baseVariant = toewijzing.variant;
      // Voor voordeur: geen subvarianten, return direct
      if (baseVariant === 'voordeur') {
        return 'Voordeur';
      }
      
      if (baseVariant.includes('_stapeldorpel')) {
        baseVariant = baseVariant.replace('_stapeldorpel', '');
      } else if (baseVariant.includes('_2vaks')) {
        baseVariant = baseVariant.replace('_2vaks', '');
      } else if (baseVariant.includes('_dicht')) {
        baseVariant = baseVariant.replace('_dicht', '');
      }
      
      const variantLabelMap = {
        deur_buiten: 'Buitendraaiende deur',
        stolpdeuren_buiten: 'Stolpdeuren buitendraaiend',
        deur_draaikiep: 'Draaikiep deur',
        stolpdeuren_draaikiep: 'Stolpdraaikiep deur',
        voordeur: 'Voordeur'
      };
      
      // Bepaal of het een stolpdeuren variant is
      const isStolpdeuren = baseVariant === 'stolpdeuren_buiten' || baseVariant === 'stolpdeuren_draaikiep';
      
      // Bepaal deur type tekst
      let deurTypeText = '';
      if (toewijzing.variant.includes('_stapeldorpel')) {
        deurTypeText = ' (stapeldorpel)';
      } else if (toewijzing.variant.includes('_2vaks')) {
        deurTypeText = ' (2 vaks)';
      } else if (toewijzing.variant.includes('_dicht')) {
        deurTypeText = ' (dicht)';
      }
      
      const base = variantLabelMap[baseVariant] || 'Deur';
      const variantText = base + deurTypeText;
      
      // Voeg draairichting toe
      if (toewijzing.orientation) {
        if (isStolpdeuren) {
          // Voor stolpdeuren: "links actief" of "rechts actief"
          const orientationText = toewijzing.orientation === 'links' ? ' links actief' :
                                  toewijzing.orientation === 'rechts' ? ' rechts actief' : '';
          return `${variantText}${orientationText}`;
        } else {
          // Voor normale deuren: "links draaiend" of "rechts draaiend"
          const orientationText = toewijzing.orientation === 'links' ? ' links draaiend' :
                                  toewijzing.orientation === 'rechts' ? ' rechts draaiend' : '';
          return `${variantText}${orientationText}`;
        }
      }
      return variantText;
    }
    if (toewijzing.type === 'glas') {
      const variantLabelMap = {
        glas_vast: 'Vast glas',
        glas_vast_stapel: 'Vast glas met stapeldorpels'
      };
      const base = variantLabelMap[toewijzing.variant] || 'Glas';
      const roosterText = toewijzing.rooster ? ' (met rooster)' : '';
      return `${base}${roosterText}`;
    }
    const label = `${toewijzing.type}` || '';
    return label ? label.charAt(0).toUpperCase() + label.slice(1) : 'Onbekend';
  }

  function createRaamOrientationIcon(orientation, variant) {
    const svgEl = n('svg');
    svgEl.setAttribute('viewBox', '0 0 80 80');
    svgEl.setAttribute('width', '80');
    svgEl.setAttribute('height', '80');

    const frame = n('rect');
    frame.setAttribute('x', '12');
    frame.setAttribute('y', '12');
    frame.setAttribute('width', '56');
    frame.setAttribute('height', '56');
    frame.setAttribute('fill', '#0f1a24');
    frame.setAttribute('stroke', '#4aa3ff');
    frame.setAttribute('stroke-width', '3');
    svgEl.appendChild(frame);

    const hingeLine = n('line');
    const hingeX = orientation === 'links' ? 20 : 60;
    hingeLine.setAttribute('x1', hingeX);
    hingeLine.setAttribute('y1', '16');
    hingeLine.setAttribute('x2', hingeX);
    hingeLine.setAttribute('y2', '68');
    hingeLine.setAttribute('stroke', '#4aa3ff');
    hingeLine.setAttribute('stroke-width', '2');
    svgEl.appendChild(hingeLine);

    const diag = n('line');
    if (orientation === 'links') {
      diag.setAttribute('x1', '20');
      diag.setAttribute('y1', '16');
      diag.setAttribute('x2', '64');
      diag.setAttribute('y2', '64');
    } else {
      diag.setAttribute('x1', '60');
      diag.setAttribute('y1', '16');
      diag.setAttribute('x2', '16');
      diag.setAttribute('y2', '64');
    }
    diag.setAttribute('stroke', '#4aa3ff');
    diag.setAttribute('stroke-width', '3');
    svgEl.appendChild(diag);

    if (variant === 'draaikiep_binnen') {
      const tilt = n('line');
      if (orientation === 'links') {
        tilt.setAttribute('x1', '40');
        tilt.setAttribute('y1', '18');
        tilt.setAttribute('x2', '20');
        tilt.setAttribute('y2', '32');
      } else {
        tilt.setAttribute('x1', '40');
        tilt.setAttribute('y1', '18');
        tilt.setAttribute('x2', '60');
        tilt.setAttribute('y2', '32');
      }
      tilt.setAttribute('stroke', '#4aa3ff');
      tilt.setAttribute('stroke-width', '3');
      svgEl.appendChild(tilt);
    }

    return svgEl;
  }

  function updateTekenenStatusUI() {
    if (state.kanTekenen) {
      btnDetectVakken.textContent = '‚úì Klaar met tekenen';
      btnDetectVakken.title = 'Detecteer vakken en schakel tekenen uit';
      svg.style.cursor = 'crosshair';
    } else {
      btnDetectVakken.textContent = '‚úèÔ∏è Opnieuw tekenen';
      btnDetectVakken.title = 'Schakel tekenen weer in en verwijder vakken';
      svg.style.cursor = 'default';
    }
    if (maatTools) {
      if (state.kanTekenen) {
        maatTools.classList.remove('active');
      } else {
        maatTools.classList.add('active');
      }
    }
    if (state.kanTekenen) {
      closeMaatPopover();
    }
  }
  updateTekenenStatusUI();

  const VAK_TYPE_OPTIES = [
    { value: '', text: 'Geen toewijzing', assign: null, img: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM2NjY2NjYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWRhc2hhcnJheT0iNCA0IiBmaWxsPSJub25lIi8+Cjwvc3ZnPg==' },
    { value: 'raam_draairaam_buiten', text: 'Draairaam naar buiten', assign: { type: 'raam', variant: 'draairaam_buiten' }, img: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM0YWEzZmYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8bGluZSB4MT0iNDAiIHkxPSIxMCIgeDI9IjQwIiB5Mj0iNzAiIHN0cm9rZT0iIzRhYTNmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPg==' },
    { value: 'raam_stolpraam_buiten', text: 'Stolpraam buitendraaiend', assign: { type: 'raam', variant: 'stolpraam_buiten' }, img: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM0YWEzZmYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8bGluZSB4MT0iNDAiIHkxPSIxMCIgeDI9IjQwIiB5Mj0iNzAiIHN0cm9rZT0iIzRhYTNmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPg==' },
    { value: 'raam_draaikiep', text: 'Draaikiep raam', assign: { type: 'raam', variant: 'draaikiep' }, img: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM0YWEzZmYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8bGluZSB4MT0iNDAiIHkxPSIxMCIgeDI9IjQwIiB5Mj0iNzAiIHN0cm9rZT0iIzRhYTNmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPg==' },
    { value: 'raam_stolpraam_draaikiep', text: 'Stolpraam draaikiep', assign: { type: 'raam', variant: 'stolpraam_draaikiep' }, img: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM0YWEzZmYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8bGluZSB4MT0iNDAiIHkxPSIxMCIgeDI9IjQwIiB5Mj0iNzAiIHN0cm9rZT0iIzRhYTNmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPg==' },
    { value: 'raam_klepraam', text: 'Klepraam', assign: { type: 'raam', variant: 'klepraam' }, img: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM0YWEzZmYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8bGluZSB4MT0iNDAiIHkxPSIxMCIgeDI9IjQwIiB5Mj0iNzAiIHN0cm9rZT0iIzRhYTNmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPg==' },
    { value: 'raam', text: 'Raam (algemeen)', assign: { type: 'raam' }, img: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM0YWEzZmYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8bGluZSB4MT0iNDAiIHkxPSIxMCIgeDI9IjQwIiB5Mj0iNzAiIHN0cm9rZT0iIzRhYTNmZiIgc3Ryb2tlLXdpZHRoPSIyIi8+Cjwvc3ZnPg==' },
    { value: 'deur', text: 'Deur', assign: { type: 'deur' }, img: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM0YWEzZmYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8Y2lyY2xlIGN4PSI1NSIgY3k9IjQwIiByPSI0IiBmaWxsPSIjNGFlM2ZmIi8+Cjwvc3ZnPg==' },
    { value: 'glas', text: 'Glas', assign: { type: 'glas' }, img: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMGYxMzE4Ii8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBzdHJva2U9IiM0YWEzZmYiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPgo8cmVjdCB4PSIxNSIgeT0iMTUiIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0iIzRhYTNmZiIgZmlsbC1vcGFjaXR5PSIwLjIiLz4KPC9zdmc+' }
  ];

  function getOptieAssign(optie) {
    if (optie.assign === null) return null;
    if (optie.assign) return { ...optie.assign };
    if (!optie.value) return null;
    return { type: optie.value };
  }

  // Schaalberekening: maak ruimte met padding
  const mmToPxScale = () => { 
    const pad = 120; 
    const maxBox = 1400 - pad * 2; 
    const s = Math.min(maxBox / state.Wmm, maxBox / state.Hmm); 
    return {s, pad}; 
  };
  
  const toPx = mm => mm * mmToPxScale().s + mmToPxScale().pad;
  
  function n(tag){ return document.createElementNS('http://www.w3.org/2000/svg',tag); }
  
  function line(x1, y1, x2, y2, cls){ 
    const l = n('line'); 
    l.setAttribute('x1', x1); 
    l.setAttribute('y1', y1); 
    l.setAttribute('x2', x2); 
    l.setAttribute('y2', y2); 
    l.setAttribute('class', cls); 
    return l; 
  }

  function text(x, y, txt, cls){
    const t = n('text');
    t.setAttribute('x', x);
    t.setAttribute('y', y);
    t.setAttribute('class', cls);
    t.setAttribute('text-anchor', 'middle');
    t.setAttribute('dominant-baseline', 'middle');
    t.textContent = txt;
    return t;
  }

  const MIN_DAGMAAT = 30;

  function ensureDagConfig(axis) {
    if (!state.dagmaatConfig) {
      state.dagmaatConfig = { horiz: null, vert: null };
    }
    const key = axis === 'h' ? 'horiz' : 'vert';
    const structures = axis === 'h' ? getUniqueColumns() : getUniqueRows();
    const dagLengths = axis === 'h'
      ? computeHorizontalDagLengths(structures)
      : computeVerticalDagLengths(structures);
    const expectedSegments = dagLengths.length;
    const existing = state.dagmaatConfig[key];

    const needsRebuild =
      !existing ||
      !existing.dag ||
      existing.dag.length !== expectedSegments ||
      !(existing.structures && existing.structures.length === structures.length);

    if (needsRebuild) {
      const lockedSnapshot = existing?.dag?.map(seg => ({
        length: seg.length,
        locked: seg.locked,
        manual: seg.manual,
      })) || [];

      state.dagmaatConfig[key] = createDagConfig(axis, dagLengths, structures);

      if (lockedSnapshot.length === expectedSegments) {
        state.dagmaatConfig[key].dag.forEach((seg, idx) => {
          const old = lockedSnapshot[idx];
          if (old && old.locked) {
            seg.length = old.length;
            seg.locked = true;
            seg.manual = !!old.manual;
          }
        });
      }
    } else {
      const config = state.dagmaatConfig[key];
      const newStructures = structures.map(item => axis === 'h' ? item.x : item.y);
      const structuresChanged =
        !config.structures ||
        config.structures.length !== newStructures.length ||
        config.structures.some((val, idx) => Math.abs(val - newStructures[idx]) > 0.01);

      config.structures = newStructures;

      if (!structuresChanged) {
        config.dag.forEach((seg, idx) => {
          if (!seg.locked) {
            seg.length = dagLengths[idx];
          }
        });
      }
    }

    return state.dagmaatConfig[key];
  }

  function createDagConfig(axis, lengths, structures) {
    return {
      axis,
      structures: structures.map(item => axis === 'h' ? item.x : item.y),
      dag: lengths.map((len, idx) => ({
        id: `${axis}-${idx}`,
        length: len,
        locked: false,
        manual: false
      }))
    };
  }

  function getUniqueColumns() {
    const map = new Map();
    state.tussenStijlen.forEach((stijl, idx) => {
      const key = stijl.x1.toFixed(3);
      if (!map.has(key)) {
        map.set(key, { key, x: stijl.x1, indices: [] });
      }
      map.get(key).indices.push(idx);
    });
    return Array.from(map.values()).sort((a, b) => a.x - b.x);
  }

  function getUniqueRows() {
    const map = new Map();
    state.tussenDorpels.forEach((dorpel, idx) => {
      const key = dorpel.y1.toFixed(3);
      if (!map.has(key)) {
        map.set(key, { key, y: dorpel.y1, indices: [] });
      }
      map.get(key).indices.push(idx);
    });
    return Array.from(map.values()).sort((a, b) => a.y - b.y);
  }

  function computeHorizontalDagLengths(columns) {
    const lengths = [];
    const halfTussen = state.tussenDikte / 2;
    let cursor = state.frameDikte;
    columns.forEach(col => {
      const leftEdge = col.x - halfTussen;
      lengths.push(Math.max(0, leftEdge - cursor));
      cursor = col.x + halfTussen;
    });
    lengths.push(Math.max(0, (state.Wmm - state.frameDikte) - cursor));
    return lengths;
  }

  function computeVerticalDagLengths(rows) {
    const lengths = [];
    const halfTussen = state.tussenDikte / 2;
    let cursor = state.frameDikte;
    rows.forEach(row => {
      const topEdge = row.y - halfTussen;
      lengths.push(Math.max(0, topEdge - cursor));
      cursor = row.y + halfTussen;
    });
    lengths.push(Math.max(0, (state.Hmm - state.frameDikte) - cursor));
    return lengths;
  }

  function getTotalDagSpace(axis) {
    const isHoriz = axis === 'h';
    const full = isHoriz ? state.Wmm : state.Hmm;
    const structures = isHoriz ? getUniqueColumns() : getUniqueRows();
    const structuralCount = structures.length;
    const total = full - 2 * state.frameDikte - structuralCount * state.tussenDikte;
    return Math.max(0, total);
  }

  function applyDagLayout(axis, providedConfig = null) {
    const config = providedConfig || ensureDagConfig(axis);
    if (!config) return;

    const lockedSnapshot = config.dag.map(seg => ({
      length: seg.length,
      locked: seg.locked,
      manual: seg.manual,
    }));

    if (axis === 'h') {
      const columns = getUniqueColumns();
      if (columns.length !== config.dag.length - 1) {
        return;
      }
      const halfTussen = state.tussenDikte / 2;
      let cursor = state.frameDikte;
      for (let i = 0; i < columns.length; i++) {
        const dag = config.dag[i];
        cursor += dag.length;
        const targetLeftEdge = cursor;
        const targetCenter = targetLeftEdge + halfTussen;
        const delta = targetCenter - columns[i].x;
        if (Math.abs(delta) > 0.01) {
          shiftColumn(columns[i], delta);
        }
        cursor = targetLeftEdge + state.tussenDikte;
      }
    } else {
      const rows = getUniqueRows();
      if (rows.length !== config.dag.length - 1) {
        return;
      }
      const halfTussen = state.tussenDikte / 2;
      let cursor = state.frameDikte;
      for (let i = 0; i < rows.length; i++) {
        const dag = config.dag[i];
        cursor += dag.length;
        const targetTopEdge = cursor;
        const targetCenter = targetTopEdge + halfTussen;
        const delta = targetCenter - rows[i].y;
        if (Math.abs(delta) > 0.01) {
          shiftRow(rows[i], delta);
        }
        cursor = targetTopEdge + state.tussenDikte;
      }
    }

    const key = axis === 'h' ? 'horiz' : 'vert';
    state.dagmaatConfig[key] = null;
    const refreshed = ensureDagConfig(axis);
    if (refreshed && lockedSnapshot.length === refreshed.dag.length) {
      refreshed.dag.forEach((seg, idx) => {
        const old = lockedSnapshot[idx];
        if (old && old.locked) {
          seg.length = old.length;
          seg.locked = true;
          seg.manual = !!old.manual;
        }
      });
    }

    if (!state.kanTekenen && state.vakken.length > 0) {
      detecteerVakken(true);
    }
    draw();
  }

  function shiftColumn(column, delta) {
    if (!column || Math.abs(delta) < 0.01) return;
    state.tussenStijlen.forEach(stijl => {
      if (Math.abs(stijl.x1 - column.x) < 0.01) {
        stijl.x1 += delta;
        stijl.x2 += delta;
      }
    });
  }

  function shiftRow(row, delta) {
    if (!row || Math.abs(delta) < 0.01) return;
    state.tussenDorpels.forEach(dorpel => {
      if (Math.abs(dorpel.y1 - row.y) < 0.01) {
        dorpel.y1 += delta;
        dorpel.y2 += delta;
      }
    });
  }

  function findDagSegmentIndex(axis, segmentId, providedConfig = null) {
    const config = providedConfig || ensureDagConfig(axis);
    if (!config) return -1;
    return config.dag.findIndex(seg => seg.id === segmentId);
  }

  function updateDagSegment(axis, segmentId, newLength, shouldLock, autoLock) {
    const config = ensureDagConfig(axis);
    if (!config) return false;
    const index = findDagSegmentIndex(axis, segmentId, config);
    if (index === -1) return false;
    const seg = config.dag[index];
    const originalLength = seg.length;
    const originalLock = seg.locked;
    const targetLength = Math.max(MIN_DAGMAAT, newLength);
    const delta = targetLength - seg.length;
    seg.length = targetLength;
    if (typeof shouldLock === 'boolean') {
      seg.locked = shouldLock;
    } else if (autoLock) {
      seg.locked = true;
    }
    seg.manual = seg.manual || autoLock;
    if (!redistributeDelta(axis, index, delta)) {
      seg.length = originalLength;
      seg.locked = originalLock;
      return false;
    }
    applyDagLayout(axis, config);
    return true;
  }

  function redistributeDelta(axis, sourceIndex, delta) {
    if (Math.abs(delta) < 0.01) return true;
    const config = ensureDagConfig(axis);
    if (!config) return false;
    const original = config.dag.map(seg => ({ length: seg.length, locked: seg.locked }));
    let remaining = delta;

    let directions;
    if (sourceIndex === 0) {
      directions = [1];
    } else if (sourceIndex === config.dag.length - 1) {
      directions = [-1];
    } else {
      directions = [1, -1];
    }

    for (const dir of directions) {
      let idx = sourceIndex + dir;
      while (idx >= 0 && idx < config.dag.length && Math.abs(remaining) > 0.01) {
        const seg = config.dag[idx];
        if (seg.locked) {
          idx += dir;
          continue;
        }
        if (remaining > 0) {
          const available = Math.max(0, seg.length - MIN_DAGMAAT);
          const take = Math.min(available, remaining);
          if (take > 0) {
            seg.length -= take;
            remaining -= take;
          } else {
            idx += dir;
            continue;
          }
        } else {
          const addition = Math.abs(remaining);
          seg.length += addition;
          remaining = 0;
        }
        if (Math.abs(remaining) <= 0.01) break;
        idx += dir;
      }
      if (Math.abs(remaining) <= 0.01) break;
    }

    if (Math.abs(remaining) > 0.01) {
      config.dag.forEach((seg, idx) => {
        seg.length = original[idx].length;
        seg.locked = original[idx].locked;
      });
      return false;
    }
    return true;
  }

  function equalizeDagSegments(axis) {
    const config = ensureDagConfig(axis);
    if (!config) return;
    const totalSpace = getTotalDagSpace(axis);
    const lockedSum = config.dag
      .filter(seg => seg.locked)
      .reduce((sum, seg) => sum + seg.length, 0);
    const freeSegments = config.dag.filter(seg => !seg.locked);
    if (!freeSegments.length) return;
    const target = Math.max(MIN_DAGMAAT, (totalSpace - lockedSum) / freeSegments.length);
    freeSegments.forEach(seg => {
      seg.length = target;
    });
    applyDagLayout(axis, config);
  }

  function distributeMiddleSegments(axis) {
    const config = ensureDagConfig(axis);
    if (!config) return;
    if (config.dag.length <= 2) return;
    const totalSpace = getTotalDagSpace(axis);
    const first = config.dag[0].length;
    const last = config.dag[config.dag.length - 1].length;
    const lockedMiddleSum = config.dag
      .slice(1, -1)
      .filter(seg => seg.locked)
      .reduce((sum, seg) => sum + seg.length, 0);
    const adjustable = config.dag.slice(1, -1).filter(seg => !seg.locked);
    if (!adjustable.length) return;
    const remainder = totalSpace - first - last - lockedMiddleSum;
    if (remainder <= 0) return;
    const target = Math.max(MIN_DAGMAAT, remainder / adjustable.length);
    adjustable.forEach(seg => {
      seg.length = target;
    });
    applyDagLayout(axis, config);
  }

  function resetDagConfigCache() {
    state.dagmaatConfig = {
      horiz: null,
      vert: null
    };
  }

  // Helper: vind kruispunten voor een dorpel (horizontaal) met stijlen
  function findDorpelIntersections(y) {
    const frame = state.frameDikte;
    const halfFrame = frame / 2;
    const linkerStijlX = halfFrame;
    const rechterStijlX = state.Wmm - halfFrame;
    const intersections = [linkerStijlX, rechterStijlX]; // kader stijlen
    // Voor elke tussenstijl: voeg de x positie toe (stijl blokkeert de hele dorpel)
    state.tussenStijlen.forEach(s => {
      intersections.push(s.x1); // gewoon de x positie
    });
    // Sorteer en filter duplicates
    return [...new Set(intersections)].sort((a, b) => a - b);
  }
  
  // Helper: check of een tussenstijl van bovendorpel tot onderdorpel loopt
  function isStijlVanBovenTotOnder(yStart, yEnd) {
    const frame = state.frameDikte;
    const halfFrame = frame / 2;
    const onderdorpelDikte = state.ekosietOnderdorpel ? 52 : frame;
    const halfOnderdorpel = onderdorpelDikte / 2;
    const bovendorpelY = halfFrame;
    const onderdorpelY = state.Hmm - halfOnderdorpel;
    const bovendorpelRand = bovendorpelY + halfFrame;
    const onderdorpelRand = onderdorpelY - halfOnderdorpel;
    const tolerance = 1;
    
    // Check of stijl start bij bovendorpel en eindigt bij onderdorpel (of andersom)
    const startBijBoven = Math.abs(yStart - bovendorpelRand) < tolerance;
    const eindBijOnder = Math.abs(yEnd - onderdorpelRand) < tolerance;
    const startBijOnder = Math.abs(yStart - onderdorpelRand) < tolerance;
    const eindBijBoven = Math.abs(yEnd - bovendorpelRand) < tolerance;
    
    return (startBijBoven && eindBijOnder) || (startBijOnder && eindBijBoven);
  }

  function draw(){
    svg.innerHTML = '';
    closeVakQuickMenu(true);
    const frame = state.frameDikte;  // 67mm
    const tussen = state.tussenDikte; // 90mm
    const halfTussen = tussen / 2;
    const halfFrame = frame / 2;
    
    // Bepaal onderdorpel dikte: 52mm voor ekosiet, anders 67mm
    const onderdorpelDikte = state.ekosietOnderdorpel ? 52 : frame;
    const halfOnderdorpel = onderdorpelDikte / 2;
    
    // Buitenste kozijn kader (67mm dik) - buitenwerkse maat
    const kozijnOuter = [
      line(toPx(0), toPx(0), toPx(state.Wmm), toPx(0), 'kozijnFrame'),
      line(toPx(state.Wmm), toPx(0), toPx(state.Wmm), toPx(state.Hmm), 'kozijnFrame'),
      line(toPx(state.Wmm), toPx(state.Hmm), toPx(0), toPx(state.Hmm), 'kozijnFrame'),
      line(toPx(0), toPx(state.Hmm), toPx(0), toPx(0), 'kozijnFrame')
    ];
    kozijnOuter.forEach(el => svg.appendChild(el));

    // KADER: Opgebouwd uit 4 delen
    // 1. BOVENDORPEL: horizontale lijn bovenaan
    //    Beide lijnen (boven en onder) lopen door tot de zijkant van het kader
    const bovendorpelY = halfFrame;
    svg.appendChild(line(toPx(0), toPx(bovendorpelY - halfFrame), toPx(state.Wmm), toPx(bovendorpelY - halfFrame), 'kozijnKader'));
    svg.appendChild(line(toPx(0), toPx(bovendorpelY + halfFrame), toPx(state.Wmm), toPx(bovendorpelY + halfFrame), 'kozijnKader'));
    
    // 2. ONDERDORPEL: horizontale lijn onderaan
    //    Beide lijnen (boven en onder) lopen door tot de zijkant van het kader
    //    Gebruik onderdorpelDikte in plaats van frame voor ekosiet onderdorpel
    const onderdorpelY = state.Hmm - halfOnderdorpel;
    svg.appendChild(line(toPx(0), toPx(onderdorpelY - halfOnderdorpel), toPx(state.Wmm), toPx(onderdorpelY - halfOnderdorpel), 'kozijnKader'));
    svg.appendChild(line(toPx(0), toPx(onderdorpelY + halfOnderdorpel), toPx(state.Wmm), toPx(onderdorpelY + halfOnderdorpel), 'kozijnKader'));
    
    // Tekst toevoegen onder onderdorpel als ekosiet onderdorpel actief is
    if (state.ekosietOnderdorpel) {
      const tekstY = state.Hmm + 25; // 25mm onder de onderkant
      const tekst = text(toPx(state.Wmm / 2), toPx(tekstY), 'Ekosiet onderdorpel', 'maatkettingText');
      tekst.setAttribute('text-anchor', 'middle');
      tekst.setAttribute('font-size', '12');
      tekst.setAttribute('fill', '#9aa1a8');
      svg.appendChild(tekst);
    }
    
    // 3. LINKER STIJL: verticale lijn links
    //    Beide lijnen (links en rechts) sluiten aan op de dorpels
    const linkerStijlX = halfFrame;
    const linkerStijlYStart = bovendorpelY + halfFrame; // start bij onderkant bovendorpel
    const linkerStijlYEnd = onderdorpelY - halfOnderdorpel;    // eindigt bij bovenkant onderdorpel
    svg.appendChild(line(toPx(linkerStijlX - halfFrame), toPx(linkerStijlYStart), toPx(linkerStijlX - halfFrame), toPx(linkerStijlYEnd), 'kozijnKader'));
    svg.appendChild(line(toPx(linkerStijlX + halfFrame), toPx(linkerStijlYStart), toPx(linkerStijlX + halfFrame), toPx(linkerStijlYEnd), 'kozijnKader'));
    
    // 4. RECHTER STIJL: verticale lijn rechts
    //    Beide lijnen (links en rechts) sluiten aan op de dorpels
    const rechterStijlX = state.Wmm - halfFrame;
    const rechterStijlYStart = bovendorpelY + halfFrame; // start bij onderkant bovendorpel
    const rechterStijlYEnd = onderdorpelY - halfOnderdorpel;  // eindigt bij bovenkant onderdorpel
    svg.appendChild(line(toPx(rechterStijlX - halfFrame), toPx(rechterStijlYStart), toPx(rechterStijlX - halfFrame), toPx(rechterStijlYEnd), 'kozijnKader'));
    svg.appendChild(line(toPx(rechterStijlX + halfFrame), toPx(rechterStijlYStart), toPx(rechterStijlX + halfFrame), toPx(rechterStijlYEnd), 'kozijnKader'));

    renderTotaleMaatlijnen();

    // Helper: geef de linker- en rechterrand van een tussenstijl terug
    function getStijlRanden(stijl) {
      return {
        links: stijl.x1 - halfTussen,
        rechts: stijl.x1 + halfTussen
      };
    }
    
    // Helper: geef de boven- en onderrand van een tussendorpel terug
    function getDorpelRanden(dorpel) {
      return {
        boven: dorpel.y1 - halfTussen,
        onder: dorpel.y1 + halfTussen
      };
    }
    
    // Helper: bereken de segmenten van een tussendorpel (stopt bij tussenstijlen)
    // Een dorpel wordt gesplitst in meerdere aparte dorpels bij elke tussenstijl
    function getDorpelSegmentenVoorTeken(dorpel) {
      const y = dorpel.y1;
      const xStart = dorpel.x1;
      const xEnd = dorpel.x2;
      
      // Vind alle tussenstijlen die deze dorpel kruisen op y-positie
      const kruisendeStijlen = state.tussenStijlen.filter(s => {
        const randen = getStijlRanden(s);
        // Stijl kruist dorpel als: y ligt binnen stijl bereik EN x-bereik overlapt
        return y >= s.y1 && y <= s.y2 && 
               xStart < randen.rechts && xEnd > randen.links;
      });
      
      // Als er geen kruisende stijlen zijn, gebruik volledige lengte
      if (kruisendeStijlen.length === 0) {
        return [{ xStart: xStart, xEnd: xEnd, y: y }];
      }
      
      // Verzamel alle x-posities waar stijlen de dorpel splitsen
      // We gebruiken de linker- en rechterranden van elke stijl
      const splitsPunten = [xStart, xEnd];
      kruisendeStijlen.forEach(s => {
        const randen = getStijlRanden(s);
        // Voeg splitspunten toe als ze binnen het dorpel bereik vallen
        if (randen.links >= xStart && randen.links <= xEnd) {
          splitsPunten.push(randen.links);
        }
        if (randen.rechts >= xStart && randen.rechts <= xEnd) {
          splitsPunten.push(randen.rechts);
        }
      });
      
      // Sorteer splitspunten
      const gesorteerdeSplitsPunten = [...new Set(splitsPunten)].sort((a, b) => a - b);
      
      // Maak segmenten tussen de splitspunten
      // Elk segment stopt bij een stijl en begint weer na de stijl
      const segmenten = [];
      
      for (let i = 0; i < gesorteerdeSplitsPunten.length - 1; i++) {
        const segStart = gesorteerdeSplitsPunten[i];
        const segEnd = gesorteerdeSplitsPunten[i + 1];
        
        // Check of dit segment overlapt met een tussenstijl
        const overlaptMetStijl = kruisendeStijlen.some(s => {
          const randen = getStijlRanden(s);
          // Segment overlapt als het niet volledig buiten de stijl ligt
          return segStart < randen.rechts && segEnd > randen.links;
        });
        
        // Alleen segmenten toevoegen die NIET overlappen met een stijl
        if (!overlaptMetStijl && segEnd > segStart) {
          segmenten.push({ xStart: segStart, xEnd: segEnd, y: y });
        }
      }
      
      return segmenten.length > 0 ? segmenten : [];
    }
    
    // Helper: bereken de niet-onderbroken segmenten van een tussenstijl
    function getStijlSegmentenVoorTeken(stijl) {
      const x = stijl.x1;
      const yStart = stijl.y1;
      const yEnd = stijl.y2;
      
      // Vind alle tussendorpels die deze stijl kruisen op x-positie
      const kruisendeDorpels = state.tussenDorpels.filter(d => {
        const randen = getDorpelRanden(d);
        // Dorpel kruist stijl als: x ligt binnen dorpel bereik EN y-bereik overlapt
        return x >= d.x1 && x <= d.x2 &&
               yStart < randen.onder && yEnd > randen.boven;
      });
      
      // Als er geen kruisende dorpels zijn, gebruik volledige lengte
      if (kruisendeDorpels.length === 0) {
        return [{ x: x, yStart: yStart, yEnd: yEnd }];
      }
      
      // Verzamel alle y-posities waar dorpels de stijl onderbreken
      const onderbrekingen = [];
      kruisendeDorpels.forEach(d => {
        const randen = getDorpelRanden(d);
        // Voeg alleen toe als het binnen het stijl bereik valt
        if (randen.boven > yStart && randen.boven < yEnd) {
          onderbrekingen.push({ type: 'start', y: randen.boven });
        }
        if (randen.onder > yStart && randen.onder < yEnd) {
          onderbrekingen.push({ type: 'end', y: randen.onder });
        }
      });
      
      // Sorteer onderbrekingen op y-positie
      onderbrekingen.sort((a, b) => a.y - b.y);
      
      // Maak segmenten tussen de onderbrekingen
      const segmenten = [];
      let huidigeStart = yStart;
      
      for (const onderbreking of onderbrekingen) {
        if (onderbreking.type === 'start' && onderbreking.y > huidigeStart) {
          // Voeg segment toe voor deze onderbreking
          segmenten.push({ x: x, yStart: huidigeStart, yEnd: onderbreking.y });
        }
        if (onderbreking.type === 'end') {
          // Start nieuw segment na deze onderbreking
          huidigeStart = onderbreking.y;
        }
      }
      
      // Voeg laatste segment toe (na laatste onderbreking tot yEnd)
      if (huidigeStart < yEnd) {
        segmenten.push({ x: x, yStart: huidigeStart, yEnd: yEnd });
      }
      
      // Als er geen segmenten zijn (volledig onderbroken), return lege array
      // Anders return de segmenten, of als er geen onderbrekingen waren, de volledige lengte
      return segmenten.length > 0 ? segmenten : (onderbrekingen.length === 0 ? [{ x: x, yStart: yStart, yEnd: yEnd }] : []);
    }
    
    // Teken alle tussen dorpels (horizontaal = wit) - 90mm dik
    // Dorpels zijn al gesplitst in aparte objecten (zoals kader)
    state.tussenDorpels.forEach(d => {
      const randen = getDorpelRanden(d);
      // Teken beide lijnen direct (boven en onder)
      svg.appendChild(line(toPx(d.x1), toPx(randen.boven), toPx(d.x2), toPx(randen.boven), 'tussenDorpel'));
      svg.appendChild(line(toPx(d.x1), toPx(randen.onder), toPx(d.x2), toPx(randen.onder), 'tussenDorpel'));
    });

    // Teken alle tussen stijlen (verticaal = wit) - 90mm dik  
    // Stijlen zijn al gesplitst in aparte objecten (zoals kader)
    state.tussenStijlen.forEach(s => {
      const randen = getStijlRanden(s);
      // Teken beide lijnen direct (links en rechts)
      svg.appendChild(line(toPx(randen.links), toPx(s.y1), toPx(randen.links), toPx(s.y2), 'tussenStijl'));
      svg.appendChild(line(toPx(randen.rechts), toPx(s.y1), toPx(randen.rechts), toPx(s.y2), 'tussenStijl'));
    });

    if (!state.kanTekenen) {
      tekenMaatkettingen();
    }

    function renderTotaleMaatlijnen() {
      const group = n('g');
      group.setAttribute('class', 'maatketting');

      const horizY = toPx(-110);
      const horizStart = 0;
      const horizEnd = state.Wmm;
      group.appendChild(line(toPx(horizStart), horizY, toPx(horizEnd), horizY, 'maatkettingLine'));
      group.appendChild(line(toPx(horizStart), horizY - 8, toPx(horizStart), horizY + 8, 'maatkettingTick'));
      group.appendChild(line(toPx(horizEnd), horizY - 8, toPx(horizEnd), horizY + 8, 'maatkettingTick'));
      const horizText = text(toPx((horizStart + horizEnd) / 2), horizY - 16, `Totale breedte ${Math.round(state.Wmm)}mm`, 'maatkettingText');
      group.appendChild(horizText);

      const vertX = toPx(state.Wmm + 140);
      const vertStart = 0;
      const vertEnd = state.Hmm;
      group.appendChild(line(vertX, toPx(vertStart), vertX, toPx(vertEnd), 'maatkettingLine'));
      group.appendChild(line(vertX - 8, toPx(vertStart), vertX + 8, toPx(vertStart), 'maatkettingTick'));
      group.appendChild(line(vertX - 8, toPx(vertEnd), vertX + 8, toPx(vertEnd), 'maatkettingTick'));
      const vertTextY = toPx((vertStart + vertEnd) / 2);
      const vertText = text(vertX + 12, vertTextY, `Totale hoogte ${Math.round(state.Hmm)}mm`, 'maatkettingText');
      vertText.setAttribute('text-anchor', 'middle');
      vertText.setAttribute('dominant-baseline', 'middle');
      vertText.setAttribute('transform', `rotate(-90 ${vertX + 12} ${vertTextY})`);
      group.appendChild(vertText);

      svg.appendChild(group);
    }

    function tekenMaatkettingen() {
      const hConfig = ensureDagConfig('h');
      const vConfig = ensureDagConfig('v');
      const horizontale = buildHorizBoundaries();
      if (horizontale.length > 1) {
        const group = renderHorizChain(horizontale, hConfig);
        if (group) svg.appendChild(group);
      }
      const verticale = buildVertBoundaries();
      if (verticale.length > 1) {
        const group = renderVertChain(verticale, vConfig);
        if (group) svg.appendChild(group);
      }
    }

    function buildHorizBoundaries() {
      const boundaries = [0, frame, state.Wmm - frame, state.Wmm];
      state.tussenStijlen.forEach(s => {
        boundaries.push(s.x1 - halfTussen, s.x1 + halfTussen);
      });
      return uniqueSorted(boundaries, 0, state.Wmm);
    }

    function buildVertBoundaries() {
      const onderdorpelDikte = state.ekosietOnderdorpel ? 52 : frame;
      const boundaries = [0, frame, state.Hmm - onderdorpelDikte, state.Hmm];
      state.tussenDorpels.forEach(d => {
        boundaries.push(d.y1 - halfTussen, d.y1 + halfTussen);
      });
      return uniqueSorted(boundaries, 0, state.Hmm);
    }

    function uniqueSorted(values, min, max) {
      const filtered = values
        .map(v => Number(v.toFixed(2)))
        .filter(v => v >= min && v <= max);
      return [...new Set(filtered)].sort((a, b) => a - b);
    }

    function segmentType(length, startPos = null, isVertical = false) {
      const epsilon = 0.5;
      const onderdorpelDikte = state.ekosietOnderdorpel ? 52 : frame;
      
      // Voor verticale maatlijnen: check of dit de onderdorpel is
      if (isVertical && startPos !== null) {
        const verwachteOnderdorpelStart = state.Hmm - onderdorpelDikte;
        const isOnderdorpel = Math.abs(startPos - verwachteOnderdorpelStart) < epsilon;
        if (isOnderdorpel && Math.abs(length - onderdorpelDikte) < epsilon) {
          return 'ekosiet_onderdorpel';
        }
      }
      
      // Normale kader check
      if (Math.abs(length - frame) < epsilon) return 'kader';
      if (Math.abs(length - tussen) < epsilon) return 'stijl';
      return 'dag';
    }

    function formatLabel(type, length) {
      const rounded = Math.round(length);
      if (type === 'dag') return `Dag ${rounded}mm`;
      if (type === 'stijl') return `Tussenstijl ${rounded}mm`;
      if (type === 'ekosiet_onderdorpel') return `Kader ${rounded}mm`;
      return `Kader ${rounded}mm`;
    }

    function renderHorizChain(boundaries, dagConfig) {
      const chainY = toPx(-70);
      const tickHeight = 18;
       let dagIndex = 0;
      const group = n('g');
      group.setAttribute('class', 'maatketting');

      const baseLine = line(toPx(boundaries[0]), chainY, toPx(boundaries[boundaries.length - 1]), chainY, 'maatkettingLine');
      group.appendChild(baseLine);

      boundaries.forEach(pos => {
        const tick = line(toPx(pos), chainY - 6, toPx(pos), chainY + tickHeight, 'maatkettingTick');
        group.appendChild(tick);
      });

      for (let i = 0; i < boundaries.length - 1; i++) {
        const start = boundaries[i];
        const end = boundaries[i + 1];
        const length = end - start;
        if (length <= 0) continue;
        const type = segmentType(length, start, false); // false = horizontale maatlijn
        let label = formatLabel(type, length);
        if (type === 'dag' && dagConfig && dagConfig.dag[dagIndex]) {
          const segMeta = dagConfig.dag[dagIndex];
          label = `${segMeta.locked ? 'üîí ' : ''}Dag ${Math.round(segMeta.length)}mm`;
        }
        const mid = (start + end) / 2;
        const txt = text(toPx(mid), chainY - 16, label, 'maatkettingText');
        if (type === 'dag' && dagConfig && dagConfig.dag[dagIndex]) {
          txt.setAttribute('data-segment-id', dagConfig.dag[dagIndex].id);
          txt.setAttribute('data-segment-type', 'h');
          dagIndex++;
        }
        group.appendChild(txt);
      }

      return group;
    }

    function renderVertChain(boundaries, dagConfig) {
      const chainX = toPx(state.Wmm + 80);
      const tickWidth = 18;
      let dagIndex = 0;
      const group = n('g');
      group.setAttribute('class', 'maatketting');

      const baseLine = line(chainX, toPx(boundaries[0]), chainX, toPx(boundaries[boundaries.length - 1]), 'maatkettingLine');
      group.appendChild(baseLine);

      boundaries.forEach(pos => {
        const tick = line(chainX - tickWidth, toPx(pos), chainX + 6, toPx(pos), 'maatkettingTick');
        group.appendChild(tick);
      });

      for (let i = 0; i < boundaries.length - 1; i++) {
        const start = boundaries[i];
        const end = boundaries[i + 1];
        const length = end - start;
        if (length <= 0) continue;
        const type = segmentType(length, start, true); // true = verticale maatlijn
        let label = formatLabel(type, length);
        if (type === 'dag' && dagConfig && dagConfig.dag[dagIndex]) {
          const segMeta = dagConfig.dag[dagIndex];
          label = `${segMeta.locked ? 'üîí ' : ''}Dag ${Math.round(segMeta.length)}mm`;
        }
        const mid = (start + end) / 2;
        const txt = text(chainX + 12, toPx(mid), label, 'maatkettingText maatkettingTextVert');
        txt.setAttribute('text-anchor', 'start');
        txt.setAttribute('dominant-baseline', 'middle');
        if (type === 'dag' && dagConfig && dagConfig.dag[dagIndex]) {
          txt.setAttribute('data-segment-id', dagConfig.dag[dagIndex].id);
          txt.setAttribute('data-segment-type', 'v');
          dagIndex++;
        }
        group.appendChild(txt);
      }

      return group;
    }

    // Update statistieken
    countStijl.textContent = state.tussenStijlen.length;
    countDorpel.textContent = state.tussenDorpels.length;

    // Update modus info
    if (!state.kanTekenen) {
      modeText.textContent = 'Tekenen is uitgeschakeld. Klik op vakken voor type toewijzing.';
    } else if (state.tussenStijlen.length === 0 && state.tussenDorpels.length === 0) {
      modeText.textContent = 'Klaar om te tekenen! Sleep verticale of horizontale lijnen.';
    } else {
      modeText.textContent = `${state.tussenStijlen.length} stijlen, ${state.tussenDorpels.length} dorpels`;
    }
    
    // Teken vaknummers opnieuw als ze al gedetecteerd zijn
    if (state.vakken.length > 0) {
      tekenVakken();
    }
    
    // Update prijs overzicht
    updatePrijsOverzicht();
    
    updateTekenenStatusUI();
  }

  function screenToMm(evt){
    const pt = svg.createSVGPoint(); 
    pt.x = evt.clientX; 
    pt.y = evt.clientY;
    const ctm = svg.getScreenCTM(); 
    const p = pt.matrixTransform(ctm.inverse());
    const {s, pad} = mmToPxScale(); 
    return {x: (p.x - pad) / s, y: (p.y - pad) / s};
  }

  function isValidCoord(pos) {
    return pos.x >= 0 && pos.x <= state.Wmm && pos.y >= 0 && pos.y <= state.Hmm;
  }

  // Functie om alle dorpels en stijlen automatisch te splitsen bij kruispunten
  // Deze functie maakt dorpels en stijlen "krachtig" zoals het kader - ze stoppen daadwerkelijk bij elkaar
  function splitAlleDorpelsEnStijlen() {
    const tussen = state.tussenDikte;
    const halfTussen = tussen / 2;
    
    // Helper om dorpel segmenten te berekenen
    function berekenDorpelSegmenten(dorpel) {
      const y = dorpel.y1;
      const xStart = dorpel.x1;
      const xEnd = dorpel.x2;
      
      const kruisendeStijlen = state.tussenStijlen.filter(s => {
        const stijlLinks = s.x1 - halfTussen;
        const stijlRechts = s.x1 + halfTussen;
        return y >= s.y1 && y <= s.y2 && 
               xStart < stijlRechts && xEnd > stijlLinks;
      });
      
      if (kruisendeStijlen.length === 0) {
        return [{ xStart: xStart, xEnd: xEnd, y: y }];
      }
      
      const splitsPunten = [xStart, xEnd];
      kruisendeStijlen.forEach(s => {
        const stijlLinks = s.x1 - halfTussen;
        const stijlRechts = s.x1 + halfTussen;
        if (stijlLinks >= xStart && stijlLinks <= xEnd) splitsPunten.push(stijlLinks);
        if (stijlRechts >= xStart && stijlRechts <= xEnd) splitsPunten.push(stijlRechts);
      });
      
      const gesorteerd = [...new Set(splitsPunten)].sort((a, b) => a - b);
      const segmenten = [];
      
      for (let i = 0; i < gesorteerd.length - 1; i++) {
        const segStart = gesorteerd[i];
        const segEnd = gesorteerd[i + 1];
        
        const overlaptMetStijl = kruisendeStijlen.some(s => {
          const stijlLinks = s.x1 - halfTussen;
          const stijlRechts = s.x1 + halfTussen;
          return segStart < stijlRechts && segEnd > stijlLinks;
        });
        
        if (!overlaptMetStijl && segEnd > segStart) {
          segmenten.push({ xStart: segStart, xEnd: segEnd, y: y });
        }
      }
      
      return segmenten.length > 0 ? segmenten : [];
    }
    
    // Helper om stijl segmenten te berekenen
    function berekenStijlSegmenten(stijl) {
      const x = stijl.x1;
      const yStart = stijl.y1;
      const yEnd = stijl.y2;
      
      const kruisendeDorpels = state.tussenDorpels.filter(d => {
        const dorpelBoven = d.y1 - halfTussen;
        const dorpelOnder = d.y1 + halfTussen;
        return x >= d.x1 && x <= d.x2 &&
               yStart < dorpelOnder && yEnd > dorpelBoven;
      });
      
      if (kruisendeDorpels.length === 0) {
        return [{ x: x, yStart: yStart, yEnd: yEnd }];
      }
      
      const onderbrekingen = [];
      kruisendeDorpels.forEach(d => {
        const dorpelBoven = d.y1 - halfTussen;
        const dorpelOnder = d.y1 + halfTussen;
        if (dorpelBoven > yStart && dorpelBoven < yEnd) {
          onderbrekingen.push({ type: 'start', y: dorpelBoven });
        }
        if (dorpelOnder > yStart && dorpelOnder < yEnd) {
          onderbrekingen.push({ type: 'end', y: dorpelOnder });
        }
      });
      
      onderbrekingen.sort((a, b) => a.y - b.y);
      const segmenten = [];
      let huidigeStart = yStart;
      
      for (const onderbreking of onderbrekingen) {
        if (onderbreking.type === 'start' && onderbreking.y > huidigeStart) {
          segmenten.push({ x: x, yStart: huidigeStart, yEnd: onderbreking.y });
        }
        if (onderbreking.type === 'end') {
          huidigeStart = onderbreking.y;
        }
      }
      
      if (huidigeStart < yEnd) {
        segmenten.push({ x: x, yStart: huidigeStart, yEnd: yEnd });
      }
      
      return segmenten.length > 0 ? segmenten : (onderbrekingen.length === 0 ? [{ x: x, yStart: yStart, yEnd: yEnd }] : []);
    }
    
    // Split alle dorpels
    const nieuweDorpels = [];
    state.tussenDorpels.forEach(d => {
      const segmenten = berekenDorpelSegmenten(d);
      segmenten.forEach(seg => {
        nieuweDorpels.push({ x1: seg.xStart, y1: seg.y, x2: seg.xEnd, y2: seg.y });
      });
    });
    state.tussenDorpels = nieuweDorpels;
    
    // Split alle stijlen
    const nieuweStijlen = [];
    state.tussenStijlen.forEach(s => {
      const segmenten = berekenStijlSegmenten(s);
      segmenten.forEach(seg => {
        nieuweStijlen.push({ x1: seg.x, y1: seg.yStart, x2: seg.x, y2: seg.yEnd });
      });
    });
    state.tussenStijlen = nieuweStijlen;
  }

  // Muis events
  svg.addEventListener('mousedown', e => {
    if (!state.kanTekenen) return;
    const pos = screenToMm(e);
    if (!isValidCoord(pos)) return;
    
    drawing = true;
    start = pos;
    preview = line(toPx(pos.x), toPx(pos.y), toPx(pos.x), toPx(pos.y), 'preview');
    svg.appendChild(preview);
  });

  svg.addEventListener('mousemove', e => {
    if (!state.kanTekenen) return;
    if (!drawing || !preview) return;
    
    let pos = screenToMm(e);
    pos.x = Math.max(0, Math.min(state.Wmm, pos.x));
    pos.y = Math.max(0, Math.min(state.Hmm, pos.y));
    
    const dx = Math.abs(pos.x - start.x);
    const dy = Math.abs(pos.y - start.y);
    
    // Bepaal of het verticale (stijl) of horizontale (dorpel) lijn is
    if (dx > dy) {
      pos.y = start.y;
      preview.setAttribute('class', 'preview dorpel');
    } else {
      pos.x = start.x;
      preview.setAttribute('class', 'preview stijl');
    }
    
    preview.setAttribute('x2', toPx(pos.x));
    preview.setAttribute('y2', toPx(pos.y));
  });

  svg.addEventListener('mouseup', e => {
    if (!state.kanTekenen) return;
    if (!drawing) return;
    drawing = false;
    
    if (!preview) return;
    svg.removeChild(preview);
    preview = null;
    
    let end = screenToMm(e);
    end.x = Math.max(0, Math.min(state.Wmm, end.x));
    end.y = Math.max(0, Math.min(state.Hmm, end.y));
    
    const dx = Math.abs(end.x - start.x);
    const dy = Math.abs(end.y - start.y);
    
    // Te kort? niets doen
    if (dx < 5 && dy < 5) return;
    
    const frame = state.frameDikte;
    const tussen = state.tussenDikte;
    const halfTussen = tussen / 2;
    const halfFrame = frame / 2;
    
    // Helper: vind dichtstbijzijnde verticale lijn links of rechts (kader of tussenstijl)
    function findNearestStijl(x, isLeft) {
      const linkerStijlX = halfFrame;
      const rechterStijlX = state.Wmm - halfFrame;
      const linkerStijlRandLinks = linkerStijlX - halfFrame;
      const linkerStijlRandRechts = linkerStijlX + halfFrame;
      const rechterStijlRandLinks = rechterStijlX - halfFrame;
      const rechterStijlRandRechts = rechterStijlX + halfFrame;
      
      let nearest = isLeft ? linkerStijlRandRechts : rechterStijlRandLinks; // kader rand als default
      let minDist = Math.abs(x - nearest);
      
      state.tussenStijlen.forEach(s => {
        const sx = s.x1;
        const stijlRandLinks = sx - halfTussen;
        const stijlRandRechts = sx + halfTussen;
        
        // Check welke rand het dichtstbij is
        const distLinks = Math.abs(x - stijlRandLinks);
        const distRechts = Math.abs(x - stijlRandRechts);
        const distMidden = Math.abs(x - sx);
        const dichtstbij = Math.min(distLinks, distRechts, distMidden);
        
        if (isLeft && sx < x && dichtstbij < minDist) {
          // Gebruik de rechterrand van de stijl (want we komen van links)
          nearest = stijlRandRechts;
          minDist = dichtstbij;
        } else if (!isLeft && sx > x && dichtstbij < minDist) {
          // Gebruik de linkerrand van de stijl (want we komen van rechts)
          nearest = stijlRandLinks;
          minDist = dichtstbij;
        }
      });
      
      return nearest;
    }
    
    // Helper: vind dichtstbijzijnde horizontale lijn boven of onder (kader of tussendorpel)
    function findNearestDorpel(y, isUp) {
      const bovendorpelY = halfFrame;
      const onderdorpelDikte = state.ekosietOnderdorpel ? 52 : frame;
      const halfOnderdorpel = onderdorpelDikte / 2;
      const onderdorpelY = state.Hmm - halfOnderdorpel;
      const bovendorpelRand = bovendorpelY + halfFrame;
      const onderdorpelRand = onderdorpelY - halfOnderdorpel;
      
      let nearest = isUp ? bovendorpelRand : onderdorpelRand; // kader rand als default
      let minDist = Math.abs(y - nearest);
      
      state.tussenDorpels.forEach(d => {
        const dy = d.y1;
        const dorpelRandBoven = dy - halfTussen;
        const dorpelRandOnder = dy + halfTussen;
        
        // Check welke rand het dichtstbij is
        const distBoven = Math.abs(y - dorpelRandBoven);
        const distOnder = Math.abs(y - dorpelRandOnder);
        const distMidden = Math.abs(y - dy);
        const dichtstbij = Math.min(distBoven, distOnder, distMidden);
        
        if (isUp && dy < y && dichtstbij < minDist) {
          // Gebruik de onderste rand van de dorpel (want we komen van boven)
          nearest = dorpelRandOnder;
          minDist = dichtstbij;
        } else if (!isUp && dy > y && dichtstbij < minDist) {
          // Gebruik de bovenste rand van de dorpel (want we komen van onder)
          nearest = dorpelRandBoven;
          minDist = dichtstbij;
        }
      });
      
      return nearest;
    }
    
    // Voeg lijn toe aan juiste array met automatische extensie naar kader of bestaand onderdeel
    if (dy > dx) {
      // Verticaal = tussen stijl
      const x = start.x;
      const yActualStart = Math.min(start.y, end.y);
      const yActualEnd = Math.max(start.y, end.y);
      
      // Vind dichtstbijzijnde dorpel/stijl om aan te sluiten
      // Voor boven: zoek naar dichtstbijzijnde horizontale lijn boven (kader of tussendorpel)
      const y1 = findNearestDorpel(yActualStart, true);
      
      // Voor onder: zoek naar dichtstbijzijnde horizontale lijn onder (kader of tussendorpel)
      const y2 = findNearestDorpel(yActualEnd, false);
      
      state.tussenStijlen.push({x1: x, y1: y1, x2: x, y2: y2});
    } else {
      // Horizontaal = tussen dorpel
      const y = start.y;
      const xActualStart = Math.min(start.x, end.x);
      const xActualEnd = Math.max(start.x, end.x);
      
      // Vind dichtstbijzijnde stijl om aan te sluiten
      // Voor links: zoek naar dichtstbijzijnde verticale lijn links (kader of tussenstijl)
      const x1 = findNearestStijl(xActualStart, true);
      
      // Voor rechts: zoek naar dichtstbijzijnde verticale lijn rechts (kader of tussenstijl)
      const x2 = findNearestStijl(xActualEnd, false);
      
      state.tussenDorpels.push({x1: x1, y1: y, x2: x2, y2: y});
    }
    
    // Split automatisch alle dorpels en stijlen bij kruispunten
    splitAlleDorpelsEnStijlen();
    
    draw();
  });

  // Knoppen
  if (ekosietOnderdorpelCheckbox) {
    ekosietOnderdorpelCheckbox.addEventListener('change', (e) => {
      state.ekosietOnderdorpel = e.target.checked;
      resetDagConfigCache();
      draw();
    });
  }

  btnApply.addEventListener('click', () => { 
    state.Wmm = +inpW.value || 2000; 
    state.Hmm = +inpH.value || 2000;
    if (ekosietOnderdorpelCheckbox) {
      state.ekosietOnderdorpel = ekosietOnderdorpelCheckbox.checked;
    }
    resetDagConfigCache();
    draw(); 
  });
  
  btnReset.addEventListener('click', () => { 
    if (confirm('Weet je zeker dat je alle lijnen wilt wissen?')) {
      state.tussenStijlen = []; 
      state.tussenDorpels = [];
      state.vakken = [];
      state.vakkenToewijzingen = {};
      state.kanTekenen = true;
      vakkenFieldset.style.display = 'none';
      closeVakQuickMenu(true);
      resetDagConfigCache();
      draw(); 
    }
  });
  
  btnUndo.addEventListener('click', () => {
    const wasVergrendeld = !state.kanTekenen;
    if (wasVergrendeld) {
      state.kanTekenen = true;
      state.vakken = [];
      state.vakkenToewijzingen = {};
      vakkenFieldset.style.display = 'none';
      closeVakQuickMenu(true);
    }
    let heeftGewijzigd = false;
    // Verwijder laatste toegevoegde element en split alles opnieuw
    // Omdat alles al gesplitst is, verwijderen we gewoon de laatste en splitsen opnieuw
    // Dit is een vereenvoudigde aanpak - in de praktijk zou je een history moeten bijhouden
    if (state.tussenStijlen.length > 0) {
      // Verwijder alle stijlen met dezelfde x-positie als de laatste (gesplitste delen)
      const laatsteStijl = state.tussenStijlen[state.tussenStijlen.length - 1];
      const xPos = laatsteStijl.x1;
      // Verwijder alle stijlen op deze x-positie (zijn gesplitste delen van √©√©n stijl)
      state.tussenStijlen = state.tussenStijlen.filter(s => s.x1 !== xPos);
      // Split alles opnieuw
      splitAlleDorpelsEnStijlen();
      heeftGewijzigd = true;
    } else if (state.tussenDorpels.length > 0) {
      // Verwijder alle dorpels met dezelfde y-positie als de laatste (gesplitste delen)
      const laatsteDorpel = state.tussenDorpels[state.tussenDorpels.length - 1];
      const yPos = laatsteDorpel.y1;
      // Verwijder alle dorpels op deze y-positie (zijn gesplitste delen van √©√©n dorpel)
      state.tussenDorpels = state.tussenDorpels.filter(d => d.y1 !== yPos);
      // Split alles opnieuw
      splitAlleDorpelsEnStijlen();
      heeftGewijzigd = true;
    }
    if (wasVergrendeld || heeftGewijzigd) {
      closeVakQuickMenu();
      resetDagConfigCache();
      draw();
    }
  });

  // Snapshots
  btnSave.addEventListener('click', () => {
    const snap = { 
      Wmm: state.Wmm, 
      Hmm: state.Hmm,
      frameDikte: state.frameDikte,
      tussenDikte: state.tussenDikte,
      tussenStijlen: state.tussenStijlen.slice(), 
      tussenDorpels: state.tussenDorpels.slice(),
      vakken: state.vakken.slice(),
      vakkenToewijzingen: {...state.vakkenToewijzingen},
      kanTekenen: state.kanTekenen,
      ekosietOnderdorpel: state.ekosietOnderdorpel
    };
    localStorage.setItem(LS_KEY, JSON.stringify(snap));
    alert('‚úÖ Opgeslagen!');
  });
  
  btnLoad.addEventListener('click', () => {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) {
      alert('Geen opgeslagen versie gevonden.');
      return;
    }
    try {
      const snap = JSON.parse(raw);
      state.Wmm = +snap.Wmm || 2000;
      state.Hmm = +snap.Hmm || 2000;
      state.frameDikte = +snap.frameDikte || 67;
      state.tussenDikte = +snap.tussenDikte || 90;
      state.tussenStijlen = Array.isArray(snap.tussenStijlen) ? snap.tussenStijlen : [];
      state.tussenDorpels = Array.isArray(snap.tussenDorpels) ? snap.tussenDorpels : [];
      state.vakken = Array.isArray(snap.vakken) ? snap.vakken : [];
      state.vakkenToewijzingen = snap.vakkenToewijzingen || {};
      normalizeAlleToewijzingen();
      state.kanTekenen = snap.hasOwnProperty('kanTekenen') ? !!snap.kanTekenen : state.vakken.length === 0;
      state.ekosietOnderdorpel = snap.hasOwnProperty('ekosietOnderdorpel') ? !!snap.ekosietOnderdorpel : false;
      resetDagConfigCache();
      inpW.value = state.Wmm;
      inpH.value = state.Hmm;
      if (ekosietOnderdorpelCheckbox) {
        ekosietOnderdorpelCheckbox.checked = state.ekosietOnderdorpel;
      }
      
      // Toon vakken als ze geladen zijn
      if (state.vakken.length > 0) {
        toonVakken();
      } else {
        vakkenFieldset.style.display = 'none';
      }
      
      draw();
      alert('‚úÖ Geladen!');
    } catch (_) {
      alert('‚ùå Fout bij laden.');
    }
  });

  // PDF Export functie - toont PDF in modal
  let currentPdfBlob = null;
  let currentPdfFileName = '';

  async function exportNaarPDF() {
    if (!window.jspdf || !window.html2canvas) {
      alert('PDF export bibliotheken zijn niet geladen. Ververs de pagina en probeer opnieuw.');
      return;
    }

    try {
      // Toon laad indicator
      if (btnExportPDF) {
        btnExportPDF.disabled = true;
        btnExportPDF.textContent = '‚è≥ PDF wordt gegenereerd...';
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('landscape', 'mm', 'a4');
      
      // Converteer SVG canvas naar afbeelding met html2canvas
      const canvasWrap = document.querySelector('.canvasWrap');
      if (!canvasWrap) {
        throw new Error('Canvas element niet gevonden');
      }

      const canvas = await html2canvas(canvasWrap, {
        backgroundColor: '#0f1318',
        scale: 2,
        logging: false,
        useCORS: true
      });

      // Bereken schaal voor PDF (A4 landscape: 297mm x 210mm)
      const pdfWidth = 297;
      const pdfHeight = 210;
      const margin = 15;
      const maxWidth = pdfWidth - (margin * 2);
      const maxHeight = pdfHeight - (margin * 2) - 60; // Ruimte voor tekst onderaan
      
      // Converteer pixels naar mm (96 DPI = 3.7795 pixels per mm)
      const pxToMm = 0.264583; // 1px = 0.264583mm bij 96 DPI
      const imgWidthMm = canvas.width * pxToMm;
      const imgHeightMm = canvas.height * pxToMm;
      
      const scale = Math.min(maxWidth / imgWidthMm, maxHeight / imgHeightMm);
      const imgWidth = imgWidthMm * scale;
      const imgHeight = imgHeightMm * scale;
      const imgX = margin + (maxWidth - imgWidth) / 2;
      const imgY = margin + 15; // Extra ruimte voor titel

      // Voeg titel toe
      pdf.setFontSize(16);
      pdf.setFont(undefined, 'bold');
      pdf.text('Technische Tekening Kozijn', pdfWidth / 2, 10, { align: 'center' });
      
      // Voeg afmetingen toe
      pdf.setFontSize(10);
      pdf.setFont(undefined, 'normal');
      pdf.text(`Buitenmaat: ${state.Wmm}mm √ó ${state.Hmm}mm`, pdfWidth / 2, 18, { align: 'center' });
      
      if (state.ekosietOnderdorpel) {
        pdf.text('Ekosiet onderdorpel', pdfWidth / 2, 22, { align: 'center' });
      }

      // Voeg canvas afbeelding toe
      const imgData = canvas.toDataURL('image/png');
      pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth, imgHeight);

      // Voeg opsomming van vakindelingen toe
      let yPos = imgY + imgHeight + 10;
      
      pdf.setFontSize(12);
      pdf.setFont(undefined, 'bold');
      pdf.text('Vakindelingen:', margin, yPos);
      
      yPos += 8;
      pdf.setFontSize(10);
      pdf.setFont(undefined, 'normal');
      
      if (state.vakken.length === 0) {
        pdf.text('Geen vakken gedetecteerd', margin, yPos);
      } else {
        state.vakken.forEach((vak, idx) => {
          const toewijzing = getVakToewijzing(vak.id);
          const beschrijving = formatToewijzing(toewijzing);
          const maten = `${Math.round(vak.breedte)}mm √ó ${Math.round(vak.hoogte)}mm`;
          
          const regel = `Vak ${vak.id}: ${beschrijving} - ${maten}`;
          
          // Controleer of regel op nieuwe pagina moet
          if (yPos > pdfHeight - 20) {
            pdf.addPage();
            yPos = margin;
          }
          
          pdf.text(regel, margin, yPos);
          yPos += 6;
        });
      }

      // Voeg afwerkingsopties toe als ze zijn ingesteld
      if (state.afwerkingsOpties.glasType || state.afwerkingsOpties.afwerking) {
        yPos += 5;
        if (yPos > pdfHeight - 30) {
          pdf.addPage();
          yPos = margin;
        }
        
        pdf.setFontSize(12);
        pdf.setFont(undefined, 'bold');
        pdf.text('Afwerkingsopties:', margin, yPos);
        yPos += 8;
        
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'normal');
        
        if (state.afwerkingsOpties.glasType) {
          const glasTypeLabel = state.afwerkingsOpties.glasType === 'hr++' ? 'HR++' : 
                                state.afwerkingsOpties.glasType === 'hr+++' ? 'HR+++' : 'Enkelglas';
          pdf.text(`Glas type: ${glasTypeLabel}`, margin, yPos);
          yPos += 6;
        }
        
        if (state.afwerkingsOpties.afwerking) {
          const afwerkingLabel = state.afwerkingsOpties.afwerking === 'afgelakt' ? 'Afgelakt' : 'Alleen gegrond';
          pdf.text(`Afwerking: ${afwerkingLabel}`, margin, yPos);
          yPos += 6;
        }
        
        if (state.afwerkingsOpties.kleurDeurenRamenBinnen || 
            state.afwerkingsOpties.kleurDeurenRamenBuiten || 
            state.afwerkingsOpties.kleurKozijn) {
          pdf.text('Kleuren:', margin, yPos);
          yPos += 6;
          if (state.afwerkingsOpties.kleurDeurenRamenBinnen) {
            pdf.text(`  - Deuren/ramen binnen: ${state.afwerkingsOpties.kleurDeurenRamenBinnen}`, margin + 5, yPos);
            yPos += 6;
          }
          if (state.afwerkingsOpties.kleurDeurenRamenBuiten) {
            pdf.text(`  - Deuren/ramen buiten: ${state.afwerkingsOpties.kleurDeurenRamenBuiten}`, margin + 5, yPos);
            yPos += 6;
          }
          if (state.afwerkingsOpties.kleurKozijn) {
            pdf.text(`  - Kozijn: ${state.afwerkingsOpties.kleurKozijn}`, margin + 5, yPos);
            yPos += 6;
          }
        }
      }

      // Voeg datum toe
      const datum = new Date().toLocaleDateString('nl-NL', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      pdf.setFontSize(8);
      pdf.text(`Gegenereerd op: ${datum}`, pdfWidth - margin, pdfHeight - 10, { align: 'right' });

      // Genereer PDF als blob en toon in modal
      const pdfBlob = pdf.output('blob');
      currentPdfBlob = pdfBlob;
      currentPdfFileName = `technische-tekening-kozijn-${Date.now()}.pdf`;
      
      // Maak blob URL voor iframe
      const blobUrl = URL.createObjectURL(pdfBlob);
      
      // Toon modal met PDF
      const modal = document.getElementById('technischeTekeningModal');
      const iframe = document.getElementById('technischeTekeningIframe');
      if (modal && iframe) {
        iframe.src = blobUrl;
        modal.classList.add('active');
      }
      
      if (btnExportPDF) {
        btnExportPDF.disabled = false;
        btnExportPDF.textContent = 'üìÑ Technische Tekening';
      }
    } catch (error) {
      console.error('Fout bij PDF export:', error);
      alert('‚ùå Fout bij het genereren van de PDF: ' + error.message);
      
      if (btnExportPDF) {
        btnExportPDF.disabled = false;
        btnExportPDF.textContent = 'üìÑ Technische Tekening';
      }
    }
  }

  // Download PDF functie
  function downloadTechnischeTekening() {
    if (currentPdfBlob && currentPdfFileName) {
      const url = URL.createObjectURL(currentPdfBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = currentPdfFileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  }

  // Sluit modal functie
  function sluitTechnischeTekeningModal() {
    const modal = document.getElementById('technischeTekeningModal');
    const iframe = document.getElementById('technischeTekeningIframe');
    if (modal) {
      modal.classList.remove('active');
      if (iframe) {
        const oldSrc = iframe.src;
        iframe.src = '';
        if (oldSrc.startsWith('blob:')) {
          URL.revokeObjectURL(oldSrc);
        }
      }
    }
  }

  // Event listener voor PDF export
  if (btnExportPDF) {
    btnExportPDF.addEventListener('click', exportNaarPDF);
  }

  // Event listeners voor technische tekening modal
  const technischeTekeningModal = document.getElementById('technischeTekeningModal');
  const technischeTekeningModalClose = document.getElementById('technischeTekeningModalClose');
  const technischeTekeningSluiten = document.getElementById('technischeTekeningSluiten');
  const technischeTekeningDownload = document.getElementById('technischeTekeningDownload');

  if (technischeTekeningModalClose) {
    technischeTekeningModalClose.addEventListener('click', sluitTechnischeTekeningModal);
  }

  if (technischeTekeningSluiten) {
    technischeTekeningSluiten.addEventListener('click', sluitTechnischeTekeningModal);
  }

  if (technischeTekeningDownload) {
    technischeTekeningDownload.addEventListener('click', downloadTechnischeTekening);
  }

  // Sluit modal bij klik buiten modal
  if (technischeTekeningModal) {
    technischeTekeningModal.addEventListener('click', (e) => {
      if (e.target === technischeTekeningModal) {
        sluitTechnischeTekeningModal();
      }
    });
  }

  btnEqualizeDagHoriz.addEventListener('click', () => {
    if (state.kanTekenen) {
      alert('Beschikbaar na "Klaar met tekenen".');
      return;
    }
    equalizeDagSegments('h');
  });

  btnEqualizeDagVert.addEventListener('click', () => {
    if (state.kanTekenen) {
      alert('Beschikbaar na "Klaar met tekenen".');
      return;
    }
    equalizeDagSegments('v');
  });

  btnDistributeMiddleHoriz.addEventListener('click', () => {
    if (state.kanTekenen) {
      alert('Beschikbaar na "Klaar met tekenen".');
      return;
    }
    distributeMiddleSegments('h');
  });

  btnDistributeMiddleVert.addEventListener('click', () => {
    if (state.kanTekenen) {
      alert('Beschikbaar na "Klaar met tekenen".');
      return;
    }
    distributeMiddleSegments('v');
  });

  svg.addEventListener('click', handleMaatkettingClick);
  maatPopoverSave.addEventListener('click', handleMaatPopoverSave);
  maatPopoverCancel.addEventListener('click', () => closeMaatPopover());
  document.addEventListener('click', handleDocumentClickForPopover);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeMaatPopover();
    }
  });

  // Detecteer alle vakken in het kozijn
  function detecteerVakken(preserveAssignments = false) {
    const frame = state.frameDikte;
    const halfFrame = frame / 2;
    const onderdorpelDikte = state.ekosietOnderdorpel ? 52 : frame;
    const tussen = state.tussenDikte;
    const halfTussen = tussen / 2;
    
    // Binnenranden van het kader waar stijlen/dorpels op aansluiten
    const bovendorpelRand = frame;
    const onderdorpelRand = state.Hmm - onderdorpelDikte;
    const linkerStijlRand = frame;
    const rechterStijlRand = state.Wmm - frame;
    
    // Helper: bereken de daadwerkelijk getekende segmenten van een tussendorpel
    // Dorpels zijn al gesplitst in aparte objecten, gebruik gewoon de volledige lengte
    function getDorpelSegmenten(dorpel) {
      return [{ xStart: dorpel.x1, xEnd: dorpel.x2, y: dorpel.y1 }];
    }
    
    // Helper: bereken de daadwerkelijk getekende segmenten van een tussenstijl
    // Stijlen zijn al gesplitst in aparte objecten, gebruik gewoon de volledige lengte
    function getStijlSegmenten(stijl) {
      return [{ x: stijl.x1, yStart: stijl.y1, yEnd: stijl.y2 }];
    }
    
    // Verzamel alle verticale scheidslijnen van daadwerkelijk getekende stijl segmenten
    const verticaleRanden = new Set([linkerStijlRand, rechterStijlRand]);
    
    state.tussenStijlen.forEach(s => {
      const stijlSegmenten = getStijlSegmenten(s);
      stijlSegmenten.forEach(seg => {
        verticaleRanden.add(seg.x - halfTussen);
        verticaleRanden.add(seg.x + halfTussen);
      });
    });
    
    // Voeg ook de xStart en xEnd van dorpels toe (zijn ook verticale randen)
    state.tussenDorpels.forEach(d => {
      const dorpelSegmenten = getDorpelSegmenten(d);
      dorpelSegmenten.forEach(seg => {
        verticaleRanden.add(seg.xStart);
        verticaleRanden.add(seg.xEnd);
      });
    });
    
    const verticaleRandenArray = Array.from(verticaleRanden).sort((a, b) => a - b);
    
    // Maak vakken alleen in de OPEN ruimtes tussen de massieve balken
    const oudeToewijzingen = preserveAssignments && Array.isArray(state.vakken)
      ? state.vakken.map(vak => state.vakkenToewijzingen[vak.id] || null)
      : null;

    const vakken = [];
    let vakNummer = 1;
    
    for (let j = 0; j < verticaleRandenArray.length - 1; j++) {
      const xLeft = verticaleRandenArray[j];
      const xRight = verticaleRandenArray[j + 1];
      
      // Verzamel alleen horizontale randen die relevant zijn voor dit x-bereik
      const horizontaleRanden = new Set([bovendorpelRand, onderdorpelRand]);
      
      state.tussenDorpels.forEach(d => {
        const segmenten = getDorpelSegmenten(d);
        segmenten.forEach(seg => {
          const overlaptX = !(xRight <= seg.xStart || xLeft >= seg.xEnd);
          if (overlaptX) {
            horizontaleRanden.add(seg.y - halfTussen);
            horizontaleRanden.add(seg.y + halfTussen);
          }
        });
      });
      
      state.tussenStijlen.forEach(s => {
        const segmenten = getStijlSegmenten(s);
        segmenten.forEach(seg => {
          const stijlLinks = seg.x - halfTussen;
          const stijlRechts = seg.x + halfTussen;
          const overlaptX = !(xRight <= stijlLinks || xLeft >= stijlRechts);
          if (overlaptX) {
            horizontaleRanden.add(seg.yStart);
            horizontaleRanden.add(seg.yEnd);
          }
        });
      });
      
      const horizontaleRandenArray = Array.from(horizontaleRanden).sort((a, b) => a - b);
      
      for (let i = 0; i < horizontaleRandenArray.length - 1; i++) {
        const yTop = horizontaleRandenArray[i];
        const yBottom = horizontaleRandenArray[i + 1];
        
        // Check of dit overlapt met een daadwerkelijk getekend dorpel segment
        const isInDorpelSegment = state.tussenDorpels.some(d => {
          const dorpelSegmenten = getDorpelSegmenten(d);
          return dorpelSegmenten.some(seg => {
            const balkLinks = seg.xStart;
            const balkRechts = seg.xEnd;
            const balkBoven = seg.y - halfTussen;
            const balkOnder = seg.y + halfTussen;
            // Overlap als: niet volledig buiten het segment
            return !(xRight <= balkLinks || xLeft >= balkRechts || yBottom <= balkBoven || yTop >= balkOnder);
          });
        });
        
        // Check of dit overlapt met een daadwerkelijk getekend stijl segment
        const isInStijlSegment = state.tussenStijlen.some(s => {
          const stijlSegmenten = getStijlSegmenten(s);
          return stijlSegmenten.some(seg => {
            const balkLinks = seg.x - halfTussen;
            const balkRechts = seg.x + halfTussen;
            const balkBoven = seg.yStart;
            const balkOnder = seg.yEnd;
            // Overlap als: niet volledig buiten het segment
            return !(xRight <= balkLinks || xLeft >= balkRechts || yBottom <= balkBoven || yTop >= balkOnder);
          });
        });
        
        if (!isInDorpelSegment && !isInStijlSegment) {
          const breedte = xRight - xLeft;
          const hoogte = yBottom - yTop;
          
          if (breedte > 10 && hoogte > 10) { // Minimaal 10mm
            vakken.push({
              id: vakNummer++,
              x: xLeft,
              y: yTop,
              breedte: breedte,
              hoogte: hoogte
            });
          }
        }
      }
    }
    
    state.vakken = vakken;

    if (preserveAssignments && oudeToewijzingen && oudeToewijzingen.length === vakken.length) {
      const nieuweToewijzingen = {};
      vakken.forEach((vak, idx) => {
        const oude = oudeToewijzingen[idx];
        if (oude) {
          nieuweToewijzingen[vak.id] = oude;
        }
      });
      state.vakkenToewijzingen = nieuweToewijzingen;
    } else {
      state.vakkenToewijzingen = {};
    }
    
    // Toon vakken in de interface
    toonVakken();
    
    // Teken vaknummers op het SVG
    tekenVakken();
  }

  function handleMaatkettingClick(e) {
    const target = e.target;
    if (!target || !target.dataset || !target.dataset.segmentId) return;
    if (state.kanTekenen) {
      alert('Beschikbaar na "Klaar met tekenen".');
      return;
    }
    e.stopPropagation();
    openMaatPopoverForSegment(target.dataset.segmentType, target.dataset.segmentId, target);
  }

  function openMaatPopoverForSegment(axis, segmentId, anchor) {
    const config = ensureDagConfig(axis);
    if (!config) return;
    const idx = findDagSegmentIndex(axis, segmentId);
    if (idx === -1) return;
    const segment = config.dag[idx];
    actieveMaatContext = { axis, segmentId };
    maatPopoverInput.value = Math.round(segment.length);
    const defaultLock = segment.locked || !segment.manual;
    maatPopoverLock.checked = defaultLock;
    maatPopover.style.display = 'flex';
    maatPopover.style.visibility = 'hidden';
    requestAnimationFrame(() => {
      const rect = anchor.getBoundingClientRect();
      const popWidth = maatPopover.offsetWidth;
      const popHeight = maatPopover.offsetHeight;
      const left = rect.left + window.scrollX + rect.width / 2 - popWidth / 2;
      const top = rect.top + window.scrollY - popHeight - 12;
      maatPopover.style.left = `${Math.max(16, left)}px`;
      maatPopover.style.top = `${Math.max(16, top)}px`;
      maatPopover.style.visibility = 'visible';
      maatPopoverInput.focus();
      maatPopoverInput.select();
    });
  }

  function closeMaatPopover() {
    if (!maatPopover) return;
    maatPopover.style.display = 'none';
    actieveMaatContext = null;
  }

  function handleMaatPopoverSave() {
    if (!actieveMaatContext) return;
    const axis = actieveMaatContext.axis;
    const segmentId = actieveMaatContext.segmentId;
    const value = parseFloat(maatPopoverInput.value);
    if (!isFinite(value) || value <= 0) {
      alert('Voer een geldige maat in millimeters in.');
      return;
    }
    const success = updateDagSegment(axis, segmentId, value, maatPopoverLock.checked, true);
    if (!success) {
      alert('Kon het verschil niet verdelen. Ontgrendel een ander vak of pas waarden aan.');
      return;
    }
    closeMaatPopover();
  }

  function handleDocumentClickForPopover(e) {
    if (maatPopover.style.display === 'none') return;
    if (maatPopover.contains(e.target)) return;
    const target = e.target;
    if (target && target.dataset && target.dataset.segmentId) return;
    closeMaatPopover();
  }
  
  // Controleer of alle vakken zijn ingevuld
  function zijnAlleVakkenIngevuld() {
    if (state.vakken.length === 0) return false;
    return state.vakken.every(vak => {
      const toewijzing = getVakToewijzing(vak.id);
      return toewijzing && (toewijzing.type === 'raam' || toewijzing.type === 'deur' || toewijzing.type === 'glas');
    });
  }
  
  // Toon vakken in de lijst
  function toonVakken() {
    if (state.vakken.length === 0) {
      vakkenList.innerHTML = '<small>Geen vakken gedetecteerd.</small>';
      vakkenFieldset.style.display = 'none';
      if (btnAfwerkingsOpties) btnAfwerkingsOpties.style.display = 'none';
      return;
    }
    
    vakkenFieldset.style.display = 'block';
    vakkenList.innerHTML = '';
    
    state.vakken.forEach(vak => {
      const container = document.createElement('div');
      container.style.marginBottom = '10px';
      container.style.padding = '10px';
      container.style.background = '#1a1f2a';
      container.style.borderRadius = '8px';
      
      const titel = document.createElement('div');
      titel.style.fontWeight = '600';
      titel.style.color = 'var(--fg)';
      titel.style.marginBottom = '6px';
      titel.textContent = `Vak ${vak.id} (${Math.round(vak.breedte)}mm √ó ${Math.round(vak.hoogte)}mm)`;
      
      const toewijzing = getVakToewijzing(vak.id);
      const beschrijving = document.createElement('div');
      beschrijving.style.fontSize = '12px';
      beschrijving.style.color = 'var(--muted)';
      beschrijving.style.marginBottom = '10px';
      beschrijving.textContent = formatToewijzing(toewijzing);
      
      const actieWrap = document.createElement('div');
      actieWrap.style.display = 'flex';
      actieWrap.style.flexDirection = 'column';
      actieWrap.style.gap = '6px';
      
      const btnKies = document.createElement('button');
      btnKies.type = 'button';
      btnKies.className = 'btn';
      btnKies.style.width = '100%';
      btnKies.textContent = 'Type kiezen / wijzigen';
      btnKies.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        openVakQuickMenu(vak);
      });
      
      const btnVerwijder = document.createElement('button');
      btnVerwijder.type = 'button';
      btnVerwijder.className = 'btn danger';
      btnVerwijder.style.width = '100%';
      btnVerwijder.textContent = 'Verwijder toewijzing';
      btnVerwijder.disabled = !toewijzing;
      btnVerwijder.style.opacity = btnVerwijder.disabled ? '0.5' : '1';
      btnVerwijder.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        setVakToewijzing(vak.id, null);
        toonVakken();
        draw();
      });
      
      actieWrap.appendChild(btnKies);
      actieWrap.appendChild(btnVerwijder);
      
      container.appendChild(titel);
      container.appendChild(beschrijving);
      container.appendChild(actieWrap);
      
      vakkenList.appendChild(container);
    });
    
    // Open afwerkingsopties menu automatisch als alle vakken zijn ingevuld
    const alleIngevuld = zijnAlleVakkenIngevuld();
    if (alleIngevuld && !afwerkingsOptiesMenuAutoOpened && vakAfwerkingsOptiesMenu && vakAfwerkingsOptiesMenu.style.display !== 'flex') {
      // Open menu automatisch
      afwerkingsOptiesMenuAutoOpened = true;
      setTimeout(() => {
        openVakAfwerkingsOptiesMenu();
      }, 300); // Kleine vertraging voor betere UX
    }
    
    // Verberg de knop (menu opent nu automatisch)
    if (btnAfwerkingsOpties) {
      btnAfwerkingsOpties.style.display = 'none';
    }
    
    // Update prijs overzicht
    updatePrijsOverzicht();
  }
  
  // Teken vak overlays + nummers op het SVG
  function tekenVakken() {
    // Verwijder oude vak overlays
    const oudeVakken = svg.querySelectorAll('.vakOverlay');
    oudeVakken.forEach(el => el.remove());
    
    const { s, pad } = mmToPxScale();
    const toPxCached = mm => mm * s + pad;
    
    // Teken nieuwe overlays en nummers
    state.vakken.forEach(vak => {      
      const x = toPxCached(vak.x);
      const y = toPxCached(vak.y);
      const w = vak.breedte * s;
      const h = vak.hoogte * s;
      const cx = toPxCached(vak.x + vak.breedte / 2);
      const cy = toPxCached(vak.y + vak.hoogte / 2);
      
      // Klikbaar overlay-vlak (onzichtbaar)
      const rect = n('rect');
      rect.setAttribute('x', x);
      rect.setAttribute('y', y);
      rect.setAttribute('width', w);
      rect.setAttribute('height', h);
      rect.setAttribute('class', 'vakOverlay');
      rect.setAttribute('data-vak-id', vak.id);
      rect.setAttribute('fill', '#fff');
      rect.setAttribute('fill-opacity', '0');
      rect.setAttribute('pointer-events', 'all');
      rect.style.cursor = 'pointer';
      rect.addEventListener('click', (e) => {
        e.stopPropagation();
        openVakQuickMenu(vak);
      });
      svg.appendChild(rect);

      const toewijzing = getVakToewijzing(vak.id);
      tekenVakInhoud(vak, toewijzing, toPxCached, svg);
      
      // Nummer met achtergrond
      const circle = n('circle');
      circle.setAttribute('cx', cx);
      circle.setAttribute('cy', cy);
      circle.setAttribute('r', '18');
      circle.setAttribute('fill', '#1a1f2a');
      circle.setAttribute('stroke', '#4aa3ff');
      circle.setAttribute('stroke-width', '2');
      circle.setAttribute('opacity', '0.9');
      circle.setAttribute('class', 'vakOverlay');
      circle.style.pointerEvents = 'none';
      svg.appendChild(circle);
      
      const text = n('text');
      text.setAttribute('x', cx);
      text.setAttribute('y', cy);
      text.setAttribute('text-anchor', 'middle');
      text.setAttribute('dominant-baseline', 'middle');
      text.setAttribute('fill', '#4aa3ff');
      text.setAttribute('font-size', '20');
      text.setAttribute('font-weight', 'bold');
      text.setAttribute('pointer-events', 'none');
      text.setAttribute('class', 'vakOverlay');
      text.textContent = vak.id;
      svg.appendChild(text);
    });
  }

  function tekenVakInhoud(vak, toewijzing, toPxFn, svgRoot) {
    if (!toewijzing) return;
    if (toewijzing.type === 'raam') {
      // Gebruik EXACT dezelfde berekening als de overlay rect voor consistentie
      // De SVG moet exact dezelfde positie en grootte hebben als het klikbare vak
      const { s } = mmToPxScale();
      // Exact dezelfde berekening als in tekenVakken() voor de overlay rect:
      const x = toPxFn(vak.x);
      const y = toPxFn(vak.y);
      const width = vak.breedte * s;
      const height = vak.hoogte * s;
      
      // Haal de juiste SVG data URI op op basis van variant en orientation
      const variant = toewijzing.variant || null;
      const orientation = toewijzing.orientation || 'links';
      
      // Maak inline SVG groep met transform voor exacte schaling naar vak dimensies
      if (variant === 'draairaam_buiten' && orientation === 'links') {
        // De SVG content bounds in de originele viewBox
        // Content is tussen: x: 286.58-463.3, y: 145.46-407.54
        const contentMinX = 286.58;
        const contentMinY = 145.46;
        const contentMaxX = 463.3;
        const contentMaxY = 407.54;
        const contentWidth = contentMaxX - contentMinX; // ~176.72
        const contentHeight = contentMaxY - contentMinY; // ~262.08
        
        // Schaal factoren: schaal de content naar vak dimensies
        // Vak is in mm, content is in viewBox units (800x600)
        // Maar we werken in pixels, dus we moeten schalen van content size naar vak size in pixels
        const scaleX = width / contentWidth; // pixels / viewBox units
        const scaleY = height / contentHeight; // pixels / viewBox units
        
        // Maak een <g> element met transform om de SVG content direct in het canvas te plaatsen
        const g = n('g');
        g.setAttribute('class', 'vakOverlay vakInhoud');
        g.style.pointerEvents = 'none';
        
        // Transformeer zodat de content exact het vak vult:
        // translate(x - contentMinX*sx, y - contentMinY*sy) scale(sx, sy)
        const translateX = x - (contentMinX * scaleX);
        const translateY = y - (contentMinY * scaleY);
        
        g.setAttribute('transform', `translate(${translateX}, ${translateY}) scale(${scaleX}, ${scaleY})`);
        
        // Voeg de paths toe aan de groep
        const paths = [
          {d: "M288.58 145.46L463.3 145.46"},
          {d: "M288.58 145.46L463.3 145.46"},
          {d: "M288.58 145.46L288.58 407.54Z"},
          {d: "M288.58 145.46L288.58 407.54Z"},
          {d: "M463.3 145.46L463.3 407.54Z"},
          {d: "M463.3 145.46L463.3 407.54Z"},
          {d: "M288.58 407.54L463.3 407.54"},
          {d: "M288.58 407.54L463.3 407.54"},
          {d: "M305.62 162.49L446.27 162.49"},
          {d: "M305.62 390.5L446.27 390.5"},
          {d: "M305.62 162.49L305.62 390.5Z"},
          {d: "M446.27 162.49L446.27 390.5Z"},
          {d: "M445.43 162.58L445.45 162.6"},
          {d: "M445.45 162.6L445.43 162.62"},
          {d: "M445.43 162.62L445.4 162.6"},
          {d: "M445.4 162.6L445.4 162.58Z"},
          {d: "M445.4 162.58L445.43 162.54"},
          {d: "M445.43 162.54L445.45 162.51"},
          {d: "M445.45 162.51L445.49 162.49"},
          {d: "M445.49 162.49L445.55 162.49"},
          {d: "M445.55 162.49L445.61 162.51"},
          {d: "M445.61 162.51L445.63 162.56"},
          {d: "M445.63 162.56L445.63 162.6Z"},
          {d: "M445.63 162.6L445.61 162.64"},
          {d: "M445.61 162.64L445.59 162.66"},
          {d: "M445.59 162.66L445.55 162.68"},
          {d: "M445.55 162.68L445.51 162.72"},
          {d: "M445.51 162.72L445.51 162.78Z"},
          {d: "M445.51 162.89L445.49 162.91"},
          {d: "M445.49 162.91L445.51 162.93"},
          {d: "M445.51 162.93L445.53 162.91"},
          {d: "M445.53 162.91L445.51 162.89"},
          {d: "M445.8 162.58L445.82 162.6"},
          {d: "M445.82 162.6L445.8 162.62"},
          {d: "M445.8 162.62L445.78 162.6"},
          {d: "M445.78 162.6L445.78 162.58Z"},
          {d: "M445.78 162.58L445.8 162.54"},
          {d: "M445.8 162.54L445.82 162.51"},
          {d: "M445.82 162.51L445.86 162.49"},
          {d: "M445.86 162.49L445.92 162.49"},
          {d: "M445.92 162.49L445.99 162.51"},
          {d: "M445.99 162.51L446.01 162.56"},
          {d: "M446.01 162.56L446.01 162.6Z"},
          {d: "M446.01 162.6L445.99 162.64"},
          {d: "M445.99 162.64L445.97 162.66"},
          {d: "M445.97 162.66L445.92 162.68"},
          {d: "M445.92 162.68L445.88 162.72"},
          {d: "M445.88 162.72L445.88 162.78Z"},
          {d: "M445.88 162.89L445.86 162.91"},
          {d: "M445.86 162.91L445.88 162.93"},
          {d: "M445.88 162.93L445.9 162.91"},
          {d: "M445.9 162.91L445.88 162.89"},
          {d: "M288.58 145.46L463.3 276.5"},
          {d: "M288.58 407.54L463.3 276.5"},
          {d: "M286.4 167.3L288.58 167.3", stroke: "#88ccff"},
          {d: "M288.58 167.3L288.58 174.83Z", stroke: "#88ccff"},
          {d: "M288.58 179.2L288.58 186.74Z", stroke: "#88ccff"},
          {d: "M286.4 167.3L286.4 174.83Z", stroke: "#88ccff"},
          {d: "M286.4 179.2L286.4 186.74Z", stroke: "#88ccff"},
          {d: "M286.4 186.74L288.58 186.74", stroke: "#88ccff"},
          {d: "M286.4 232.82L288.58 232.82"},
          {d: "M288.58 232.82L288.58 252.26Z"},
          {d: "M286.4 232.82L286.4 252.26Z"},
          {d: "M286.4 252.26L288.58 252.26"},
          {d: "M286.4 366.26L288.58 366.26"},
          {d: "M288.58 366.26L288.58 385.7Z"},
          {d: "M286.4 366.26L286.4 385.7Z"},
          {d: "M286.4 385.7L288.58 385.7"}
        ];
        
        paths.forEach(pathData => {
          const path = n('path');
          path.setAttribute('d', pathData.d);
          path.setAttribute('stroke', pathData.stroke || '#4aa3ff');
          // Stroke-width verlaagd naar 1.0 voor dunnere lijnen
          path.setAttribute('stroke-width', '1.0');
          path.setAttribute('fill', 'none');
          g.appendChild(path);
        });
        
        svgRoot.appendChild(g);
      } else {
        // Fallback: gebruik data URI voor andere varianten
        const svgDataUri = getOrientationSvgDataUri(orientation, variant);
        const img = n('image');
        img.setAttribute('x', x);
        img.setAttribute('y', y);
        img.setAttribute('width', width);
        img.setAttribute('height', height);
        img.setAttribute('href', svgDataUri);
        img.setAttribute('preserveAspectRatio', 'none');
        img.setAttribute('class', 'vakOverlay vakInhoud');
        img.style.pointerEvents = 'none';
        svgRoot.appendChild(img);
      }
    }
    if (toewijzing.type === 'glas') {
      const margeMm = Math.min(vak.breedte, vak.hoogte) * 0.12;
      const x1 = toPxFn(vak.x + margeMm);
      const y1 = toPxFn(vak.y + margeMm);
      const x2 = toPxFn(vak.x + vak.breedte - margeMm);
      const y2 = toPxFn(vak.y + vak.hoogte - margeMm);
      const pane = n('rect');
      pane.setAttribute('x', x1);
      pane.setAttribute('y', y1);
      pane.setAttribute('width', Math.max(4, x2 - x1));
      pane.setAttribute('height', Math.max(4, y2 - y1));
      pane.setAttribute('fill', 'rgba(74,163,255,0.12)');
      pane.setAttribute('stroke', '#4aa3ff');
      pane.setAttribute('stroke-width', '1.5');
      pane.setAttribute('class', 'vakOverlay vakInhoud');
      pane.style.pointerEvents = 'none';
      svgRoot.appendChild(pane);

      if (toewijzing.variant === 'glas_vast_stapel') {
        const deelHoogte = (y2 - y1) / 3;
        for (let i = 1; i < 3; i++) {
          const lineY = y1 + deelHoogte * i;
          const stapel = n('line');
          stapel.setAttribute('x1', x1);
          stapel.setAttribute('y1', lineY);
          stapel.setAttribute('x2', x2);
          stapel.setAttribute('y2', lineY);
          stapel.setAttribute('stroke', '#4aa3ff');
          stapel.setAttribute('stroke-width', '1');
          stapel.setAttribute('class', 'vakOverlay vakInhoud');
          stapel.setAttribute('stroke-dasharray', '4 2');
          stapel.style.pointerEvents = 'none';
          svgRoot.appendChild(stapel);
        }
      }

      if (toewijzing.rooster) {
        const vert = n('line');
        vert.setAttribute('x1', (x1 + x2) / 2);
        vert.setAttribute('y1', y1);
        vert.setAttribute('x2', (x1 + x2) / 2);
        vert.setAttribute('y2', y2);
        vert.setAttribute('stroke', '#4aa3ff');
        vert.setAttribute('stroke-width', '1');
        vert.setAttribute('class', 'vakOverlay vakInhoud');
        vert.style.pointerEvents = 'none';
        svgRoot.appendChild(vert);

        const horiz = n('line');
        horiz.setAttribute('x1', x1);
        horiz.setAttribute('y1', (y1 + y2) / 2);
        horiz.setAttribute('x2', x2);
        horiz.setAttribute('y2', (y1 + y2) / 2);
        horiz.setAttribute('stroke', '#4aa3ff');
        horiz.setAttribute('stroke-width', '1');
        horiz.setAttribute('class', 'vakOverlay vakInhoud');
        horiz.style.pointerEvents = 'none';
        svgRoot.appendChild(horiz);
      }
    }
  }
  
  // Open modal voor vak selectie
  function openVakSelectModal(vak) {
    huidigGeselecteerdVak = vak;
    modalVakId.textContent = vak.id;
    
    // Maak opties aan
    vakSelectGrid.innerHTML = '';
    
    const huidigeToewijzing = getVakToewijzing(vak.id);
    VAK_TYPE_OPTIES.forEach(optie => {
      const optionDiv = document.createElement('div');
      optionDiv.className = 'vakSelectOption';
      const optieAssign = getOptieAssign(optie);
      const isSelected = (!optieAssign && !huidigeToewijzing) || (optieAssign && huidigeToewijzing && toewijzingenGelijk(huidigeToewijzing, optieAssign));
      if (isSelected) optionDiv.classList.add('selected');
      
      const img = document.createElement('img');
      img.src = optie.img;
      img.alt = optie.text;
      
      const span = document.createElement('span');
      span.textContent = optie.text;
      
      optionDiv.appendChild(img);
      optionDiv.appendChild(span);
      
      optionDiv.addEventListener('click', () => {
        // Toewijzen aan vak of verwijderen
        const payload = optieAssign ? { ...optieAssign } : null;
        if (!payload) {
          setVakToewijzing(vak.id, null);
          toonVakken();
          draw();
          closeVakSelectModal();
          return;
        }

        if (payload.type === 'raam') {
          closeVakSelectModal();
          huidigQuickMenuVak = vak;
          const pos = berekenVakMenuPos(vak);
          openVakRaamMenu(vak, pos, payload.variant || null);
          return;
        }
        
        if (payload.type === 'deur') {
          closeVakSelectModal();
          huidigQuickMenuVak = vak;
          const pos = berekenVakMenuPos(vak);
          openVakDeurMenu(vak, pos, payload.variant || null);
          return;
        }

        if (payload.type === 'glas') {
          closeVakSelectModal();
          huidigQuickMenuVak = vak;
          const pos = berekenVakMenuPos(vak);
          openVakGlasMenu(vak, pos, payload.variant || null);
          return;
        }
        
        setVakToewijzing(vak.id, payload);
        // Update visuele feedback
        vakSelectGrid.querySelectorAll('.vakSelectOption').forEach(el => {
          el.classList.remove('selected');
        });
        optionDiv.classList.add('selected');
        
        // Update de lijst in de sidebar
        toonVakken();
        draw();
        
        // Sluit modal na korte delay voor visuele feedback
        setTimeout(() => {
          closeVakSelectModal();
        }, 300);
      });
      
      vakSelectGrid.appendChild(optionDiv);
    });
    
    vakSelectModal.classList.add('active');
  }
  
  // Sluit modal
  function closeVakSelectModal() {
    vakSelectModal.classList.remove('active');
    huidigGeselecteerdVak = null;
  }

  function getSvgCenterPos() {
    const rect = svg.getBoundingClientRect();
    return {
      x: rect.left + rect.width / 2,
      y: rect.top + rect.height / 2
    };
  }

  function openVakQuickMenu(vak) {
    huidigQuickMenuVak = vak;
    closeVakOrientationMenu();
    closeVakRaamMenu();
    closeVakDeurMenu();
    closeVakGlasMenu();
    closeVakGlasExtraMenu();
    
    const pos = getSvgCenterPos();
    laatsteVakClickPos = { ...pos };
    
    vakQuickMenu.style.left = `${pos.x}px`;
    vakQuickMenu.style.top = `${pos.y}px`;
    vakQuickMenu.style.display = 'flex';
    
    const huidige = getVakToewijzing(vak.id);
    vakQuickButtons.forEach(btn => {
      btn.classList.toggle('selected', buttonKomtOvereenMet(huidige, btn));
    });
  }
  
  function closeVakQuickMenu(resetButtons = false) {
    vakQuickMenu.style.display = 'none';
    huidigQuickMenuVak = null;
    if (resetButtons) {
      vakQuickButtons.forEach(btn => btn.classList.remove('selected'));
    }
    closeVakOrientationMenu();
    closeVakRaamMenu();
    closeVakDeurMenu();
    closeVakGlasMenu();
    closeVakGlasExtraMenu();
  }

  vakQuickMenu.addEventListener('click', (e) => {
    const button = e.target.closest('button[data-type]');
    if (!button || !huidigQuickMenuVak) return;
    
    const targetId = huidigQuickMenuVak.id;
    const type = button.dataset.type;
    const variant = button.dataset.variant;
    
    if (!type) return;
    
    // Toon uitgebreide raam opties wanneer geen variant is gekozen
    if (type === 'raam' && !variant) {
      const rect = button.getBoundingClientRect();
      const pos = {
        x: rect.left + rect.width / 2,
        y: rect.top
      };
      openVakRaamMenu(huidigQuickMenuVak, pos);
      return;
    }
    
    // Toon uitgebreide deur opties wanneer geen variant is gekozen
    if (type === 'deur' && !variant) {
      const rect = button.getBoundingClientRect();
      const pos = {
        x: rect.left + rect.width / 2,
        y: rect.top
      };
      openVakDeurMenu(huidigQuickMenuVak, pos);
      return;
    }

    if (type === 'glas' && !variant) {
      const rect = button.getBoundingClientRect();
      const pos = {
        x: rect.left + rect.width / 2,
        y: rect.top
      };
      openVakGlasMenu(huidigQuickMenuVak, pos);
      return;
    }
    
    const payload = getButtonToewijzing(button);
    if (!payload) return;
    
    const huidige = getVakToewijzing(targetId);
    if (toewijzingenGelijk(huidige, payload)) {
      setVakToewijzing(targetId, null);
    } else {
      setVakToewijzing(targetId, payload);
    }
    
    updateQuickButtonStates(targetId);
    toonVakken();
    closeVakQuickMenu();
    draw();
  });
  
  function updateQuickButtonStates(vakId) {
    const assign = getVakToewijzing(vakId);
    vakQuickButtons.forEach(btn => {
      btn.classList.toggle('selected', buttonKomtOvereenMet(assign, btn));
    });
  }

  function refreshRaamStatus(assign) {
    if (!vakRaamStatus) return;
    if (assign && assign.type === 'raam') {
      const variantTextMap = {
        draairaam_buiten: 'Draairaam naar buiten',
        stolpraam_buiten: 'Stolpraam buitendraaiend',
        draaikiep: 'Draaikiep raam',
        stolpraam_draaikiep: 'Stolpraam draaikiep',
        klepraam: 'Klepraam',
        klepraam_open: 'Klepraam (open)',
        klepraam_vast: 'Vast klepraam'
      };
      const variantText = variantTextMap[assign.variant] || 'Raam';
      // Voor klepraam varianten: geen orientation tekst
      let suffix = '';
      if (assign.variant !== 'klepraam' && assign.variant !== 'klepraam_open' && assign.variant !== 'klepraam_vast') {
      const orientationText = assign.orientation === 'links' ? 'Links' :
                              assign.orientation === 'rechts' ? 'Rechts' :
                              assign.orientation === 'vast' ? 'Vast' : '';
        suffix = orientationText ? ` ¬∑ ${orientationText}` : '';
      }
      vakRaamStatus.textContent = `Geselecteerd: ${variantText}${suffix}`;
    } else {
      vakRaamStatus.textContent = 'Selecteer een raamtype voor dit vak';
    }
  }

  function openVakRaamMenu(vak, _pos, preselectVariant = null) {
    huidigRaamMenuVak = vak;
    const centerPos = getSvgCenterPos();
    laatsteRaamMenuPos = centerPos;
    const assign = getVakToewijzing(vak.id);
    vakRaamMenu.style.left = `${centerPos.x}px`;
    vakRaamMenu.style.top = `${centerPos.y}px`;
    vakRaamMenu.style.display = 'flex';
    const heeftRaam = assign && assign.type === 'raam';
    vakRaamWis.disabled = !heeftRaam;
    
    if (preselectVariant) {
      huidigRaamVariant = preselectVariant;
      if (heeftRaam && assign.variant === preselectVariant) {
        huidigRaamOrientation = assign.orientation || null;
        // Voor klepraam varianten: bepaal het type
        if (assign.variant === 'klepraam_open' || assign.variant === 'klepraam_vast') {
          huidigKlepraamType = assign.variant === 'klepraam_open' ? 'open' : 'vast';
        }
      } else {
        huidigRaamOrientation = null;
        huidigKlepraamType = null;
      }
    } else if (heeftRaam) {
      huidigRaamVariant = assign.variant || null;
      huidigRaamOrientation = assign.orientation || null;
      // Voor klepraam varianten: bepaal het type
      if (assign.variant === 'klepraam_open' || assign.variant === 'klepraam_vast') {
        huidigKlepraamType = assign.variant === 'klepraam_open' ? 'open' : 'vast';
        huidigRaamVariant = 'klepraam'; // Zet terug naar basis variant voor menu
      } else {
        huidigKlepraamType = null;
      }
    } else {
      huidigRaamVariant = null;
      huidigRaamOrientation = null;
      huidigKlepraamType = null;
    }
    
    updateRaamVariantButtons();
    refreshRaamStatus(assign);
    updateQuickButtonStates(vak.id);

    // Alleen orientation status tonen voor niet-klepraam varianten
    if (preselectVariant && preselectVariant !== 'klepraam' && !huidigRaamOrientation && vakRaamStatus) {
      const variantText = getVariantOmschrijving(preselectVariant);
      vakRaamStatus.textContent = `Kies de draairichting voor ${variantText}`;
    } else if (heeftRaam && huidigRaamVariant !== 'klepraam' && !huidigRaamOrientation && vakRaamStatus) {
      const variantText = getVariantOmschrijving(huidigRaamVariant);
      vakRaamStatus.textContent = `Kies de draairichting voor ${variantText}`;
    }
  }

  function closeVakRaamMenu(resetState = true) {
    const huidigeVak = huidigRaamMenuVak;
    vakRaamMenu.style.display = 'none';
    if (resetState) {
      if (vakRaamStatus) {
        const assign = huidigeVak ? getVakToewijzing(huidigeVak.id) : null;
        refreshRaamStatus(assign);
      }
      huidigRaamMenuVak = null;
      huidigRaamVariant = null;
      huidigRaamOrientation = null;
      updateRaamVariantButtons();
    }
  }

  function openVakDeurMenu(vak, _pos, preselectVariant = null) {
    huidigDeurMenuVak = vak;
    const centerPos = getSvgCenterPos();
    laatsteDeurMenuPos = centerPos;
    const assign = getVakToewijzing(vak.id);
    vakDeurMenu.style.left = `${centerPos.x}px`;
    vakDeurMenu.style.top = `${centerPos.y}px`;
    vakDeurMenu.style.display = 'flex';
    const heeftDeur = assign && assign.type === 'deur';
    vakDeurWis.disabled = !heeftDeur;
    
    if (preselectVariant) {
      huidigDeurVariant = preselectVariant;
      // Voor deur_buiten subvarianten: zet terug naar basis variant
      if (heeftDeur && (assign.variant === 'deur_buiten_stapeldorpel' || assign.variant === 'deur_buiten_2vaks' || assign.variant === 'deur_buiten_dicht')) {
        if (assign.variant === 'deur_buiten_stapeldorpel') {
          huidigDeurBuitenType = 'stapeldorpel';
        } else if (assign.variant === 'deur_buiten_2vaks') {
          huidigDeurBuitenType = '2vaks';
        } else if (assign.variant === 'deur_buiten_dicht') {
          huidigDeurBuitenType = 'dicht';
        }
        huidigDeurVariant = 'deur_buiten';
      }
      // Voor stolpdeuren_buiten subvarianten
      else if (heeftDeur && (assign.variant === 'stolpdeuren_buiten_stapeldorpel' || assign.variant === 'stolpdeuren_buiten_2vaks' || assign.variant === 'stolpdeuren_buiten_dicht')) {
        if (assign.variant === 'stolpdeuren_buiten_stapeldorpel') {
          huidigStolpdeurenBuitenType = 'stapeldorpel';
        } else if (assign.variant === 'stolpdeuren_buiten_2vaks') {
          huidigStolpdeurenBuitenType = '2vaks';
        } else if (assign.variant === 'stolpdeuren_buiten_dicht') {
          huidigStolpdeurenBuitenType = 'dicht';
        }
        huidigDeurVariant = 'stolpdeuren_buiten';
      }
      // Voor deur_draaikiep subvarianten
      else if (heeftDeur && (assign.variant === 'deur_draaikiep_stapeldorpel' || assign.variant === 'deur_draaikiep_2vaks' || assign.variant === 'deur_draaikiep_dicht')) {
        if (assign.variant === 'deur_draaikiep_stapeldorpel') {
          huidigDeurDraaikiepType = 'stapeldorpel';
        } else if (assign.variant === 'deur_draaikiep_2vaks') {
          huidigDeurDraaikiepType = '2vaks';
        } else if (assign.variant === 'deur_draaikiep_dicht') {
          huidigDeurDraaikiepType = 'dicht';
        }
        huidigDeurVariant = 'deur_draaikiep';
      }
      // Voor stolpdeuren_draaikiep subvarianten
      else if (heeftDeur && (assign.variant === 'stolpdeuren_draaikiep_stapeldorpel' || assign.variant === 'stolpdeuren_draaikiep_2vaks' || assign.variant === 'stolpdeuren_draaikiep_dicht')) {
        if (assign.variant === 'stolpdeuren_draaikiep_stapeldorpel') {
          huidigStolpdeurenDraaikiepType = 'stapeldorpel';
        } else if (assign.variant === 'stolpdeuren_draaikiep_2vaks') {
          huidigStolpdeurenDraaikiepType = '2vaks';
        } else if (assign.variant === 'stolpdeuren_draaikiep_dicht') {
          huidigStolpdeurenDraaikiepType = 'dicht';
        }
        huidigDeurVariant = 'stolpdeuren_draaikiep';
      }
    } else if (heeftDeur) {
      // Voor deur_buiten subvarianten: zet terug naar basis variant
      if (assign.variant === 'deur_buiten_stapeldorpel' || assign.variant === 'deur_buiten_2vaks' || assign.variant === 'deur_buiten_dicht') {
        if (assign.variant === 'deur_buiten_stapeldorpel') {
          huidigDeurBuitenType = 'stapeldorpel';
        } else if (assign.variant === 'deur_buiten_2vaks') {
          huidigDeurBuitenType = '2vaks';
        } else if (assign.variant === 'deur_buiten_dicht') {
          huidigDeurBuitenType = 'dicht';
        }
        huidigDeurVariant = 'deur_buiten';
      }
      // Voor stolpdeuren_buiten subvarianten
      else if (assign.variant === 'stolpdeuren_buiten_stapeldorpel' || assign.variant === 'stolpdeuren_buiten_2vaks' || assign.variant === 'stolpdeuren_buiten_dicht') {
        if (assign.variant === 'stolpdeuren_buiten_stapeldorpel') {
          huidigStolpdeurenBuitenType = 'stapeldorpel';
        } else if (assign.variant === 'stolpdeuren_buiten_2vaks') {
          huidigStolpdeurenBuitenType = '2vaks';
        } else if (assign.variant === 'stolpdeuren_buiten_dicht') {
          huidigStolpdeurenBuitenType = 'dicht';
        }
        huidigDeurVariant = 'stolpdeuren_buiten';
      }
      // Voor deur_draaikiep subvarianten
      else if (assign.variant === 'deur_draaikiep_stapeldorpel' || assign.variant === 'deur_draaikiep_2vaks' || assign.variant === 'deur_draaikiep_dicht') {
        if (assign.variant === 'deur_draaikiep_stapeldorpel') {
          huidigDeurDraaikiepType = 'stapeldorpel';
        } else if (assign.variant === 'deur_draaikiep_2vaks') {
          huidigDeurDraaikiepType = '2vaks';
        } else if (assign.variant === 'deur_draaikiep_dicht') {
          huidigDeurDraaikiepType = 'dicht';
        }
        huidigDeurVariant = 'deur_draaikiep';
      }
      // Voor stolpdeuren_draaikiep subvarianten
      else if (assign.variant === 'stolpdeuren_draaikiep_stapeldorpel' || assign.variant === 'stolpdeuren_draaikiep_2vaks' || assign.variant === 'stolpdeuren_draaikiep_dicht') {
        if (assign.variant === 'stolpdeuren_draaikiep_stapeldorpel') {
          huidigStolpdeurenDraaikiepType = 'stapeldorpel';
        } else if (assign.variant === 'stolpdeuren_draaikiep_2vaks') {
          huidigStolpdeurenDraaikiepType = '2vaks';
        } else if (assign.variant === 'stolpdeuren_draaikiep_dicht') {
          huidigStolpdeurenDraaikiepType = 'dicht';
        }
        huidigDeurVariant = 'stolpdeuren_draaikiep';
      } else {
      huidigDeurVariant = assign.variant || null;
      }
    } else {
      huidigDeurVariant = null;
      huidigDeurBuitenType = null;
    }
    
    updateDeurVariantButtons();
    refreshDeurStatus(assign);
    updateQuickButtonStates(vak.id);
  }

  function closeVakDeurMenu(resetState = true) {
    const huidigeVak = huidigDeurMenuVak;
    vakDeurMenu.style.display = 'none';
    if (resetState) {
      if (vakDeurStatus) {
        const assign = huidigeVak ? getVakToewijzing(huidigeVak.id) : null;
        refreshDeurStatus(assign);
      }
      huidigDeurMenuVak = null;
      huidigDeurVariant = null;
      updateDeurVariantButtons();
    }
  }

  function openVakGlasMenu(vak, _pos, preselectVariant = null) {
    if (!vakGlasMenu) return;
    closeVakGlasExtraMenu();
    huidigGlasMenuVak = vak;
    const centerPos = getSvgCenterPos();
    laatsteGlasMenuPos = centerPos;
    const assign = getVakToewijzing(vak.id);
    vakGlasMenu.style.left = `${centerPos.x}px`;
    vakGlasMenu.style.top = `${centerPos.y}px`;
    vakGlasMenu.style.display = 'flex';
    const heeftGlas = assign && assign.type === 'glas';
    if (vakGlasWis) vakGlasWis.disabled = !heeftGlas;

    if (preselectVariant) {
      huidigGlasVariant = preselectVariant;
      if (heeftGlas && assign.variant === preselectVariant) {
        huidigGlasRooster = !!assign.rooster;
      } else {
        huidigGlasRooster = false;
      }
    } else if (heeftGlas) {
      huidigGlasVariant = assign.variant || null;
      huidigGlasRooster = !!assign.rooster;
    } else {
      huidigGlasVariant = null;
      huidigGlasRooster = false;
    }

    updateGlasVariantButtons();
    refreshGlasStatus(assign);
    updateQuickButtonStates(vak.id);
  }

  function closeVakGlasMenu(resetState = true) {
    const huidigeVak = huidigGlasMenuVak;
    if (vakGlasMenu) vakGlasMenu.style.display = 'none';
    closeVakGlasExtraMenu(resetState);
    if (resetState) {
      if (vakGlasStatus) {
        const assign = huidigeVak ? getVakToewijzing(huidigeVak.id) : null;
        refreshGlasStatus(assign);
      }
      huidigGlasMenuVak = null;
      huidigGlasVariant = null;
      updateGlasVariantButtons();
    }
  }

  function openVakGlasExtraMenu() {
    if (!vakGlasExtraMenu || !huidigGlasMenuVak) return;
    const centerPos = getSvgCenterPos();
    vakGlasExtraMenu.style.left = `${centerPos.x}px`;
    vakGlasExtraMenu.style.top = `${centerPos.y}px`;
    vakGlasExtraMenu.style.display = 'flex';
    if (vakGlasExtraStatus) {
      const variantTextMap = {
        glas_vast: 'vast glas',
        glas_vast_stapel: 'vast glas met stapeldorpels'
      };
      const variantText = variantTextMap[huidigGlasVariant] || 'dit glasvak';
      vakGlasExtraStatus.textContent = `Wil je een rooster in ${variantText}?`;
    }
    updateGlasRoosterButtons();
  }

  function closeVakGlasExtraMenu(resetState = true) {
    if (!vakGlasExtraMenu) return;
    vakGlasExtraMenu.style.display = 'none';
    if (resetState) {
      huidigGlasRooster = false;
      updateGlasRoosterButtons();
    }
  }

  function updateGlasRoosterButtons() {
    if (glasRoosterYesBtn) {
      glasRoosterYesBtn.classList.toggle('selected', !!huidigGlasRooster);
    }
    if (glasRoosterNoBtn) {
      glasRoosterNoBtn.classList.toggle('selected', !huidigGlasRooster);
    }
  }

  vakRaamWis.addEventListener('click', () => {
    if (!huidigRaamMenuVak) return;
    const vakId = huidigRaamMenuVak.id;
    setVakToewijzing(vakId, null);
    toonVakken();
    draw();
    updateQuickButtonStates(vakId);
    refreshRaamStatus(null);
    vakRaamWis.disabled = true;
    closeVakRaamMenu();
    closeVakQuickMenu(true);
  });

  if (vakDeurWis) {
    vakDeurWis.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      const vakId = huidigDeurMenuVak.id;
      setVakToewijzing(vakId, null);
      toonVakken();
      draw();
      updateQuickButtonStates(vakId);
      refreshDeurStatus(null);
      vakDeurWis.disabled = true;
      closeVakDeurMenu();
      closeVakQuickMenu(true);
    });
  }

  if (vakGlasWis) {
    vakGlasWis.addEventListener('click', () => {
      if (!huidigGlasMenuVak) return;
      const vakId = huidigGlasMenuVak.id;
      setVakToewijzing(vakId, null);
      toonVakken();
      draw();
      updateQuickButtonStates(vakId);
      refreshGlasStatus(null);
      vakGlasWis.disabled = true;
      closeVakGlasMenu();
      closeVakQuickMenu(true);
    });
  }

  // Event listener voor raam variant knoppen
  if (vakRaamMenuSection) {
    vakRaamMenuSection.addEventListener('click', (e) => {
      // Negeer clicks op knoppen die niet data-variant hebben (zoals vak1/vak2 knoppen, deur-dicht knoppen)
      if (e.target.closest('button[data-vak1-type]') || 
          e.target.closest('button[data-vak2-type]') ||
          e.target.closest('button[data-deur-dicht-type]')) {
        return;
      }
      const button = e.target.closest('button[data-variant]');
      if (!button || !huidigRaamMenuVak) return;
      
      const vakId = huidigRaamMenuVak.id;
      const variant = button.dataset.variant;
      huidigRaamVariant = variant;
      const huidigeAssign = getVakToewijzing(vakId);
      if (huidigeAssign && huidigeAssign.type === 'raam' && huidigeAssign.variant === variant) {
        huidigRaamOrientation = huidigeAssign.orientation || null;
      } else {
        huidigRaamOrientation = null;
      }
      
      updateRaamVariantButtons();
      
      // Voor klepraam: open klepraam menu (open/vast)
      if (variant === 'klepraam') {
        const btnRect = button.getBoundingClientRect();
        const pos = {
          x: btnRect.left + btnRect.width / 2,
          y: btnRect.top
        };
        closeVakRaamMenu(false);
        openVakKlepraamMenu(huidigRaamMenuVak, pos);
        return;
      }
      
      // Voor andere varianten: open orientation menu
      const btnRect = button.getBoundingClientRect();
      const pos = {
        x: btnRect.left + btnRect.width / 2,
        y: btnRect.top
      };
      closeVakRaamMenu(false);
      openVakOrientationMenu(huidigRaamMenuVak, pos);
    });
  }

  // Event listener voor deur variant knoppen
  if (vakDeurMenuSection) {
    vakDeurMenuSection.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-variant]');
      if (!button || !huidigDeurMenuVak) return;
      
      const vakId = huidigDeurMenuVak.id;
      const variant = button.dataset.variant;
      huidigDeurVariant = variant;
      
      // Voor deur_buiten: open submenu (stapeldorpel, 2vaks, dicht)
      if (variant === 'deur_buiten') {
        const btnRect = button.getBoundingClientRect();
        const pos = {
          x: btnRect.left + btnRect.width / 2,
          y: btnRect.top
        };
        closeVakDeurMenu(false);
        openVakDeurBuitenMenu(huidigDeurMenuVak, pos);
        return;
      }
      
      // Voor stolpdeuren_buiten: open submenu (stapeldorpel, 2vaks, dicht)
      if (variant === 'stolpdeuren_buiten') {
        const btnRect = button.getBoundingClientRect();
        const pos = {
          x: btnRect.left + btnRect.width / 2,
          y: btnRect.top
        };
        closeVakDeurMenu(false);
        openVakStolpdeurenBuitenMenu(huidigDeurMenuVak, pos);
        return;
      }
      
      // Voor deur_draaikiep: open submenu (stapeldorpel, 2vaks, dicht)
      if (variant === 'deur_draaikiep') {
        const btnRect = button.getBoundingClientRect();
        const pos = {
          x: btnRect.left + btnRect.width / 2,
          y: btnRect.top
        };
        closeVakDeurMenu(false);
        openVakDeurDraaikiepMenu(huidigDeurMenuVak, pos);
        return;
      }
      
      // Voor stolpdeuren_draaikiep: open submenu (stapeldorpel, 2vaks, dicht)
      if (variant === 'stolpdeuren_draaikiep') {
        const btnRect = button.getBoundingClientRect();
        const pos = {
          x: btnRect.left + btnRect.width / 2,
          y: btnRect.top
        };
        closeVakDeurMenu(false);
        openVakStolpdeurenDraaikiepMenu(huidigDeurMenuVak, pos);
        return;
      }
      
      // Voor andere deuren: sla direct op
      setVakToewijzing(vakId, { type: 'deur', variant });
      
      updateDeurVariantButtons();
      toonVakken();
      draw();
      updateQuickButtonStates(vakId);
      refreshDeurStatus({ type: 'deur', variant });
      vakDeurWis.disabled = false;
      
      setTimeout(() => {
        closeVakDeurMenu();
        closeVakQuickMenu(true);
      }, 300);
    });
  }

  if (vakGlasMenuSection) {
    vakGlasMenuSection.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-variant]');
      if (!button || !huidigGlasMenuVak) return;

      const vakId = huidigGlasMenuVak.id;
      const variant = button.dataset.variant;
      huidigGlasVariant = variant;
      const huidigeAssign = getVakToewijzing(vakId);
      if (huidigeAssign && huidigeAssign.type === 'glas' && huidigeAssign.variant === variant) {
        huidigGlasRooster = !!huidigeAssign.rooster;
      } else {
        huidigGlasRooster = false;
      }

      updateGlasVariantButtons();
      closeVakGlasMenu(false);
      openVakGlasExtraMenu();
    });
  }

  if (vakOrientationMenu) {
    vakOrientationMenu.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-orientation]');
      if (!button || !huidigRaamMenuVak || !huidigRaamVariant) return;
      
      const orientation = button.dataset.orientation;
      huidigRaamOrientation = orientation;
      updateOrientationButtons();
      
      // Open het extra menu in plaats van direct op te slaan
      closeVakOrientationMenu(false);
      openVakRaamExtraMenu(huidigRaamMenuVak);
    });
  }

  if (vakOrientationBack) {
    vakOrientationBack.addEventListener('click', () => {
      if (!huidigRaamMenuVak) return;
      closeVakOrientationMenu(false);
      if (laatsteRaamMenuPos) {
        openVakRaamMenu(huidigRaamMenuVak, laatsteRaamMenuPos, huidigRaamVariant || null);
      }
    });
  }

  if (vakOrientationCancel) {
    vakOrientationCancel.addEventListener('click', () => {
      closeVakOrientationMenu();
      closeVakRaamMenu();
      closeVakQuickMenu(true);
    });
  }

  // Event listeners voor klepraam menu
  if (vakKlepraamMenu) {
    vakKlepraamMenu.addEventListener('click', (e) => {
      // Check of de klik op een button of span binnen een button was
      const button = e.target.closest('button[data-klepraam-type]');
      if (!button || !huidigRaamMenuVak) {
        // Als de klik niet op een button was, negeer het
        return;
      }
      
      // Zorg ervoor dat huidigRaamVariant is ingesteld op 'klepraam'
      if (!huidigRaamVariant || huidigRaamVariant !== 'klepraam') {
        huidigRaamVariant = 'klepraam';
      }
      
      const klepraamType = button.dataset.klepraamType;
      if (!klepraamType) {
        console.warn('Klepraam type niet gevonden in button dataset');
        return;
      }
      
      huidigKlepraamType = klepraamType;
      updateKlepraamButtons();
      
      // Open het extra menu (rooster) in plaats van direct op te slaan
      closeVakKlepraamMenu(false);
      openVakRaamExtraMenu(huidigRaamMenuVak);
    });
  }

  if (vakKlepraamBack) {
    vakKlepraamBack.addEventListener('click', () => {
      if (!huidigRaamMenuVak) return;
      closeVakKlepraamMenu(false);
      if (laatsteRaamMenuPos) {
        openVakRaamMenu(huidigRaamMenuVak, laatsteRaamMenuPos, 'klepraam');
      }
    });
  }

  if (vakKlepraamCancel) {
    vakKlepraamCancel.addEventListener('click', () => {
      closeVakKlepraamMenu();
      closeVakRaamMenu();
      closeVakQuickMenu(true);
    });
  }

  // Event listeners voor deur buiten menu
  if (vakDeurBuitenMenu) {
    vakDeurBuitenMenu.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-deur-buiten-type]');
      if (!button || !huidigDeurMenuVak) return;
      
      // Zorg ervoor dat huidigDeurVariant is ingesteld op 'deur_buiten'
      if (!huidigDeurVariant || huidigDeurVariant !== 'deur_buiten') {
        huidigDeurVariant = 'deur_buiten';
      }
      
      const deurBuitenType = button.dataset.deurBuitenType;
      if (!deurBuitenType) {
        console.warn('Deur buiten type niet gevonden in button dataset');
        return;
      }
      
      huidigDeurBuitenType = deurBuitenType;
      updateDeurBuitenButtons();
      
      // Voor stapeldorpel en 2vaks: open opties menu
      if (deurBuitenType === 'stapeldorpel' || deurBuitenType === '2vaks') {
        // Sla het vak op voordat we het menu sluiten
        const deurVak = huidigDeurMenuVak;
        if (!deurVak) {
          console.error('Deur menu: huidigDeurMenuVak is null');
          return;
        }
        closeVakDeurBuitenMenu(false);
        // Kleine vertraging om ervoor te zorgen dat het vorige menu gesloten is
        setTimeout(() => {
          openVakDeurStapeldorpelMenu(deurVak, deurBuitenType, 'deur_buiten');
        }, 50);
        return;
      }
      
      // Voor dichte deur: open dichte deur type menu
      if (deurBuitenType === 'dicht') {
        const deurVak = huidigDeurMenuVak;
        if (!deurVak) {
          console.error('Deur menu: huidigDeurMenuVak is null');
          return;
        }
        const menuPos = laatsteDeurMenuPos || getSvgCenterPos();
        closeVakDeurBuitenMenu(false);
        setTimeout(() => {
          openVakDeurDichtMenu(deurVak, menuPos);
        }, 50);
        return;
      }
      
      // Voor andere types: sla direct op
      const vakId = huidigDeurMenuVak.id;
      let variant = 'deur_buiten';
      
      setVakToewijzing(vakId, { type: 'deur', variant });
      toonVakken();
      draw();
      updateQuickButtonStates(vakId);
      refreshDeurStatus({ type: 'deur', variant });
      
      setTimeout(() => {
        closeVakDeurBuitenMenu();
        closeVakDeurMenu();
        closeVakQuickMenu(true);
      }, 300);
    });
  }

  if (vakDeurBuitenBack) {
    vakDeurBuitenBack.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      closeVakDeurBuitenMenu(false);
      if (laatsteDeurMenuPos) {
        openVakDeurMenu(huidigDeurMenuVak, laatsteDeurMenuPos, 'deur_buiten');
      }
    });
  }

  if (vakDeurBuitenCancel) {
    vakDeurBuitenCancel.addEventListener('click', () => {
      closeVakDeurBuitenMenu();
      closeVakDeurMenu();
      closeVakQuickMenu(true);
    });
  }

  // Event listeners voor stolpdeuren_buiten menu
  if (vakStolpdeurenBuitenMenu) {
    vakStolpdeurenBuitenMenu.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-stolpdeuren-buiten-type]');
      if (!button || !huidigDeurMenuVak) return;
      
      if (!huidigDeurVariant || huidigDeurVariant !== 'stolpdeuren_buiten') {
        huidigDeurVariant = 'stolpdeuren_buiten';
      }
      
      const type = button.dataset.stolpdeurenBuitenType;
      if (!type) {
        console.warn('Stolpdeuren buiten type niet gevonden in button dataset');
        return;
      }
      
      huidigStolpdeurenBuitenType = type;
      updateStolpdeurenBuitenButtons();
      
      if (type === 'stapeldorpel' || type === '2vaks') {
        const deurVak = huidigDeurMenuVak;
        if (!deurVak) {
          console.error('Deur menu: huidigDeurMenuVak is null');
          return;
        }
        closeVakStolpdeurenBuitenMenu(false);
        setTimeout(() => {
          openVakDeurStapeldorpelMenu(deurVak, type, 'stolpdeuren_buiten');
        }, 50);
        return;
      }
      
      if (type === 'dicht') {
        const deurVak = huidigDeurMenuVak;
        if (!deurVak) {
          console.error('Deur menu: huidigDeurMenuVak is null');
          return;
        }
        const menuPos = laatsteDeurMenuPos || getSvgCenterPos();
        closeVakStolpdeurenBuitenMenu(false);
        setTimeout(() => {
          openVakDeurDichtMenu(deurVak, menuPos);
        }, 50);
        return;
      }
    });
  }

  if (vakStolpdeurenBuitenBack) {
    vakStolpdeurenBuitenBack.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      closeVakStolpdeurenBuitenMenu(false);
      if (laatsteDeurMenuPos) {
        openVakDeurMenu(huidigDeurMenuVak, laatsteDeurMenuPos, 'stolpdeuren_buiten');
      }
    });
  }

  if (vakStolpdeurenBuitenCancel) {
    vakStolpdeurenBuitenCancel.addEventListener('click', () => {
      closeVakStolpdeurenBuitenMenu();
      closeVakDeurMenu();
      closeVakQuickMenu(true);
    });
  }

  // Event listeners voor deur_draaikiep menu
  if (vakDeurDraaikiepMenu) {
    vakDeurDraaikiepMenu.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-deur-draaikiep-type]');
      if (!button || !huidigDeurMenuVak) return;
      
      if (!huidigDeurVariant || huidigDeurVariant !== 'deur_draaikiep') {
        huidigDeurVariant = 'deur_draaikiep';
      }
      
      const type = button.dataset.deurDraaikiepType;
      if (!type) {
        console.warn('Deur draaikiep type niet gevonden in button dataset');
        return;
      }
      
      huidigDeurDraaikiepType = type;
      updateDeurDraaikiepButtons();
      
      if (type === 'stapeldorpel' || type === '2vaks') {
        const deurVak = huidigDeurMenuVak;
        if (!deurVak) {
          console.error('Deur menu: huidigDeurMenuVak is null');
          return;
        }
        closeVakDeurDraaikiepMenu(false);
        setTimeout(() => {
          openVakDeurStapeldorpelMenu(deurVak, type, 'deur_draaikiep');
        }, 50);
        return;
      }
      
      if (type === 'dicht') {
        const deurVak = huidigDeurMenuVak;
        if (!deurVak) {
          console.error('Deur menu: huidigDeurMenuVak is null');
          return;
        }
        const menuPos = laatsteDeurMenuPos || getSvgCenterPos();
        closeVakDeurDraaikiepMenu(false);
        setTimeout(() => {
          openVakDeurDichtMenu(deurVak, menuPos);
        }, 50);
        return;
      }
    });
  }

  if (vakDeurDraaikiepBack) {
    vakDeurDraaikiepBack.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      closeVakDeurDraaikiepMenu(false);
      if (laatsteDeurMenuPos) {
        openVakDeurMenu(huidigDeurMenuVak, laatsteDeurMenuPos, 'deur_draaikiep');
      }
    });
  }

  if (vakDeurDraaikiepCancel) {
    vakDeurDraaikiepCancel.addEventListener('click', () => {
      closeVakDeurDraaikiepMenu();
      closeVakDeurMenu();
      closeVakQuickMenu(true);
    });
  }

  // Event listeners voor stolpdeuren_draaikiep menu
  if (vakStolpdeurenDraaikiepMenu) {
    vakStolpdeurenDraaikiepMenu.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-stolpdeuren-draaikiep-type]');
      if (!button || !huidigDeurMenuVak) return;
      
      if (!huidigDeurVariant || huidigDeurVariant !== 'stolpdeuren_draaikiep') {
        huidigDeurVariant = 'stolpdeuren_draaikiep';
      }
      
      const type = button.dataset.stolpdeurenDraaikiepType;
      if (!type) {
        console.warn('Stolpdeuren draaikiep type niet gevonden in button dataset');
        return;
      }
      
      huidigStolpdeurenDraaikiepType = type;
      updateStolpdeurenDraaikiepButtons();
      
      if (type === 'stapeldorpel' || type === '2vaks') {
        const deurVak = huidigDeurMenuVak;
        if (!deurVak) {
          console.error('Deur menu: huidigDeurMenuVak is null');
          return;
        }
        closeVakStolpdeurenDraaikiepMenu(false);
        setTimeout(() => {
          openVakDeurStapeldorpelMenu(deurVak, type, 'stolpdeuren_draaikiep');
        }, 50);
        return;
      }
      
      if (type === 'dicht') {
        const deurVak = huidigDeurMenuVak;
        if (!deurVak) {
          console.error('Deur menu: huidigDeurMenuVak is null');
          return;
        }
        const menuPos = laatsteDeurMenuPos || getSvgCenterPos();
        closeVakStolpdeurenDraaikiepMenu(false);
        setTimeout(() => {
          openVakDeurDichtMenu(deurVak, menuPos);
        }, 50);
        return;
      }
    });
  }

  if (vakStolpdeurenDraaikiepBack) {
    vakStolpdeurenDraaikiepBack.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      closeVakStolpdeurenDraaikiepMenu(false);
      if (laatsteDeurMenuPos) {
        openVakDeurMenu(huidigDeurMenuVak, laatsteDeurMenuPos, 'stolpdeuren_draaikiep');
      }
    });
  }

  if (vakStolpdeurenDraaikiepCancel) {
    vakStolpdeurenDraaikiepCancel.addEventListener('click', () => {
      closeVakStolpdeurenDraaikiepMenu();
      closeVakDeurMenu();
      closeVakQuickMenu(true);
    });
  }

  // Event listeners voor dichte deur menu
  if (deurDichtVlakBtn) {
    deurDichtVlakBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      huidigDeurDichtType = 'vlak';
      updateDeurDichtButtons();
      console.log('Vlakke deur gekozen');
    });
  }

  if (deurDichtVgroevenBtn) {
    deurDichtVgroevenBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      huidigDeurDichtType = 'vgroeven';
      updateDeurDichtButtons();
      console.log('V-groeven deur gekozen');
    });
  }

  if (btnKiesDeurbeslagDicht) {
    btnKiesDeurbeslagDicht.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      console.log('btnKiesDeurbeslagDicht geklikt, huidigDeurMenuVak:', huidigDeurMenuVak);
      if (!huidigDeurMenuVak) {
        console.warn('btnKiesDeurbeslagDicht: geen huidigDeurMenuVak, proberen huidigDeurMenuVak te vinden...');
        // Probeer het vak te vinden uit de context
        const dichtMenu = document.getElementById('vakDeurDichtMenu');
        if (dichtMenu && dichtMenu.style.display !== 'none') {
          // Menu is open, gebruik de opgeslagen waarde
          console.log('Menu is open, maar huidigDeurMenuVak is null');
        }
        return;
      }
      console.log('btnKiesDeurbeslagDicht geklikt, opening deurbeslag menu');
      // Sluit eerst het dichte deur menu zodat het deurbeslag menu erboven kan komen
      closeVakDeurDichtMenu(false);
      const menuPos = getSvgCenterPos();
      setTimeout(() => {
        openVakDeurbeslagMenu(huidigDeurMenuVak, menuPos, 'dicht');
      }, 50);
    });
  } else {
    console.error('btnKiesDeurbeslagDicht element niet gevonden!');
  }

  if (vakDeurDichtConfirm) {
    vakDeurDichtConfirm.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      console.log('vakDeurDichtConfirm geklikt, huidigDeurMenuVak:', huidigDeurMenuVak, 'huidigDeurDichtType:', huidigDeurDichtType);
      if (!huidigDeurMenuVak) {
        console.warn('Geen huidigDeurMenuVak bij bevestigen');
        return;
      }
      if (!huidigDeurDichtType) {
        console.warn('Geen deur type gekozen');
        return;
      }
      
      // Ga direct naar orientatie menu
      closeVakDeurDichtMenu(false);
      const deurVak = huidigDeurMenuVak;
      setTimeout(() => {
        openVakStapeldorpelOrientationMenu(deurVak);
      }, 50);
    });
  }

  if (vakDeurDichtBack) {
    vakDeurDichtBack.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      closeVakDeurDichtMenu(false);
      if (laatsteDeurMenuPos) {
        openVakDeurBuitenMenu(huidigDeurMenuVak, laatsteDeurMenuPos);
      }
    });
  }

  if (vakDeurDichtCancel) {
    vakDeurDichtCancel.addEventListener('click', () => {
      closeVakDeurDichtMenu();
      closeVakDeurBuitenMenu();
      closeVakDeurMenu();
      closeVakQuickMenu(true);
    });
  }


  // Event listeners voor extra raam opties menu
  if (beslagF1Btn) {
    beslagF1Btn.addEventListener('click', () => {
      huidigBeslagKleur = 'f1';
      beslagF1Btn.classList.add('selected');
      beslagAndersBtn.classList.remove('selected');
      if (beslagKleurPicker) beslagKleurPicker.style.display = 'none';
    });
  }

  if (beslagAndersBtn) {
    beslagAndersBtn.addEventListener('click', () => {
      huidigBeslagKleur = 'anders';
      beslagAndersBtn.classList.add('selected');
      beslagF1Btn.classList.remove('selected');
      if (beslagKleurPicker) beslagKleurPicker.style.display = 'flex';
    });
  }

  if (beslagKleurInput) {
    beslagKleurInput.addEventListener('input', (e) => {
      huidigBeslagKleurWaarde = e.target.value;
    });
  }

  if (roosterCheckbox) {
    roosterCheckbox.addEventListener('change', (e) => {
      huidigRooster = e.target.checked;
    });
  }

  if (horCheckbox) {
    horCheckbox.addEventListener('change', (e) => {
      huidigHor = e.target.checked;
    });
  }

  if (vakRaamExtraBack) {
    vakRaamExtraBack.addEventListener('click', () => {
      if (!huidigRaamMenuVak) return;
      closeVakRaamExtraMenu(false);
      const centerPos = getSvgCenterPos();
      openVakOrientationMenu(huidigRaamMenuVak, centerPos);
    });
  }

  if (vakRaamExtraCancel) {
    vakRaamExtraCancel.addEventListener('click', () => {
      closeVakRaamExtraMenu();
      closeVakOrientationMenu();
      closeVakRaamMenu();
      closeVakQuickMenu(true);
    });
  }

  if (vakRaamExtraConfirm) {
    vakRaamExtraConfirm.addEventListener('click', () => {
      if (!huidigRaamMenuVak || !huidigRaamVariant) return;
      
      const vakId = huidigRaamMenuVak.id;
      
      // Bepaal de variant: voor klepraam gebruik klepraam_open of klepraam_vast
      let variant = huidigRaamVariant;
      if (huidigRaamVariant === 'klepraam') {
        // Voor klepraam: check of type is gekozen
        if (!huidigKlepraamType) {
          console.warn('Klepraam type niet gekozen');
          return;
        }
        variant = huidigKlepraamType === 'open' ? 'klepraam_open' : 'klepraam_vast';
      } else {
        // Voor andere varianten: check of orientation is gekozen
        if (!huidigRaamOrientation) {
          console.warn('Orientation niet gekozen');
          return;
        }
      }
      
      const toewijzing = {
        type: 'raam',
        variant: variant,
        rooster: huidigRooster,
        beslagKleur: huidigBeslagKleur
      };
      
      // Alleen hor toevoegen voor niet-klepraam varianten
      if (huidigRaamVariant !== 'klepraam') {
        toewijzing.hor = huidigHor;
      }
      
      // Alleen orientation toevoegen voor niet-klepraam varianten
      if (huidigRaamVariant !== 'klepraam') {
        toewijzing.orientation = huidigRaamOrientation;
      }
      
      if (huidigBeslagKleur === 'anders') {
        toewijzing.beslagKleurWaarde = huidigBeslagKleurWaarde;
      }
      
      setVakToewijzing(vakId, toewijzing);
      updateOrientationButtons();
      updateKlepraamButtons();
      
      toonVakken();
      draw();
      updateQuickButtonStates(vakId);
      refreshRaamStatus(toewijzing);
      vakRaamWis.disabled = false;
      
      setTimeout(() => {
        closeVakRaamExtraMenu();
        closeVakOrientationMenu();
        closeVakKlepraamMenu();
        closeVakRaamMenu();
        closeVakQuickMenu(true);
      }, 300);
    });
  }

  if (glasRoosterYesBtn) {
    glasRoosterYesBtn.addEventListener('click', () => {
      huidigGlasRooster = true;
      updateGlasRoosterButtons();
    });
  }

  if (glasRoosterNoBtn) {
    glasRoosterNoBtn.addEventListener('click', () => {
      huidigGlasRooster = false;
      updateGlasRoosterButtons();
    });
  }

  // Event listeners voor stapeldorpel menu
  if (btnKiesDeurbeslag) {
    btnKiesDeurbeslag.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      const btnRect = btnKiesDeurbeslag.getBoundingClientRect();
      const pos = {
        x: btnRect.left + btnRect.width / 2,
        y: btnRect.top
      };
      closeVakDeurStapeldorpelMenu(false);
      openVakDeurbeslagMenu(huidigDeurMenuVak, pos);
    });
  }

  if (stapeldorpelAantal) {
    stapeldorpelAantal.addEventListener('change', (e) => {
      huidigStapeldorpelAantal = parseInt(e.target.value);
    });
  }

  if (stapeldorpelRoosterCheckbox) {
    stapeldorpelRoosterCheckbox.addEventListener('change', (e) => {
      huidigStapeldorpelRooster = e.target.checked;
    });
  }

  if (tussendorpelHoogte) {
    tussendorpelHoogte.addEventListener('change', (e) => {
      let value = parseInt(e.target.value) || 250;
      // Valideer min/max
      if (value < 250) value = 250;
      if (value > 1500) value = 1500;
      huidigTussendorpelHoogte = value;
      e.target.value = value;
    });
    tussendorpelHoogte.addEventListener('input', (e) => {
      let value = parseInt(e.target.value) || 250;
      // Valideer min/max
      if (value < 250) value = 250;
      if (value > 1500) value = 1500;
      huidigTussendorpelHoogte = value;
    });
  }

  // Event listeners voor bovenste vak knoppen
  // Gebruik event delegation op vak1Group in plaats van individuele knoppen
  if (vak1Group) {
    vak1Group.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-vak1-type]');
      if (!button) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      const vak1Type = button.dataset.vak1Type;
      if (!vak1Type) return;
      
      huidig2vaksVak1Type = vak1Type;
      update2vaksVak1Buttons();
      console.log('Bovenste vak:', vak1Type, 'geselecteerd');
    });
  }
  
  // Ook individuele event listeners toevoegen voor extra zekerheid
  if (vak1GlasBtn) {
    vak1GlasBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      huidig2vaksVak1Type = 'glas';
      update2vaksVak1Buttons();
      console.log('Bovenste vak: glas geselecteerd');
    });
  }
  if (vak1BossingBtn) {
    vak1BossingBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      huidig2vaksVak1Type = 'bossing';
      update2vaksVak1Buttons();
      console.log('Bovenste vak: bossing geselecteerd');
    });
  }
  if (vak1VlakBtn) {
    vak1VlakBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      huidig2vaksVak1Type = 'vlak';
      update2vaksVak1Buttons();
      console.log('Bovenste vak: vlak geselecteerd');
    });
  }

  // Event listeners voor onderste vak knoppen
  if (vak2GlasBtn) {
    vak2GlasBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      huidig2vaksVak2Type = 'glas';
      update2vaksVak2Buttons();
      console.log('Onderste vak: glas geselecteerd');
    });
  }
  if (vak2BossingBtn) {
    vak2BossingBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      huidig2vaksVak2Type = 'bossing';
      update2vaksVak2Buttons();
      console.log('Onderste vak: bossing geselecteerd');
    });
  }
  if (vak2VlakBtn) {
    vak2VlakBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      huidig2vaksVak2Type = 'vlak';
      update2vaksVak2Buttons();
      console.log('Onderste vak: vlak geselecteerd');
    });
  }

  if (vakDeurStapeldorpelBack) {
    vakDeurStapeldorpelBack.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      closeVakDeurStapeldorpelMenu(false);
      if (laatsteDeurMenuPos) {
        openVakDeurBuitenMenu(huidigDeurMenuVak, laatsteDeurMenuPos);
      }
    });
  }

  if (vakDeurStapeldorpelCancel) {
    vakDeurStapeldorpelCancel.addEventListener('click', () => {
      closeVakDeurStapeldorpelMenu();
      closeVakDeurBuitenMenu();
      closeVakDeurMenu();
      closeVakQuickMenu(true);
    });
  }

  if (vakDeurStapeldorpelConfirm) {
    vakDeurStapeldorpelConfirm.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      
      const deurType = huidigDeurBuitenType || 'stapeldorpel';
      
      // Voor zowel 2vaks als stapeldorpel: direct naar orientatie menu
      // (De keuzes voor bovenste en onderste vak zitten al in het 2vaks deur opties menu)
      closeVakDeurStapeldorpelMenu(false);
      const deurVak = huidigDeurMenuVak;
      setTimeout(() => {
        openVakStapeldorpelOrientationMenu(deurVak);
      }, 50);
    });
  }

  // Event listeners voor deurbeslag menu
  if (vakDeurbeslagMenuSection) {
    vakDeurbeslagMenuSection.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-deurbeslag]');
      if (!button || !huidigDeurMenuVak) return;
      
      const deurbeslagType = button.dataset.deurbeslag;
      huidigDeurbeslag = deurbeslagType;
      updateDeurbeslagButtons();
      
      const deurType = huidigDeurBuitenType || 'stapeldorpel';
      
      // Voor dichte deur: ga terug naar dichte deur menu
      if (deurType === 'dicht') {
        console.log('Deurbeslag gekozen voor dichte deur:', deurbeslagType);
        closeVakDeurbeslagMenu(false);
        const deurVak = huidigDeurMenuVak;
        const menuPos = getSvgCenterPos();
        setTimeout(() => {
          openVakDeurDichtMenu(deurVak, menuPos);
          updateDeurbeslagStatusDicht();
        }, 50);
      } else {
        // Voor stapeldorpel en 2vaks: ga terug naar stapeldorpel menu
        closeVakDeurbeslagMenu(false);
        openVakDeurStapeldorpelMenu(huidigDeurMenuVak, deurType);
        updateDeurbeslagStatus();
      }
    });
  }

  if (vakDeurbeslagWis) {
    vakDeurbeslagWis.addEventListener('click', () => {
      huidigDeurbeslag = null;
      updateDeurbeslagButtons();
      updateDeurbeslagStatus();
    });
  }


  // Event listeners voor stapeldorpel orientatie menu
  if (vakStapeldorpelOrientationButtons.length) {
    vakStapeldorpelOrientationButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        if (!huidigDeurMenuVak) return;
        
        const orientation = btn.dataset.stapeldorpelOrientation;
        huidigStapeldorpelOrientation = orientation;
        updateStapeldorpelOrientationButtons();
        
        // Nu alle opties zijn gekozen, sla de definitieve toewijzing op
        const vakId = huidigDeurMenuVak.id;
        // Bepaal deurType en baseVariant
        // Check eerst op normale deuren (deur_buiten), dan op andere varianten
        let deurType = 'stapeldorpel';
        let baseVariant = 'deur_buiten';
        
        if (huidigDeurBuitenType) {
          // Normale buitendraaiende deur
          baseVariant = 'deur_buiten';
          deurType = huidigDeurBuitenType;
        } else if (huidigStolpdeurenBuitenType) {
          // Buitendraaiende stolpdeuren
          baseVariant = 'stolpdeuren_buiten';
          deurType = huidigStolpdeurenBuitenType;
        } else if (huidigDeurDraaikiepType) {
          // Draaikiep deur
          baseVariant = 'deur_draaikiep';
          deurType = huidigDeurDraaikiepType;
        } else if (huidigStolpdeurenDraaikiepType) {
          // Stolpdraaikiep deuren
          baseVariant = 'stolpdeuren_draaikiep';
          deurType = huidigStolpdeurenDraaikiepType;
        }
        let variant = baseVariant;
        if (deurType === 'stapeldorpel') {
          variant = `${baseVariant}_stapeldorpel`;
        } else if (deurType === '2vaks') {
          variant = `${baseVariant}_2vaks`;
        } else if (deurType === 'dicht') {
          variant = `${baseVariant}_dicht`;
        }
        
        const toewijzing = {
          type: 'deur',
          variant: variant,
          orientation: huidigStapeldorpelOrientation
        };
        
        // Voeg type-specifieke opties toe
        if (deurType === 'stapeldorpel') {
          toewijzing.stapeldorpelAantal = huidigStapeldorpelAantal;
          toewijzing.rooster = huidigStapeldorpelRooster; // Alleen voor stapeldorpel
        } else if (deurType === '2vaks') {
          toewijzing.tussendorpelHoogte = huidigTussendorpelHoogte;
          toewijzing.vak1Type = huidig2vaksVak1Type;
          toewijzing.vak2Type = huidig2vaksVak2Type;
        } else if (deurType === 'dicht') {
          toewijzing.deurDichtType = huidigDeurDichtType; // vlak of vgroeven
        }
        
        // Voeg deurbeslag toe als het is gekozen (voor stapeldorpel, 2vaks en dicht)
        if (huidigDeurbeslag) {
          toewijzing.deurbeslag = huidigDeurbeslag;
        }
        
        console.log('Opslaan toewijzing voor', deurType, 'deur:', toewijzing);
        setVakToewijzing(vakId, toewijzing);
        toonVakken();
        draw();
        updateQuickButtonStates(vakId);
        refreshDeurStatus(toewijzing);
        vakDeurWis.disabled = false;
        
        setTimeout(() => {
          closeVakStapeldorpelOrientationMenu();
          closeVak2vaksVak2Menu();
          closeVak2vaksVak1Menu();
          closeVakDeurStapeldorpelMenu();
          closeVakDeurDichtMenu();
          closeVakDeurbeslagMenu();
          closeVakDeurBuitenMenu();
          closeVakDeurMenu();
          closeVakQuickMenu(true);
        }, 300);
      });
    });
  }

  if (vakStapeldorpelOrientationBack) {
    vakStapeldorpelOrientationBack.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      // Bepaal deurType en baseVariant
      // Check eerst op normale deuren (deur_buiten), dan op andere varianten
      let deurType = 'stapeldorpel';
      let baseVariant = 'deur_buiten';
      
      if (huidigDeurBuitenType) {
        // Normale buitendraaiende deur
        baseVariant = 'deur_buiten';
        deurType = huidigDeurBuitenType;
      } else if (huidigStolpdeurenBuitenType) {
        // Buitendraaiende stolpdeuren
        baseVariant = 'stolpdeuren_buiten';
        deurType = huidigStolpdeurenBuitenType;
      } else if (huidigDeurDraaikiepType) {
        // Draaikiep deur
        baseVariant = 'deur_draaikiep';
        deurType = huidigDeurDraaikiepType;
      } else if (huidigStolpdeurenDraaikiepType) {
        // Stolpdraaikiep deuren
        baseVariant = 'stolpdeuren_draaikiep';
        deurType = huidigStolpdeurenDraaikiepType;
      }
      closeVakStapeldorpelOrientationMenu(false);
      if (deurType === 'dicht') {
        // Voor dichte deur: ga terug naar dichte deur menu
        const menuPos = getSvgCenterPos();
        openVakDeurDichtMenu(huidigDeurMenuVak, menuPos);
      } else {
        // Voor stapeldorpel en 2vaks: ga terug naar stapeldorpel menu
        openVakDeurStapeldorpelMenu(huidigDeurMenuVak, deurType, baseVariant);
      }
    });
  }

  if (vakStapeldorpelOrientationCancel) {
    vakStapeldorpelOrientationCancel.addEventListener('click', () => {
      closeVakStapeldorpelOrientationMenu();
      closeVakDeurStapeldorpelMenu();
      closeVakDeurDichtMenu();
      closeVakDeurbeslagMenu();
      closeVakDeurBuitenMenu();
      closeVakDeurMenu();
      closeVakQuickMenu(true);
    });
  }

  // Event listeners voor 2vaks bovenste vak menu
  if (vak2vaksVak1MenuSection) {
    vak2vaksVak1MenuSection.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-vak1-type]');
      if (!button || !huidigDeurMenuVak) return;
      
      const vak1Type = button.dataset.vak1Type;
      huidig2vaksVak1Type = vak1Type;
      update2vaksVak1Buttons();
      
      // Ga naar onderste vak menu
      closeVak2vaksVak1Menu(false);
      const deurVak = huidigDeurMenuVak;
      setTimeout(() => {
        openVak2vaksVak2Menu(deurVak);
      }, 50);
    });
  }

  if (vak2vaksVak1Back) {
    vak2vaksVak1Back.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      closeVak2vaksVak1Menu(false);
      openVakDeurStapeldorpelMenu(huidigDeurMenuVak, '2vaks');
    });
  }

  if (vak2vaksVak1Cancel) {
    vak2vaksVak1Cancel.addEventListener('click', () => {
      closeVak2vaksVak1Menu();
      closeVakDeurStapeldorpelMenu();
      closeVakDeurBuitenMenu();
      closeVakDeurMenu();
      closeVakQuickMenu(true);
    });
  }

  // Event listeners voor 2vaks onderste vak menu
  if (vak2vaksVak2MenuSection) {
    vak2vaksVak2MenuSection.addEventListener('click', (e) => {
      const button = e.target.closest('button[data-vak2-type]');
      if (!button || !huidigDeurMenuVak) return;
      
      const vak2Type = button.dataset.vak2Type;
      huidig2vaksVak2Type = vak2Type;
      update2vaksVak2Buttons();
      
      // Ga naar orientatie menu
      closeVak2vaksVak2Menu(false);
      const deurVak = huidigDeurMenuVak;
      setTimeout(() => {
        openVakStapeldorpelOrientationMenu(deurVak);
      }, 50);
    });
  }

  if (vak2vaksVak2Back) {
    vak2vaksVak2Back.addEventListener('click', () => {
      if (!huidigDeurMenuVak) return;
      closeVak2vaksVak2Menu(false);
      openVak2vaksVak1Menu(huidigDeurMenuVak);
    });
  }

  if (vak2vaksVak2Cancel) {
    vak2vaksVak2Cancel.addEventListener('click', () => {
      closeVak2vaksVak2Menu();
      closeVak2vaksVak1Menu();
      closeVakDeurStapeldorpelMenu();
      closeVakDeurBuitenMenu();
      closeVakDeurMenu();
      closeVakQuickMenu(true);
    });
  }

  if (vakGlasExtraBack) {
    vakGlasExtraBack.addEventListener('click', () => {
      if (!huidigGlasMenuVak) return;
      closeVakGlasExtraMenu(false);
      if (laatsteGlasMenuPos) {
        openVakGlasMenu(huidigGlasMenuVak, laatsteGlasMenuPos, huidigGlasVariant || null);
      }
    });
  }

  if (vakGlasExtraCancel) {
    vakGlasExtraCancel.addEventListener('click', () => {
      closeVakGlasExtraMenu();
      closeVakGlasMenu();
      closeVakQuickMenu(true);
    });
  }

  if (vakGlasExtraConfirm) {
    vakGlasExtraConfirm.addEventListener('click', () => {
      if (!huidigGlasMenuVak || !huidigGlasVariant) return;
      const vakId = huidigGlasMenuVak.id;
      const toewijzing = {
        type: 'glas',
        variant: huidigGlasVariant,
        rooster: !!huidigGlasRooster
      };
      setVakToewijzing(vakId, toewijzing);
      refreshGlasStatus(toewijzing);
      updateQuickButtonStates(vakId);
      toonVakken();
      draw();
      if (vakGlasWis) vakGlasWis.disabled = false;

      setTimeout(() => {
        closeVakGlasExtraMenu();
        closeVakGlasMenu();
        closeVakQuickMenu(true);
      }, 300);
    });
  }
  
  vakQuickMenu.addEventListener('mousedown', (e) => {
    e.stopPropagation();
  });
  vakQuickMenu.addEventListener('mouseup', (e) => {
    e.stopPropagation();
  });
  vakRaamMenu.addEventListener('mousedown', (e) => {
    e.stopPropagation();
  });
  vakRaamMenu.addEventListener('mouseup', (e) => {
    e.stopPropagation();
  });
  if (vakDeurMenu) {
    vakDeurMenu.addEventListener('mousedown', (e) => {
      e.stopPropagation();
    });
    vakDeurMenu.addEventListener('mouseup', (e) => {
      e.stopPropagation();
    });
  }
  if (vakOrientationMenu) {
    vakOrientationMenu.addEventListener('mousedown', (e) => {
      e.stopPropagation();
    });
    vakOrientationMenu.addEventListener('mouseup', (e) => {
      e.stopPropagation();
    });
  }
  if (vakGlasMenu) {
    vakGlasMenu.addEventListener('mousedown', (e) => {
      e.stopPropagation();
    });
    vakGlasMenu.addEventListener('mouseup', (e) => {
      e.stopPropagation();
    });
  }
  if (vakAfwerkingsOptiesMenu) {
    vakAfwerkingsOptiesMenu.addEventListener('mousedown', (e) => {
      e.stopPropagation();
    });
    vakAfwerkingsOptiesMenu.addEventListener('mouseup', (e) => {
      e.stopPropagation();
    });
  }
  
  if (vakRaamExtraMenu) {
    vakRaamExtraMenu.addEventListener('mousedown', (e) => {
      e.stopPropagation();
    });
    vakRaamExtraMenu.addEventListener('mouseup', (e) => {
      e.stopPropagation();
    });
  }
  if (vakGlasExtraMenu) {
    vakGlasExtraMenu.addEventListener('mousedown', (e) => {
      e.stopPropagation();
    });
    vakGlasExtraMenu.addEventListener('mouseup', (e) => {
      e.stopPropagation();
    });
  }

  document.addEventListener('click', (e) => {
    const klikInQuick = vakQuickMenu.contains(e.target);
    const klikInRaam = vakRaamMenu.contains(e.target);
    const klikInDeur = vakDeurMenu && vakDeurMenu.contains(e.target);
    const klikInGlas = vakGlasMenu && vakGlasMenu.contains(e.target);
    const klikInOrientation = vakOrientationMenu && vakOrientationMenu.contains(e.target);
    const klikInExtra = vakRaamExtraMenu && vakRaamExtraMenu.contains(e.target);
    const klikInGlasExtra = vakGlasExtraMenu && vakGlasExtraMenu.contains(e.target);
    const klikInDeurStapeldorpel = vakDeurStapeldorpelMenu && vakDeurStapeldorpelMenu.contains(e.target);
    const klikInDeurbeslag = vakDeurbeslagMenu && vakDeurbeslagMenu.contains(e.target);
    const klikInStapeldorpelOrientation = vakStapeldorpelOrientationMenu && vakStapeldorpelOrientationMenu.contains(e.target);
    const klikIn2vaksVak1 = vak2vaksVak1Menu && vak2vaksVak1Menu.contains(e.target);
    const klikIn2vaksVak2 = vak2vaksVak2Menu && vak2vaksVak2Menu.contains(e.target);
    const klikInAfwerkingsOpties = vakAfwerkingsOptiesMenu && vakAfwerkingsOptiesMenu.contains(e.target);
    if (!klikInQuick && !klikInRaam && !klikInDeur && !klikInGlas && !klikInOrientation && !klikInExtra && !klikInGlasExtra && !klikInDeurStapeldorpel && !klikInDeurbeslag && !klikInStapeldorpelOrientation && !klikIn2vaksVak1 && !klikIn2vaksVak2 && !klikInAfwerkingsOpties) {
      closeVakQuickMenu(true);
      closeVakDeurStapeldorpelMenu();
      closeVakDeurbeslagMenu();
      closeVakStapeldorpelOrientationMenu();
      closeVak2vaksVak1Menu();
      closeVak2vaksVak2Menu();
    }
  });

  window.addEventListener('resize', () => closeVakQuickMenu(true));
  
  // Sluit modal bij klik op sluitknop
  modalClose.addEventListener('click', closeVakSelectModal);
  
  // Sluit modal bij klik buiten modal
  vakSelectModal.addEventListener('click', (e) => {
    if (e.target === vakSelectModal) {
      closeVakSelectModal();
    }
  });
  
  // Sluit modal bij ESC toets
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && vakSelectModal.classList.contains('active')) {
      closeVakSelectModal();
    }
  });
  
  // Event listener voor klaar met tekenen
  btnDetectVakken.addEventListener('click', () => {
    if (state.kanTekenen) {
      detecteerVakken();
      if (state.vakken.length > 0) {
        state.kanTekenen = false;
        closeVakQuickMenu(true);
        resetDagConfigCache();
        draw();
      } else {
        draw();
      }
    } else {
      state.kanTekenen = true;
      state.vakken = [];
      state.vakkenToewijzingen = {};
      vakkenFieldset.style.display = 'none';
      closeVakQuickMenu(true);
      resetDagConfigCache();
      // Reset afwerkingsopties menu flag wanneer opnieuw begonnen wordt met tekenen
      afwerkingsOptiesMenuAutoOpened = false;
      closeVakAfwerkingsOptiesMenu(true);
      draw();
    }
  });

  // Event listeners voor afwerkingsopties menu
  if (btnAfwerkingsOpties) {
    btnAfwerkingsOpties.addEventListener('click', () => {
      openVakAfwerkingsOptiesMenu();
    });
  }

  if (glasEnkelglasBtn) {
    glasEnkelglasBtn.addEventListener('click', () => {
      huidigGlasType = 'enkelglas';
      updateGlasTypeButtons();
      updateAfwerkingsOptiesStatus();
    });
  }

  if (glasHrPlusPlusBtn) {
    glasHrPlusPlusBtn.addEventListener('click', () => {
      huidigGlasType = 'hr++';
      updateGlasTypeButtons();
      updateAfwerkingsOptiesStatus();
    });
  }

  if (glasHrPlusPlusPlusBtn) {
    glasHrPlusPlusPlusBtn.addEventListener('click', () => {
      huidigGlasType = 'hr+++';
      updateGlasTypeButtons();
      updateAfwerkingsOptiesStatus();
    });
  }

  if (afwerkingAfgelaktBtn) {
    afwerkingAfgelaktBtn.addEventListener('click', () => {
      huidigAfwerking = 'afgelakt';
      updateAfwerkingButtons();
      updateAfwerkingsOptiesStatus();
    });
  }

  if (afwerkingGegrondBtn) {
    afwerkingGegrondBtn.addEventListener('click', () => {
      huidigAfwerking = 'alleen-gegrond';
      updateAfwerkingButtons();
      updateAfwerkingsOptiesStatus();
    });
  }

  // Kleur inputs synchroniseren
  // Color picker en text input velden zijn verwijderd - alleen RAL buttons worden gebruikt

  // Event listeners voor RAL kleur buttons
  document.addEventListener('click', (e) => {
    if (e.target.classList.contains('ral-kleur-btn')) {
      const btn = e.target;
      const kleur = btn.getAttribute('data-kleur');
      const target = btn.getAttribute('data-target');
      
      if (target === 'binnen') {
        huidigKleurDeurenRamenBinnen = kleur;
      } else if (target === 'buiten') {
        huidigKleurDeurenRamenBuiten = kleur;
      } else if (target === 'kozijn') {
        huidigKleurKozijn = kleur;
      }
      
      updateRalKleurButtons();
    }
  });

  if (vakAfwerkingsOptiesBack) {
    vakAfwerkingsOptiesBack.addEventListener('click', () => {
      closeVakAfwerkingsOptiesMenu(false);
    });
  }

  if (vakAfwerkingsOptiesCancel) {
    vakAfwerkingsOptiesCancel.addEventListener('click', () => {
      closeVakAfwerkingsOptiesMenu();
    });
  }

  if (vakAfwerkingsOptiesConfirm) {
    vakAfwerkingsOptiesConfirm.addEventListener('click', () => {
      // Sla afwerkingsopties op in state
      state.afwerkingsOpties = {
        glasType: huidigGlasType,
        kleurDeurenRamenBinnen: huidigKleurDeurenRamenBinnen,
        kleurDeurenRamenBuiten: huidigKleurDeurenRamenBuiten,
        kleurKozijn: huidigKleurKozijn,
        afwerking: huidigAfwerking
      };
      console.log('Afwerkingsopties bevestigd en opgeslagen:', state.afwerkingsOpties);
      closeVakAfwerkingsOptiesMenu(false);
      updatePrijsOverzicht();
    });
  }

  // Winkelwagen event listeners
  const btnNaarTekenen = document.getElementById('btnNaarTekenen');
  const btnNaarWinkelwagen = document.getElementById('btnNaarWinkelwagen');
  const btnNaarLosseProducten = document.getElementById('btnNaarLosseProducten');
  const btnToevoegenAanWinkelwagen = document.getElementById('btnToevoegenAanWinkelwagen');
  const btnLeegWinkelwagen = document.getElementById('btnLeegWinkelwagen');

  if (btnNaarTekenen) {
    btnNaarTekenen.addEventListener('click', () => gaNaarPagina('tekenen'));
  }

  if (btnNaarLosseProducten) {
    btnNaarLosseProducten.addEventListener('click', () => gaNaarPagina('losseProducten'));
  }

  if (btnNaarWinkelwagen) {
    btnNaarWinkelwagen.addEventListener('click', () => gaNaarPagina('winkelwagen'));
  }

  // Product keuze cards event listeners
  const keuzeGlas = document.getElementById('keuzeGlas');
  const keuzeRaam = document.getElementById('keuzeRaam');
  const keuzeDeur = document.getElementById('keuzeDeur');
  
  if (keuzeGlas) {
    keuzeGlas.addEventListener('click', () => gaNaarPagina('glas'));
  }
  if (keuzeRaam) {
    keuzeRaam.addEventListener('click', () => gaNaarPagina('raam'));
  }
  if (keuzeDeur) {
    keuzeDeur.addEventListener('click', () => gaNaarPagina('deur'));
  }

  // Terug naar overzicht knoppen
  const btnTerugNaarOverzicht = document.getElementById('btnTerugNaarOverzicht');
  const btnTerugNaarOverzichtRaam = document.getElementById('btnTerugNaarOverzichtRaam');
  const btnTerugNaarOverzichtDeur = document.getElementById('btnTerugNaarOverzichtDeur');
  
  if (btnTerugNaarOverzicht) {
    btnTerugNaarOverzicht.addEventListener('click', () => gaNaarPagina('losseProducten'));
  }
  if (btnTerugNaarOverzichtRaam) {
    btnTerugNaarOverzichtRaam.addEventListener('click', () => gaNaarPagina('losseProducten'));
  }
  if (btnTerugNaarOverzichtDeur) {
    btnTerugNaarOverzichtDeur.addEventListener('click', () => gaNaarPagina('losseProducten'));
  }

  if (btnToevoegenAanWinkelwagen) {
    btnToevoegenAanWinkelwagen.addEventListener('click', voegToeAanWinkelwagen);
  }

  if (btnLeegWinkelwagen) {
    btnLeegWinkelwagen.addEventListener('click', leegWinkelwagen);
  }

  // Losse producten functionaliteit
  const btnVoegGlasToe = document.getElementById('btnVoegGlasToe');
  const btnVoegRaamToe = document.getElementById('btnVoegRaamToe');
  const btnVoegDeurToe = document.getElementById('btnVoegDeurToe');

  // Functie om prijs te berekenen voor los glas
  function berekenGlasPrijs(breedte, hoogte, glasType, glasOpbouw = '') {
    const oppervlakteM2 = (breedte / 1000) * (hoogte / 1000);
    let prijsPerM2 = 60; // Basis prijs voor enkel glas
    
    if (glasType === 'dubbel') {
      prijsPerM2 = 70;
    } else if (glasType === 'trippel') {
      prijsPerM2 = 85;
    }
    
    // Voeg glasopbouw meerprijs toe als opgegeven
    if (glasOpbouw) {
      const opbouwMeerprijs = haalGlasOpbouwPrijs(glasType, glasOpbouw);
      prijsPerM2 += opbouwMeerprijs;
    }
    
    return oppervlakteM2 * prijsPerM2;
  }

  // Functie om prijs te berekenen voor los raam
  function berekenRaamPrijs(breedte, hoogte, glasType) {
    const oppervlakteM2 = (breedte / 1000) * (hoogte / 1000);
    let basisPrijs = oppervlakteM2 * 80; // Basis prijs voor raam
    
    // Glas type meerprijs
    if (glasType === 'hr++') {
      basisPrijs += oppervlakteM2 * 15;
    } else if (glasType === 'hr+++') {
      basisPrijs += oppervlakteM2 * 25;
    }
    
    return basisPrijs;
  }

  // Functie om prijs te berekenen voor losse deur
  function berekenDeurPrijs(breedte, hoogte, glasType) {
    const oppervlakteM2 = (breedte / 1000) * (hoogte / 1000);
    let basisPrijs = oppervlakteM2 * 120; // Basis prijs voor deur
    
    // Glas type meerprijs
    if (glasType === 'hr++') {
      basisPrijs += oppervlakteM2 * 15;
    } else if (glasType === 'hr+++') {
      basisPrijs += oppervlakteM2 * 25;
    }
    
    return basisPrijs;
  }

  // Voeg glas toe aan winkelwagen
  if (btnVoegGlasToe) {
    btnVoegGlasToe.addEventListener('click', () => {
      const breedte = parseInt(document.getElementById('glasBreedte').value) || 1000;
      const hoogte = parseInt(document.getElementById('glasHoogte').value) || 1000;
      const glasType = document.getElementById('glasTypeLos').value;
      const glasOpbouw = document.getElementById('glasOpbouw')?.value || '';
      const rooster = document.getElementById('glasRooster').value || '';
      const aantal = parseInt(document.getElementById('glasAantal').value) || 1;
      
      if (breedte < 100 || hoogte < 100) {
        alert('‚ö†Ô∏è Minimale afmetingen zijn 100mm √ó 100mm');
        return;
      }
      
      const basisPrijs = berekenGlasPrijs(breedte, hoogte, glasType, glasOpbouw);
      const totaalPrijs = basisPrijs * aantal;
      
      const winkelwagen = haalWinkelwagenOp();
      const glasTypeLabel = glasType === 'hr+' ? 'HR+' : 
                           glasType === 'hr++' ? 'HR++' : 
                           glasType === 'hr+++' ? 'HR+++' : 'Enkel glas';
      
      // Haal rooster label op vanuit JSON data
      let roosterLabel = rooster;
      if (roosterData && roosterData.opties) {
        const roosterOptie = roosterData.opties.find(opt => opt.value === rooster);
        if (roosterOptie) {
          roosterLabel = roosterOptie.label;
        }
      }
      
      // Haal label op vanuit JSON data
      let glasOpbouwLabel = glasOpbouw;
      if (glasOpbouwData && glasOpbouw) {
        const typeData = glasOpbouwData[glasType];
        if (typeData && typeData.opties) {
          const optie = typeData.opties.find(opt => opt.value === glasOpbouw);
          if (optie) {
            glasOpbouwLabel = optie.label;
          }
        }
      }
      
      const item = {
        id: Date.now(),
        type: 'glas',
        titel: `Los glas ${breedte}mm √ó ${hoogte}mm`,
        afmetingen: `${breedte}mm √ó ${hoogte}mm`,
        glasType: glasType,
        glasTypeLabel: glasTypeLabel,
        glasOpbouw: glasOpbouw,
        glasOpbouwLabel: glasOpbouwLabel,
        rooster: rooster,
        roosterLabel: roosterLabel,
        aantal: aantal,
        prijs: totaalPrijs,
        basisPrijs: basisPrijs,
        datum: new Date().toISOString()
      };
      
      winkelwagen.push(item);
      slaWinkelwagenOp(winkelwagen);
      alert(`‚úÖ ${aantal}x glas toegevoegd aan winkelwagen!`);
      updateWinkelwagenBadge();
    });
  }

  // Voeg raam toe aan winkelwagen
  if (btnVoegRaamToe) {
    btnVoegRaamToe.addEventListener('click', () => {
      const breedte = parseInt(document.getElementById('raamBreedte').value) || 1000;
      const hoogte = parseInt(document.getElementById('raamHoogte').value) || 1000;
      const raamType = document.getElementById('raamTypeLos').value;
      const draairichting = document.getElementById('raamDraairichting').value;
      const glasType = document.getElementById('raamGlasType').value;
      const aantal = parseInt(document.getElementById('raamAantal').value) || 1;
      
      if (breedte < 300 || hoogte < 300) {
        alert('‚ö†Ô∏è Minimale afmetingen voor ramen zijn 300mm √ó 300mm');
        return;
      }
      
      const basisPrijs = berekenRaamPrijs(breedte, hoogte, glasType);
      const totaalPrijs = basisPrijs * aantal;
      
      const winkelwagen = haalWinkelwagenOp();
      const raamTypeLabels = {
        'draairaam_buiten': 'Draairaam naar buiten',
        'draairaam_binnen': 'Draairaam naar binnen',
        'stolpraam_buiten': 'Stolpraam buitendraaiend',
        'stolpraam_binnen': 'Stolpraam binnendraaiend',
        'draaikiep': 'Draaikiep raam',
        'kiep': 'Kiep raam',
        'vast': 'Vast raam'
      };
      const glasTypeLabel = glasType === 'hr+' ? 'HR+' : 
                           glasType === 'hr++' ? 'HR++' : 
                           glasType === 'hr+++' ? 'HR+++' : 'Enkel glas';
      
      const item = {
        id: Date.now(),
        type: 'raam',
        titel: `Los raam ${breedte}mm √ó ${hoogte}mm`,
        afmetingen: `${breedte}mm √ó ${hoogte}mm`,
        raamType: raamType,
        raamTypeLabel: raamTypeLabels[raamType] || raamType,
        draairichting: draairichting,
        glasType: glasType,
        glasTypeLabel: glasTypeLabel,
        aantal: aantal,
        prijs: totaalPrijs,
        basisPrijs: basisPrijs,
        datum: new Date().toISOString()
      };
      
      winkelwagen.push(item);
      slaWinkelwagenOp(winkelwagen);
      alert(`‚úÖ ${aantal}x raam toegevoegd aan winkelwagen!`);
      updateWinkelwagenBadge();
    });
  }

  // Voeg deur toe aan winkelwagen
  if (btnVoegDeurToe) {
    btnVoegDeurToe.addEventListener('click', () => {
      const breedte = parseInt(document.getElementById('deurBreedte').value) || 900;
      const hoogte = parseInt(document.getElementById('deurHoogte').value) || 2100;
      const deurType = document.getElementById('deurTypeLos').value;
      const draairichting = document.getElementById('deurDraairichting').value;
      const glasType = document.getElementById('deurGlasType').value;
      const aantal = parseInt(document.getElementById('deurAantal').value) || 1;
      
      if (breedte < 600 || hoogte < 1800) {
        alert('‚ö†Ô∏è Minimale afmetingen voor deuren zijn 600mm √ó 1800mm');
        return;
      }
      
      const basisPrijs = berekenDeurPrijs(breedte, hoogte, glasType);
      const totaalPrijs = basisPrijs * aantal;
      
      const winkelwagen = haalWinkelwagenOp();
      const deurTypeLabels = {
        'dichte_deur': 'Dichte deur',
        'deur_met_raam': 'Deur met raam',
        'stolpdeur_buitendraaiend': 'Stolpdeur buitendraaiend',
        'stolpdeur_binnendraaiend': 'Stolpdeur binnendraaiend'
      };
      const glasTypeLabel = glasType === 'hr+' ? 'HR+' : 
                           glasType === 'hr++' ? 'HR++' : 
                           glasType === 'hr+++' ? 'HR+++' : 'Enkel glas';
      
      const item = {
        id: Date.now(),
        type: 'deur',
        titel: `Losse deur ${breedte}mm √ó ${hoogte}mm`,
        afmetingen: `${breedte}mm √ó ${hoogte}mm`,
        deurType: deurType,
        deurTypeLabel: deurTypeLabels[deurType] || deurType,
        draairichting: draairichting,
        glasType: glasType,
        glasTypeLabel: glasTypeLabel,
        aantal: aantal,
        prijs: totaalPrijs,
        basisPrijs: basisPrijs,
        datum: new Date().toISOString()
      };
      
      winkelwagen.push(item);
      slaWinkelwagenOp(winkelwagen);
      alert(`‚úÖ ${aantal}x deur toegevoegd aan winkelwagen!`);
      updateWinkelwagenBadge();
    });
  }

  // Menu items voor losse producten
  const menuItemGlas = document.getElementById('menuItemGlas');
  const menuItemRaam = document.getElementById('menuItemRaam');
  const menuItemDeur = document.getElementById('menuItemDeur');
  const previewGlas = document.getElementById('previewGlas');
  const previewRaam = document.getElementById('previewRaam');
  const previewDeur = document.getElementById('previewDeur');

  // Functie om product preview te wisselen
  function wisselProductPreview(product) {
    // Verberg alle previews
    if (previewGlas) previewGlas.style.display = 'none';
    if (previewRaam) previewRaam.style.display = 'none';
    if (previewDeur) previewDeur.style.display = 'none';
    
    // Verwijder active class van alle menu items
    if (menuItemGlas) menuItemGlas.classList.remove('active');
    if (menuItemRaam) menuItemRaam.classList.remove('active');
    if (menuItemDeur) menuItemDeur.classList.remove('active');
    
    // Toon juiste preview en active menu item
    if (product === 'glas') {
      if (previewGlas) previewGlas.style.display = 'block';
      if (menuItemGlas) menuItemGlas.classList.add('active');
      updateGlasPreview();
    } else if (product === 'raam') {
      if (previewRaam) previewRaam.style.display = 'block';
      if (menuItemRaam) menuItemRaam.classList.add('active');
      updateRaamPreview();
    } else if (product === 'deur') {
      if (previewDeur) previewDeur.style.display = 'block';
      if (menuItemDeur) menuItemDeur.classList.add('active');
      updateDeurPreview();
    }
  }

  // Event listeners voor menu items
  if (menuItemGlas) {
    menuItemGlas.addEventListener('click', () => wisselProductPreview('glas'));
  }
  if (menuItemRaam) {
    menuItemRaam.addEventListener('click', () => wisselProductPreview('raam'));
  }
  if (menuItemDeur) {
    menuItemDeur.addEventListener('click', () => wisselProductPreview('deur'));
  }

  // Functie om glas tekening te tekenen
  function tekenGlasTekening(breedte, hoogte, rooster) {
    const svg = document.getElementById('glasTekeningSVG');
    if (!svg) return;
    
    // Leeg de SVG
    svg.innerHTML = '';
    
    // Bereken schaal om het glas goed te laten passen in de viewBox (500x400)
    const padding = 60;
    const maxBreedte = 500 - (padding * 2);
    const maxHoogte = 400 - (padding * 2);
    
    const schaalBreedte = maxBreedte / breedte;
    const schaalHoogte = maxHoogte / hoogte;
    const schaal = Math.min(schaalBreedte, schaalHoogte, 1); // Max 1:1 schaal
    
    const getekendeBreedte = breedte * schaal;
    const getekendeHoogte = hoogte * schaal;
    
    // Centreer het glas
    const startX = (500 - getekendeBreedte) / 2;
    const startY = (400 - getekendeHoogte) / 2;
    
    // Teken glas rechthoek
    const glasRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    glasRect.setAttribute('x', startX);
    glasRect.setAttribute('y', startY);
    glasRect.setAttribute('width', getekendeBreedte);
    glasRect.setAttribute('height', getekendeHoogte);
    glasRect.setAttribute('class', 'glasTekening');
    svg.appendChild(glasRect);
    
    // Teken rooster als gekozen (alleen voor grid patterns zoals 2x2, 3x3, etc)
    if (rooster && rooster.includes('x') && !rooster.includes('_')) {
      const roosterParts = rooster.split('x');
      const kolommen = parseInt(roosterParts[0]) || 2;
      const rijen = parseInt(roosterParts[1]) || 2;
      
      // Verticale lijnen
      for (let i = 1; i < kolommen; i++) {
        const x = startX + (getekendeBreedte / kolommen) * i;
        const lijn = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        lijn.setAttribute('x1', x);
        lijn.setAttribute('y1', startY);
        lijn.setAttribute('x2', x);
        lijn.setAttribute('y2', startY + getekendeHoogte);
        lijn.setAttribute('class', 'glasTekeningRooster');
        svg.appendChild(lijn);
      }
      
      // Horizontale lijnen
      for (let i = 1; i < rijen; i++) {
        const y = startY + (getekendeHoogte / rijen) * i;
        const lijn = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        lijn.setAttribute('x1', startX);
        lijn.setAttribute('y1', y);
        lijn.setAttribute('x2', startX + getekendeBreedte);
        lijn.setAttribute('y2', y);
        lijn.setAttribute('class', 'glasTekeningRooster');
        svg.appendChild(lijn);
      }
    }
    
    // Teken afmetingen labels
    // Breedte label onder
    const breedteLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    breedteLabel.setAttribute('x', startX + getekendeBreedte / 2);
    breedteLabel.setAttribute('y', startY + getekendeHoogte + 25);
    breedteLabel.setAttribute('class', 'glasTekeningMaat');
    breedteLabel.textContent = `${breedte} mm`;
    svg.appendChild(breedteLabel);
    
    // Hoogte label links
    const hoogteLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    hoogteLabel.setAttribute('x', startX - 15);
    hoogteLabel.setAttribute('y', startY + getekendeHoogte / 2);
    hoogteLabel.setAttribute('class', 'glasTekeningMaat');
    hoogteLabel.setAttribute('text-anchor', 'end');
    hoogteLabel.setAttribute('dominant-baseline', 'middle');
    hoogteLabel.textContent = `${hoogte} mm`;
    svg.appendChild(hoogteLabel);
    
    // Teken maatlijnen voor breedte
    const breedteMaatLijnY = startY + getekendeHoogte + 10;
    const maatlijnBreedte1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    maatlijnBreedte1.setAttribute('x1', startX);
    maatlijnBreedte1.setAttribute('y1', breedteMaatLijnY);
    maatlijnBreedte1.setAttribute('x2', startX);
    maatlijnBreedte1.setAttribute('y2', breedteMaatLijnY + 5);
    maatlijnBreedte1.setAttribute('stroke', '#ffb347');
    maatlijnBreedte1.setAttribute('stroke-width', '1.5');
    svg.appendChild(maatlijnBreedte1);
    
    const maatlijnBreedte2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    maatlijnBreedte2.setAttribute('x1', startX + getekendeBreedte);
    maatlijnBreedte2.setAttribute('y1', breedteMaatLijnY);
    maatlijnBreedte2.setAttribute('x2', startX + getekendeBreedte);
    maatlijnBreedte2.setAttribute('y2', breedteMaatLijnY + 5);
    maatlijnBreedte2.setAttribute('stroke', '#ffb347');
    maatlijnBreedte2.setAttribute('stroke-width', '1.5');
    svg.appendChild(maatlijnBreedte2);
    
    const maatlijnBreedteHor = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    maatlijnBreedteHor.setAttribute('x1', startX);
    maatlijnBreedteHor.setAttribute('y1', breedteMaatLijnY + 2.5);
    maatlijnBreedteHor.setAttribute('x2', startX + getekendeBreedte);
    maatlijnBreedteHor.setAttribute('y2', breedteMaatLijnY + 2.5);
    maatlijnBreedteHor.setAttribute('stroke', '#ffb347');
    maatlijnBreedteHor.setAttribute('stroke-width', '1');
    maatlijnBreedteHor.setAttribute('stroke-dasharray', '3,3');
    svg.appendChild(maatlijnBreedteHor);
    
    // Teken maatlijnen voor hoogte
    const hoogteMaatLijnX = startX - 10;
    const maatlijnHoogte1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    maatlijnHoogte1.setAttribute('x1', hoogteMaatLijnX);
    maatlijnHoogte1.setAttribute('y1', startY);
    maatlijnHoogte1.setAttribute('x2', hoogteMaatLijnX + 5);
    maatlijnHoogte1.setAttribute('y2', startY);
    maatlijnHoogte1.setAttribute('stroke', '#ffb347');
    maatlijnHoogte1.setAttribute('stroke-width', '1.5');
    svg.appendChild(maatlijnHoogte1);
    
    const maatlijnHoogte2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    maatlijnHoogte2.setAttribute('x1', hoogteMaatLijnX);
    maatlijnHoogte2.setAttribute('y1', startY + getekendeHoogte);
    maatlijnHoogte2.setAttribute('x2', hoogteMaatLijnX + 5);
    maatlijnHoogte2.setAttribute('y2', startY + getekendeHoogte);
    maatlijnHoogte2.setAttribute('stroke', '#ffb347');
    maatlijnHoogte2.setAttribute('stroke-width', '1.5');
    svg.appendChild(maatlijnHoogte2);
    
    const maatlijnHoogteVert = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    maatlijnHoogteVert.setAttribute('x1', hoogteMaatLijnX + 2.5);
    maatlijnHoogteVert.setAttribute('y1', startY);
    maatlijnHoogteVert.setAttribute('x2', hoogteMaatLijnX + 2.5);
    maatlijnHoogteVert.setAttribute('y2', startY + getekendeHoogte);
    maatlijnHoogteVert.setAttribute('stroke', '#ffb347');
    maatlijnHoogteVert.setAttribute('stroke-width', '1');
    maatlijnHoogteVert.setAttribute('stroke-dasharray', '3,3');
    svg.appendChild(maatlijnHoogteVert);
  }

  // Glas en rooster data (wordt geladen vanuit JSON bestand)
  let glasEnRoosterData = null;
  let glasOpbouwData = null;
  let roosterData = null;
  
  // Functie om glas en rooster data te laden vanuit JSON bestand
  async function laadGlasEnRoosterData() {
    try {
      // Cache-busting: voeg timestamp toe om te voorkomen dat browser oude versie cached
      const cacheBuster = '?v=' + new Date().getTime();
      const response = await fetch('glas-en-rooster-data.json' + cacheBuster);
      if (!response.ok) {
        throw new Error('Kon glas en rooster data niet laden');
      }
      glasEnRoosterData = await response.json();
      glasOpbouwData = glasEnRoosterData.glasopbouw || null;
      roosterData = glasEnRoosterData.roosters || null;
      console.log('Glas en rooster data geladen:', glasEnRoosterData);
    } catch (error) {
      console.error('Fout bij laden van glas en rooster data:', error);
      // Fallback data als JSON niet geladen kan worden
      glasEnRoosterData = {
        "glasopbouw": {
          "enkel": {
            "opties": [
              { "value": "4mm", "label": "4mm", "prijs": 0 },
              { "value": "5mm", "label": "5mm", "prijs": 5 },
              { "value": "33.1_gelaagd", "label": "33.1 gelaagd", "prijs": 15 },
              { "value": "44.2_gelaagd", "label": "44.2 gelaagd", "prijs": 20 },
              { "value": "33.1_matte_witte_folie", "label": "33.1 matte witte folie", "prijs": 25 }
            ]
          },
          "Dubbel glas": {
            "opties": [
              { "value": "4-spouw-*4", "label": "4-spouw-*4", "prijs": 10 },
              { "value": "5-spouw-*4", "label": "5-spouw-*4", "prijs": 15 },
              { "value": "33.1-spouw-*4", "label": "33.1-spouw-*4", "prijs": 25 },
              { "value": "33.1_mf-spouw-*4", "label": "33.1(MF)-spouw-*4 (matte witte folie)", "prijs": 0 },
              { "value": "33.1-spouw-*33.1", "label": "33.1-spouw-*33.1", "prijs": 0 },
              { "value": "33.1_mf-spouw-*33.1", "label": "33.1(MF)-spouw-*33.1 (matte witte folie)", "prijs": 0 }
            ]
          },
          // Oude keys als fallback voor backward compatibility
          "hr+": {
            "opties": [
              { "value": "4-6-*4", "label": "4-6-*4", "prijs": 10 },
              { "value": "5-6-*4", "label": "5-6-*4", "prijs": 15 },
              { "value": "4-8-*4", "label": "4-8-*4", "prijs": 12 },
              { "value": "5-8-*4", "label": "5-8-*4", "prijs": 17 },
              { "value": "4-10-*4", "label": "4-10-*4", "prijs": 14 },
              { "value": "5-10-*4", "label": "5-10-*4", "prijs": 19 },
              { "value": "4-12-*4", "label": "4-12-*4", "prijs": 16 },
              { "value": "5-12-*4", "label": "5-12-*4", "prijs": 21 },
              { "value": "33.1-6-*4", "label": "33.1-6-*4", "prijs": 25 },
              { "value": "33.1-8-*4", "label": "33.1-8-*4", "prijs": 27 },
              { "value": "33.1-10-*4", "label": "33.1-10-*4", "prijs": 29 },
              { "value": "33.1-12-*4", "label": "33.1-12-*4", "prijs": 31 }
            ]
          },
          "hr++": {
            "opties": [
              { "value": "4-13-*4", "label": "4-13-*4", "prijs": 0 },
              { "value": "5-13-*4", "label": "5-13-*4", "prijs": 0 },
              { "value": "33.1-13-*4", "label": "33.1-13-*4", "prijs": 0 },
              { "value": "33.1_mf-13-*4", "label": "33.1(MF)-13-*4", "prijs": 0 },
              { "value": "33.1-13-*33.1", "label": "33.1-13-*33.1", "prijs": 0 },
              { "value": "4-15-*4", "label": "4-15-*4", "prijs": 0 },
              { "value": "5-15-*4", "label": "5-15-*4", "prijs": 0 },
              { "value": "33.1-15-*4", "label": "33.1-15-*4", "prijs": 0 },
              { "value": "33.1-15-*33.1", "label": "33.1-15-*33.1", "prijs": 0 },
              { "value": "33.1_mf-15-*4", "label": "33.1(MF)-15-*4", "prijs": 0 }
            ]
          },
          "Trippel glas": {
            "opties": [
              { "value": "4*-spouw-4-spouw-*4", "label": "4*-spouw-4-spouw-*4", "prijs": 0 },
              { "value": "5*-spouw-4-spouw-*4", "label": "5*-spouw-4-spouw-*4", "prijs": 0 },
              { "value": "33.1*-spouw-4-spouw-*4", "label": "33.1*-spouw-4-spouw-*4", "prijs": 0 },
              { "value": "33.1*-spouw-4-spouw-*33.1", "label": "33.1*-spouw-4-spouw-*33.1", "prijs": 0 },
              { "value": "33.1_mf-spouw-4-spouw-*4", "label": "33.1(mf)-spouw-4-spouw-*4", "prijs": 0 },
              { "value": "33.1_mf-spouw-4-spouw-33.1", "label": "33.1(mf)-spouw-4-spouw-33.1", "prijs": 0 }
            ]
          }
        },
      "roosters": {
          "opties": [
            { "value": "ducoton_10", "label": "Ducoton 10", "prijs": 0 },
            { "value": "ducoton_10_zr", "label": "Ducoton 10 ZR", "prijs": 0 },
            { "value": "ducoton_flat", "label": "Ducoton flat", "prijs": 0 },
            { "value": "ductonline_15", "label": "Ductonline 15", "prijs": 0 }
          ]
        }
      };
      glasOpbouwData = glasEnRoosterData.glasopbouw;
      roosterData = glasEnRoosterData.roosters;
    }
  }
  
  // Alias voor backward compatibility
  async function laadGlasOpbouwData() {
    return laadGlasEnRoosterData();
  }
  
  // Functie om prijs op te halen voor een glasopbouw optie
  function haalGlasOpbouwPrijs(glasType, glasOpbouw) {
    if (!glasOpbouwData || !glasOpbouw) return 0;
    
    // Mapping van nieuwe glas type waarden naar JSON keys
    // Controleer eerst of de nieuwe keys bestaan, anders gebruik oude keys als fallback
    let jsonKey = glasType;
    if (glasType === 'dubbel') {
      if (glasOpbouwData && glasOpbouwData['Dubbel glas']) {
        jsonKey = 'Dubbel glas';
      } else if (glasOpbouwData && glasOpbouwData['hr+']) {
        jsonKey = 'hr+';
      }
    } else if (glasType === 'trippel') {
      if (glasOpbouwData && glasOpbouwData['Trippel glas']) {
        jsonKey = 'Trippel glas';
      } else if (glasOpbouwData && glasOpbouwData['hr++']) {
        jsonKey = 'hr++';
      }
    }
    
    const typeData = glasOpbouwData[jsonKey];
    if (!typeData) return 0;
    
    const optie = typeData.opties.find(opt => opt.value === glasOpbouw);
    return optie ? optie.prijs : 0;
  }
  
  // Functie om rooster opties te laden in dropdown menu
  function updateRoosterOpties() {
    const productPaginaGlas = document.getElementById('productPaginaGlas');
    let glasRoosterSelect = null;
    
    // Zoek het rooster select element
    if (productPaginaGlas && productPaginaGlas.classList.contains('active')) {
      glasRoosterSelect = productPaginaGlas.querySelector('#glasRooster');
    } else {
      glasRoosterSelect = document.getElementById('glasRooster');
    }
    
    if (!glasRoosterSelect || !roosterData) return;
    
    // Leeg het select menu
    glasRoosterSelect.innerHTML = '';
    
    // Voeg rooster opties toe vanuit JSON data
    if (roosterData.opties) {
      roosterData.opties.forEach(optie => {
        const option = document.createElement('option');
        option.value = optie.value;
        option.textContent = optie.label;
        glasRoosterSelect.appendChild(option);
      });
    }
  }

  // Functie om glasopbouw opties te updaten op basis van glas type
  function updateGlasOpbouwOpties() {
    // Zoek het actieve glasTypeLos element (op de zichtbare pagina)
    const productPaginaGlas = document.getElementById('productPaginaGlas');
    let glasTypeSelect = null;
    let glasOpbouwSelect = null;
    let glasOpbouwItem = null;
    
    // Als we op de glas product pagina zijn, gebruik die elementen
    if (productPaginaGlas && productPaginaGlas.classList.contains('active')) {
      glasTypeSelect = productPaginaGlas.querySelector('#glasTypeLos');
      glasOpbouwSelect = productPaginaGlas.querySelector('#glasOpbouw');
      glasOpbouwItem = productPaginaGlas.querySelector('#glasOpbouwItem');
    } else {
      // Anders probeer de algemene elementen
      glasTypeSelect = document.getElementById('glasTypeLos');
      glasOpbouwSelect = document.getElementById('glasOpbouw');
      glasOpbouwItem = document.getElementById('glasOpbouwItem');
    }
    
    if (!glasTypeSelect || !glasOpbouwSelect || !glasOpbouwItem) {
      return;
    }
    
    const glasType = glasTypeSelect.value || 'enkel';
    
    // Mapping van nieuwe glas type waarden naar JSON keys
    // Controleer eerst of de nieuwe keys bestaan, anders gebruik oude keys als fallback
    let jsonKey = glasType;
    if (glasType === 'dubbel') {
      // Probeer eerst "Dubbel glas", anders fallback naar "hr+"
      if (glasOpbouwData && glasOpbouwData['Dubbel glas']) {
        jsonKey = 'Dubbel glas';
      } else if (glasOpbouwData && glasOpbouwData['hr+']) {
        jsonKey = 'hr+';
      }
    } else if (glasType === 'trippel') {
      // Probeer eerst "Trippel glas", anders fallback naar "hr++"
      if (glasOpbouwData && glasOpbouwData['Trippel glas']) {
        jsonKey = 'Trippel glas';
      } else if (glasOpbouwData && glasOpbouwData['hr++']) {
        jsonKey = 'hr++';
      }
    }
    
    // Leeg het select menu
    glasOpbouwSelect.innerHTML = '';
    
    // Wacht tot data geladen is, of gebruik fallback
    if (!glasOpbouwData) {
      // Probeer data opnieuw te laden als het nog niet geladen is
      laadGlasOpbouwData().then(() => {
        updateGlasOpbouwOpties();
      });
      return;
    }
    
    // Debug: log de beschikbare keys
    console.log('Glas type:', glasType, 'JSON key:', jsonKey);
    console.log('GlasOpbouwData beschikbaar:', !!glasOpbouwData);
    if (glasOpbouwData) {
      console.log('Beschikbare keys in glasOpbouwData:', Object.keys(glasOpbouwData));
    }
    
    const typeData = glasOpbouwData ? glasOpbouwData[jsonKey] : null;
    
    console.log('Type data gevonden voor key "' + jsonKey + '":', typeData);
    
    if (typeData && typeData.opties && typeData.opties.length > 0) {
      // Voeg opties toe vanuit JSON data
      typeData.opties.forEach(optie => {
        const option = document.createElement('option');
        option.value = optie.value;
        option.textContent = optie.label;
        glasOpbouwSelect.appendChild(option);
      });
      
      glasOpbouwItem.style.display = 'flex';
      console.log('Glasopbouw menu getoond met', typeData.opties.length, 'opties');
      
      // Voeg event listener toe aan het select element
      glasOpbouwSelect.removeEventListener('change', updateGlasPreview);
      glasOpbouwSelect.addEventListener('change', () => {
        console.log('Glasopbouw dropdown gewijzigd naar:', glasOpbouwSelect.value);
        updateGlasPreview();
      });
      
      // Update preview direct na het vullen
      setTimeout(() => updateGlasPreview(), 50);
    } else {
      // Geen glasopbouw opties beschikbaar voor dit glas type
      glasOpbouwItem.style.display = 'none';
      console.log('Geen glasopbouw opties gevonden voor', jsonKey);
    }
  }

  // Functie om spouw menu te tonen/verbergen en opties te updaten op basis van glas type
  function updateSpouwMenu() {
    const productPaginaGlas = document.getElementById('productPaginaGlas');
    let glasTypeSelect = null;
    let glasSpouwItem = null;
    let glasSpouwSelect = null;
    
    // Als we op de glas product pagina zijn, gebruik die elementen
    if (productPaginaGlas && productPaginaGlas.classList.contains('active')) {
      glasTypeSelect = productPaginaGlas.querySelector('#glasTypeLos');
      glasSpouwItem = productPaginaGlas.querySelector('#glasSpouwItem');
      glasSpouwSelect = productPaginaGlas.querySelector('#glasSpouw');
    } else {
      // Anders probeer de algemene elementen
      glasTypeSelect = document.getElementById('glasTypeLos');
      glasSpouwItem = document.getElementById('glasSpouwItem');
      glasSpouwSelect = document.getElementById('glasSpouw');
    }
    
    if (!glasTypeSelect || !glasSpouwItem || !glasSpouwSelect) {
      return;
    }
    
    const glasType = glasTypeSelect.value || 'enkel';
    
    // Verberg spouw menu bij enkel glas, toon bij dubbel of trippel glas
    if (glasType === 'enkel') {
      glasSpouwItem.style.display = 'none';
    } else {
      glasSpouwItem.style.display = 'flex';
      
      // Leeg het select menu
      glasSpouwSelect.innerHTML = '';
      
      // Vul opties op basis van glas type
      if (glasType === 'dubbel') {
        // Opties voor Dubbel glas (HR+ en HR++)
        const dubbelOpties = [
          { value: '6mm', label: '6mm (HR+)' },
          { value: '8mm', label: '8mm (HR+)' },
          { value: '10mm', label: '10mm (HR+)' },
          { value: '12mm', label: '12mm (HR+)' },
          { value: '13mm', label: '13mm (HR++)' },
          { value: '14mm', label: '14mm (HR++)' },
          { value: '15mm', label: '15mm (HR++)' },
          { value: '16mm', label: '16mm (HR++)' }
        ];
        dubbelOpties.forEach(optie => {
          const option = document.createElement('option');
          option.value = optie.value;
          option.textContent = optie.label;
          glasSpouwSelect.appendChild(option);
        });
      } else if (glasType === 'trippel') {
        // Opties voor Trippel glas (HR++ en HR+++)
        const trippelOpties = [
          { value: '8mm', label: '8mm (HR++)' },
          { value: '10mm', label: '10mm (HR++)' },
          { value: '12mm', label: '12mm (HR+++)' },
          { value: '13mm', label: '13mm (HR+++)' },
          { value: '14mm', label: '14mm (HR+++)' },
          { value: '15mm', label: '15mm (HR+++)' }
        ];
        trippelOpties.forEach(optie => {
          const option = document.createElement('option');
          option.value = optie.value;
          option.textContent = optie.label;
          glasSpouwSelect.appendChild(option);
        });
      }
      
      // Voeg event listener toe aan het select element
      glasSpouwSelect.removeEventListener('change', updateGlasPreview);
      glasSpouwSelect.addEventListener('change', () => {
        console.log('Spouw dropdown gewijzigd naar:', glasSpouwSelect.value);
        updateGlasPreview();
      });
      
      // Update preview direct na het vullen
      setTimeout(() => updateGlasPreview(), 50);
    }
  }

  // Functie om spacer menu te tonen/verbergen op basis van glas type
  function updateSpacerMenu() {
    const productPaginaGlas = document.getElementById('productPaginaGlas');
    let glasTypeSelect = null;
    let glasSpacerItem = null;
    
    // Als we op de glas product pagina zijn, gebruik die elementen
    if (productPaginaGlas && productPaginaGlas.classList.contains('active')) {
      glasTypeSelect = productPaginaGlas.querySelector('#glasTypeLos');
      glasSpacerItem = productPaginaGlas.querySelector('#glasSpacerItem');
    } else {
      // Anders probeer de algemene elementen
      glasTypeSelect = document.getElementById('glasTypeLos');
      glasSpacerItem = document.getElementById('glasSpacerItem');
    }
    
    if (!glasTypeSelect || !glasSpacerItem) {
      return;
    }
    
    const glasType = glasTypeSelect.value || 'enkel';
    
    // Verberg spacer menu bij enkel glas, toon bij dubbel of trippel glas
    if (glasType === 'enkel') {
      glasSpacerItem.style.display = 'none';
    } else {
      glasSpacerItem.style.display = 'flex';
    }
  }

  // Functie om glasopbouw menu te tonen/verbergen (oude functie, nu gebruikt updateGlasOpbouwOpties)
  function updateGlasOpbouwMenu() {
    updateGlasOpbouwOpties();
    updateSpouwMenu();
    updateSpacerMenu();
  }

  // Functie om glas dikte te berekenen op basis van opbouw en spouw
  function berekenGlasDikte(glasOpbouw, spouwWaarde, glasType) {
    if (!glasOpbouw) return null;
    
    // Voor enkel glas is er geen spouw
    if (glasType === 'enkel') {
      // Functie om glas dikte te converteren (33.1 = 6.2mm)
      function getGlasDikte(waarde) {
        if (waarde === '33.1' || waarde === '33.1_gelaagd' || waarde.startsWith('33.1')) {
          return 6.2;
        }
        // Verwijder "mm" en andere tekst, alleen nummer behouden
        const nummer = parseFloat(waarde.replace(/[^0-9.]/g, '')) || 0;
        return nummer;
      }
      return getGlasDikte(glasOpbouw);
    }
    
    // Voor dubbel en trippel glas is spouw vereist
    if (!spouwWaarde) return null;
    
    // Converteer spouw waarde naar nummer (bijv. "6mm" -> 6)
    const spouwDikte = parseFloat(spouwWaarde.replace('mm', '')) || 0;
    
    // Functie om glas dikte te converteren (33.1 = 6.2mm)
    function getGlasDikte(waarde) {
      if (waarde === '33.1' || waarde === '33.1_gelaagd' || waarde.startsWith('33.1')) {
        return 6.2;
      }
      // Verwijder "mm" en andere tekst, alleen nummer behouden
      const nummer = parseFloat(waarde.replace(/[^0-9.]/g, '')) || 0;
      return nummer;
    }
    
    let totaleDikte = 0;
    
    // Parse glasopbouw string
    // Voorbeelden: "4-spouw-*4", "33.1-spouw-*4", "4*-spouw-4-spouw-*4"
    
    if (glasOpbouw.includes('*-spouw-') && glasOpbouw.includes('-spouw-*')) {
      // Trippel glas: "4*-spouw-4-spouw-*4"
      const delen = glasOpbouw.split('-spouw-');
      if (delen.length >= 3) {
        // Eerste ruit (bijv. "4*")
        const eersteRuit = delen[0].replace('*', '');
        totaleDikte += getGlasDikte(eersteRuit);
        // Eerste spouw
        totaleDikte += spouwDikte;
        // Middelste ruit (bijv. "4")
        totaleDikte += getGlasDikte(delen[1]);
        // Tweede spouw
        totaleDikte += spouwDikte;
        // Laatste ruit (bijv. "*4")
        const laatsteRuit = delen[2].replace('*', '');
        totaleDikte += getGlasDikte(laatsteRuit);
      }
    } else if (glasOpbouw.includes('-spouw-')) {
      // Dubbel glas: "4-spouw-*4" of "33.1-spouw-*4"
      const delen = glasOpbouw.split('-spouw-');
      if (delen.length >= 2) {
        // Eerste ruit
        const eersteRuit = delen[0];
        totaleDikte += getGlasDikte(eersteRuit);
        // Spouw
        totaleDikte += spouwDikte;
        // Tweede ruit (bijv. "*4" of "*33.1")
        const tweedeRuit = delen[1].replace('*', '');
        totaleDikte += getGlasDikte(tweedeRuit);
      }
    } else if (glasOpbouw.endsWith('mm')) {
      // Enkel glas: "4mm", "5mm", etc.
      totaleDikte = getGlasDikte(glasOpbouw);
    } else {
      // Andere formaten (bijv. "33.1_gelaagd")
      totaleDikte = getGlasDikte(glasOpbouw);
    }
    
    return totaleDikte > 0 ? totaleDikte : null;
  }

  // Functie om U-waarde te berekenen op basis van glas type en spouw
  function berekenUWaarde(glasType, spouwWaarde) {
    if (!glasType) return null;
    
    // Converteer spouw waarde naar nummer (bijv. "6mm" -> 6)
    const spouwDikte = spouwWaarde ? parseFloat(spouwWaarde.replace('mm', '')) : 0;
    
    // U-waarden op basis van glas type en spouw dikte
    if (glasType === 'enkel') {
      return 5.8; // Enkel glas: ~5.8 W/m¬≤K
    } else if (glasType === 'dubbel') {
      // Dubbel glas (HR+): U-waarde afhankelijk van spouw dikte
      if (spouwDikte >= 13) {
        return 1.2; // HR++ met spouw 13mm+: ~1.2 W/m¬≤K
      } else if (spouwDikte >= 12) {
        return 1.3; // HR++ met spouw 12mm: ~1.3 W/m¬≤K
      } else if (spouwDikte >= 10) {
        return 1.4; // HR+ met spouw 10mm: ~1.4 W/m¬≤K
      } else if (spouwDikte >= 8) {
        return 1.5; // HR+ met spouw 8mm: ~1.5 W/m¬≤K
      } else {
        return 1.6; // HR+ met spouw 6mm: ~1.6 W/m¬≤K
      }
    } else if (glasType === 'trippel') {
      // Trippel glas (HR+++): U-waarde afhankelijk van spouw dikte
      if (spouwDikte >= 15) {
        return 0.6; // HR+++ met spouw 15mm+: ~0.6 W/m¬≤K
      } else if (spouwDikte >= 14) {
        return 0.65; // HR+++ met spouw 14mm: ~0.65 W/m¬≤K
      } else if (spouwDikte >= 13) {
        return 0.7; // HR+++ met spouw 13mm: ~0.7 W/m¬≤K
      } else if (spouwDikte >= 12) {
        return 0.75; // HR+++ met spouw 12mm: ~0.75 W/m¬≤K
      } else if (spouwDikte >= 10) {
        return 0.8; // HR+++ met spouw 10mm: ~0.8 W/m¬≤K
      } else {
        return 0.85; // HR+++ met spouw 8mm: ~0.85 W/m¬≤K
      }
    }
    
    return null;
  }

  // Functie om glas preview te updaten
  function updateGlasPreview() {
    // Zoek elementen op de juiste pagina (productPaginaGlas of algemeen)
    const productPaginaGlas = document.getElementById('productPaginaGlas');
    let glasBreedteInput = null;
    let glasHoogteInput = null;
    let glasTypeSelect = null;
    let glasRoosterSelect = null;
    let glasAantalInput = null;
    let glasOpbouwSelect = null;
    let glasSpouwSelect = null;
    
    // Als we op de glas product pagina zijn, gebruik die elementen
    if (productPaginaGlas && productPaginaGlas.classList.contains('active')) {
      glasBreedteInput = productPaginaGlas.querySelector('#glasBreedte');
      glasHoogteInput = productPaginaGlas.querySelector('#glasHoogte');
      glasTypeSelect = productPaginaGlas.querySelector('#glasTypeLos');
      glasRoosterSelect = productPaginaGlas.querySelector('#glasRooster');
      glasAantalInput = productPaginaGlas.querySelector('#glasAantal');
      glasOpbouwSelect = productPaginaGlas.querySelector('#glasOpbouw');
      glasSpouwSelect = productPaginaGlas.querySelector('#glasSpouw');
    } else {
      // Anders probeer de algemene elementen
      glasBreedteInput = document.getElementById('glasBreedte');
      glasHoogteInput = document.getElementById('glasHoogte');
      glasTypeSelect = document.getElementById('glasTypeLos');
      glasRoosterSelect = document.getElementById('glasRooster');
      glasAantalInput = document.getElementById('glasAantal');
      glasOpbouwSelect = document.getElementById('glasOpbouw');
      glasSpouwSelect = document.getElementById('glasSpouw');
    }
    
    const breedte = parseInt(glasBreedteInput?.value) || 1000;
    const hoogte = parseInt(glasHoogteInput?.value) || 1000;
    const glasType = glasTypeSelect?.value || 'enkel';
    const rooster = glasRoosterSelect?.value || '';
    const aantal = parseInt(glasAantalInput?.value) || 1;
    
    // Update glasopbouw menu zichtbaarheid
    updateGlasOpbouwMenu();
    
    const oppervlakteM2 = (breedte / 1000) * (hoogte / 1000);
    const glasOpbouw = glasOpbouwSelect?.value || '';
    const spouwWaarde = glasSpouwSelect?.value || '';
    const basisPrijs = berekenGlasPrijs(breedte, hoogte, glasType, glasOpbouw);
    const totaalPrijs = basisPrijs * aantal;
    
    const glasTypeLabels = {
      'enkel': 'Enkel glas',
      'hr+': 'HR+',
      'hr++': 'HR++',
      'hr+++': 'HR+++'
    };
    
    // Update preview info
    const afmetingenEl = document.getElementById('glasAfmetingen');
    const oppervlakteEl = document.getElementById('glasOppervlakte');
    const glasTypeDisplayEl = document.getElementById('glasTypeDisplay');
    const glasOpbouwDisplayEl = document.getElementById('glasOpbouwDisplay');
    const glasOpbouwDisplayItem = document.getElementById('glasOpbouwDisplayItem');
    const glasSpouwDisplayEl = document.getElementById('glasSpouwDisplay');
    const glasSpouwDisplayItem = document.getElementById('glasSpouwDisplayItem');
    const glasDikteDisplayEl = document.getElementById('glasDikteDisplay');
    const glasDikteDisplayItem = document.getElementById('glasDikteDisplayItem');
    const glasUWaardeDisplayEl = document.getElementById('glasUWaardeDisplay');
    const glasUWaardeDisplayItem = document.getElementById('glasUWaardeDisplayItem');
    const glasAantalDisplayEl = document.getElementById('glasAantalDisplay');
    const glasPrijsEl = document.getElementById('glasPrijs');
    
    if (afmetingenEl) afmetingenEl.textContent = `${breedte} √ó ${hoogte} mm`;
    if (oppervlakteEl) oppervlakteEl.textContent = `${oppervlakteM2.toFixed(2)} m¬≤`;
    if (glasTypeDisplayEl) glasTypeDisplayEl.textContent = glasTypeLabels[glasType] || glasType;
    
    // Bereken en toon totale dikte
    const totaleDikte = berekenGlasDikte(glasOpbouw, spouwWaarde, glasType);
    if (totaleDikte) {
      if (glasDikteDisplayEl) glasDikteDisplayEl.textContent = `${totaleDikte.toFixed(1)} mm`;
      if (glasDikteDisplayItem) glasDikteDisplayItem.style.display = 'flex';
    } else {
      if (glasDikteDisplayItem) glasDikteDisplayItem.style.display = 'none';
    }
    
    // Bereken en toon U-waarde
    const uWaarde = berekenUWaarde(glasType, spouwWaarde);
    if (uWaarde) {
      if (glasUWaardeDisplayEl) glasUWaardeDisplayEl.textContent = `${uWaarde.toFixed(2)} W/m¬≤K`;
      if (glasUWaardeDisplayItem) glasUWaardeDisplayItem.style.display = 'flex';
    } else {
      if (glasUWaardeDisplayItem) glasUWaardeDisplayItem.style.display = 'none';
    }
    
    // Mapping van nieuwe glas type waarden naar JSON keys
    // Controleer eerst of de nieuwe keys bestaan, anders gebruik oude keys als fallback
    let jsonKey = glasType;
    if (glasType === 'dubbel') {
      if (glasOpbouwData && glasOpbouwData['Dubbel glas']) {
        jsonKey = 'Dubbel glas';
      } else if (glasOpbouwData && glasOpbouwData['hr+']) {
        jsonKey = 'hr+';
      }
    } else if (glasType === 'trippel') {
      if (glasOpbouwData && glasOpbouwData['Trippel glas']) {
        jsonKey = 'Trippel glas';
      } else if (glasOpbouwData && glasOpbouwData['hr++']) {
        jsonKey = 'hr++';
      }
    }
    
    // Toon glasopbouw alleen als er een waarde is en het menu zichtbaar is
    if (glasOpbouw && (glasType === 'enkel' || glasType === 'dubbel' || glasType === 'trippel')) {
      // Haal label op vanuit JSON data
      let glasOpbouwLabel = glasOpbouw;
      if (glasOpbouwData) {
        const typeData = glasOpbouwData[jsonKey];
        if (typeData && typeData.opties) {
          const optie = typeData.opties.find(opt => opt.value === glasOpbouw);
          if (optie) {
            glasOpbouwLabel = optie.label;
          }
        }
      }
      if (glasOpbouwDisplayEl) {
        glasOpbouwDisplayEl.textContent = glasOpbouwLabel;
      }
      if (glasOpbouwDisplayItem) {
        glasOpbouwDisplayItem.style.display = 'flex';
      }
    } else {
      if (glasOpbouwDisplayItem) glasOpbouwDisplayItem.style.display = 'none';
    }
    
    // Toon spouw waarde als deze is geselecteerd
    if (spouwWaarde && (glasType === 'dubbel' || glasType === 'trippel')) {
      // Haal label op van de geselecteerde spouw optie
      let spouwLabel = spouwWaarde;
      if (glasSpouwSelect) {
        const selectedOption = glasSpouwSelect.options[glasSpouwSelect.selectedIndex];
        if (selectedOption) {
          spouwLabel = selectedOption.textContent;
        }
      }
      if (glasSpouwDisplayEl) {
        glasSpouwDisplayEl.textContent = spouwLabel;
      }
      if (glasSpouwDisplayItem) {
        glasSpouwDisplayItem.style.display = 'flex';
      }
    } else {
      if (glasSpouwDisplayItem) glasSpouwDisplayItem.style.display = 'none';
    }
    
    if (glasAantalDisplayEl) glasAantalDisplayEl.textContent = aantal;
    if (glasPrijsEl) glasPrijsEl.textContent = `‚Ç¨${totaalPrijs.toFixed(2)}`;
    
    // Update tekening
    tekenGlasTekening(breedte, hoogte, rooster);
  }

  // Functie om raam preview te updaten
  function updateRaamPreview() {
    const breedte = parseInt(document.getElementById('raamBreedte')?.value) || 1000;
    const hoogte = parseInt(document.getElementById('raamHoogte')?.value) || 1000;
    const raamType = document.getElementById('raamTypeLos')?.value || 'draairaam_buiten';
    const draairichting = document.getElementById('raamDraairichting')?.value || 'links';
    const glasType = document.getElementById('raamGlasType')?.value || 'enkel';
    const aantal = parseInt(document.getElementById('raamAantal')?.value) || 1;
    
    const oppervlakteM2 = (breedte / 1000) * (hoogte / 1000);
    const basisPrijs = berekenRaamPrijs(breedte, hoogte, glasType);
    const totaalPrijs = basisPrijs * aantal;
    
    const raamTypeLabels = {
      'draairaam_buiten': 'Draairaam naar buiten',
      'draairaam_binnen': 'Draairaam naar binnen',
      'stolpraam_buiten': 'Stolpraam buitendraaiend',
      'stolpraam_binnen': 'Stolpraam binnendraaiend',
      'draaikiep': 'Draaikiep raam',
      'kiep': 'Kiep raam',
      'vast': 'Vast raam'
    };
    const glasTypeLabels = {
      'enkel': 'Enkel glas',
      'hr+': 'HR+',
      'hr++': 'HR++',
      'hr+++': 'HR+++'
    };
    const draairichtingLabels = {
      'links': 'Links draaiend',
      'rechts': 'Rechts draaiend',
      'actief': 'Actief'
    };
    
    // Update preview info
    const afmetingenEl = document.getElementById('raamAfmetingen');
    const oppervlakteEl = document.getElementById('raamOppervlakte');
    const raamTypeDisplayEl = document.getElementById('raamTypeDisplay');
    const raamDraairichtingDisplayEl = document.getElementById('raamDraairichtingDisplay');
    const raamGlasTypeDisplayEl = document.getElementById('raamGlasTypeDisplay');
    const raamAantalDisplayEl = document.getElementById('raamAantalDisplay');
    const raamPrijsEl = document.getElementById('raamPrijs');
    
    if (afmetingenEl) afmetingenEl.textContent = `${breedte} √ó ${hoogte} mm`;
    if (oppervlakteEl) oppervlakteEl.textContent = `${oppervlakteM2.toFixed(2)} m¬≤`;
    if (raamTypeDisplayEl) raamTypeDisplayEl.textContent = raamTypeLabels[raamType] || raamType;
    if (raamDraairichtingDisplayEl) raamDraairichtingDisplayEl.textContent = draairichtingLabels[draairichting] || draairichting;
    if (raamGlasTypeDisplayEl) raamGlasTypeDisplayEl.textContent = glasTypeLabels[glasType] || glasType;
    if (raamAantalDisplayEl) raamAantalDisplayEl.textContent = aantal;
    if (raamPrijsEl) raamPrijsEl.textContent = `‚Ç¨${totaalPrijs.toFixed(2)}`;
  }

  // Functie om deur preview te updaten
  function updateDeurPreview() {
    const breedte = parseInt(document.getElementById('deurBreedte')?.value) || 900;
    const hoogte = parseInt(document.getElementById('deurHoogte')?.value) || 2100;
    const deurType = document.getElementById('deurTypeLos')?.value || 'dichte_deur';
    const draairichting = document.getElementById('deurDraairichting')?.value || 'links';
    const glasType = document.getElementById('deurGlasType')?.value || 'enkel';
    const aantal = parseInt(document.getElementById('deurAantal')?.value) || 1;
    
    const oppervlakteM2 = (breedte / 1000) * (hoogte / 1000);
    const basisPrijs = berekenDeurPrijs(breedte, hoogte, glasType);
    const totaalPrijs = basisPrijs * aantal;
    
    const deurTypeLabels = {
      'dichte_deur': 'Dichte deur',
      'deur_met_raam': 'Deur met raam',
      'stolpdeur_buitendraaiend': 'Stolpdeur buitendraaiend',
      'stolpdeur_binnendraaiend': 'Stolpdeur binnendraaiend'
    };
    const glasTypeLabels = {
      'enkel': 'Enkel glas',
      'hr+': 'HR+',
      'hr++': 'HR++',
      'hr+++': 'HR+++'
    };
    const draairichtingLabels = {
      'links': 'Links draaiend',
      'rechts': 'Rechts draaiend',
      'actief': 'Actief'
    };
    
    // Update preview info
    const afmetingenEl = document.getElementById('deurAfmetingen');
    const oppervlakteEl = document.getElementById('deurOppervlakte');
    const deurTypeDisplayEl = document.getElementById('deurTypeDisplay');
    const deurDraairichtingDisplayEl = document.getElementById('deurDraairichtingDisplay');
    const deurGlasTypeDisplayEl = document.getElementById('deurGlasTypeDisplay');
    const deurAantalDisplayEl = document.getElementById('deurAantalDisplay');
    const deurPrijsEl = document.getElementById('deurPrijs');
    
    if (afmetingenEl) afmetingenEl.textContent = `${breedte} √ó ${hoogte} mm`;
    if (oppervlakteEl) oppervlakteEl.textContent = `${oppervlakteM2.toFixed(2)} m¬≤`;
    if (deurTypeDisplayEl) deurTypeDisplayEl.textContent = deurTypeLabels[deurType] || deurType;
    if (deurDraairichtingDisplayEl) deurDraairichtingDisplayEl.textContent = draairichtingLabels[draairichting] || draairichting;
    if (deurGlasTypeDisplayEl) deurGlasTypeDisplayEl.textContent = glasTypeLabels[glasType] || glasType;
    if (deurAantalDisplayEl) deurAantalDisplayEl.textContent = aantal;
    if (deurPrijsEl) deurPrijsEl.textContent = `‚Ç¨${totaalPrijs.toFixed(2)}`;
  }

  // Event listeners voor glas inputs - gebruik event delegation voor betere compatibiliteit
  document.addEventListener('change', (e) => {
    if (e.target.id === 'glasTypeLos') {
      updateGlasOpbouwMenu();
      updateGlasPreview();
    } else if (e.target.id === 'glasOpbouw' || e.target.id === 'glasRooster' || e.target.id === 'glasSpouw') {
      updateGlasPreview();
    }
  });
  
  document.addEventListener('input', (e) => {
    if (e.target.id === 'glasBreedte' || e.target.id === 'glasHoogte' || e.target.id === 'glasAantal') {
      updateGlasPreview();
    }
  });
  
  // Ook direct event listeners toevoegen voor backward compatibility
  const glasBreedteInput = document.getElementById('glasBreedte');
  const glasHoogteInput = document.getElementById('glasHoogte');
  const glasSpouwSelect = document.getElementById('glasSpouw');
  const glasTypeSelect = document.getElementById('glasTypeLos');
  const glasOpbouwSelect = document.getElementById('glasOpbouw');
  const glasRoosterSelect = document.getElementById('glasRooster');
  const glasAantalInput = document.getElementById('glasAantal');
  
  if (glasBreedteInput) glasBreedteInput.addEventListener('input', updateGlasPreview);
  if (glasHoogteInput) glasHoogteInput.addEventListener('input', updateGlasPreview);
  if (glasSpouwSelect) glasSpouwSelect.addEventListener('change', updateGlasPreview);
  if (glasTypeSelect) {
    glasTypeSelect.addEventListener('change', () => {
      updateGlasOpbouwMenu();
      updateGlasPreview();
      // Zet event listeners opnieuw na het updaten van menu's
      setTimeout(() => {
        const productPaginaGlas = document.getElementById('productPaginaGlas');
        let glasOpbouwSelectNew = null;
        let glasSpouwSelectNew = null;
        
        if (productPaginaGlas && productPaginaGlas.classList.contains('active')) {
          glasOpbouwSelectNew = productPaginaGlas.querySelector('#glasOpbouw');
          glasSpouwSelectNew = productPaginaGlas.querySelector('#glasSpouw');
        } else {
          glasOpbouwSelectNew = document.getElementById('glasOpbouw');
          glasSpouwSelectNew = document.getElementById('glasSpouw');
        }
        
        if (glasOpbouwSelectNew) {
          glasOpbouwSelectNew.removeEventListener('change', updateGlasPreview);
          glasOpbouwSelectNew.addEventListener('change', updateGlasPreview);
        }
        if (glasSpouwSelectNew) {
          glasSpouwSelectNew.removeEventListener('change', updateGlasPreview);
          glasSpouwSelectNew.addEventListener('change', updateGlasPreview);
        }
      }, 100);
    });
  }
  if (glasOpbouwSelect) glasOpbouwSelect.addEventListener('change', updateGlasPreview);
  if (glasRoosterSelect) glasRoosterSelect.addEventListener('change', updateGlasPreview);
  if (glasAantalInput) glasAantalInput.addEventListener('input', updateGlasPreview);

  // Event listeners voor raam inputs
  const raamBreedteInput = document.getElementById('raamBreedte');
  const raamHoogteInput = document.getElementById('raamHoogte');
  const raamTypeSelect = document.getElementById('raamTypeLos');
  const raamDraairichtingSelect = document.getElementById('raamDraairichting');
  const raamGlasTypeSelect = document.getElementById('raamGlasType');
  const raamAantalInput = document.getElementById('raamAantal');
  
  if (raamBreedteInput) raamBreedteInput.addEventListener('input', updateRaamPreview);
  if (raamHoogteInput) raamHoogteInput.addEventListener('input', updateRaamPreview);
  if (raamTypeSelect) raamTypeSelect.addEventListener('change', updateRaamPreview);
  if (raamDraairichtingSelect) raamDraairichtingSelect.addEventListener('change', updateRaamPreview);
  if (raamGlasTypeSelect) raamGlasTypeSelect.addEventListener('change', updateRaamPreview);
  if (raamAantalInput) raamAantalInput.addEventListener('input', updateRaamPreview);

  // Event listeners voor deur inputs
  const deurBreedteInput = document.getElementById('deurBreedte');
  const deurHoogteInput = document.getElementById('deurHoogte');
  const deurTypeSelect = document.getElementById('deurTypeLos');
  const deurDraairichtingSelect = document.getElementById('deurDraairichting');
  const deurGlasTypeSelect = document.getElementById('deurGlasType');
  const deurAantalInput = document.getElementById('deurAantal');
  
  if (deurBreedteInput) deurBreedteInput.addEventListener('input', updateDeurPreview);
  if (deurHoogteInput) deurHoogteInput.addEventListener('input', updateDeurPreview);
  if (deurTypeSelect) deurTypeSelect.addEventListener('change', updateDeurPreview);
  if (deurDraairichtingSelect) deurDraairichtingSelect.addEventListener('change', updateDeurPreview);
  if (deurGlasTypeSelect) deurGlasTypeSelect.addEventListener('change', updateDeurPreview);
  if (deurAantalInput) deurAantalInput.addEventListener('input', updateDeurPreview);

  // Laad glas en rooster data bij page load
  laadGlasEnRoosterData().then(() => {
    // Initialiseer preview bij page load
    if (previewGlas && previewGlas.style.display !== 'none') {
      updateGlasPreview();
    }
    
    // Initialiseer glasopbouw menu bij page load
    updateGlasOpbouwMenu();
    
    // Initialiseer spouw menu bij page load
    updateSpouwMenu();
    
    // Initialiseer spacer menu bij page load
    updateSpacerMenu();
    
    // Initialiseer rooster opties bij page load
    updateRoosterOpties();
    
    // Zet event listeners opnieuw na het laden van menu's
    setTimeout(() => {
      const productPaginaGlas = document.getElementById('productPaginaGlas');
      let glasOpbouwSelectNew = null;
      let glasSpouwSelectNew = null;
      
      if (productPaginaGlas && productPaginaGlas.classList.contains('active')) {
        glasOpbouwSelectNew = productPaginaGlas.querySelector('#glasOpbouw');
        glasSpouwSelectNew = productPaginaGlas.querySelector('#glasSpouw');
      } else {
        glasOpbouwSelectNew = document.getElementById('glasOpbouw');
        glasSpouwSelectNew = document.getElementById('glasSpouw');
      }
      
      if (glasOpbouwSelectNew) {
        glasOpbouwSelectNew.removeEventListener('change', updateGlasPreview);
        glasOpbouwSelectNew.addEventListener('change', () => {
          console.log('Glasopbouw gewijzigd:', glasOpbouwSelectNew.value);
          updateGlasPreview();
        });
      }
      if (glasSpouwSelectNew) {
        glasSpouwSelectNew.removeEventListener('change', updateGlasPreview);
        glasSpouwSelectNew.addEventListener('change', () => {
          console.log('Spouw gewijzigd:', glasSpouwSelectNew.value);
          updateGlasPreview();
        });
      }
    }, 200);
  });

  // Laad SVG iconen bij page load
  loadSvgIcons();

  // Start
  draw();
  
  // Initialiseer prijs overzicht
  updatePrijsOverzicht();
  
  // Initialiseer winkelwagen badge
  updateWinkelwagenBadge();
  
  // Event listeners voor aantal input velden
  const aantalGetekendInput = document.getElementById('aantalGetekend');
  const aantalGespiegeldInput = document.getElementById('aantalGespiegeld');
  
  if (aantalGetekendInput) {
    aantalGetekendInput.addEventListener('input', () => {
      updatePrijsOverzicht();
    });
    aantalGetekendInput.addEventListener('change', () => {
      updatePrijsOverzicht();
    });
  }
  
  if (aantalGespiegeldInput) {
    aantalGespiegeldInput.addEventListener('input', () => {
      updatePrijsOverzicht();
    });
    aantalGespiegeldInput.addEventListener('change', () => {
      updatePrijsOverzicht();
    });
  }

  // Foto upload functionaliteit
  let huidigeFotoBuitenkant = null;
  let huidigeFotoBinnenkant = null;
  
  // Buitenkant foto
  if (btnUploadFotoBuitenkant) {
    btnUploadFotoBuitenkant.addEventListener('click', () => {
      fotoUploadBuitenkant.click();
    });
  }

  if (fotoUploadBuitenkant) {
    fotoUploadBuitenkant.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          huidigeFotoBuitenkant = event.target.result;
          fotoPreviewImgBuitenkant.src = huidigeFotoBuitenkant;
          fotoPreviewBuitenkant.style.display = 'block';
          btnVerwijderFotoBuitenkant.style.display = 'block';
          // Verberg de upload knop als er een foto is
          if (btnUploadFotoBuitenkant) {
            btnUploadFotoBuitenkant.style.display = 'none';
          }
          // Voeg click event toe om foto in modal te tonen
          fotoPreviewImgBuitenkant.onclick = () => {
            fotoModalImg.src = huidigeFotoBuitenkant;
            fotoModal.classList.add('active');
          };
        };
        reader.readAsDataURL(file);
      }
    });
  }

  if (btnVerwijderFotoBuitenkant) {
    btnVerwijderFotoBuitenkant.addEventListener('click', () => {
      huidigeFotoBuitenkant = null;
      fotoPreviewImgBuitenkant.src = '';
      fotoPreviewBuitenkant.style.display = 'none';
      btnVerwijderFotoBuitenkant.style.display = 'none';
      fotoUploadBuitenkant.value = '';
      // Toon de upload knop weer als de foto is verwijderd
      if (btnUploadFotoBuitenkant) {
        btnUploadFotoBuitenkant.style.display = 'block';
      }
    });
  }

  // Binnenkant foto
  if (btnUploadFotoBinnenkant) {
    btnUploadFotoBinnenkant.addEventListener('click', () => {
      fotoUploadBinnenkant.click();
    });
  }

  if (fotoUploadBinnenkant) {
    fotoUploadBinnenkant.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          huidigeFotoBinnenkant = event.target.result;
          fotoPreviewImgBinnenkant.src = huidigeFotoBinnenkant;
          fotoPreviewBinnenkant.style.display = 'block';
          btnVerwijderFotoBinnenkant.style.display = 'block';
          // Verberg de upload knop als er een foto is
          if (btnUploadFotoBinnenkant) {
            btnUploadFotoBinnenkant.style.display = 'none';
          }
          // Voeg click event toe om foto in modal te tonen
          fotoPreviewImgBinnenkant.onclick = () => {
            fotoModalImg.src = huidigeFotoBinnenkant;
            fotoModal.classList.add('active');
          };
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // Sluit foto modal
  if (fotoModalClose) {
    fotoModalClose.addEventListener('click', () => {
      fotoModal.classList.remove('active');
    });
  }

  // Sluit modal bij klikken op achtergrond
  if (fotoModal) {
    fotoModal.addEventListener('click', (e) => {
      if (e.target === fotoModal) {
        fotoModal.classList.remove('active');
      }
    });
  }

  if (btnVerwijderFotoBinnenkant) {
    btnVerwijderFotoBinnenkant.addEventListener('click', () => {
      huidigeFotoBinnenkant = null;
      fotoPreviewImgBinnenkant.src = '';
      fotoPreviewBinnenkant.style.display = 'none';
      btnVerwijderFotoBinnenkant.style.display = 'none';
      fotoUploadBinnenkant.value = '';
      // Toon de upload knop weer als de foto is verwijderd
      if (btnUploadFotoBinnenkant) {
        btnUploadFotoBinnenkant.style.display = 'block';
      }
    });
  }

  // Functie om lijnen te detecteren uit een foto
  function detecteerLijnenUitFoto(fotoSrc) {
    const img = new Image();
    img.onload = () => {
      // Pas canvas aan op foto grootte
      const maxSize = 800; // Max breedte/hoogte voor processing
      let width = img.width;
      let height = img.height;
      
      if (width > maxSize || height > maxSize) {
        const scale = maxSize / Math.max(width, height);
        width = Math.floor(width * scale);
        height = Math.floor(height * scale);
      }
      
      processingCanvas.width = width;
      processingCanvas.height = height;
      
      // Teken foto op canvas
      processingCtx.drawImage(img, 0, 0, width, height);
      
      // Bewaar originele image data voor kleur detectie
      const imageData = processingCtx.getImageData(0, 0, width, height);
      
      // Converteer naar grijswaarden
      let grayData = converteerNaarGrijs(imageData);
      
      // Verhoog contrast voor betere edge detection
      grayData = verhoogContrast(grayData, width, height, 1.3);
      
      // Gaussian blur voor ruis reductie (minder blur voor scherpere lijnen)
      const blurredData = gaussianBlur(grayData, width, height, 2);
      
      // Edge detection (Sobel filter) met hogere threshold
      const edges = sobelEdgeDetection(blurredData, width, height);
      
      // Detecteer verticale en horizontale lijnen met breedte en kleur filtering
      // Schat de pixel/mm ratio op basis van foto grootte en kozijn afmetingen
      const geschattePixelPerMm = Math.max(width / state.Wmm, height / state.Hmm);
      const minBreedtePixels = 20 * geschattePixelPerMm; // 20mm minimum breedte voor kozijn stijlen/dorpels
      const maxVoegBreedtePixels = 10 * geschattePixelPerMm; // 10mm maximum voor voegen
      
      const verticaleLijnen = detecteerVerticaleLijnenMetBreedte(edges, imageData, width, height, minBreedtePixels, maxVoegBreedtePixels);
      const horizontaleLijnen = detecteerHorizontaleLijnenMetBreedte(edges, imageData, width, height, minBreedtePixels, maxVoegBreedtePixels);
      
      // Converteer naar kozijn co√∂rdinaten (mm)
      const kozijnBreedte = state.Wmm;
      const kozijnHoogte = state.Hmm;
      const frame = state.frameDikte;
      const tussen = state.tussenDikte;
      const halfTussen = tussen / 2;
      const bovendorpelY = frame;
      const onderdorpelDikte = state.ekosietOnderdorpel ? 52 : frame;
      const halfOnderdorpel = onderdorpelDikte / 2;
      const onderdorpelY = kozijnHoogte - halfOnderdorpel;
      const bovendorpelRand = bovendorpelY + frame / 2;
      const onderdorpelRand = onderdorpelY - halfOnderdorpel;
      const linkerStijlRand = frame;
      const rechterStijlRand = kozijnBreedte - frame;
      
      // Reset bestaande lijnen
      state.tussenStijlen = [];
      state.tussenDorpels = [];
      
      // Filter baksteen voegen en andere ruis
      // Baksteen voegen zijn meestal veel dichter bij elkaar dan kozijn lijnen
      const gefilterdeVerticaleLijnen = filterBaksteenVoegen(verticaleLijnen, width, height);
      const gefilterdeHorizontaleLijnen = filterBaksteenVoegen(horizontaleLijnen, height, width);
      
      // Filter en converteer verticale lijnen naar tussenStijlen
      // Behoud alleen de belangrijkste lijnen (max 10, verdeeld over de breedte)
      const finaleVerticaleLijnen = filterBelangrijksteLijnen(gefilterdeVerticaleLijnen, width, 10);
      
      finaleVerticaleLijnen.forEach(x => {
        // Converteer x van pixel naar mm
        const xMm = (x / width) * kozijnBreedte;
        
        // Filter lijnen die te dicht bij de randen zijn
        if (xMm > linkerStijlRand + 50 && xMm < rechterStijlRand - 50) {
          state.tussenStijlen.push({
            x1: xMm,
            y1: bovendorpelRand,
            x2: xMm,
            y2: onderdorpelRand
          });
        }
      });
      
      // Filter en converteer horizontale lijnen naar tussenDorpels
      // Behoud alleen de belangrijkste lijnen (max 8, verdeeld over de hoogte)
      const finaleHorizontaleLijnen = filterBelangrijksteLijnen(gefilterdeHorizontaleLijnen, height, 8);
      
      finaleHorizontaleLijnen.forEach(y => {
        // Converteer y van pixel naar mm
        const yMm = (y / height) * kozijnHoogte;
        
        // Filter lijnen die te dicht bij de randen zijn
        if (yMm > bovendorpelRand + 50 && yMm < onderdorpelRand - 50) {
          state.tussenDorpels.push({
            x1: linkerStijlRand,
            y1: yMm,
            x2: rechterStijlRand,
            y2: yMm
          });
        }
      });
      
      // Split automatisch alle dorpels en stijlen bij kruispunten
      splitAlleDorpelsEnStijlen();
      
      // Teken opnieuw
      draw();
      
      // Detecteer vakken
      detecteerVakken();
      toonVakken();
      
      alert(`Gedetecteerd: ${state.tussenStijlen.length} tussenstijlen en ${state.tussenDorpels.length} tussendorpels`);
    };
    img.src = fotoSrc;
  }

  // Converteer RGB naar grijswaarden
  function converteerNaarGrijs(imageData) {
    const data = imageData.data;
    const grayData = new Uint8ClampedArray(imageData.width * imageData.height);
    
    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];
      // Gebruik luminance formule
      grayData[i / 4] = Math.floor(0.299 * r + 0.587 * g + 0.114 * b);
    }
    
    return grayData;
  }

  // Verhoog contrast van grijswaarden afbeelding
  function verhoogContrast(grayData, width, height, factor) {
    const result = new Uint8ClampedArray(width * height);
    
    // Bereken gemiddelde waarde
    let som = 0;
    for (let i = 0; i < grayData.length; i++) {
      som += grayData[i];
    }
    const gemiddelde = som / grayData.length;
    
    // Pas contrast toe
    for (let i = 0; i < grayData.length; i++) {
      const waarde = grayData[i];
      // Trek gemiddelde af, vermenigvuldig met factor, tel gemiddelde weer op
      const nieuweWaarde = (waarde - gemiddelde) * factor + gemiddelde;
      // Clamp tussen 0 en 255
      result[i] = Math.max(0, Math.min(255, Math.round(nieuweWaarde)));
    }
    
    return result;
  }

  // Gaussian blur voor ruis reductie
  function gaussianBlur(grayData, width, height, radius) {
    const result = new Uint8ClampedArray(width * height);
    const sigma = radius / 3;
    const kernelSize = radius * 2 + 1;
    const kernel = [];
    let sum = 0;
    
    // Maak Gaussian kernel
    for (let i = -radius; i <= radius; i++) {
      const value = Math.exp(-(i * i) / (2 * sigma * sigma));
      kernel.push(value);
      sum += value;
    }
    
    // Normaliseer kernel
    for (let i = 0; i < kernel.length; i++) {
      kernel[i] /= sum;
    }
    
    // Horizontale blur
    const temp = new Uint8ClampedArray(width * height);
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        let value = 0;
        for (let k = -radius; k <= radius; k++) {
          const px = Math.max(0, Math.min(width - 1, x + k));
          value += grayData[y * width + px] * kernel[k + radius];
        }
        temp[y * width + x] = Math.round(value);
      }
    }
    
    // Verticale blur
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        let value = 0;
        for (let k = -radius; k <= radius; k++) {
          const py = Math.max(0, Math.min(height - 1, y + k));
          value += temp[py * width + x] * kernel[k + radius];
        }
        result[y * width + x] = Math.round(value);
      }
    }
    
    return result;
  }

  // Sobel edge detection met hogere threshold
  function sobelEdgeDetection(grayData, width, height) {
    const edges = new Uint8ClampedArray(width * height);
    const sobelX = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
    const sobelY = [-1, -2, -1, 0, 0, 0, 1, 2, 1];
    
    // Bereken magnitude voor alle pixels eerst
    const magnitudes = new Float32Array(width * height);
    let maxMagnitude = 0;
    
    for (let y = 1; y < height - 1; y++) {
      for (let x = 1; x < width - 1; x++) {
        let gx = 0, gy = 0;
        
        for (let ky = -1; ky <= 1; ky++) {
          for (let kx = -1; kx <= 1; kx++) {
            const idx = (y + ky) * width + (x + kx);
            const kernelIdx = (ky + 1) * 3 + (kx + 1);
            gx += grayData[idx] * sobelX[kernelIdx];
            gy += grayData[idx] * sobelY[kernelIdx];
          }
        }
        
        const magnitude = Math.sqrt(gx * gx + gy * gy);
        magnitudes[y * width + x] = magnitude;
        maxMagnitude = Math.max(maxMagnitude, magnitude);
      }
    }
    
    // Gebruik adaptieve threshold (top 10% van magnitudes voor betere detectie van meer lijnen)
    const threshold = maxMagnitude * 0.10;
    
    for (let i = 0; i < magnitudes.length; i++) {
      edges[i] = magnitudes[i] > threshold ? 255 : 0;
    }
    
    return edges;
  }

  // Helper: Check of een kleur lijkt op een kozijn kleur
  function isKozijnKleur(r, g, b) {
    // Wit: hoge waarden voor alle kanalen
    if (r > 200 && g > 200 && b > 200) return true;
    
    // Antraciet: donkergrijs (rond 40-80)
    if (r > 20 && r < 100 && g > 20 && g < 100 && b > 20 && b < 100 && 
        Math.abs(r - g) < 30 && Math.abs(g - b) < 30) return true;
    
    // Zwart: zeer lage waarden
    if (r < 50 && g < 50 && b < 50) return true;
    
    // Groen: hoge groen waarde, lagere rood en blauw
    if (g > r + 30 && g > b + 30 && g > 80) return true;
    
    return false;
  }


  // Detecteer verticale lijnen met breedte en kleur filtering
  function detecteerVerticaleLijnenMetBreedte(edges, imageData, width, height, minBreedtePixels, maxVoegBreedtePixels) {
    const lijnen = [];
    const data = imageData.data;
    const minLengte = height * 0.4; // Minimum lengte van lijn (40% van hoogte)
    const minAfstand = width * 0.05; // Minimum afstand tussen lijnen (5% van breedte)
    
    // Scan voor verticale lijnen door te kijken naar edge clusters
    for (let x = 0; x < width; x++) {
      // Vind de breedte van de lijn op deze x-positie
      let linksX = x;
      let rechtsX = x;
      
      // Zoek naar de linker en rechter rand van de lijn
      while (linksX > 0) {
        let heeftEdge = false;
        for (let y = 0; y < height; y++) {
          const idx = y * width + linksX;
          if (edges[idx] > 0) {
            heeftEdge = true;
            break;
          }
        }
        if (!heeftEdge) break;
        linksX--;
      }
      
      while (rechtsX < width - 1) {
        let heeftEdge = false;
        for (let y = 0; y < height; y++) {
          const idx = y * width + rechtsX;
          if (edges[idx] > 0) {
            heeftEdge = true;
            break;
          }
        }
        if (!heeftEdge) break;
        rechtsX++;
      }
      
      const lijnBreedte = rechtsX - linksX;
      
      // Filter: alleen lijnen die minimaal 20mm breed zijn (niet voegen van 10mm)
      if (lijnBreedte < minBreedtePixels || lijnBreedte <= maxVoegBreedtePixels) {
        continue; // Skip voegen en te smalle lijnen
      }
      
      // Vind de verticale lengte van de lijn
      let startY = -1;
      let endY = -1;
      let edgeCount = 0;
      let kozijnKleurCount = 0;
      
      for (let y = 0; y < height; y++) {
        let heeftEdgeInLijn = false;
        for (let lx = linksX; lx <= rechtsX; lx++) {
          const idx = y * width + lx;
          if (edges[idx] > 0) {
            heeftEdgeInLijn = true;
            edgeCount++;
            
            // Check kleur rond deze edge
            const pixelIdx = (y * width + lx) * 4;
            const r = data[pixelIdx];
            const g = data[pixelIdx + 1];
            const b = data[pixelIdx + 2];
            if (isKozijnKleur(r, g, b)) {
              kozijnKleurCount++;
            }
            break;
          }
        }
        
        if (heeftEdgeInLijn) {
          if (startY === -1) startY = y;
          endY = y;
        }
      }
      
      const lengte = endY - startY;
      const kozijnKleurRatio = edgeCount > 0 ? kozijnKleurCount / edgeCount : 0;
      
      // Filter criteria:
      // - Lijn moet lang genoeg zijn
      // - Lijn moet breed genoeg zijn (al gecheckt)
      // - Lijn moet kozijn kleuren bevatten (minimaal 20% van de pixels voor betere detectie)
      if (lengte > minLengte && kozijnKleurRatio > 0.2) {
        const centerX = (linksX + rechtsX) / 2;
        lijnen.push({ 
          x: centerX, 
          breedte: lijnBreedte,
          strength: edgeCount,
          lengte: lengte,
          kozijnKleurRatio: kozijnKleurRatio
        });
      }
    }
    
    // Sorteer op sterkte (sterkste eerst)
    lijnen.sort((a, b) => b.strength - a.strength);
    
    // Groepeer lijnen die dicht bij elkaar liggen
    const gegroepeerdeLijnen = [];
    
    for (const lijn of lijnen) {
      const bestaandeGroep = gegroepeerdeLijnen.find(g => Math.abs(g.x - lijn.x) < minAfstand * 1.5);
      
      if (bestaandeGroep) {
        if (lijn.strength > bestaandeGroep.strength * 0.8) {
          const totaalStrength = bestaandeGroep.strength + lijn.strength;
          bestaandeGroep.x = (bestaandeGroep.x * bestaandeGroep.strength + lijn.x * lijn.strength) / totaalStrength;
          bestaandeGroep.strength = totaalStrength;
        }
      } else {
        gegroepeerdeLijnen.push({ x: lijn.x, strength: lijn.strength });
      }
    }
    
    gegroepeerdeLijnen.sort((a, b) => a.x - b.x);
    return gegroepeerdeLijnen.map(g => g.x);
  }

  // Detecteer horizontale lijnen met breedte en kleur filtering
  function detecteerHorizontaleLijnenMetBreedte(edges, imageData, width, height, minBreedtePixels, maxVoegBreedtePixels) {
    const lijnen = [];
    const data = imageData.data;
    const minLengte = width * 0.4; // Minimum lengte van lijn (40% van breedte)
    const minAfstand = height * 0.05; // Minimum afstand tussen lijnen (5% van hoogte)
    
    // Scan voor horizontale lijnen door te kijken naar edge clusters
    for (let y = 0; y < height; y++) {
      // Vind de breedte (hoogte) van de lijn op deze y-positie
      let bovenY = y;
      let onderY = y;
      
      // Zoek naar de boven en onder rand van de lijn
      while (bovenY > 0) {
        let heeftEdge = false;
        for (let x = 0; x < width; x++) {
          const idx = bovenY * width + x;
          if (edges[idx] > 0) {
            heeftEdge = true;
            break;
          }
        }
        if (!heeftEdge) break;
        bovenY--;
      }
      
      while (onderY < height - 1) {
        let heeftEdge = false;
        for (let x = 0; x < width; x++) {
          const idx = onderY * width + x;
          if (edges[idx] > 0) {
            heeftEdge = true;
            break;
          }
        }
        if (!heeftEdge) break;
        onderY++;
      }
      
      const lijnBreedte = onderY - bovenY;
      
      // Filter: alleen lijnen die minimaal 20mm breed zijn (niet voegen van 10mm)
      if (lijnBreedte < minBreedtePixels || lijnBreedte <= maxVoegBreedtePixels) {
        continue; // Skip voegen en te smalle lijnen
      }
      
      // Vind de horizontale lengte van de lijn
      let startX = -1;
      let endX = -1;
      let edgeCount = 0;
      let kozijnKleurCount = 0;
      
      for (let x = 0; x < width; x++) {
        let heeftEdgeInLijn = false;
        for (let ly = bovenY; ly <= onderY; ly++) {
          const idx = ly * width + x;
          if (edges[idx] > 0) {
            heeftEdgeInLijn = true;
            edgeCount++;
            
            // Check kleur rond deze edge
            const pixelIdx = (ly * width + x) * 4;
            const r = data[pixelIdx];
            const g = data[pixelIdx + 1];
            const b = data[pixelIdx + 2];
            if (isKozijnKleur(r, g, b)) {
              kozijnKleurCount++;
            }
            break;
          }
        }
        
        if (heeftEdgeInLijn) {
          if (startX === -1) startX = x;
          endX = x;
        }
      }
      
      const lengte = endX - startX;
      const kozijnKleurRatio = edgeCount > 0 ? kozijnKleurCount / edgeCount : 0;
      
      // Filter criteria:
      // - Lijn moet lang genoeg zijn
      // - Lijn moet breed genoeg zijn (al gecheckt)
      // - Lijn moet kozijn kleuren bevatten (minimaal 20% van de pixels voor betere detectie)
      if (lengte > minLengte && kozijnKleurRatio > 0.2) {
        const centerY = (bovenY + onderY) / 2;
        lijnen.push({ 
          y: centerY, 
          breedte: lijnBreedte,
          strength: edgeCount,
          lengte: lengte,
          kozijnKleurRatio: kozijnKleurRatio
        });
      }
    }
    
    // Sorteer op sterkte (sterkste eerst)
    lijnen.sort((a, b) => b.strength - a.strength);
    
    // Groepeer lijnen die dicht bij elkaar liggen
    const gegroepeerdeLijnen = [];
    
    for (const lijn of lijnen) {
      const bestaandeGroep = gegroepeerdeLijnen.find(g => Math.abs(g.y - lijn.y) < minAfstand * 1.5);
      
      if (bestaandeGroep) {
        if (lijn.strength > bestaandeGroep.strength * 0.8) {
          const totaalStrength = bestaandeGroep.strength + lijn.strength;
          bestaandeGroep.y = (bestaandeGroep.y * bestaandeGroep.strength + lijn.y * lijn.strength) / totaalStrength;
          bestaandeGroep.strength = totaalStrength;
        }
      } else {
        gegroepeerdeLijnen.push({ y: lijn.y, strength: lijn.strength });
      }
    }
    
    gegroepeerdeLijnen.sort((a, b) => a.y - b.y);
    return gegroepeerdeLijnen.map(g => g.y);
  }

  // Filter baksteen voegen en andere ruis
  // Baksteen voegen zijn meestal veel dichter bij elkaar dan kozijn lijnen
  function filterBaksteenVoegen(lijnen, primaireDimensie, secundaireDimensie) {
    if (lijnen.length === 0) {
      return [];
    }
    
    // Sorteer lijnen op positie
    const gesorteerdeLijnen = [...lijnen].sort((a, b) => a - b);
    
    // Baksteen voegen zijn meestal:
    // - Veel dichter bij elkaar (minder dan 3% van de primaire dimensie)
    // - Regelmatig verdeeld (bijna gelijke afstanden)
    // - Kozijn lijnen zijn meestal verder uit elkaar (meer dan 6% van de primaire dimensie)
    
    const gefilterdeLijnen = [];
    const minAfstandKozijn = primaireDimensie * 0.06; // Minimum afstand voor kozijn lijnen
    const maxAfstandBaksteen = primaireDimensie * 0.03; // Maximum afstand voor baksteen voegen
    
    // Focus op het centrale gebied waar het kozijn waarschijnlijk is (80% van de foto)
    const centraleStart = primaireDimensie * 0.1;
    const centraleEnd = primaireDimensie * 0.9;
    
    for (let i = 0; i < gesorteerdeLijnen.length; i++) {
      const huidigeLijn = gesorteerdeLijnen[i];
      
      // Check of de lijn in het centrale gebied ligt
      const isInCentraalGebied = huidigeLijn >= centraleStart && huidigeLijn <= centraleEnd;
      
      if (!isInCentraalGebied) {
        // Skip lijnen buiten het centrale gebied (waarschijnlijk muur/randen)
        continue;
      }
      
      // Tel hoeveel lijnen dichtbij zijn (kenmerk van baksteen voegen)
      let aantalDichtbij = 0;
      let minAfstandTotAndere = primaireDimensie;
      
      for (let j = 0; j < gesorteerdeLijnen.length; j++) {
        if (i === j) continue;
        
        const andereLijn = gesorteerdeLijnen[j];
        const afstand = Math.abs(huidigeLijn - andereLijn);
        minAfstandTotAndere = Math.min(minAfstandTotAndere, afstand);
        
        // Als er veel lijnen zijn met kleine afstanden, is het waarschijnlijk baksteen voegen
        if (afstand < maxAfstandBaksteen) {
          aantalDichtbij++;
        }
      }
      
      // Filter criteria:
      // - Als er meer dan 2 lijnen dichtbij zijn (binnen 3% afstand), is het waarschijnlijk baksteen voegen
      // - Als de minimum afstand tot andere lijnen groter is dan 6%, is het waarschijnlijk een kozijn lijn
      const isWaarschijnlijkBaksteenVoeg = aantalDichtbij > 2;
      const isWaarschijnlijkKozijnLijn = minAfstandTotAndere >= minAfstandKozijn;
      
      // Behoud alleen lijnen die waarschijnlijk kozijn lijnen zijn
      if (!isWaarschijnlijkBaksteenVoeg || isWaarschijnlijkKozijnLijn) {
        gefilterdeLijnen.push(huidigeLijn);
      }
    }
    
    return gefilterdeLijnen;
  }

  // Filter de belangrijkste lijnen door ze gelijkmatig te verdelen
  function filterBelangrijksteLijnen(lijnen, dimensie, maxAantal) {
    if (lijnen.length === 0) {
      return [];
    }
    
    // Als we minder of evenveel lijnen hebben als maxAantal, retourneer allemaal
    if (lijnen.length <= maxAantal) {
      return lijnen.sort((a, b) => a - b);
    }
    
    // Sorteer lijnen op positie
    const gesorteerdeLijnen = [...lijnen].sort((a, b) => a - b);
    
    // Gebruik een slimmere aanpak: behoud alle lijnen die ver genoeg uit elkaar liggen
    const geselecteerdeLijnen = [];
    const minAfstand = dimensie / (maxAantal * 2); // Kleinere minimum afstand om meer lijnen toe te staan
    
    for (const lijn of gesorteerdeLijnen) {
      // Check of deze lijn ver genoeg van alle geselecteerde lijnen ligt
      const teDichtbij = geselecteerdeLijnen.some(geselecteerd => Math.abs(lijn - geselecteerd) < minAfstand);
      
      if (!teDichtbij) {
        geselecteerdeLijnen.push(lijn);
        // Stop niet bij maxAantal, maar laat alle lijnen die ver genoeg uit elkaar liggen toe
      }
    }
    
    // Als we te veel lijnen hebben, behoud alleen de eerste maxAantal
    if (geselecteerdeLijnen.length > maxAantal) {
      return geselecteerdeLijnen.slice(0, maxAantal);
    }
    
    return geselecteerdeLijnen.sort((a, b) => a - b);
  }
})();
</script>
</body>
</html>






